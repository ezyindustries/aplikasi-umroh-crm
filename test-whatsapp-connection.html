<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WhatsApp Connection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .warning { background: #5a5a2d; }
        .info { background: #2d3a5a; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        img {
            max-width: 300px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>WhatsApp Connection Test</h1>
    
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="status-info" class="status info">Checking...</div>
    </div>
    
    <div class="test-section">
        <h2>Actions</h2>
        <button onclick="checkStatus()">Check Status</button>
        <button onclick="startSession()">Start Session</button>
        <button onclick="getQR()">Get QR Code</button>
        <button onclick="stopSession()">Stop Session</button>
        <button onclick="testWebhook()">Test Webhook</button>
    </div>
    
    <div class="test-section">
        <h2>QR Code</h2>
        <div id="qr-container">
            <p>Click "Get QR Code" to display</p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Response Log</h2>
        <pre id="response-log"></pre>
    </div>
    
    <script>
        const WAHA_URL = 'http://localhost:3001';
        const WAHA_API_KEY = 'your-secret-api-key';
        const SESSION = 'default';
        
        function log(message, data) {
            const logElement = document.getElementById('response-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            if (data) {
                logElement.textContent += JSON.stringify(data, null, 2) + '\n\n';
            }
        }
        
        async function checkStatus() {
            try {
                const response = await fetch(`${WAHA_URL}/api/sessions/${SESSION}`, {
                    headers: { 'X-Api-Key': WAHA_API_KEY }
                });
                
                const data = await response.json();
                log('Status check:', data);
                
                const statusElement = document.getElementById('status-info');
                statusElement.className = 'status ' + (data.status === 'WORKING' ? 'success' : 'warning');
                statusElement.textContent = `Status: ${data.status}`;
                
                if (data.me) {
                    statusElement.textContent += ` | Number: ${data.me.id}`;
                }
            } catch (error) {
                log('Error checking status:', error.message);
                document.getElementById('status-info').className = 'status error';
                document.getElementById('status-info').textContent = 'Error: ' + error.message;
            }
        }
        
        async function startSession() {
            try {
                log('Starting session...');
                
                const response = await fetch(`${WAHA_URL}/api/sessions/start`, {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': WAHA_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: SESSION,
                        config: {
                            webhooks: [{
                                url: 'http://localhost:5000/api/crm/webhook',
                                events: ['message', 'message.ack', 'state.change']
                            }]
                        }
                    })
                });
                
                const data = await response.json();
                log('Start session response:', data);
                
                if (response.ok) {
                    setTimeout(getQR, 2000);
                }
            } catch (error) {
                log('Error starting session:', error.message);
            }
        }
        
        async function getQR() {
            try {
                log('Fetching QR code...');
                
                const response = await fetch(`${WAHA_URL}/api/sessions/${SESSION}/auth/qr`, {
                    headers: { 'X-Api-Key': WAHA_API_KEY }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    document.getElementById('qr-container').innerHTML = 
                        `<img src="${imageUrl}" alt="QR Code"><p>Scan with WhatsApp</p>`;
                    
                    log('QR code loaded successfully');
                    
                    // Start checking for connection
                    const interval = setInterval(async () => {
                        const status = await checkStatusQuiet();
                        if (status === 'WORKING') {
                            clearInterval(interval);
                            log('WhatsApp connected!');
                            document.getElementById('qr-container').innerHTML = 
                                '<p class="status success">Connected!</p>';
                        }
                    }, 3000);
                    
                    // Stop checking after 5 minutes
                    setTimeout(() => clearInterval(interval), 300000);
                } else {
                    log('Failed to get QR code:', response.statusText);
                }
            } catch (error) {
                log('Error getting QR code:', error.message);
            }
        }
        
        async function checkStatusQuiet() {
            try {
                const response = await fetch(`${WAHA_URL}/api/sessions/${SESSION}`, {
                    headers: { 'X-Api-Key': WAHA_API_KEY }
                });
                const data = await response.json();
                return data.status;
            } catch (error) {
                return 'ERROR';
            }
        }
        
        async function stopSession() {
            try {
                log('Stopping session...');
                
                const response = await fetch(`${WAHA_URL}/api/sessions/${SESSION}/stop`, {
                    method: 'POST',
                    headers: { 'X-Api-Key': WAHA_API_KEY }
                });
                
                const data = await response.json();
                log('Stop session response:', data);
                
                setTimeout(checkStatus, 1000);
            } catch (error) {
                log('Error stopping session:', error.message);
            }
        }
        
        async function testWebhook() {
            try {
                log('Testing webhook configuration...');
                
                // First check if backend is running
                const backendResponse = await fetch('http://localhost:5000/api/crm/webhook', {
                    method: 'GET'
                });
                
                if (backendResponse.ok) {
                    log('Backend webhook endpoint is accessible');
                } else {
                    log('Backend webhook endpoint returned:', backendResponse.status);
                }
                
                // Check WAHA webhook config
                const response = await fetch(`${WAHA_URL}/api/sessions/${SESSION}`, {
                    headers: { 'X-Api-Key': WAHA_API_KEY }
                });
                
                const data = await response.json();
                log('Session config:', data.config);
            } catch (error) {
                log('Error testing webhook:', error.message);
            }
        }
        
        // Check status on load
        checkStatus();
    </script>
</body>
</html>