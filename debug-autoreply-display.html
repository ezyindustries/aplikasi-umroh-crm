<!DOCTYPE html>
<html>
<head>
    <title>Debug Autoreply Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        pre {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .log-card {
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .field {
            margin: 5px 0;
        }
        .label {
            font-weight: bold;
            color: #4a9eff;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #44ff44;
        }
    </style>
</head>
<body>
    <h1>Debug Autoreply Display</h1>
    
    <div class="section">
        <h2>API Test Results</h2>
        <div id="apiResults"></div>
    </div>
    
    <div class="section">
        <h2>Processed Logs</h2>
        <div id="processedLogs"></div>
    </div>
    
    <div class="section">
        <h2>Sample Message Card</h2>
        <div id="sampleCard"></div>
    </div>

    <script>
        async function debugDisplay() {
            const resultsDiv = document.getElementById('apiResults');
            const processedDiv = document.getElementById('processedLogs');
            const sampleDiv = document.getElementById('sampleCard');
            
            try {
                // Fetch logs from API
                console.log('Fetching logs...');
                const response = await fetch('http://localhost:3003/api/automation/logs?limit=5');
                const data = await response.json();
                
                resultsDiv.innerHTML = '<h3>Raw API Response:</h3>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                if (data.success && data.logs && data.logs.length > 0) {
                    processedDiv.innerHTML = '<h3>Parsed Log Fields:</h3>';
                    
                    data.logs.forEach((log, index) => {
                        processedDiv.innerHTML += `
                            <div class="log-card">
                                <h4>Log ${index + 1} (ID: ${log.id})</h4>
                                <div class="field"><span class="label">Status:</span> ${log.status}</div>
                                <div class="field"><span class="label">Rule ID:</span> ${log.ruleId}</div>
                                <div class="field"><span class="label">Created At:</span> ${new Date(log.createdAt).toLocaleString()}</div>
                                <div class="field"><span class="label">Execution Time:</span> ${log.executionTime}ms</div>
                                
                                <h5>Metadata:</h5>
                                <pre>${JSON.stringify(log.metadata, null, 2)}</pre>
                                
                                <h5>TriggerData:</h5>
                                <pre>${JSON.stringify(log.triggerData, null, 2)}</pre>
                                
                                ${log.rule ? `
                                    <h5>Rule Info:</h5>
                                    <div class="field"><span class="label">Rule Name:</span> ${log.rule.name}</div>
                                    <div class="field"><span class="label">Rule Type:</span> ${log.rule.ruleType}</div>
                                ` : '<div class="error">No rule data</div>'}
                                
                                ${log.contact ? `
                                    <h5>Contact Info:</h5>
                                    <div class="field"><span class="label">Phone:</span> ${log.contact.phone}</div>
                                    <div class="field"><span class="label">Name:</span> ${log.contact.name || 'Unknown'}</div>
                                ` : '<div class="error">No contact data</div>'}
                            </div>
                        `;
                    });
                    
                    // Create sample card using the first log
                    const firstLog = data.logs[0];
                    sampleDiv.innerHTML = createSampleCard(firstLog);
                    
                } else {
                    processedDiv.innerHTML = '<div class="error">No logs found in response</div>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
                console.error('Error:', error);
            }
        }
        
        function createSampleCard(log) {
            // Extract data with fallbacks
            const ruleName = log.metadata?.ruleName || log.rule?.name || 'Unknown Rule';
            const ruleType = log.metadata?.ruleType || log.rule?.ruleType || 'unknown';
            const messageContent = log.triggerData?.messageContent || log.metadata?.messageContent || 'No content';
            const matchedKeywords = log.metadata?.matchedKeywords || [];
            const intentDetection = log.metadata?.intentDetection;
            const templateUsed = log.metadata?.templateUsed;
            const status = log.status || 'pending';
            const executionTime = log.executionTime || 0;
            const timeInSeconds = (executionTime / 1000).toFixed(2);
            
            return `
                <h3>Rendered Message Card:</h3>
                <div style="background: #444; border: 1px solid #666; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; color: #fff;">${ruleName}</div>
                            <span style="background: #5a5a5a; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                                ${formatRuleType(ruleType)}
                            </span>
                        </div>
                        <div class="${status}" style="font-weight: bold;">${status.toUpperCase()}</div>
                    </div>
                    
                    <div style="margin: 10px 0; color: #ddd;">
                        <div>${messageContent}</div>
                        ${matchedKeywords.length > 0 ? `
                            <div style="margin-top: 5px; font-size: 12px; color: #aaa;">
                                Matched: ${matchedKeywords.join(', ')}
                            </div>
                        ` : ''}
                        ${intentDetection ? `
                            <div style="margin-top: 5px;">
                                <span style="background: #6a6a6a; padding: 2px 6px; border-radius: 3px; font-size: 11px;">
                                    ${intentDetection.intent} (${Math.round(intentDetection.confidence * 100)}%)
                                </span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: #999;">
                        <div>
                            <span>${timeInSeconds}s</span>
                            ${templateUsed ? `<span style="margin-left: 10px;">${templateUsed}</span>` : ''}
                        </div>
                        <span>${new Date(log.createdAt).toLocaleTimeString()}</span>
                    </div>
                </div>
                
                <h4>Debug Info:</h4>
                <pre style="font-size: 11px;">
Rule Name Sources:
- metadata.ruleName: ${log.metadata?.ruleName || 'undefined'}
- rule.name: ${log.rule?.name || 'undefined'}

Message Content Sources:
- triggerData.messageContent: ${log.triggerData?.messageContent || 'undefined'}
- metadata.messageContent: ${log.metadata?.messageContent || 'undefined'}

Has matched keywords: ${matchedKeywords.length > 0}
Has intent detection: ${!!intentDetection}
Has template used: ${!!templateUsed}
                </pre>
            `;
        }
        
        function formatRuleType(ruleType) {
            const types = {
                keyword: 'Keyword',
                template: 'Template',
                llm_agent: 'LLM Agent',
                welcome: 'Welcome',
                away: 'Away',
                workflow: 'Workflow'
            };
            return types[ruleType] || 'Unknown';
        }
        
        // Run debug on load
        debugDisplay();
    </script>
</body>
</html>