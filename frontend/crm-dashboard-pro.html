<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Dashboard Pro - Vauza Tamma Marketing</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- Material UI Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js removed due to CSP - will use inline chart implementation -->
    
    <style>
        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            min-height: 100vh;
            color: #f8fafc;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        /* Main Container */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(71, 85, 105, 0.3);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .logo {
            text-align: center;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 12px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.4), rgba(30, 41, 59, 0.3));
            border: 1px solid rgba(71, 85, 105, 0.3);
            text-decoration: none;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            transform: translateX(5px);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(16, 185, 129, 0.3));
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .nav-item i {
            margin-right: 12px;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.5);
        }

        /* Header */
        .header {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(71, 85, 105, 0.3);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.4);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-indicator.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .status-indicator.connecting {
            background: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Content Area */
        .content {
            padding: 30px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 0 60px rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-icon.blue {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2));
            color: #60a5fa;
        }

        .stat-icon.green {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.2));
            color: #34d399;
        }

        .stat-icon.purple {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.2));
            color: #a78bfa;
        }

        .stat-icon.orange {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.3), rgba(249, 115, 22, 0.2));
            color: #fb923c;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        .stat-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.4);
            color: #e2e8f0;
            border: 1px solid rgba(71, 85, 105, 0.5);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(71, 85, 105, 0.6);
            border-color: rgba(71, 85, 105, 0.7);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        /* WhatsApp Control Panel */
        .wa-control-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            margin-bottom: 30px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-item {
            background: rgba(71, 85, 105, 0.2);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .control-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 10px;
            display: block;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(71, 85, 105, 0.4);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* QR Modal - Full Screen */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 24px;
            width: 95%;
            max-width: 900px;
            height: 90vh;
            max-height: 900px;
            padding: 40px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.1);
        }

        .qr-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin: 30px auto;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 600px;
            width: 100%;
        }

        .qr-container img {
            width: 100%;
            height: auto;
            max-width: 500px;
            max-height: 500px;
            image-rendering: crisp-edges;
        }

        .qr-instructions {
            background: rgba(71, 85, 105, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .qr-instructions ol {
            text-align: left;
            color: #cbd5e1;
            line-height: 1.8;
        }

        /* Charts */
        .chart-container {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            margin-bottom: 30px;
            position: relative;
            height: 400px;
        }

        .chart-wrapper {
            position: relative;
            height: 100%;
            width: 100%;
        }

        /* Funnel */
        .funnel-container {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            margin-bottom: 30px;
        }

        .funnel-stages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .funnel-stage {
            text-align: center;
            padding: 20px;
            background: rgba(71, 85, 105, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.3s;
            cursor: pointer;
        }

        .funnel-stage:hover {
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }

        .funnel-value {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .funnel-label {
            color: #94a3b8;
            font-size: 14px;
        }

        /* Chat Interface */
        .chat-container {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            height: 600px;
            display: flex;
            overflow: hidden;
        }

        .conversation-list {
            width: 300px;
            border-right: 1px solid rgba(71, 85, 105, 0.3);
            overflow-y: auto;
        }

        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .conversation-item:hover {
            background: rgba(71, 85, 105, 0.2);
        }

        .conversation-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }

        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .conversation-preview {
            font-size: 13px;
            color: #94a3b8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            background: rgba(15, 23, 42, 0.5);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
        }

        .message.inbound {
            justify-content: flex-start;
        }

        .message.outbound {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
        }

        .message.inbound .message-bubble {
            background: rgba(71, 85, 105, 0.3);
            border-bottom-left-radius: 4px;
        }

        .message.outbound .message-bubble {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
            background: rgba(15, 23, 42, 0.5);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                height: 100vh;
                z-index: 200;
                transition: left 0.3s;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .conversation-list {
                display: none;
            }

            /* Modal adjustments for mobile */
            .modal-content {
                width: 100%;
                height: 100vh;
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                padding: 20px;
            }

            .qr-container {
                padding: 20px;
                max-width: 100%;
            }

            .qr-container img {
                max-width: 100%;
                max-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">CRM Pro Dashboard</div>
            <nav>
                <a href="#" class="nav-item active" data-page="dashboard">
                    <i class="material-icons">dashboard</i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="whatsapp">
                    <i class="material-icons">chat</i>
                    <span>WhatsApp Chat</span>
                </a>
                <a href="#" class="nav-item" data-page="marketing">
                    <i class="material-icons">campaign</i>
                    <span>Marketing Tools</span>
                </a>
                <a href="#" class="nav-item" data-page="automation">
                    <i class="material-icons">smart_toy</i>
                    <span>WhatsApp Automation</span>
                </a>
                <a href="#" class="nav-item" data-page="leads">
                    <i class="material-icons">people</i>
                    <span>Lead Management</span>
                </a>
                <a href="#" class="nav-item" data-page="analytics">
                    <i class="material-icons">analytics</i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <i class="material-icons">settings</i>
                    <span>Settings</span>
                </a>
                <a href="/jamaah-list.html" class="nav-item">
                    <i class="material-icons">people</i>
                    <span>Data Jamaah</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="material-icons">campaign</i>
                    <span>Campaigns</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="material-icons">analytics</i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="material-icons">settings</i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title">Marketing Dashboard</h1>
                <div class="header-actions">
                    <div class="connection-status">
                        <div id="wa-indicator" class="status-indicator disconnected"></div>
                        <span id="wa-status-text">WhatsApp Disconnected</span>
                    </div>
                    <button class="btn btn-primary" data-action="add-jamaah">
                        <i class="material-icons">add</i>
                        New Lead
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page-content" style="display: block;">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <!-- Total Leads -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-leads">0</div>
                                <div class="stat-label">Total Leads</div>
                            </div>
                            <div class="stat-icon blue">
                                <i class="material-icons">people</i>
                            </div>
                        </div>
                        <div class="stat-actions">
                            <button class="btn btn-secondary" data-action="view-all-leads">
                                View All
                            </button>
                            <button class="btn btn-primary" data-action="add-new-lead">
                                Add New
                            </button>
                        </div>
                    </div>

                    <!-- Active Conversations -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="active-chats">0</div>
                                <div class="stat-label">Active Conversations</div>
                            </div>
                            <div class="stat-icon green">
                                <i class="material-icons">chat</i>
                            </div>
                        </div>
                        <div class="stat-actions">
                            <button class="btn btn-secondary" data-action="view-conversations">
                                View Chats
                            </button>
                            <button class="btn btn-success" data-action="open-whatsapp">
                                Open WhatsApp
                            </button>
                        </div>
                    </div>

                    <!-- Bot Responses -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="bot-responses">0</div>
                                <div class="stat-label">Bot Responses Today</div>
                            </div>
                            <div class="stat-icon purple">
                                <i class="material-icons">smart_toy</i>
                            </div>
                        </div>
                        <div class="stat-actions">
                            <button class="btn btn-secondary" data-action="view-bot-stats">
                                View Stats
                            </button>
                            <button class="btn btn-primary" data-action="configure-bot">
                                Configure
                            </button>
                        </div>
                    </div>

                    <!-- Conversion Rate -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="conversion-rate">0%</div>
                                <div class="stat-label">Conversion Rate</div>
                            </div>
                            <div class="stat-icon orange">
                                <i class="material-icons">trending_up</i>
                            </div>
                        </div>
                        <div class="stat-actions">
                            <button class="btn btn-secondary" data-action="view-funnel">
                                View Funnel
                            </button>
                            <button class="btn btn-primary" data-action="view-reports">
                                Reports
                            </button>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Control Panel -->
                <div class="wa-control-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="material-icons">chat</i>
                            WhatsApp Control Center
                        </h2>
                        <div id="last-check" style="color: #94a3b8; font-size: 14px;">
                            Last check: <span id="last-check-time">Never</span>
                        </div>
                    </div>

                    <div class="control-grid">
                        <!-- Connection Control -->
                        <div class="control-item">
                            <label class="control-label">Connection Status</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div id="wa-connection-status" style="flex: 1; padding: 10px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; color: #f87171;">
                                    Disconnected
                                </div>
                                <button id="wa-connect-btn" class="btn btn-success" data-action="connect-whatsapp">
                                    Connect
                                </button>
                            </div>
                        </div>

                        <!-- Bot Control -->
                        <div class="control-item">
                            <label class="control-label">Auto-Reply Bot</label>
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="bot-enabled" onchange="toggleBot(this)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span id="bot-status">Disabled</span>
                            </div>
                        </div>

                        <!-- LLM Provider -->
                        <div class="control-item">
                            <label class="control-label">AI Provider</label>
                            <select id="llm-provider" onchange="updateLLMProvider(this)" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px; color: #e2e8f0;">
                                <option value="ollama">Ollama (Local)</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>

                        <!-- Quick Actions -->
                        <div class="control-item">
                            <label class="control-label">Quick Actions</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" data-action="test-bot">
                                    Test Bot
                                </button>
                                <button class="btn btn-secondary" data-action="view-logs">
                                    View Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lead Funnel -->
                <div class="funnel-container">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="material-icons">filter_list</i>
                            Lead Conversion Funnel
                        </h2>
                    </div>

                    <div class="funnel-stages">
                        <div class="funnel-stage" data-stage="visitors">
                            <div class="funnel-value" id="funnel-visitors">0</div>
                            <div class="funnel-label">Visitors</div>
                        </div>
                        <div class="funnel-stage" data-stage="leads">
                            <div class="funnel-value" id="funnel-leads">0</div>
                            <div class="funnel-label">Leads</div>
                        </div>
                        <div class="funnel-stage" data-stage="qualified">
                            <div class="funnel-value" id="funnel-qualified">0</div>
                            <div class="funnel-label">Qualified</div>
                        </div>
                        <div class="funnel-stage" data-stage="customers">
                            <div class="funnel-value" id="funnel-customers">0</div>
                            <div class="funnel-label">Customers</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px;">
                    <!-- Lead Trends Chart -->
                    <div class="chart-container">
                        <div class="panel-header">
                            <h2 class="panel-title">
                                <i class="material-icons">show_chart</i>
                                Lead Trends (30 Days)
                            </h2>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="leadTrendsChart"></canvas>
                        </div>
                    </div>

                    <!-- Source Distribution -->
                    <div class="chart-container">
                        <div class="panel-header">
                            <h2 class="panel-title">
                                <i class="material-icons">pie_chart</i>
                                Lead Sources
                            </h2>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="sourceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="wa-control-panel" style="margin-top: 30px;">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="material-icons">forum</i>
                            WhatsApp Conversations
                        </h2>
                        <button class="btn btn-primary" data-action="open-full-chat">
                            Open Full Chat
                        </button>
                    </div>

                    <div class="chat-container">
                        <div class="conversation-list" id="conversation-list">
                            <div style="padding: 20px; text-align: center; color: #94a3b8;">
                                <p>No active conversations</p>
                                <p style="font-size: 12px; margin-top: 10px;">Connect WhatsApp to see conversations</p>
                            </div>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header">
                                <div id="chat-header-info" style="text-align: center; width: 100%; color: #94a3b8;">
                                    Select a conversation to start chatting
                                </div>
                            </div>
                            <div class="chat-messages" id="chat-messages"></div>
                            <div class="chat-input-container">
                                <div class="chat-input-wrapper">
                                    <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." disabled>
                                    <button class="btn btn-primary" data-action="send-message" disabled>
                                        <i class="material-icons">send</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                </div>
                <!-- End Dashboard Page -->

                <!-- WhatsApp Page -->
                <div id="whatsapp-page" class="page-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 140px);">
                        <!-- Conversation List -->
                        <div class="card" style="overflow: hidden; display: flex; flex-direction: column;">
                            <div style="padding: 20px; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
                                <h3>Conversations</h3>
                                <input type="text" placeholder="Search conversations..." style="width: 100%; padding: 10px; margin-top: 10px; background: rgba(71, 85, 105, 0.2); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 8px; color: #e2e8f0;">
                            </div>
                            <div id="conversation-list" class="conversation-list" style="flex: 1; overflow-y: auto;">
                                <!-- Conversations will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Chat Window -->
                        <div class="card" style="overflow: hidden; display: flex; flex-direction: column;">
                            <div class="chat-header" id="chat-header">
                                <div id="chat-header-info">
                                    <p style="color: #94a3b8;">Select a conversation to start chatting</p>
                                </div>
                            </div>
                            <div id="chat-messages" class="chat-messages" style="flex: 1;">
                                <!-- Messages will be loaded here -->
                            </div>
                            <div class="chat-input-container">
                                <div class="chat-input-wrapper">
                                    <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." disabled>
                                    <button class="btn btn-primary" id="send-message-btn" disabled>
                                        <i class="material-icons">send</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marketing Tools Page -->
                <div id="marketing-page" class="page-content" style="display: none;">
                    <div class="card">
                        <h2 style="margin-bottom: 20px;">Marketing Tools</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div class="stat-card">
                                <h3>Broadcast Messages</h3>
                                <p style="color: #94a3b8; margin: 10px 0;">Send bulk messages to your contacts</p>
                                <button class="btn btn-primary">Create Broadcast</button>
                            </div>
                            <div class="stat-card">
                                <h3>Campaigns</h3>
                                <p style="color: #94a3b8; margin: 10px 0;">Manage marketing campaigns</p>
                                <button class="btn btn-primary">View Campaigns</button>
                            </div>
                            <div class="stat-card">
                                <h3>Templates</h3>
                                <p style="color: #94a3b8; margin: 10px 0;">Message templates library</p>
                                <button class="btn btn-primary">Manage Templates</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Automation Page -->
                <div id="automation-page" class="page-content" style="display: none;">
                    <div class="card">
                        <h2 style="margin-bottom: 20px;">WhatsApp Automation</h2>
                        <div class="control-grid">
                            <div class="control-item">
                                <label class="control-label">Auto-Reply Bot</label>
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="bot-enabled">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span id="bot-status">Disabled</span>
                                </div>
                            </div>
                            <div class="control-item">
                                <label class="control-label">Welcome Message</label>
                                <textarea style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.2); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 8px; color: #e2e8f0; min-height: 100px;" placeholder="Enter welcome message..."></textarea>
                            </div>
                            <div class="control-item">
                                <label class="control-label">Business Hours</label>
                                <input type="text" style="width: 100%; padding: 10px; background: rgba(71, 85, 105, 0.2); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 8px; color: #e2e8f0;" placeholder="e.g., Mon-Fri 9AM-6PM">
                            </div>
                            <button class="btn btn-success" style="margin-top: 20px;">Save Settings</button>
                        </div>
                    </div>
                </div>

                <!-- Lead Management Page -->
                <div id="leads-page" class="page-content" style="display: none;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>Lead Management</h2>
                            <button class="btn btn-primary">
                                <i class="material-icons">add</i>
                                Add New Lead
                            </button>
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(71, 85, 105, 0.3);">
                                    <th style="padding: 12px; text-align: left;">Name</th>
                                    <th style="padding: 12px; text-align: left;">Phone</th>
                                    <th style="padding: 12px; text-align: left;">Status</th>
                                    <th style="padding: 12px; text-align: left;">Interest</th>
                                    <th style="padding: 12px; text-align: left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leads-table">
                                <tr>
                                    <td colspan="5" style="padding: 20px; text-align: center; color: #94a3b8;">Loading leads...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Analytics Page -->
                <div id="analytics-page" class="page-content" style="display: none;">
                    <div class="card">
                        <h2>Analytics & Reports</h2>
                        <p style="color: #94a3b8; margin-top: 20px;">Analytics features coming soon...</p>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page-content" style="display: none;">
                    <div class="card">
                        <h2>Settings</h2>
                        <p style="color: #94a3b8; margin-top: 20px;">System settings will be available here.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-action="close-qr-modal">&times;</button>
            <h1 style="text-align: center; color: #60a5fa; margin-bottom: 20px; font-size: 36px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <i class="material-icons" style="font-size: 48px;">qr_code_scanner</i>
                Scan WhatsApp QR Code
            </h1>
            
            <div id="qr-status" style="text-align: center; margin-bottom: 20px; color: #10b981; font-size: 18px; font-weight: 500;">
                <div class="spinner" style="margin: 0 auto 10px;"></div>
                Loading QR Code...
            </div>
            
            <div class="qr-container">
                <img id="qr-image" alt="QR Code" style="display: block;">
            </div>
            
            <div class="qr-instructions" style="margin-top: auto;">
                <h3 style="color: #e2e8f0; margin-bottom: 15px; font-size: 20px;">ðŸ“± How to connect:</h3>
                <ol style="font-size: 16px; line-height: 2;">
                    <li>Open <strong>WhatsApp</strong> on your phone</li>
                    <li>Tap <strong>Menu</strong> or <strong>Settings</strong> and select <strong>Linked Devices</strong></li>
                    <li>Tap on <strong>Link a Device</strong></li>
                    <li>Point your phone at this screen to <strong>scan the code</strong></li>
                </ol>
                <p style="text-align: center; margin-top: 20px; color: #94a3b8; font-size: 14px;">
                    QR Code will refresh automatically every 20 seconds
                </p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:3000/api';
        const WAHA_URL = 'http://localhost:3001';
        const WAHA_API_KEY = 'your-secret-api-key';
        
        let authToken = localStorage.getItem('token');
        let waConnectionStatus = 'disconnected';
        let currentChatId = null;
        let currentPhoneNumber = null;
        let checkInterval = null;
        let ws = null;
        let conversations = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                alert('Please login first');
                window.location.href = '/index.html';
                return;
            }

            initializeDashboard();
            startConnectionMonitoring();
            loadDashboardData();
            initializeCharts();
            setupNavigationEventListeners();
            setupButtonEventListeners();
            initializeWebSocket();
        });

        // Setup navigation event listeners
        function setupNavigationEventListeners() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    switchPage(page);
                });
            });
        }

        // Setup button event listeners
        function setupButtonEventListeners() {
            // Connect button
            const connectBtn = document.getElementById('connect-wa-btn');
            if (connectBtn) {
                connectBtn.removeAttribute('onclick');
                connectBtn.addEventListener('click', connectWhatsApp);
            }
            
            // Check status button
            const checkBtn = document.getElementById('check-status-btn');
            if (checkBtn) {
                checkBtn.removeAttribute('onclick');
                checkBtn.addEventListener('click', checkWhatsAppConnection);
            }
            
            // Disconnect button
            const disconnectBtn = document.getElementById('disconnect-wa-btn');
            if (disconnectBtn) {
                disconnectBtn.removeAttribute('onclick');
                disconnectBtn.addEventListener('click', disconnectWhatsApp);
            }
            
            // Send message button
            const sendBtn = document.getElementById('send-message-btn');
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            // Chat input enter key
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Bot toggle
            const botToggle = document.getElementById('bot-enabled');
            if (botToggle) {
                botToggle.addEventListener('change', toggleBot);
            }
            
            // Modal close button
            const modalClose = document.querySelector('.modal-close');
            if (modalClose) {
                modalClose.removeAttribute('onclick');
                modalClose.addEventListener('click', closeQRModal);
            }
            
            // Remove all remaining onclick attributes
            document.querySelectorAll('[onclick]').forEach(element => {
                element.removeAttribute('onclick');
            });
            
            // Handle all button data-action attributes
            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const action = button.dataset.action;
                    handleButtonAction(action);
                });
            });
            
            // Handle funnel stage clicks
            document.querySelectorAll('.funnel-stage[data-stage]').forEach(stage => {
                stage.addEventListener('click', (e) => {
                    const stageType = stage.dataset.stage;
                    viewStageDetails(stageType);
                });
            });
        }
        
        // Handle button actions
        function handleButtonAction(action) {
            switch(action) {
                case 'add-jamaah':
                    window.location.href = '/jamaah-form.html';
                    break;
                case 'view-all-leads':
                    viewAllLeads();
                    break;
                case 'add-new-lead':
                    addNewLead();
                    break;
                case 'view-conversations':
                    viewConversations();
                    break;
                case 'open-whatsapp':
                    openWhatsApp();
                    break;
                case 'view-bot-stats':
                    viewBotStats();
                    break;
                case 'configure-bot':
                    configureBotSettings();
                    break;
                case 'view-funnel':
                    viewFunnel();
                    break;
                case 'view-reports':
                    viewReports();
                    break;
                case 'connect-whatsapp':
                    connectWhatsApp();
                    break;
                case 'test-bot':
                    testBot();
                    break;
                case 'view-logs':
                    viewLogs();
                    break;
                case 'open-full-chat':
                    openFullChat();
                    break;
                case 'send-message':
                    sendMessage();
                    break;
                case 'close-qr-modal':
                    closeQRModal();
                    break;
                default:
                    console.log('Unknown action:', action);
            }
        }

        // Switch between pages
        function switchPage(page) {
            console.log('Switching to page:', page);
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            // Hide all pages
            document.querySelectorAll('.page-content').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected page
            const pageElement = document.getElementById(`${page}-page`);
            if (pageElement) {
                pageElement.style.display = 'block';
            } else {
                // If page doesn't exist, show dashboard
                document.getElementById('dashboard-page').style.display = 'block';
            }

            // Update page title
            const titles = {
                dashboard: 'Marketing Dashboard',
                whatsapp: 'WhatsApp Chat',
                marketing: 'Marketing Tools',
                automation: 'WhatsApp Automation',
                leads: 'Lead Management',
                analytics: 'Analytics & Reports',
                settings: 'Settings'
            };
            
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.textContent = titles[page] || 'Dashboard';
            }

            // Load page-specific data
            switch(page) {
                case 'whatsapp':
                    loadConversations();
                    break;
                case 'leads':
                    loadLeads();
                    break;
                case 'automation':
                    loadBotSettings();
                    break;
            }
        }

        // Initialize Dashboard
        async function initializeDashboard() {
            await checkWhatsAppStatus();
            await loadStats();
            await loadConversations();
        }

        // Initialize WebSocket for real-time updates
        function initializeWebSocket() {
            try {
                const wsUrl = 'ws://localhost:3000';
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected for real-time updates');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('WebSocket parse error:', e);
                    }
                };

                ws.onerror = (error) => {
                    console.warn('WebSocket error:', error);
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected, reconnecting in 5s...');
                    setTimeout(initializeWebSocket, 5000);
                };
            } catch (error) {
                console.warn('WebSocket init failed:', error);
                setTimeout(initializeWebSocket, 5000);
            }
        }

        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.type === 'new_message' || data.event === 'message') {
                // Update conversation list
                loadConversations();
                
                // Update active chat messages count
                const activeChats = document.getElementById('active-chats');
                if (activeChats) {
                    const currentCount = parseInt(activeChats.textContent) || 0;
                    activeChats.textContent = currentCount + 1;
                }
                
                // If message is for current conversation, add it
                if (currentChatId && data.conversationId === currentChatId) {
                    const container = document.getElementById('chat-messages');
                    const messageEl = document.createElement('div');
                    messageEl.className = 'message inbound';
                    messageEl.innerHTML = `
                        <div class="message-bubble">
                            <div>${data.message || data.content}</div>
                            <div class="message-time">
                                ${new Date().toLocaleTimeString('id-ID', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                })}
                            </div>
                        </div>
                    `;
                    container.appendChild(messageEl);
                    container.scrollTop = container.scrollHeight;
                    
                    // Play notification sound (optional)
                    playNotificationSound();
                }
                
                // Show browser notification if page not in focus
                if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification('New WhatsApp Message', {
                        body: data.message || 'You have a new message',
                        icon: '/favicon.ico'
                    });
                }
            }
        }

        // Play notification sound
        function playNotificationSound() {
            // Create audio element for notification
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZizoIG2m98OScTgwOUq7n77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgY7k9n1y3kkBSeBzvLaizsIGWm98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTgwNUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBzvLaizsIGWi98OacTQ0NUq3m77xmGgU7k9n1y3kkBCeBz/LaizsIGWi98OacTQ==');
            audio.volume = 0.3;
            audio.play().catch(e => console.log('Could not play notification sound'));
        }

        // Connection Monitoring
        function startConnectionMonitoring() {
            // Check immediately
            checkWhatsAppStatus();
            
            // Then check every 30 seconds
            checkInterval = setInterval(() => {
                checkWhatsAppStatus();
                updateLastCheckTime();
            }, 30000);
        }

        // Check WhatsApp Status
        async function checkWhatsAppStatus() {
            try {
                const response = await fetch(`${WAHA_URL}/api/sessions/default`, {
                    headers: { 'X-Api-Key': WAHA_API_KEY }
                });

                if (!response.ok) {
                    updateConnectionStatus('disconnected', 'Session not found');
                    return;
                }

                const data = await response.json();
                
                switch(data.status) {
                    case 'WORKING':
                        updateConnectionStatus('connected', `Connected: ${data.me?.pushName || 'Unknown'}`);
                        break;
                    case 'SCAN_QR_CODE':
                        updateConnectionStatus('qr-needed', 'Scan QR Code');
                        break;
                    case 'STARTING':
                        updateConnectionStatus('connecting', 'Starting...');
                        break;
                    default:
                        updateConnectionStatus('disconnected', data.status);
                }

                // Update bot status
                const botEnabled = data.config?.webhooks?.length > 0;
                document.getElementById('bot-enabled').checked = botEnabled;
                document.getElementById('bot-status').textContent = botEnabled ? 'Enabled' : 'Disabled';

            } catch (error) {
                console.error('WhatsApp status check error:', error);
                updateConnectionStatus('error', 'Connection Error');
            }
        }

        // Update Connection Status UI
        function updateConnectionStatus(status, message) {
            waConnectionStatus = status;
            
            const indicator = document.getElementById('wa-indicator');
            const statusText = document.getElementById('wa-status-text');
            const connectionDiv = document.getElementById('wa-connection-status');
            const connectBtn = document.getElementById('wa-connect-btn');

            // Update indicator
            indicator.className = 'status-indicator';
            switch(status) {
                case 'connected':
                    indicator.classList.add('connected');
                    connectionDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                    connectionDiv.style.color = '#34d399';
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.className = 'btn btn-danger';
                    connectBtn.onclick = disconnectWhatsApp;
                    break;
                case 'qr-needed':
                    indicator.classList.add('connecting');
                    connectionDiv.style.background = 'rgba(245, 158, 11, 0.2)';
                    connectionDiv.style.color = '#f59e0b';
                    connectBtn.textContent = 'Scan QR';
                    connectBtn.className = 'btn btn-primary';
                    connectBtn.onclick = showQRModal;
                    break;
                case 'connecting':
                    indicator.classList.add('connecting');
                    connectionDiv.style.background = 'rgba(245, 158, 11, 0.2)';
                    connectionDiv.style.color = '#f59e0b';
                    connectBtn.textContent = 'Connecting...';
                    connectBtn.disabled = true;
                    break;
                default:
                    indicator.classList.add('disconnected');
                    connectionDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    connectionDiv.style.color = '#f87171';
                    connectBtn.textContent = 'Connect';
                    connectBtn.className = 'btn btn-success';
                    connectBtn.onclick = connectWhatsApp;
                    connectBtn.disabled = false;
            }

            statusText.textContent = message;
            connectionDiv.textContent = message;
        }

        // Connect WhatsApp
        async function connectWhatsApp() {
            try {
                const response = await fetch(`${WAHA_URL}/api/sessions/default/start`, {
                    method: 'POST',
                    headers: { 
                        'X-Api-Key': WAHA_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config: {
                            webhooks: [{
                                url: `${API_BASE}/crm/webhook`,
                                events: ['message', 'message.any']
                            }]
                        }
                    })
                });

                if (response.ok) {
                    setTimeout(() => {
                        checkWhatsAppStatus();
                        if (waConnectionStatus === 'qr-needed') {
                            showQRModal();
                        }
                    }, 2000);
                } else {
                    const error = await response.json();
                    if (error.message?.includes('already exists')) {
                        // Session exists, try to get QR
                        checkWhatsAppStatus();
                        setTimeout(() => {
                            if (waConnectionStatus === 'qr-needed') {
                                showQRModal();
                            }
                        }, 1000);
                    } else {
                        alert('Failed to start WhatsApp session: ' + error.message);
                    }
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        }

        // Disconnect WhatsApp
        async function disconnectWhatsApp() {
            if (!confirm('Are you sure you want to disconnect WhatsApp?')) return;

            try {
                const response = await fetch(`${WAHA_URL}/api/sessions/default/stop`, {
                    method: 'POST',
                    headers: { 'X-Api-Key': WAHA_API_KEY }
                });

                if (response.ok) {
                    updateConnectionStatus('disconnected', 'Disconnected');
                    alert('WhatsApp disconnected successfully');
                } else {
                    alert('Failed to disconnect WhatsApp');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Show QR Modal
        function showQRModal() {
            const modal = document.getElementById('qr-modal');
            modal.classList.add('active');
            loadQRCode();
        }

        // Close QR Modal
        function closeQRModal() {
            const modal = document.getElementById('qr-modal');
            modal.classList.remove('active');
        }

        // Load QR Code
        async function loadQRCode() {
            const statusDiv = document.getElementById('qr-status');
            const qrImage = document.getElementById('qr-image');

            try {
                statusDiv.innerHTML = '<div class="spinner" style="margin: 0 auto 10px;"></div> Loading QR Code...';
                statusDiv.style.color = '#94a3b8';
                
                const timestamp = new Date().getTime();
                const qrUrl = `${WAHA_URL}/api/screenshot?session=default&t=${timestamp}`;
                
                const response = await fetch(qrUrl, {
                    headers: {
                        'X-Api-Key': WAHA_API_KEY,
                        'Accept': 'image/png'
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    qrImage.src = objectUrl;
                    qrImage.style.display = 'block';
                    statusDiv.innerHTML = 'âœ… Scan the QR code with WhatsApp';
                    statusDiv.style.color = '#10b981';
                    
                    // Auto refresh QR every 20 seconds
                    setTimeout(() => {
                        if (document.getElementById('qr-modal').classList.contains('active')) {
                            loadQRCode();
                        }
                    }, 20000);
                } else {
                    statusDiv.innerHTML = 'âŒ Failed to load QR code. Please check WAHA connection.';
                    statusDiv.style.color = '#ef4444';
                    qrImage.style.display = 'none';
                }
            } catch (error) {
                statusDiv.innerHTML = `âŒ Error: ${error.message}`;
                statusDiv.style.color = '#ef4444';
                qrImage.style.display = 'none';
            }
        }

        // Load Dashboard Stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/crm/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update stat cards
                    document.getElementById('total-leads').textContent = data.data.totalLeads || 0;
                    document.getElementById('active-chats').textContent = data.data.activeConversations || 0;
                    document.getElementById('bot-responses').textContent = data.data.botResponsesToday || 0;
                    document.getElementById('conversion-rate').textContent = `${data.data.conversionRate || 0}%`;

                    // Update funnel
                    document.getElementById('funnel-visitors').textContent = data.data.funnel?.visitors || 0;
                    document.getElementById('funnel-leads').textContent = data.data.funnel?.leads || 0;
                    document.getElementById('funnel-qualified').textContent = data.data.funnel?.qualified || 0;
                    document.getElementById('funnel-customers').textContent = data.data.funnel?.customers || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Conversations
        async function loadConversations(params = {}) {
            try {
                const queryParams = new URLSearchParams(params);
                const response = await fetch(`${API_BASE}/crm/conversations?${queryParams}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayConversations(data.data.items || []);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }
        
        // Make loadConversations globally accessible for label filtering
        window.loadConversations = loadConversations;

        // Display Conversations
        function displayConversations(conversationList) {
            const container = document.getElementById('conversation-list');
            
            // Store conversations globally
            conversations = conversationList;
            
            if (conversationList.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #94a3b8;">
                        <p>No active conversations</p>
                        <p style="font-size: 12px; margin-top: 10px;">Connect WhatsApp to see conversations</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = conversationList.map(conv => {
                const lastMsg = conv.messages && conv.messages[0] ? conv.messages[0] : null;
                const preview = lastMsg ? lastMsg.content : (conv.last_message || 'No messages yet');
                const timeAgo = conv.last_message_at ? formatTimeAgo(conv.last_message_at) : '';
                const labels = conv.labels || [];
                
                return `
                    <div class="conversation-item" data-conversation-id="${conv.id}" data-phone-number="${conv.phone_number}">
                        <div class="conversation-avatar">
                            ${getInitials(conv.lead?.name || conv.phone_number)}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">${conv.lead?.name || conv.phone_number}</div>
                            <div class="conversation-preview">${preview.substring(0, 50)}${preview.length > 50 ? '...' : ''}</div>
                            ${labels.length > 0 ? `
                                <div class="conversation-labels">
                                    ${labels.map(label => `
                                        <span class="label-tag mini" style="background: ${label.color}">
                                            <i class="material-icons">${label.icon || 'label'}</i>
                                            ${label.name}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #64748b;">
                            ${timeAgo}
                            ${conv.unread_count > 0 ? `<div style="background: #3b82f6; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; margin-top: 5px; display: inline-block;">${conv.unread_count}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click event listeners to conversation items
            container.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', () => {
                    const conversationId = item.dataset.conversationId;
                    const phoneNumber = item.dataset.phoneNumber;
                    selectConversation(conversationId, phoneNumber);
                });
            });
        }

        // Select Conversation
        async function selectConversation(conversationId, phoneNumber) {
            currentChatId = conversationId;
            currentPhoneNumber = phoneNumber;
            
            // Update UI
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Get conversation details with labels
            const conversationItem = conversations.find(c => c.id === conversationId);
            const labels = conversationItem?.labels || [];

            // Update chat header
            document.getElementById('chat-header-info').innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="conversation-avatar" style="width: 40px; height: 40px;">
                        ${getInitials(phoneNumber)}
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; color: #e2e8f0;">${phoneNumber}</div>
                        <div style="font-size: 13px; color: #94a3b8;">Active conversation</div>
                    </div>
                </div>
            `;

            // Enable input
            document.getElementById('chat-input').disabled = false;
            document.querySelector('.chat-input-container button').disabled = false;

            // Load messages
            await loadMessages(conversationId);
            
            // Dispatch event for label system
            document.dispatchEvent(new CustomEvent('conversation:selected', {
                detail: {
                    conversationId: conversationId,
                    phoneNumber: phoneNumber,
                    labels: labels
                }
            }));
            
            // Request notification permission if not granted
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Load Messages
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`${API_BASE}/crm/conversations/${conversationId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMessages(data.data || []);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display Messages
        function displayMessages(messages) {
            const container = document.getElementById('chat-messages');
            
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.direction}">
                    <div class="message-bubble">
                        <div>${msg.content}</div>
                        <div class="message-time">
                            ${new Date(msg.created_at).toLocaleTimeString('id-ID', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}
                        </div>
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Load Leads
        async function loadLeads() {
            try {
                const response = await fetch(`${API_BASE}/crm/leads`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayLeads(data.data.items || []);
                }
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }

        // Display Leads
        function displayLeads(leads) {
            const tbody = document.getElementById('leads-table');
            if (!tbody) return;
            
            if (leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #94a3b8;">No leads found</td></tr>';
                return;
            }
            
            tbody.innerHTML = leads.map(lead => `
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid rgba(71, 85, 105, 0.2);">${lead.name || '-'}</td>
                    <td style="padding: 12px; border-bottom: 1px solid rgba(71, 85, 105, 0.2);">${lead.phone}</td>
                    <td style="padding: 12px; border-bottom: 1px solid rgba(71, 85, 105, 0.2);">
                        <span style="padding: 4px 8px; background: #3b82f6; color: white; border-radius: 4px; font-size: 12px;">${lead.status}</span>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid rgba(71, 85, 105, 0.2);">${lead.interest_level || '-'}/10</td>
                    <td style="padding: 12px; border-bottom: 1px solid rgba(71, 85, 105, 0.2);">
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">View</button>
                    </td>
                </tr>
            `).join('');
        }

        // Load Bot Settings
        async function loadBotSettings() {
            try {
                const response = await fetch(`${API_BASE}/crm/bot/config`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Update bot settings UI
                    const botEnabled = data.data.bot_enabled === 'true';
                    const botToggle = document.getElementById('bot-enabled');
                    if (botToggle) {
                        botToggle.checked = botEnabled;
                        document.getElementById('bot-status').textContent = botEnabled ? 'Enabled' : 'Disabled';
                    }
                }
            } catch (error) {
                console.error('Error loading bot settings:', error);
            }
        }

        // Toggle Bot
        function toggleBot(event) {
            const enabled = event.target.checked;
            document.getElementById('bot-status').textContent = enabled ? 'Enabled' : 'Disabled';
            // Save bot state
            saveBotConfig({ bot_enabled: enabled.toString() });
        }

        // Save Bot Config
        async function saveBotConfig(config) {
            try {
                await fetch(`${API_BASE}/crm/bot/config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
            } catch (error) {
                console.error('Error saving bot config:', error);
            }
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentChatId) return;

            // Disable input while sending
            input.disabled = true;
            const sendBtn = document.querySelector('.chat-input-container button');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div>';

            try {
                // Send message via backend (which will use WAHA)
                const response = await fetch(`${API_BASE}/crm/conversations/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: message })
                });

                if (response.ok) {
                    // Clear input
                    input.value = '';
                    
                    // Add message to UI immediately for better UX
                    const container = document.getElementById('chat-messages');
                    const messageEl = document.createElement('div');
                    messageEl.className = 'message outbound';
                    messageEl.innerHTML = `
                        <div class="message-bubble">
                            <div>${message}</div>
                            <div class="message-time">
                                ${new Date().toLocaleTimeString('id-ID', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                })}
                                âœ“
                            </div>
                        </div>
                    `;
                    container.appendChild(messageEl);
                    container.scrollTop = container.scrollHeight;
                    
                    // Reload messages to sync with backend
                    setTimeout(() => loadMessages(currentChatId), 1000);
                } else {
                    const error = await response.json();
                    alert('Failed to send message: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                // Re-enable input
                input.disabled = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="material-icons">send</i>';
                input.focus();
            }
        }

        // Toggle Bot
        async function toggleBot(checkbox) {
            const enabled = checkbox.checked;
            document.getElementById('bot-status').textContent = enabled ? 'Enabled' : 'Disabled';
            
            try {
                const response = await fetch(`${API_BASE}/crm/bot/config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });

                if (!response.ok) {
                    alert('Failed to update bot status');
                    checkbox.checked = !enabled;
                }
            } catch (error) {
                alert('Error: ' + error.message);
                checkbox.checked = !enabled;
            }
        }

        // Update LLM Provider
        async function updateLLMProvider(select) {
            const provider = select.value;
            
            try {
                const response = await fetch(`${API_BASE}/crm/bot/config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ provider })
                });

                if (!response.ok) {
                    alert('Failed to update AI provider');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Initialize Charts
        function initializeCharts() {
            // Lead Trends Chart
            const trendsCtx = document.getElementById('leadTrendsChart').getContext('2d');
            new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: generateDateLabels(30),
                    datasets: [{
                        label: 'New Leads',
                        data: generateRandomData(30, 10, 50),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Conversations',
                        data: generateRandomData(30, 5, 30),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            // Source Distribution Chart
            const sourceCtx = document.getElementById('sourceChart').getContext('2d');
            new Chart(sourceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['WhatsApp', 'Website', 'Referral', 'Direct'],
                    datasets: [{
                        data: [45, 25, 20, 10],
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#8b5cf6',
                            '#f59e0b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }

        // Helper Functions
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ').filter(p => p.length > 0);
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        }

        function generateDateLabels(days) {
            const labels = [];
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
            }
            return labels;
        }

        function generateRandomData(count, min, max) {
            return Array(count).fill(0).map(() => Math.floor(Math.random() * (max - min + 1)) + min);
        }

        function updateLastCheckTime() {
            const now = new Date().toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('last-check-time').textContent = now;
        }

        // Action Functions
        function viewAllLeads() {
            window.location.href = '/jamaah-list.html';
        }

        function addNewLead() {
            window.location.href = '/jamaah-form.html';
        }

        function viewConversations() {
            window.location.href = '/whatsapp-dashboard.html';
        }

        function openWhatsApp() {
            window.location.href = '/whatsapp-dashboard.html';
        }

        function viewBotStats() {
            alert('Bot statistics feature coming soon!');
        }

        function configureBotSettings() {
            alert('Bot configuration feature coming soon!');
        }

        function viewFunnel() {
            alert('Detailed funnel analysis coming soon!');
        }

        function viewReports() {
            alert('Reports feature coming soon!');
        }

        function viewStageDetails(stage) {
            alert(`Viewing details for ${stage} stage`);
        }

        function testBot() {
            window.open('/TEST-WAHA-OLLAMA.html', '_blank');
        }

        function viewLogs() {
            alert('Logs viewer coming soon!');
        }

        function openFullChat() {
            window.location.href = '/whatsapp-dashboard.html';
        }

        // Load dashboard data
        async function loadDashboardData() {
            // This would typically fetch from your API
            // For now, using sample data
        }

        // Handle Enter key in chat input
        document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle modal close on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('qr-modal');
            if (event.target === modal) {
                closeQRModal();
            }
        }
    </script>
    
    <!-- Rate Limiting & Message Queue UI -->
    <script src="js/rate-limit-ui.js"></script>
    <script src="js/message-queue-handler.js"></script>
    <script src="js/media-upload-handler.js"></script>
    <script src="js/conversation-labels.js"></script>
</body>
</html>