<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Conversations - Vauza Tamma</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="shortcut icon" href="favicon.svg">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/conversations.css">
    <script src="https://cdn.socket.io/4.6.2/socket.io.min.js"></script>
    <style>
        /* Enhanced Glass Morphism for Conversations */
        body {
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 60% 60%, rgba(251, 146, 60, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
            z-index: -1;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .conversations-container {
            display: grid;
            grid-template-columns: 380px 1fr 320px;
            gap: 24px;
            height: calc(100vh - 100px);
            padding: 24px;
            flex: 1;
        }
        
        /* Contact List Section */
        .contacts-section {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .contacts-header {
            padding: 24px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.5));
            position: relative;
            overflow: hidden;
        }
        
        .contacts-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .contacts-search {
            position: relative;
            margin-bottom: 16px;
        }
        
        .contacts-search input {
            width: 100%;
            padding: 12px 20px 12px 48px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .contacts-search input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .contacts-search .material-icons {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .filter-tab {
            padding: 8px 16px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            color: #94a3b8;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-tab.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(236, 72, 153, 0.2));
            border-color: rgba(139, 92, 246, 0.5);
            color: #e2e8f0;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        
        .filter-tab:hover {
            background: rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
        }
        
        /* Contact List */
        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 8px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .contact-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s;
        }
        
        .contact-item:hover::before {
            left: 100%;
        }
        
        .contact-item:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateX(5px);
        }
        
        .contact-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }
        
        /* Contacts Action Bar */
        .contacts-action-bar {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(15, 23, 42, 0.5);
        }
        
        .load-history-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            color: #3b82f6;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        .load-history-btn:hover {
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .load-history-btn:active {
            transform: translateY(0);
        }
        
        .load-history-btn span.material-icons {
            font-size: 18px;
        }
        
        .refresh-contacts-btn {
            padding: 10px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .refresh-contacts-btn:hover {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.5);
            color: #cbd5e1;
            transform: rotate(180deg);
        }
        
        .refresh-contacts-btn span.material-icons {
            font-size: 18px;
        }
        
        /* Loading state for history button */
        .load-history-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .load-history-btn.loading span.material-icons {
            animation: spin 1s linear infinite;
        }
        
        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            margin-right: 16px;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }
        
        .contact-avatar:nth-child(1) { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .contact-item:nth-child(odd) .contact-avatar { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .contact-item:nth-child(even) .contact-avatar { background: linear-gradient(135deg, #10b981, #059669); }
        .contact-item:nth-child(3n) .contact-avatar { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .contact-item:nth-child(4n) .contact-avatar { background: linear-gradient(135deg, #ec4899, #db2777); }
        .contact-item:nth-child(5n) .contact-avatar { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        
        .contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .contact-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-message {
            font-size: 13px;
            color: #94a3b8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .contact-time {
            font-size: 12px;
            color: #64748b;
        }
        
        .unread-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: badgePulse 2s infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Chat Section */
        .chat-section {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 20px 24px;
            background: rgba(30, 41, 59, 0.6);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .chat-header-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .chat-header-details h3 {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .chat-status {
            font-size: 13px;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2), 0 0 10px rgba(16, 185, 129, 0.4);
        }
        
        .chat-header-actions {
            display: flex;
            gap: 12px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(71, 85, 105, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #e2e8f0;
        }
        
        .icon-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .icon-btn:nth-child(1):hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            color: #a78bfa;
        }
        
        .icon-btn:nth-child(2):hover {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
            color: #34d399;
        }
        
        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
        }
        
        .message {
            display: flex;
            margin-bottom: 16px;
            animation: messageSlide 0.3s ease;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.sent {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.received .message-bubble {
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-bottom-left-radius: 4px;
        }
        
        .message.sent .message-bubble {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2));
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 10px rgba(34, 197, 94, 0.2);
        }
        
        .message-text {
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .message-time {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .message.sent .message-time {
            justify-content: flex-end;
        }
        
        /* Message status icons */
        .message-time .material-icons {
            font-size: 16px !important;
            vertical-align: middle;
        }
        
        /* Status icon colors */
        .message-time .material-icons.pending {
            color: #64748b; /* Gray for pending */
        }
        
        .message-time .material-icons.sent {
            color: #64748b; /* Gray for sent */
        }
        
        .message-time .material-icons.delivered {
            color: #64748b; /* Gray for delivered */
        }
        
        .message-time .material-icons.read {
            color: #3b82f6; /* Blue for read */
        }
        
        .message-time .material-icons.failed {
            color: #ef4444; /* Red for failed */
        }
        
        /* Chat Input */
        .chat-input-section {
            padding: 20px 24px;
            background: rgba(30, 41, 59, 0.6);
            border-top: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 24px;
            color: #e2e8f0;
            font-size: 14px;
            resize: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .emoji-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .emoji-btn:hover {
            color: #e2e8f0;
        }
        
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .send-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .send-btn:active::before {
            width: 100px;
            height: 100px;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        /* Info Section */
        .info-section {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            padding: 24px;
            overflow-y: auto;
        }
        
        .info-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .info-avatar {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 32px;
            margin: 0 auto 16px;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
            position: relative;
        }
        
        .info-avatar::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(135deg, #f59e0b, #ec4899, #8b5cf6, #3b82f6);
            border-radius: 24px;
            z-index: -1;
            opacity: 0.5;
            animation: borderRotate 3s linear infinite;
        }
        
        @keyframes borderRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Override some style.css properties for this page */
        .header {
            margin-bottom: 0;
            position: relative;
            z-index: 100;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        /* Back Button Styling - Beautiful Glass Morphism */
        .btn-back {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            color: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 15px rgba(59, 130, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-back::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .btn-back:hover::before {
            left: 100%;
        }

        .btn-back:hover {
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.25), rgba(139, 92, 246, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(59, 130, 246, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-back .material-icons {
            font-size: 20px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-back:hover .material-icons {
            transform: translateX(-3px);
        }

        .btn-back-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.5px;
        }

        .btn-back:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
            flex: 1;
        }
        
        /* Fix header layout */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            gap: 20px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: nowrap;
        }
        
        /* Adjust button sizes */
        .header-actions .btn {
            padding: 10px 20px;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .header-actions .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .header-actions .btn-text {
            display: inline-block;
        }
        
        
        /* Notification and user profile adjustment */
        .notification-btn {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(71, 85, 105, 0.2);
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .info-name {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .info-phone {
            font-size: 14px;
            color: #94a3b8;
        }
        
        .info-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-card {
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.4);
        }
        
        .info-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            color: #e2e8f0;
        }
        
        .label-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .label-tag {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .label-tag:nth-child(1) {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .label-tag:nth-child(2) {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        .label-tag:nth-child(3) {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2), rgba(245, 158, 11, 0.1));
            border: 1px solid rgba(251, 146, 60, 0.3);
            color: #fbbf24;
        }
        
        .label-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 5px;
            margin: 10px 0;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.5), rgba(59, 130, 246, 0.5));
            border-radius: 5px;
            border: 2px solid rgba(30, 41, 59, 0.4);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.7), rgba(59, 130, 246, 0.7));
        }
        
        /* Additional Visual Effects */
        .messages-area {
            background: 
                linear-gradient(to bottom, transparent, rgba(30, 41, 59, 0.1)),
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.03) 0%, transparent 50%);
        }
        
        /* Gradient text for headers */
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 5s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(30deg); }
        }
        
        /* Floating particles effect */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0.3;
            animation: float 20s infinite;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% {
                transform: translateY(-100vh) translateX(100px) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Ripple effect */
        @keyframes ripple {
            to {
                width: 200px;
                height: 200px;
                opacity: 0;
            }
        }
        
        /* Contact hover glow */
        .contact-item::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                rgba(139, 92, 246, 0.1) 0%, 
                transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .contact-item:hover::after {
            opacity: 1;
        }
        
        /* Fix user profile styling */
        .user-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .user-info .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.2;
        }
        
        .user-info .user-role {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.2;
        }
        
        /* Ensure proper button spacing */
        .btn-icon.btn-secondary {
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .btn-icon.btn-secondary:hover {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.5);
        }
        
        /* Fix logo styling */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            height: 40px;
            padding: 0 16px;
        }
        
        .logo .material-icons {
            font-size: 28px;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        /* AI Title Styling - Glass Morphism Colorful Theme */
        .ai-title {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 10px 24px;
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.08), 
                rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(139, 92, 246, 0.3),
                0 4px 16px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            animation: aiFloat 4s ease-in-out infinite;
        }
        
        @keyframes aiFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        .ai-title::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg at 50% 50%,
                #8b5cf6 0deg,
                #3b82f6 60deg,
                #10b981 120deg,
                #f59e0b 180deg,
                #ec4899 240deg,
                #8b5cf6 360deg
            );
            animation: rainbowSpin 8s linear infinite;
            opacity: 0.3;
            filter: blur(30px);
        }
        
        @keyframes rainbowSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .ai-title::after {
            content: '';
            position: absolute;
            inset: -1px;
            background: linear-gradient(90deg,
                #8b5cf6,
                #3b82f6,
                #10b981,
                #f59e0b,
                #ec4899,
                #8b5cf6
            );
            border-radius: 24px;
            z-index: -1;
            opacity: 0.5;
            background-size: 300% 100%;
            animation: borderFlow 6s linear infinite;
            filter: blur(2px);
        }
        
        @keyframes borderFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }
        
        .ai-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.9), 
                rgba(59, 130, 246, 0.9));
            border-radius: 12px;
            position: relative;
            box-shadow: 
                0 4px 15px rgba(139, 92, 246, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 4px 15px rgba(139, 92, 246, 0.5),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 
                    0 6px 20px rgba(139, 92, 246, 0.7),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
        }
        
        .ai-icon .material-icons {
            font-size: 22px;
            color: white;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
            animation: iconGlow 3s ease-in-out infinite;
        }
        
        @keyframes iconGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.8)); }
        }
        
        .ai-text {
            font-size: 15px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            background: linear-gradient(135deg,
                #8b5cf6,
                #3b82f6,
                #10b981,
                #f59e0b
            );
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            animation: textGradient 5s ease infinite;
        }
        
        @keyframes textGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Extra sparkle effects */
        .ai-title {
            position: relative;
        }
        
        .ai-title::before {
            pointer-events: none;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .ai-title {
                padding: 8px 16px;
                gap: 10px;
            }
            
            .ai-text {
                font-size: 13px;
                letter-spacing: 1px;
            }
            
            .ai-icon {
                width: 32px;
                height: 32px;
            }
            
            .ai-icon .material-icons {
                font-size: 18px;
            }
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .header-actions {
                gap: 12px;
            }
            
            .header-actions .btn-text {
                display: none;
            }
            
            .whatsapp-status {
                min-width: 150px;
            }
            
            .whatsapp-status .status-text {
                font-size: 12px;
            }
            
            .user-profile .user-info {
                display: none;
            }
        }
        
        @media (max-width: 1200px) {
            .conversations-container {
                grid-template-columns: 320px 1fr;
            }
            
            .info-section {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .conversations-container {
                grid-template-columns: 1fr;
                padding: 12px;
                height: calc(100vh - 80px);
            }
            
            .contacts-section {
                display: none;
            }
            
            .header .logo {
                font-size: 20px;
            }
            
            .header .logo .material-icons {
                font-size: 24px !important;
            }

            .btn-back-text {
                display: none;
            }

            .btn-back {
                padding: 10px 16px;
            }
        }

        /* WhatsApp Connection Status Styling */
        .whatsapp-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 10px 6px 12px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            height: 40px;
            min-width: 180px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #64748b;
            box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .status-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0;
            }
        }

        /* Status Colors */
        .whatsapp-status.connected .status-dot,
        .whatsapp-status.WORKING .status-dot {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .whatsapp-status.connecting .status-dot {
            background: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
            animation: blink 1s infinite;
        }

        .whatsapp-status.disconnected .status-dot {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        }

        .whatsapp-status.qr-required .status-dot {
            background: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-text {
            font-size: 13px;
            font-weight: 500;
            color: #e2e8f0;
            white-space: nowrap;
        }

        .status-refresh {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 50%;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .status-refresh .material-icons {
            font-size: 18px;
        }

        .status-refresh:hover {
            background: rgba(71, 85, 105, 0.4);
            color: #e2e8f0;
            transform: rotate(180deg);
        }

        .status-refresh.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* QR Code Modal */
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .qr-modal.show {
            display: flex;
            opacity: 1;
        }

        .qr-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            min-width: 400px;
            max-width: 500px;
            width: 90%;
        }

        .qr-modal.show .qr-content {
            transform: scale(1);
        }

        .qr-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .qr-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .qr-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }

        .qr-code-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 280px;
            position: relative;
            overflow: hidden;
            flex-direction: column;
        }
        
        .qr-code-container img {
            max-width: 280px;
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }

        .qr-code-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: scan-qr 3s linear infinite;
        }

        @keyframes scan-qr {
            from { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            to { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .qr-loading {
            text-align: center;
            color: #64748b;
        }

        .qr-loading .material-icons {
            font-size: 48px;
            margin-bottom: 16px;
            animation: spin 2s linear infinite;
        }

        .qr-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #94a3b8;
        }

        .qr-timer-bar {
            width: 100%;
            height: 4px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .qr-timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
            transition: width 1s linear;
        }

        .qr-actions {
            display: flex;
            gap: 12px;
        }

        .qr-actions button {
            flex: 1;
        }

        /* Connection Info Panel */
        .connection-info {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .connection-info.show {
            transform: translateX(0);
        }

        .info-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 50%;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            transform: rotate(90deg);
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-title .material-icons {
            font-size: 24px;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .info-value.number {
            color: #3b82f6;
            font-family: 'Courier New', monospace;
        }

        .info-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
        }

        .info-actions button {
            flex: 1;
            padding: 10px;
            font-size: 13px;
        }
        
        /* Additional Button Styles */
        .btn-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #10b981;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.25));
            border-color: rgba(16, 185, 129, 0.6);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.25));
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        /* Connection Control Animation */
        @keyframes connectionPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }
        
        .whatsapp-status.connected,
        .whatsapp-status.WORKING {
            animation: connectionPulse 3s infinite;
        }
        
        /* Compliance styles */
        .info-divider {
            height: 1px;
            background: rgba(71, 85, 105, 0.3);
            margin: 16px 0;
        }
        
        .compliance-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #f87171;
            font-size: 14px;
        }
        
        .compliance-warning .material-icons {
            font-size: 20px;
        }
        
        
        .compliance-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .compliance-indicator.warning {
            background: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        
        .compliance-indicator.danger {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Main Header -->
        <div class="header">
            <div class="header-left">
                <button class="btn-back" onclick="window.location.href='crm-main.html'" title="Back to Dashboard">
                    <span class="material-icons">arrow_back</span>
                    <span class="btn-back-text">Dashboard</span>
                </button>
                <div class="ai-title">
                    <span class="ai-icon">
                        <span class="material-icons">psychology</span>
                    </span>
                    <span class="ai-text">AI Based Chat Engine</span>
                </div>
            </div>
            <div class="header-actions">
                <!-- WhatsApp Connection Status -->
                <div class="whatsapp-status" id="whatsappStatus">
                    <div class="status-indicator" id="statusIndicator">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking...</span>
                    </div>
                    <button class="btn-icon status-refresh" onclick="checkConnectionStatus()" title="Refresh Status">
                        <span class="material-icons">refresh</span>
                    </button>
                </div>
                
                <button class="btn btn-primary" id="connectBtn" onclick="connectWhatsApp()">
                    <span class="material-icons">link</span>
                    <span class="btn-text">Connect</span>
                </button>
                
                <button class="btn-icon btn-secondary" onclick="showConnectionInfo()" title="Info">
                    <span class="material-icons">info</span>
                </button>
                
                <div class="notification-btn">
                    <span class="material-icons">notifications</span>
                    <span class="notification-badge">5</span>
                </div>
                
                <div class="user-profile">
                    <div class="user-avatar">
                        <span class="avatar-initials">A</span>
                    </div>
                    <div class="user-info">
                        <div class="user-name">Admin</div>
                        <div class="user-role">WhatsApp Agent</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversations Container -->
        <div class="conversations-container">
            <!-- Contacts List -->
            <div class="contacts-section">
                <div class="contacts-header">
                    <div class="contacts-search">
                        <span class="material-icons">search</span>
                        <input type="text" placeholder="Search contacts..." id="search-contacts">
                    </div>
                    <div class="filter-tabs">
                        <div class="filter-tab active" onclick="filterContacts('all')">All</div>
                        <div class="filter-tab" onclick="filterContacts('unread')">Unread</div>
                        <div class="filter-tab" onclick="filterContacts('groups')">Groups</div>
                    </div>
                </div>
                
                <!-- Action Bar for Load History -->
                <div class="contacts-action-bar" id="contactsActionBar">
                    <button class="load-history-btn" onclick="loadWhatsAppHistory()">
                        <span class="material-icons">history</span>
                        <span>Load Chat History</span>
                    </button>
                    <button class="refresh-contacts-btn" onclick="loadContacts()" title="Refresh contacts">
                        <span class="material-icons">refresh</span>
                    </button>
                </div>
                
                <div class="contacts-list" id="contacts-list">
                    <!-- Contacts will be loaded here after WhatsApp connection -->
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-section">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="chat-header-avatar">AH</div>
                        <div class="chat-header-details">
                            <h3>Select a contact</h3>
                            <div class="chat-status">
                                <span class="status-dot"></span>
                                Online
                            </div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="icon-btn" onclick="searchInChat()">
                            <span class="material-icons">search</span>
                        </button>
                        <button class="icon-btn" onclick="makeCall()">
                            <span class="material-icons">call</span>
                        </button>
                        <button class="icon-btn" onclick="showChatMenu()">
                            <span class="material-icons">more_vert</span>
                        </button>
                    </div>
                </div>

                <div class="messages-area" id="messages-area">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b; text-align: center;">
                        <div>
                            <span class="material-icons" style="font-size: 48px; opacity: 0.3;">chat_bubble_outline</span>
                            <p style="margin-top: 16px; font-size: 16px;">Connect WhatsApp and select a contact to start chatting</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-section">
                    <button class="icon-btn" onclick="attachFile()">
                        <span class="material-icons">attach_file</span>
                    </button>
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                        <button class="emoji-btn" onclick="showEmoji()">
                            <span class="material-icons">mood</span>
                        </button>
                        <div class="compliance-indicator" id="complianceIndicator"></div>
                    </div>
                    <button class="send-btn" onclick="sendMessage()">
                        <span class="material-icons">send</span>
                    </button>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="info-section">
                <div class="info-header">
                    <div class="info-avatar">AH</div>
                    <div class="info-name">No contact selected</div>
                    <div class="info-phone">-</div>
                </div>

                <div class="info-section-title">Contact Info</div>
                <div class="info-card">
                    <div class="info-label">Email</div>
                    <div class="info-value" id="contact-email">Belum teridentifikasi</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Location</div>
                    <div class="info-value" id="contact-location">Belum teridentifikasi</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Paket Umroh</div>
                    <div class="info-value" id="contact-package">Belum teridentifikasi</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Status</div>
                    <div class="info-value" id="contact-status">Belum teridentifikasi</div>
                </div>

                <div class="info-section-title">Labels</div>
                <div class="info-card">
                    <div class="label-tags" id="contact-labels">
                        <span class="label-tag">Belum ada label</span>
                    </div>
                </div>

                <div class="info-section-title">Media & Files</div>
                <div class="info-card">
                    <div class="info-value" id="contact-media">0 Photos, 0 Documents</div>
                </div>

                <div class="info-section-title">Insights</div>
                <div class="info-card">
                    <div class="info-label">Total Messages</div>
                    <div class="info-value" id="total-messages">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">First Contact</div>
                    <div class="info-value" id="first-contact">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Keywords</div>
                    <div class="info-value" id="contact-keywords">Belum teridentifikasi</div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-content">
            <div class="qr-header">
                <h2 class="qr-title">Scan QR Code</h2>
                <p class="qr-subtitle">Scan this code with WhatsApp on your phone</p>
            </div>
            
            <div class="qr-code-container" id="qrCodeContainer">
                <div class="qr-loading">
                    <span class="material-icons">qr_code_scanner</span>
                    <p>Loading QR Code...</p>
                </div>
            </div>
            
            <div class="qr-timer">
                <span class="material-icons" style="font-size: 16px;">schedule</span>
                <span>QR expires in <span id="qrTimer">60</span> seconds</span>
            </div>
            
            <div class="qr-timer-bar">
                <div class="qr-timer-fill" id="qrTimerFill" style="width: 100%"></div>
            </div>
            
            <div class="qr-actions">
                <button class="btn btn-secondary" onclick="refreshQR()">
                    <span class="material-icons">refresh</span>
                    Refresh QR
                </button>
                <button class="btn btn-primary" onclick="closeQRModal()">
                    <span class="material-icons">close</span>
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Connection Info Panel -->
    <div class="connection-info" id="connectionInfo" style="display: none;">
        <button class="info-close" onclick="hideConnectionInfo()">
            <span class="material-icons">close</span>
        </button>
        
        <div class="info-title">
            <span class="material-icons">info</span>
            Connection Details
        </div>
        
        <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value" id="infoStatus">-</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Phone Number</span>
            <span class="info-value number" id="infoPhone">-</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Session ID</span>
            <span class="info-value" id="infoSession">-</span>
        </div>
        
        <div class="info-divider"></div>
        
        <div class="info-title">
            <span class="material-icons">security</span>
            WAHA Compliance Status
        </div>
        
        <div class="info-item">
            <span class="info-label">Daily Limit</span>
            <span class="info-value" id="complianceDaily">0/50 contacts</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Messages Today</span>
            <span class="info-value" id="complianceMessages">0 sent</span>
        </div>
        
        
        <div class="info-item">
            <span class="info-label">Compliance Score</span>
            <span class="info-value" id="complianceScore">
                <span style="color: #10b981;">Good </span>
            </span>
        </div>
        
        <div class="compliance-warning" id="complianceWarning" style="display: none;">
            <span class="material-icons">warning</span>
            <span id="complianceWarningText"></span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Connected Since</span>
            <span class="info-value" id="infoConnectedTime">-</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Messages Today</span>
            <span class="info-value number" id="infoMessages">0</span>
        </div>
        
        <div class="info-actions">
            <button class="btn btn-secondary" onclick="testConnection()">
                <span class="material-icons">speed</span>
                Test
            </button>
            <button class="btn btn-danger" onclick="disconnectWhatsApp()">
                <span class="material-icons">link_off</span>
                Disconnect
            </button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95)); backdrop-filter: blur(20px); border-radius: 20px; padding: 24px; max-width: 400px; width: 90%; border: 1px solid rgba(71, 85, 105, 0.3); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #e2e8f0; font-size: 20px;">Scan QR Code</h3>
                <button class="close-btn" onclick="document.getElementById('qrModal').style.display='none'" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px;">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div id="qrCodeContainer" style="background: white; padding: 20px; border-radius: 12px; text-align: center; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                <div style="color: #64748b;">
                    <span class="material-icons" style="font-size: 48px; opacity: 0.5;">qr_code_scanner</span>
                    <p style="margin-top: 16px;">Loading QR Code...</p>
                </div>
            </div>
            <p style="margin-top: 16px; color: #94a3b8; text-align: center; font-size: 14px;">
                Open WhatsApp on your phone and scan this QR code to connect
            </p>
        </div>
    </div>

    <script>
        // Backend Configuration
        const API_CONFIG = {
            baseUrl: 'http://localhost:3001/api', // Backend API endpoint
            sessionId: 'default',
            healthCheckInterval: 10000 // 10 seconds
        };
        
        // Socket.IO will be initialized in initializeSocket() function

        // Connection state - make it global for debugging
        window.connectionState = {
            status: 'disconnected', // connected, connecting, disconnected, qr-required
            phone: null,
            connectedAt: null,
            sessionInfo: null
        };
        
        // Also keep local reference
        let connectionState = window.connectionState;



        // Check WhatsApp connection status
        async function checkConnectionStatus() {
            const statusEl = document.getElementById('whatsappStatus');
            const refreshBtn = statusEl.querySelector('.status-refresh');
            const statusText = statusEl.querySelector('.status-text');
            const connectBtn = document.getElementById('connectBtn');
            
            // Show loading
            refreshBtn.classList.add('spinning');
            statusText.textContent = 'Checking...';
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                const result = await response.json();
                
                if (result.success) {
                    updateConnectionStatus(result.data.status || 'disconnected', result.data);
                } else {
                    updateConnectionStatus('disconnected');
                }
            } catch (error) {
                console.error('Failed to check status:', error);
                updateConnectionStatus('disconnected');
            } finally {
                refreshBtn.classList.remove('spinning');
            }
        }

        // Update connection status UI
        function updateConnectionStatus(status, data = {}) {
            console.log('updateConnectionStatus called with:', status, data);
            
            const statusEl = document.getElementById('whatsappStatus');
            const statusText = statusEl.querySelector('.status-text');
            const connectBtn = document.getElementById('connectBtn');
            
            connectionState.status = status;
            console.log('connectionState updated to:', connectionState);
            
            statusEl.className = 'whatsapp-status ' + status;
            
            switch (status) {
                case 'connected':
                case 'authenticated':
                case 'WORKING':
                    statusText.textContent = 'Connected';
                    // Change button to disconnect when connected
                    connectBtn.innerHTML = `
                        <span class="material-icons">link_off</span>
                        <span class="btn-text">Disconnect</span>
                    `;
                    connectBtn.classList.remove('btn-success', 'btn-primary');
                    connectBtn.classList.add('btn-danger');
                    connectBtn.setAttribute('onclick', 'disconnectWhatsApp()');
                    connectionState.phone = data.phone || data.phoneNumber;
                    connectionState.connectedAt = data.connectedAt || new Date();
                    // Load contacts when authenticated
                    loadContacts();
                    break;
                    
                case 'connecting':
                    statusText.textContent = 'Connecting...';
                    connectBtn.innerHTML = `
                        <span class="material-icons">sync</span>
                        <span class="btn-text">Connecting...</span>
                    `;
                    break;
                    
                case 'qr-required':
                    statusText.textContent = 'Scan QR Code';
                    connectBtn.innerHTML = `
                        <span class="material-icons">qr_code</span>
                        <span class="btn-text">Scan QR</span>
                    `;
                    break;
                    
                default:
                    statusText.textContent = 'Disconnected';
                    connectBtn.innerHTML = `
                        <span class="material-icons">link</span>
                        <span class="btn-text">Connect WhatsApp</span>
                    `;
                    connectBtn.classList.remove('btn-success', 'btn-danger');
                    connectBtn.classList.add('btn-primary');
                    connectBtn.setAttribute('onclick', 'connectWhatsApp()');
                    connectionState.phone = null;
                    connectionState.connectedAt = null;
            }
            
            updateConnectionInfo();
        }
        
        // Check WAHA session status
        async function checkWAHAStatus() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/status`);
                if (!response.ok) {
                    throw new Error('Failed to get session status');
                }
                
                const result = await response.json();
                console.log('WAHA status:', result.data);
                
                if (result.data.status === 'SCAN_QR_CODE' || result.data.status === 'STARTING') {
                    // Show QR code modal for both SCAN_QR_CODE and STARTING status
                    await showWAHAQRCode();
                } else if (result.data.status === 'WORKING' || result.data.status === 'connected') {
                    // Already connected - pass the status and full data
                    updateConnectionStatus(result.data.status, result.data);
                    if (result.data.phoneNumber || result.data.phone) {
                        connectionState.phoneNumber = result.data.phoneNumber || result.data.phone;
                        updateConnectionInfo();
                    }
                    if (result.data.pushName) {
                        console.log('Connected as:', result.data.pushName);
                    }
                    // Remove alert for smoother UX
                    console.log('WhatsApp is already connected!');
                } else if (result.data.status === 'STOPPED') {
                    // Session is stopped, need to wait for it to start
                    console.log('Session is starting, waiting for QR...');
                    
                    // Poll for QR code after a short delay
                    setTimeout(async () => {
                        await checkForQRCode();
                    }, 2000);
                } else {
                    // Other status
                    console.log('Session status:', result.data.status);
                }
            } catch (error) {
                console.error('Error checking WAHA status:', error);
            }
        }
        
        // Show WAHA QR Code
        async function showWAHAQRCode() {
            try {
                // Get QR code from WAHA
                const qrResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/qr`);
                if (!qrResponse.ok) {
                    const errorData = await qrResponse.json().catch(() => ({}));
                    console.error('QR endpoint error:', {
                        status: qrResponse.status,
                        statusText: qrResponse.statusText,
                        error: errorData
                    });
                    
                    // If 500 error, it might mean session needs time to initialize
                    if (qrResponse.status === 500) {
                        console.log('Session might still be initializing, retrying...');
                        // Retry after 2 seconds
                        setTimeout(() => checkForQRCode(), 2000);
                        return;
                    }
                    
                    throw new Error(`Failed to get QR code: ${qrResponse.status} ${errorData.error || qrResponse.statusText}`);
                }
                
                const qrData = await qrResponse.json();
                console.log('QR Response:', qrData);
                
                if (!qrData.success) {
                    throw new Error(qrData.error || 'Failed to get QR code');
                }
                
                if (!qrData.data || !qrData.data.qr) {
                    console.log('No QR in response, checking status...');
                    // If no QR, check if already connected
                    const statusCheck = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/status`);
                    const statusData = await statusCheck.json();
                    if (statusData.data.status === 'WORKING') {
                        updateConnectionStatus('connected');
                        alert('WhatsApp is already connected!');
                        return;
                    }
                    throw new Error('No QR code available. Please try reconnecting.');
                }
                
                // Show QR modal
                const qrModal = document.getElementById('qrModal');
                const qrContainer = document.getElementById('qrCodeContainer');
                
                // Display QR code as base64 image
                qrContainer.innerHTML = `<img src="${qrData.data.qr}" alt="WhatsApp QR Code" style="max-width: 100%; height: auto;">`;
                qrModal.style.display = 'flex';
                
                // Start polling for status
                const statusInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/status`);
                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            if (statusData.data.status === 'WORKING' || statusData.data.status === 'connected' || statusData.data.status === 'authenticated') {
                                clearInterval(statusInterval);
                                qrModal.style.display = 'none';
                                // Pass the actual status and data
                                updateConnectionStatus(statusData.data.status, statusData.data);
                                showNotification('WhatsApp berhasil terhubung!', 'success');
                            }
                        }
                    } catch (error) {
                        console.error('Error polling status:', error);
                    }
                }, 3000); // Check every 3 seconds
                
                // Clean up interval when modal is closed
                const closeBtn = qrModal.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        clearInterval(statusInterval);
                        qrModal.style.display = 'none';
                    };
                }
                
            } catch (error) {
                console.error('Error showing QR code:', error);
                alert('Failed to get QR code. Please try again.');
            }
        }
        
        // Check for QR code
        async function checkForQRCode() {
            console.log('checkForQRCode called');
            
            // Clear any existing interval first
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
            }
            
            // Check immediately first
            try {
                console.log('Checking QR status immediately...');
                
                // First try direct QR endpoint
                const qrResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/qr`);
                if (qrResponse.ok) {
                    const qrResult = await qrResponse.json();
                    console.log('Direct QR check:', qrResult);
                    if (qrResult.success && qrResult.data.qr) {
                        console.log('QR found via direct endpoint');
                        showQRModal(qrResult.data.qr);
                        // Continue with interval checking
                    }
                }
                
                // Also check status
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                
                if (!response.ok) {
                    console.error('Failed to check QR status:', response.status);
                    return;
                }
                
                const result = await response.json();
                console.log('QR check result:', result);
                
                if (result.success && result.data) {
                    if (result.data.qr) {
                        console.log('QR code received, showing modal');
                        showQRModal(result.data.qr);
                    }
                }
            } catch (error) {
                console.error('Error checking QR immediately:', error);
            }
            
            // Set up interval to check for QR - less frequent to avoid multiple QR generation
            let qrShown = false;
            qrCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                    
                    if (!response.ok) {
                        console.error('Failed to check QR status');
                        return;
                    }
                    
                    const result = await response.json();
                    console.log('QR interval check:', result.data?.status, 'QR:', !!result.data?.qr);
                    
                    if (result.success && result.data) {
                        if (result.data.qr && !qrShown) {
                            // Show QR code only once
                            showQRModal(result.data.qr);
                            qrShown = true;
                        } else if (result.data.status === 'authenticated' || result.data.status === 'connected' || result.data.status === 'WORKING') {
                            // Connected successfully
                            console.log('WhatsApp connected! Status:', result.data.status);
                            closeQRModal();
                            updateConnectionStatus(result.data.status, result.data);
                            clearInterval(qrCheckInterval);
                            qrCheckInterval = null;
                            qrShown = false;
                            
                            // Emit connected event
                            if (socket) {
                                socket.emit('session:connected', {
                                    sessionId: API_CONFIG.sessionId,
                                    status: result.data.status
                                });
                            }
                        } else if (result.data.status === 'disconnected') {
                            // Not connected, but no QR
                            console.log('Session disconnected, no QR available');
                            qrShown = false;
                        }
                    }
                } catch (error) {
                    console.error('Error checking QR:', error);
                }
            }, 3000); // Check every 3 seconds
        }

        // Disconnect WhatsApp
        async function disconnectWhatsApp() {
            if (confirm('Are you sure you want to disconnect WhatsApp?')) {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/stop`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        updateConnectionStatus('disconnected');
                        hideConnectionInfo();
                    } else {
                        throw new Error(result.error || 'Failed to stop session');
                    }
                } catch (error) {
                    console.error('Disconnect error:', error);
                    alert('Failed to disconnect: ' + error.message);
                }
            }
        }

        // Show QR Modal
        function showQRModal(qrCode) {
            const modal = document.getElementById('qrModal');
            const container = document.getElementById('qrCodeContainer');
            
            // Prevent showing multiple modals
            if (modal.classList.contains('show')) {
                console.log('QR modal already showing, skipping');
                return;
            }
            
            console.log('Showing QR modal with code:', qrCode ? 'Present' : 'Missing');
            console.log('QR preview:', qrCode ? qrCode.substring(0, 50) + '...' : 'N/A');
            
            // Clear any existing QR first
            container.innerHTML = '';
            
            // Display QR code - WAHA returns base64 image
            if (qrCode && (qrCode.startsWith('data:') || qrCode.startsWith('http'))) {
                // Add timestamp to prevent caching
                const img = document.createElement('img');
                img.src = qrCode;
                img.alt = 'WhatsApp QR Code';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.onload = () => {
                    console.log('QR image loaded successfully');
                };
                img.onerror = () => {
                    console.error('Failed to load QR image');
                };
                container.appendChild(img);
            } else {
                // Fallback if no image
                container.innerHTML = `
                    <div class="qr-loading">
                        <span class="material-icons">qr_code_scanner</span>
                        <p>QR Code is loading...</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #94a3b8;">
                            Check the backend terminal window if QR doesn't appear here
                        </p>
                    </div>
                `;
            }
            
            modal.classList.add('show');
            startQRTimer();
        }

        // Close QR Modal
        function closeQRModal() {
            const modal = document.getElementById('qrModal');
            modal.classList.remove('show');
            stopQRTimer();
            
            // Clear QR check interval
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
        }

        // Refresh QR Code
        async function refreshQR() {
            const container = document.getElementById('qrCodeContainer');
            container.innerHTML = `
                <div class="qr-loading">
                    <span class="material-icons">qr_code_scanner</span>
                    <p>Loading new QR Code...</p>
                </div>
            `;
            
            // Stop current timer
            stopQRTimer();
            
            try {
                // First disconnect current session
                console.log('Disconnecting current session...');
                await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/stop`, {
                    method: 'POST'
                });
                
                // Wait a bit
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Start new session
                console.log('Starting new session...');
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: API_CONFIG.sessionId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to start new session');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('New session started, checking for QR...');
                    // Start checking for new QR
                    checkForQRCode();
                    // Restart timer
                    startQRTimer();
                } else {
                    throw new Error(result.error || 'Failed to start session');
                }
            } catch (error) {
                console.error('Error refreshing QR:', error);
                container.innerHTML = `
                    <div class="qr-loading">
                        <span class="material-icons">error</span>
                        <p>Failed to refresh QR. Please try connecting again.</p>
                    </div>
                `;
            }
        }

        // QR Timer
        function startQRTimer() {
            // Stop any existing timer first
            stopQRTimer();
            
            // Only start new timer if modal is showing
            const modal = document.getElementById('qrModal');
            if (!modal.classList.contains('show')) {
                return;
            }
            
            qrCountdown = 60;
            updateQRTimer();
            
            qrTimer = setInterval(() => {
                // Check if modal still showing
                if (!modal.classList.contains('show')) {
                    stopQRTimer();
                    return;
                }
                
                qrCountdown--;
                updateQRTimer();
                
                if (qrCountdown <= 0) {
                    stopQRTimer();
                    // Don't auto-refresh, let user manually refresh
                    document.getElementById('qrTimer').textContent = 'Expired';
                    document.getElementById('qrTimerFill').style.width = '0%';
                }
            }, 1000);
        }

        function stopQRTimer() {
            if (qrTimer) {
                clearInterval(qrTimer);
                qrTimer = null;
            }
        }

        function updateQRTimer() {
            document.getElementById('qrTimer').textContent = qrCountdown;
            document.getElementById('qrTimerFill').style.width = (qrCountdown / 60 * 100) + '%';
        }

        // Connection Info Panel
        function showConnectionInfo() {
            const infoPanel = document.getElementById('connectionInfo');
            infoPanel.style.display = 'block';
            infoPanel.classList.add('show');
            updateConnectionInfo();
        }

        function hideConnectionInfo() {
            const infoPanel = document.getElementById('connectionInfo');
            infoPanel.classList.remove('show');
            setTimeout(() => {
                infoPanel.style.display = 'none';
            }, 300);
        }

        function updateConnectionInfo() {
            document.getElementById('infoStatus').textContent = 
                connectionState.status.charAt(0).toUpperCase() + connectionState.status.slice(1);
            
            document.getElementById('infoPhone').textContent = 
                connectionState.phone || '-';
            
            document.getElementById('infoSession').textContent = 
                API_CONFIG.sessionId;
            
            document.getElementById('infoConnectedTime').textContent = 
                connectionState.connectedAt ? 
                new Date(connectionState.connectedAt).toLocaleString() : '-';
            
            // Simulate message count
            document.getElementById('infoMessages').textContent = 
                connectionState.status === 'connected' ? '847' : '0';
        }

        // Test Connection
        async function testConnection() {
            alert('Connection test successful! Response time: 23ms');
        }

        // Start health check
        function startHealthCheck() {
            healthCheckTimer = setInterval(() => {
                if (connectionState.status === 'connected') {
                    checkConnectionStatus();
                }
            }, 30000); // Check every 30 seconds
        }

        // Stop health check
        function stopHealthCheck() {
            if (healthCheckTimer) {
                clearInterval(healthCheckTimer);
                healthCheckTimer = null;
            }
        }

        // Create floating particles
        function createParticles() {
            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899'];
            const container = document.body;
            
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.width = particle.style.height = Math.random() * 10 + 5 + 'px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.borderRadius = '50%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 20) + 's';
                container.appendChild(particle);
            }
        }
        
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notificationHtml = `
                <div class="notification notification-${type}" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(71, 85, 105, 0.4);
                    border-radius: 12px;
                    padding: 16px 24px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    color: #e2e8f0;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    transition: opacity 0.3s;
                ">
                    <span class="material-icons">${type === 'error' ? 'error' : 'info'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = notificationHtml;
            document.body.appendChild(tempDiv.firstElementChild);
            
            setTimeout(() => {
                const notification = document.querySelector('.notification');
                if (notification) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function filterContacts(filter) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter logic here
            console.log('Filtering by:', filter);
        }

        // Removed duplicate sendMessage function - using async version below

        // Auto-resize textarea
        const chatInput = document.getElementById('messageInput');
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            checkMessageCompliance(this.value);
        });

        // Enter to send
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Current conversation state
        let currentConversation = null;
        let currentContact = null;
        let socket = null;
        let qrCheckInterval = null;
        let qrTimer = null;
        let qrCountdown = 60;
        let healthCheckTimer = null;
        
        // Socket.IO connection
        function initializeSocket() {
            const socketUrl = API_CONFIG.baseUrl.replace('/api', '');
            console.log('Connecting to socket:', socketUrl);
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true
            });
            
            socket.on('connect', () => {
                console.log('Connected to backend socket');
                initializeSocketListeners();
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from backend socket');
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
            });
        }
        
        // Load contacts
        async function loadContacts(filter = 'all') {
            console.log('=== loadContacts called ===');
            console.log('Filter:', filter);
            console.log('API_CONFIG:', API_CONFIG);
            
            try {
                // Get conversations instead of just contacts - this includes last message
                let url = `${API_CONFIG.baseUrl}/conversations?status=active&limit=50`;
                if (filter === 'unread') {
                    url += '&hasUnread=true';
                }
                
                console.log('Fetching from URL:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('API Result:', result);
                
                if (result.success) {
                    console.log(`Found ${result.data.length} conversations`);
                    
                    // Transform conversations data to match displayContacts format
                    const contactsData = result.data.map(conv => ({
                        ...conv.contact,
                        conversations: [conv],
                        lastMessage: conv.messages?.[0],
                        isWithin24hWindow: conv.isWithin24hWindow
                    }));
                    
                    console.log('Transformed data:', contactsData);
                    displayContacts(contactsData);
                    
                    // Show total conversations loaded
                    console.log(`Loaded ${result.data.length} conversations (Total: ${result.pagination.total})`);
                    
                    // Add load more button if there are more conversations
                    if (result.pagination.total > 50) {
                        addLoadMoreButton(result.pagination.total);
                    }
                } else {
                    console.error('API returned error:', result.error);
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                console.error('Stack trace:', error.stack);
            }
        }
        
        // Add load more button
        function addLoadMoreButton(totalConversations) {
            const contactsList = document.getElementById('contacts-list');
            const existingButton = document.getElementById('load-more-btn');
            
            if (existingButton) {
                existingButton.remove();
            }
            
            const loadMoreBtn = document.createElement('div');
            loadMoreBtn.id = 'load-more-btn';
            loadMoreBtn.className = 'load-more-button';
            loadMoreBtn.innerHTML = `
                <button onclick="loadMoreConversations()" style="
                    width: 100%;
                    padding: 12px;
                    margin: 10px 0;
                    background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
                    border: 1px solid rgba(59, 130, 246, 0.3);
                    border-radius: 8px;
                    color: #60a5fa;
                    cursor: pointer;
                    font-weight: 500;
                    transition: all 0.3s ease;
                ">
                    Load More Conversations (Showing 50 of ${totalConversations})
                </button>
            `;
            contactsList.appendChild(loadMoreBtn);
        }
        
        // Load more conversations
        let currentOffset = 0;
        async function loadMoreConversations() {
            currentOffset += 50;
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/conversations?status=active&limit=50&offset=${currentOffset}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const contactsData = result.data.map(conv => ({
                        ...conv.contact,
                        conversations: [conv],
                        lastMessage: conv.messages?.[0],
                        isWithin24hWindow: conv.isWithin24hWindow
                    }));
                    
                    // Append to existing contacts
                    appendContacts(contactsData);
                    
                    // Update or remove load more button
                    if (currentOffset + 50 < result.pagination.total) {
                        const btn = document.querySelector('#load-more-btn button');
                        if (btn) {
                            btn.textContent = `Load More Conversations (Showing ${currentOffset + 50} of ${result.pagination.total})`;
                        }
                    } else {
                        document.getElementById('load-more-btn')?.remove();
                    }
                }
            } catch (error) {
                console.error('Error loading more conversations:', error);
                showNotification('Failed to load more conversations', 'error');
            }
        }
        
        // Append contacts to existing list
        function appendContacts(contacts) {
            const contactsList = document.getElementById('contacts-list');
            const loadMoreBtn = document.getElementById('load-more-btn');
            
            contacts.forEach(contact => {
                const conversation = contact.conversations?.[0];
                const lastMessage = conversation?.messages?.[0];
                const unreadCount = conversation?.unreadCount || 0;
                
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.dataset.contactId = contact.id;
                contactItem.dataset.conversationId = conversation?.id || '';
                contactItem.dataset.lastActivity = contact.lastMessageAt || '';
                contactItem.style.animationDelay = `${index * 50}ms`;
                contactItem.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    selectContact(contact, conversation, contactItem);
                };
                
                contactItem.innerHTML = `
                    <div class="contact-avatar">${getInitials(contact.name || contact.phoneNumber)}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name || contact.phoneNumber}</div>
                        <div class="contact-message">${lastMessage?.content || 'No messages yet'}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${formatTime(lastMessage?.createdAt)}</div>
                        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                    </div>
                `;
                
                // Insert before load more button if it exists
                if (loadMoreBtn) {
                    contactsList.insertBefore(contactItem, loadMoreBtn);
                } else {
                    contactsList.appendChild(contactItem);
                }
            });
        }
        
        // Display contacts in UI
        function displayContacts(contacts) {
            console.log('=== displayContacts called ===');
            console.log('Number of contacts:', contacts.length);
            
            const contactsList = document.getElementById('contacts-list');
            if (!contactsList) {
                console.error('ERROR: contacts-list element not found!');
                return;
            }
            
            console.log('Clearing contacts list...');
            contactsList.innerHTML = '';
            
            contacts.forEach((contact, index) => {
                console.log(`Processing contact ${index}:`, contact);
                const conversation = contact.conversations?.[0];
                const lastMessage = conversation?.messages?.[0];
                const unreadCount = conversation?.unreadCount || 0;
                
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.dataset.contactId = contact.id;
                contactItem.dataset.conversationId = conversation?.id || '';
                contactItem.dataset.lastActivity = contact.lastMessageAt || '';
                contactItem.style.animationDelay = `${index * 50}ms`;
                contactItem.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    selectContact(contact, conversation, contactItem);
                };
                
                contactItem.innerHTML = `
                    <div class="contact-avatar">${getInitials(contact.name || contact.phoneNumber)}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name || contact.phoneNumber}</div>
                        <div class="contact-message">${lastMessage?.content || 'No messages yet'}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${formatTime(lastMessage?.createdAt)}</div>
                        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                    </div>
                `;
                
                contactsList.appendChild(contactItem);
            });
        }
        
        // Select contact and load conversation
        async function selectContact(contact, conversation, element = null) {
            console.log('Selecting contact:', contact);
            currentContact = contact;
            
            // Update UI
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked element
            if (element) {
                element.classList.add('active');
            }
            
            // Update chat header
            updateChatHeader(contact);
            
            // Clear current messages
            const messagesArea = document.getElementById('messages-area');
            messagesArea.innerHTML = '<div class="loading-messages">Loading messages...</div>';
            
            // Load or create conversation
            try {
                if (conversation) {
                    currentConversation = conversation;
                    await loadMessages(conversation.id);
                } else {
                    await createConversation(contact.id);
                }
                
                // Join socket room
                if (currentConversation && socket) {
                    socket.emit('join:conversation', currentConversation.id);
                }
            } catch (error) {
                console.error('Error selecting contact:', error);
                messagesArea.innerHTML = '<div class="error-message">Failed to load messages</div>';
            }
        }
        
        // Update chat header
        function updateChatHeader(contact) {
            document.querySelector('.chat-header-avatar').textContent = getInitials(contact.name || contact.phoneNumber);
            document.querySelector('.chat-header-details h3').textContent = contact.name || contact.phoneNumber;
            document.querySelector('.info-name').textContent = contact.name || contact.phoneNumber;
            document.querySelector('.info-phone').textContent = contact.phoneNumber;
            document.querySelector('.info-avatar').textContent = getInitials(contact.name || contact.phoneNumber);
            
            // Update contact info panel
            updateContactInfoPanel(contact);
        }
        
        // Create new conversation
        async function createConversation(contactId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/conversations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contactId,
                        sessionId: API_CONFIG.sessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentConversation = result.data;
                    loadMessages(currentConversation.id);
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
            }
        }
        
        // Load messages
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/messages/${conversationId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayMessages(result.data);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        // Display messages
        function displayMessages(messages) {
            const messagesArea = document.getElementById('messages-area');
            messagesArea.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.direction === 'inbound' ? 'received' : 'sent'}`;
                messageDiv.dataset.messageId = message.whatsappMessageId || message.id;
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-text">${message.content}</div>
                        <div class="message-time">
                            ${formatTime(message.createdAt)}
                            ${message.direction === 'outbound' ? getStatusIcon(message.status) : ''}
                        </div>
                    </div>
                `;
                
                messagesArea.appendChild(messageDiv);
            });
            
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Analyze messages for contact info
            analyzeConversation(messages);
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                return; // Empty message, do nothing
            }
            
            if (!currentContact || !currentConversation) {
                showNotification('Please select a contact first to send a message', 'warning');
                return;
            }
            
            // Check compliance before sending
            if (!checkComplianceBeforeSend()) {
                return;
            }
            
            console.log('Sending message:', { conversationId: currentConversation.id, toNumber: currentContact.phoneNumber });
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/messages/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversationId: currentConversation.id,
                        toNumber: currentContact.phoneNumber,
                        content: message,
                        messageType: 'text'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    input.value = '';
                    input.style.height = 'auto';
                    
                    // Add optimistic UI update
                    const tempId = 'temp-' + Date.now();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message sent';
                    messageDiv.dataset.messageId = tempId;
                    messageDiv.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-text">${message}</div>
                            <div class="message-time">
                                ${formatTime(new Date())}
                                ${getStatusIcon('pending')}
                            </div>
                        </div>
                    `;
                    
                    // Store temp ID mapping for later update
                    if (result.data && result.data.id) {
                        messageDiv.dataset.messageId = result.data.whatsappMessageId || result.data.id;
                    }
                    
                    document.getElementById('messages-area').appendChild(messageDiv);
                    document.getElementById('messages-area').scrollTop = document.getElementById('messages-area').scrollHeight;
                } else {
                    // Check for rate limit error
                    if (response.status === 429) {
                        const retryAfter = result.retryAfter || 60;
                        showNotification(`Rate limit exceeded. Please wait ${retryAfter} seconds before sending more messages.`, 'warning');
                        
                        // Disable input temporarily
                        input.disabled = true;
                        const sendBtn = document.querySelector('.send-btn');
                        if (sendBtn) {
                            sendBtn.disabled = true;
                            setTimeout(() => {
                                input.disabled = false;
                                if (sendBtn) sendBtn.disabled = false;
                                input.focus();
                            }, retryAfter * 1000);
                        }
                    } else {
                        showNotification('Failed to send message: ' + (result.error || 'Unknown error'), 'error');
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    conversationId: currentConversation?.id,
                    toNumber: currentContact?.phoneNumber
                });
                showNotification('Failed to send message: ' + error.message, 'error');
            }
        }
        
        // Format time for display
        function formatTime(date) {
            const d = new Date(date);
            const hours = d.getHours().toString().padStart(2, '0');
            const minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Display new message in chat area
        function displayNewMessage(message) {
            console.log('Displaying new message:', message);
            
            const messagesArea = document.getElementById('messages-area');
            if (!messagesArea) {
                console.error('Messages area not found');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.direction === 'inbound' ? 'received' : 'sent'}`;
            messageDiv.dataset.messageId = message.whatsappMessageId || message.id;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${message.content || ''}</div>
                    <div class="message-time">
                        ${formatTime(new Date(message.createdAt))}
                        ${message.direction === 'outbound' ? getStatusIcon(message.status) : ''}
                    </div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Show notification if message is inbound
            if (message.direction === 'inbound') {
                showNotification(`New message from ${currentContact?.name || 'Unknown'}`, 'info');
            }
        }
        
        // Initialize Socket.IO listeners
        function initializeSocketListeners() {
            // Join default session room
            socket.emit('join:session', API_CONFIG.sessionId);
            
            // Listen for QR code
            socket.on('session:qr', (data) => {
                console.log('QR code received:', data);
                if (data.sessionName === API_CONFIG.sessionId && data.qr) {
                    showQRModal(data.qr);
                }
            });
            
            // Listen for connection success
            socket.on('session:connected', (data) => {
                console.log('WhatsApp connected:', data);
                closeQRModal();
                updateConnectionStatus('connected', data);
                loadContacts();
            });
            
            // Listen for chats loaded event
            socket.on('chats:loaded', (data) => {
                console.log('Chats loaded:', data);
                if (data.message) {
                    // Show a temporary message to user
                    showNotification(data.message, 'info');
                }
                // Reload contacts to show loaded chats
                setTimeout(() => {
                    loadContacts();
                }, 1000);
            });
            
            // Listen for new messages
            socket.on('message:new', (data) => {
                console.log('New message received:', data);
                
                if (currentConversation && data.conversationId === currentConversation.id) {
                    displayNewMessage(data.message);
                }
                
                // Update contact position with animation
                updateContactPosition(data.conversationId);
            });
            
            // Listen for conversation updates
            socket.on('conversation:updated', (data) => {
                console.log('Conversation updated:', data);
                // Update contact position with animation
                updateContactPosition(data.conversationId || data.id);
            });
            
            // Listen for status updates
            socket.on('message:status', (update) => {
                updateMessageStatus(update.messageId, update.status);
            });
            
            // Listen for session status
            socket.on('session:status', (update) => {
                if (update.sessionId === API_CONFIG.sessionId) {
                    updateConnectionStatus(update.status);
                }
            });
            
            // Listen for conversation updates
            socket.on('conversation:update', (update) => {
                if (currentConversation && update.conversationId === currentConversation.id) {
                    // Update UI accordingly
                }
                
                // Update contact position with animation
                updateContactPosition(update.conversationId);
            });
        }
        
        // Display new message
        function displayNewMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.direction === 'inbound' ? 'received' : 'sent'}`;
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${message.content}</div>
                    <div class="message-time">
                        ${formatTime(message.createdAt)}
                        ${message.direction === 'outbound' ? getStatusIcon(message.status) : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('messages-area').appendChild(messageDiv);
            document.getElementById('messages-area').scrollTop = document.getElementById('messages-area').scrollHeight;
        }
        
        // Update message status
        function updateMessageStatus(messageId, status) {
            console.log('Updating message status:', { messageId, status });
            
            // Find message element by ID
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) {
                console.log('Message element not found for ID:', messageId);
                return;
            }
            
            // Only update status for sent messages
            if (!messageElement.classList.contains('sent')) {
                return;
            }
            
            // Find the time element and update status icon
            const timeElement = messageElement.querySelector('.message-time');
            if (timeElement) {
                // Remove existing status icon
                const existingIcon = timeElement.querySelector('.material-icons');
                if (existingIcon) {
                    existingIcon.remove();
                }
                
                // Add new status icon
                timeElement.innerHTML = timeElement.textContent.trim() + ' ' + getStatusIcon(status);
            }
        }
        
        // Helper functions
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return parts[0][0] + parts[1][0];
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
            if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            return date.toLocaleDateString();
        }
        
        // Update contact position with smooth animation
        function updateContactPosition(conversationId) {
            const contactsList = document.getElementById('contacts-list');
            if (!contactsList) return;
            
            // Find the contact item by conversation ID
            const contactItem = contactsList.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (!contactItem) {
                // If not found, reload contacts
                loadContacts();
                return;
            }
            
            // Update last activity time
            const now = new Date().toISOString();
            contactItem.dataset.lastActivity = now;
            
            // Get all contact items
            const allContacts = Array.from(contactsList.querySelectorAll('.contact-item'));
            const currentIndex = allContacts.indexOf(contactItem);
            
            // If already at top, just highlight
            if (currentIndex === 0) {
                contactItem.classList.add('highlight');
                setTimeout(() => contactItem.classList.remove('highlight'), 1000);
                
                // Update time
                const timeElement = contactItem.querySelector('.contact-time');
                if (timeElement) timeElement.textContent = 'Just now';
                return;
            }
            
            // Calculate position to move to top
            const itemHeight = contactItem.offsetHeight + 8; // Include margin
            const moveDistance = currentIndex * itemHeight;
            
            // Apply smooth transition
            contactItem.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            contactItem.style.transform = `translateY(-${moveDistance}px)`;
            
            // Move other items down
            for (let i = 0; i < currentIndex; i++) {
                allContacts[i].style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                allContacts[i].style.transform = `translateY(${itemHeight}px)`;
            }
            
            // After animation, reorder DOM
            setTimeout(() => {
                // Reset transforms
                contactItem.style.transform = '';
                allContacts.forEach(item => item.style.transform = '');
                
                // Move to top
                contactsList.insertBefore(contactItem, contactsList.firstChild);
                
                // Add highlight effect
                contactItem.classList.add('highlight');
                setTimeout(() => contactItem.classList.remove('highlight'), 1000);
                
                // Update time
                const timeElement = contactItem.querySelector('.contact-time');
                if (timeElement) timeElement.textContent = 'Just now';
            }, 500);
        }
        
        function getStatusIcon(status) {
            const icons = {
                'pending': '<span class="material-icons" style="font-size: 16px; color: #64748b;">schedule</span>',
                'sent': '<span class="material-icons" style="font-size: 16px; color: #64748b;">done</span>',
                'delivered': '<span class="material-icons" style="font-size: 16px; color: #64748b;">done_all</span>',
                'read': '<span class="material-icons" style="font-size: 16px; color: #3b82f6;">done_all</span>',
                'failed': '<span class="material-icons" style="font-size: 16px; color: #ef4444;">error</span>'
            };
            
            return icons[status] || '';
        }
        
        // Update contact info panel
        function updateContactInfoPanel(contact) {
            // Reset all fields to default
            document.getElementById('contact-email').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-location').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-package').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-status').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-keywords').textContent = 'Belum teridentifikasi';
            document.getElementById('total-messages').textContent = '0';
            document.getElementById('first-contact').textContent = '-';
            document.getElementById('contact-media').textContent = '0 Photos, 0 Documents';
            
            // Update labels
            const labelsContainer = document.getElementById('contact-labels');
            labelsContainer.innerHTML = '<span class="label-tag">Belum ada label</span>';
        }
        
        // Analyze conversation to extract contact info
        function analyzeConversation(messages) {
            if (!messages || messages.length === 0) return;
            
            // Extract information from messages
            const analysis = {
                email: null,
                location: null,
                package: null,
                status: null,
                keywords: new Set(),
                mediaCount: { photos: 0, documents: 0 },
                firstContact: null,
                totalMessages: messages.length
            };
            
            // Email pattern
            const emailPattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            
            // Location patterns
            const locationPatterns = [
                /\b(jakarta|bandung|surabaya|medan|semarang|makassar|palembang|tangerang|depok|bekasi)\b/gi,
                /\b(jawa\s*(barat|timur|tengah)|sumatra|kalimantan|sulawesi|bali)\b/gi
            ];
            
            // Package patterns
            const packagePatterns = [
                /\b(paket\s*(regular|vip|eksekutif|ekonomi|premium))\b/gi,
                /\b(ramadhan|syawal|dzulhijjah|muharram)\s*\d{4}/gi,
                /\b(9\s*hari|12\s*hari|15\s*hari|21\s*hari|plus\s*turki)\b/gi
            ];
            
            // Status patterns
            const statusPatterns = {
                'Prospek': /\b(tanya|info|berapa|harga|jadwal|kapan)\b/gi,
                'Hot Prospect': /\b(serius|minat|tertarik|booking|daftar)\b/gi,
                'Jamaah': /\b(sudah\s*transfer|dp|lunas|bayar)\b/gi,
                'Repeat': /\b(lagi|kembali|umroh\s*ke-?\d+)\b/gi
            };
            
            // Analyze each message
            messages.forEach((message, index) => {
                const content = message.content || '';
                
                // Extract email
                const emailMatches = content.match(emailPattern);
                if (emailMatches && !analysis.email) {
                    analysis.email = emailMatches[0];
                }
                
                // Extract location
                locationPatterns.forEach(pattern => {
                    const matches = content.match(pattern);
                    if (matches && !analysis.location) {
                        analysis.location = matches[0];
                    }
                });
                
                // Extract package
                packagePatterns.forEach(pattern => {
                    const matches = content.match(pattern);
                    if (matches && !analysis.package) {
                        analysis.package = matches[0];
                    }
                });
                
                // Determine status
                for (const [status, pattern] of Object.entries(statusPatterns)) {
                    if (pattern.test(content) && !analysis.status) {
                        analysis.status = status;
                    }
                }
                
                // Extract keywords (nouns and important words)
                const keywordPatterns = /\b(umroh|haji|visa|paspor|hotel|pesawat|makkah|madinah|ziarah|manasik)\b/gi;
                const keywordMatches = content.match(keywordPatterns);
                if (keywordMatches) {
                    keywordMatches.forEach(kw => analysis.keywords.add(kw.toLowerCase()));
                }
                
                // Count media
                if (message.messageType === 'image') analysis.mediaCount.photos++;
                if (message.messageType === 'document') analysis.mediaCount.documents++;
                
                // First contact
                if (index === messages.length - 1) {
                    analysis.firstContact = message.createdAt;
                }
            });
            
            // Update UI with analysis results
            if (analysis.email) document.getElementById('contact-email').textContent = analysis.email;
            if (analysis.location) document.getElementById('contact-location').textContent = analysis.location;
            if (analysis.package) document.getElementById('contact-package').textContent = analysis.package;
            if (analysis.status) document.getElementById('contact-status').textContent = analysis.status;
            
            document.getElementById('total-messages').textContent = analysis.totalMessages;
            document.getElementById('first-contact').textContent = analysis.firstContact ? formatDate(analysis.firstContact) : '-';
            document.getElementById('contact-media').textContent = `${analysis.mediaCount.photos} Photos, ${analysis.mediaCount.documents} Documents`;
            
            if (analysis.keywords.size > 0) {
                document.getElementById('contact-keywords').textContent = Array.from(analysis.keywords).join(', ');
            }
            
            // Update labels based on analysis
            updateContactLabels(analysis);
        }
        
        // Update contact labels based on analysis
        function updateContactLabels(analysis) {
            const labelsContainer = document.getElementById('contact-labels');
            labelsContainer.innerHTML = '';
            
            const labels = [];
            
            // Add status label
            if (analysis.status) {
                labels.push(analysis.status);
            }
            
            // Add package label
            if (analysis.package) {
                if (analysis.package.toLowerCase().includes('ramadhan')) {
                    labels.push('Ramadhan 2025');
                } else if (analysis.package.toLowerCase().includes('vip')) {
                    labels.push('VIP');
                }
            }
            
            // Add engagement label
            if (analysis.totalMessages > 20) {
                labels.push('Aktif');
            }
            
            // Add location label
            if (analysis.location) {
                labels.push(analysis.location);
            }
            
            // Display labels or default
            if (labels.length > 0) {
                labels.forEach(label => {
                    const span = document.createElement('span');
                    span.className = 'label-tag';
                    span.textContent = label;
                    labelsContainer.appendChild(span);
                });
            } else {
                labelsContainer.innerHTML = '<span class="label-tag">Belum ada label</span>';
            }
        }
        
        // Format date helper
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }
        
        // Load WhatsApp History
        async function loadWhatsAppHistory() {
            const btn = event.target.closest('.load-history-btn');
            if (!btn) return;
            
            console.log('Load history - Connection state:', connectionState);
            
            // Check if WhatsApp is connected
            if (connectionState.status !== 'connected' && connectionState.status !== 'WORKING' && connectionState.status !== 'authenticated') {
                console.error('WhatsApp not connected. Current status:', connectionState.status);
                showNotification('WhatsApp belum terhubung. Silakan hubungkan terlebih dahulu.', 'error');
                return;
            }
            
            // Show loading state
            btn.classList.add('loading');
            btn.disabled = true;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `
                <span class="material-icons">sync</span>
                <span>Loading...</span>
            `;
            
            try {
                console.log('Loading WhatsApp history...');
                
                // Call backend to load chats - note the correct endpoint
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/load-history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        limit: 50 // Load last 50 chats
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Memuat riwayat chat dari WhatsApp...', 'success');
                    
                    // Wait a moment for backend to process, then reload contacts
                    setTimeout(() => {
                        loadContacts();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to load chats');
                }
            } catch (error) {
                console.error('Error loading WhatsApp history:', error);
                showNotification('Gagal memuat riwayat chat: ' + error.message, 'error');
            } finally {
                // Restore button state
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // Search in chat
        function searchInChat() {
            // Implement search functionality
            showNotification('Fitur pencarian dalam chat akan segera tersedia', 'info');
        }
        
        // Make call
        function makeCall() {
            if (!currentContact) {
                showNotification('Silakan pilih kontak terlebih dahulu', 'error');
                return;
            }
            
            showNotification('Fitur panggilan belum tersedia', 'info');
        }
        
        // Show chat menu
        function showChatMenu() {
            // Implement chat menu
            showNotification('Menu chat akan segera tersedia', 'info');
        }
        
        // Sound alert for disconnection (optional)
        function playDisconnectSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF');
            audio.volume = 0.5;
            audio.play().catch(() => {});
        }
        
        // Compliance monitoring
        function startComplianceMonitoring() {
            // Placeholder for compliance monitoring
            console.log('Compliance monitoring started');
        }
        
        // Check message compliance
        function checkMessageCompliance(message) {
            // Basic compliance check
            if (message.length > 1000) {
                showNotification('Pesan terlalu panjang. Maksimal 1000 karakter.', 'warning');
                return false;
            }
            return true;
        }
        
        // Check compliance before sending
        function checkComplianceBeforeSend() {
            // Basic compliance check before sending
            return true;
        }
        
        // Connect WhatsApp
        async function connectWhatsApp() {
            const connectBtn = document.getElementById('connectBtn');
            const originalContent = connectBtn.innerHTML;
            
            try {
                // Show loading state
                connectBtn.innerHTML = '<span class="material-icons">sync</span><span class="btn-text">Connecting...</span>';
                connectBtn.disabled = true;
                
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/start`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.qr) {
                        // Show QR code
                        showQRModal(result.qr);
                    } else if (result.status === 'connected' || result.status === 'WORKING') {
                        // Already connected
                        updateConnectionStatus('connected', result);
                        showNotification('WhatsApp sudah terhubung', 'success');
                    }
                } else {
                    showNotification('Gagal menghubungkan WhatsApp: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error connecting WhatsApp:', error);
                showNotification('Error menghubungkan WhatsApp', 'error');
            } finally {
                connectBtn.innerHTML = originalContent;
                connectBtn.disabled = false;
            }
        }
        
        // Disconnect WhatsApp
        async function disconnectWhatsApp() {
            if (!confirm('Apakah Anda yakin ingin disconnect dari WhatsApp? Anda perlu scan QR code lagi untuk reconnect.')) {
                return;
            }
            
            const connectBtn = document.getElementById('connectBtn');
            const originalContent = connectBtn.innerHTML;
            
            try {
                // Show loading state
                connectBtn.innerHTML = '<span class="material-icons">sync</span><span class="btn-text">Disconnecting...</span>';
                connectBtn.disabled = true;
                
                // Call stop endpoint with logout=true to properly disconnect
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ logout: true })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateConnectionStatus('disconnected');
                    showNotification('WhatsApp berhasil disconnected', 'success');
                    
                    // Clear contacts and messages
                    document.getElementById('contacts-list').innerHTML = '';
                    const messagesArea = document.getElementById('messages-area');
                    if (messagesArea) {
                        messagesArea.innerHTML = '';
                    }
                    
                    // Reset current conversation
                    currentConversation = null;
                    currentContact = null;
                } else {
                    showNotification('Gagal disconnect: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error disconnecting WhatsApp:', error);
                showNotification('Error saat disconnect', 'error');
            } finally {
                connectBtn.innerHTML = originalContent;
                connectBtn.disabled = false;
                
                // Check status again
                setTimeout(checkConnectionStatus, 1000);
            }
        }
        
        // Load WhatsApp chat history
        async function loadWhatsAppHistory() {
            const statusEl = document.getElementById('whatsappStatus');
            const statusText = statusEl.querySelector('.status-text');
            const historyBtn = document.querySelector('.load-history-btn');
            
            // Check if connected
            if (connectionState.status !== 'connected') {
                showNotification('Please connect WhatsApp first', 'warning');
                return;
            }
            
            // Show loading state
            historyBtn.classList.add('loading');
            historyBtn.innerHTML = '<span class="material-icons">hourglass_empty</span><span>Loading...</span>';
            statusText.textContent = 'Loading chats...';
            showNotification('Loading chat history from WhatsApp...', 'info');
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/load-history`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Chat history is being loaded. This may take a few moments...', 'success');
                    statusText.textContent = 'Connected';
                } else {
                    showNotification('Failed to load chat history: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                showNotification('Error loading chat history', 'error');
            } finally {
                historyBtn.classList.remove('loading');
                historyBtn.innerHTML = '<span class="material-icons">history</span><span>Load Chat History</span>';
                checkConnectionStatus();
            }
        }
        
        // Show notification helper
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-family: Inter, sans-serif;
                font-size: 14px;
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Monitor connection changes
        let lastStatus = connectionState.status;
        setInterval(() => {
            if (lastStatus === 'connected' && connectionState.status === 'disconnected') {
                playDisconnectSound();
            }
            lastStatus = connectionState.status;
        }, 1000);

        // Update filter contacts function
        function filterContacts(filter) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load contacts with filter
            loadContacts(filter);
        }
        
        // Sync contacts from WhatsApp
        async function syncContacts() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/contacts/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: API_CONFIG.sessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Synced ${result.total} contacts`);
                    loadContacts();
                } else {
                    alert('Failed to sync contacts: ' + result.error);
                }
            } catch (error) {
                console.error('Error syncing contacts:', error);
                alert('Failed to sync contacts');
            }
        }
        
        // Search contacts
        document.getElementById('search-contacts').addEventListener('input', function(e) {
            const search = e.target.value;
            if (search.length > 2 || search.length === 0) {
                loadContacts('all');
            }
        });
        
        // Placeholder functions for future implementation
        function searchInChat() { 
            alert('Search in chat feature coming soon!');
        }
        
        function makeCall() { 
            alert('Voice/Video call feature coming soon!');
        }
        
        function showChatMenu() { 
            alert('Chat menu coming soon!');
        }
        
        function attachFile() { 
            alert('File attachment feature coming soon!');
        }
        
        function showEmoji() { 
            alert('Emoji picker coming soon!');
        }
        
        // =================== WAHA Compliance Functions ===================
        
        let complianceData = {
            dailyContacts: 0,
            dailyMessages: 0,
            lastMessageTime: null,
            sessionStartTime: null,
            warnings: []
        };
        
        // Start compliance monitoring
        async function startComplianceMonitoring() {
            updateComplianceStatus();
            
            // Update every minute
            setInterval(() => {
                updateComplianceStatus();
            }, 60000);
        }
        
        // Update compliance status
        async function updateComplianceStatus() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/compliance/status`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const report = result.data;
                    
                    // Update UI
                    const uniqueContacts = typeof report.metrics === 'object' ? 
                        (report.metrics.uniqueContacts || 0) : 0;
                    document.getElementById('complianceDaily').textContent = 
                        `${uniqueContacts}/50 contacts`;
                    document.getElementById('complianceMessages').textContent = 
                        `${report.metrics.messagesSent || 0} sent`;
                    
                    // Update compliance score
                    const score = calculateComplianceScore(report);
                    updateComplianceIndicator(score);
                    
                    // Show warnings if any
                    if (report.recommendations && report.recommendations.length > 0) {
                        showComplianceWarning(report.recommendations[0]);
                    }
                }
            } catch (error) {
                console.error('Error updating compliance status:', error);
            }
        }
        
        // Calculate compliance score
        function calculateComplianceScore(report) {
            const metrics = report.metrics || {};
            const contacts = metrics.uniqueContacts || 0;
            const failed = metrics.failedCount || 0;
            
            if (contacts >= 45) return 'danger'; // Near limit
            if (contacts >= 35) return 'warning'; // Getting close
            if (failed > 5) return 'warning'; // High failure rate
            
            return 'good';
        }
        
        // Update compliance indicator
        function updateComplianceIndicator(score) {
            const indicator = document.getElementById('complianceIndicator');
            const scoreEl = document.getElementById('complianceScore');
            
            indicator.className = 'compliance-indicator';
            
            switch (score) {
                case 'danger':
                    indicator.classList.add('danger');
                    scoreEl.innerHTML = '<span style="color: #ef4444;">Critical </span>';
                    break;
                case 'warning':
                    indicator.classList.add('warning');
                    scoreEl.innerHTML = '<span style="color: #f59e0b;">Warning !</span>';
                    break;
                default:
                    scoreEl.innerHTML = '<span style="color: #10b981;">Good </span>';
            }
        }
        
        
        // Check message compliance
        function checkMessageCompliance(message) {
            const prohibitedWords = [
                'gratis', 'menang', 'hadiah', 'promo gila',
                'click here', 'klik disini', 'urgent',
                'bitcoin', 'crypto', 'forex', 'trading',
                'judi', 'togel', 'slot', 'casino'
            ];
            
            const messageLower = message.toLowerCase();
            
            for (const word of prohibitedWords) {
                if (messageLower.includes(word)) {
                    return false;
                }
            }
            
            // Check message length
            if (message.length > 1000) {
                return false;
            }
            
            return true;
        }
        
        // Check compliance before sending
        function checkComplianceBeforeSend() {
            const message = document.getElementById('messageInput').value;
            
            // Check message compliance
            if (!checkMessageCompliance(message)) {
                alert('Message contains prohibited content. Please review and modify.');
                return false;
            }
            
            // Check rate limiting
            if (complianceData.lastMessageTime) {
                const timeSinceLastMessage = Date.now() - complianceData.lastMessageTime;
                if (timeSinceLastMessage < 5000) { // 5 seconds
                    const waitTime = Math.ceil((5000 - timeSinceLastMessage) / 1000);
                    alert(`Please wait ${waitTime} seconds before sending another message`);
                    return false;
                }
            }
            
            // Check daily limits
            if (complianceData.dailyContacts >= 50) {
                alert('Daily contact limit reached (50 contacts). Please try again tomorrow.');
                return false;
            }
            
            // Update metrics
            complianceData.lastMessageTime = Date.now();
            complianceData.dailyMessages++;
            
            return true;
        }
        
        // Show compliance warning
        function showComplianceWarning(message) {
            const warningEl = document.getElementById('complianceWarning');
            const warningText = document.getElementById('complianceWarningText');
            
            if (message) {
                warningEl.style.display = 'flex';
                warningText.textContent = message;
            } else {
                warningEl.style.display = 'none';
            }
        }
        
        // Format time with compliance info
        function formatTimeWithCompliance(timestamp) {
            const time = formatTime(timestamp);
            const now = new Date();
            const messageTime = new Date(timestamp);
            const hoursSince = (now - messageTime) / (1000 * 60 * 60);
            
            // Add indicator if outside 24-hour window
            if (hoursSince > 24) {
                return `${time} (template required)`;
            }
            
            return time;
        }
        
        // Connect WhatsApp function
        async function connectWhatsApp() {
            // Check if already connected
            if (connectionState.status === 'connected' || connectionState.status === 'WORKING') {
                console.log('Already connected to WhatsApp');
                showNotification('WhatsApp is already connected', 'info');
                return;
            }
            
            console.log('Connecting to WhatsApp...');
            updateConnectionStatus('connecting');
            
            try {
                // Start session
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: API_CONFIG.sessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Session started, checking for QR...');
                    // Reset checking flag
                    isCheckingQR = false;
                    // Start checking for QR code
                    checkForQRCode();
                } else {
                    throw new Error(result.error || 'Failed to start session');
                }
            } catch (error) {
                console.error('Error connecting WhatsApp:', error);
                showNotification('Failed to connect WhatsApp: ' + error.message, 'error');
                updateConnectionStatus('disconnected');
            }
        }
        
        // Flag to prevent duplicate QR checks
        let isCheckingQR = false;
        
        // Check for QR Code
        async function checkForQRCode() {
            // Prevent duplicate calls
            if (isCheckingQR) {
                console.log('Already checking for QR, skipping duplicate call');
                return;
            }
            
            isCheckingQR = true;
            
            try {
                // First, check current status
                const statusResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                const statusResult = await statusResponse.json();
                
                console.log('Session status:', statusResult);
                
                if (statusResult.success && statusResult.data) {
                    const status = statusResult.data.status;
                    
                    if (status === 'SCAN_QR_CODE') {
                        // Get QR code only if modal not already showing
                        const modal = document.getElementById('qrModal');
                        if (!modal.classList.contains('show')) {
                            const qrResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/qr`);
                            const qrResult = await qrResponse.json();
                            
                            if (qrResult.success && qrResult.data.qr) {
                                showQRModal(qrResult.data.qr);
                                // Continue checking status
                                startQRCheckInterval();
                                isCheckingQR = false;
                                return;
                            } else {
                                console.log('No QR code available yet, retrying...');
                                setTimeout(() => {
                                    isCheckingQR = false;
                                    checkForQRCode();
                                }, 2000);
                                return;
                            }
                        } else {
                            console.log('QR modal already showing, starting interval check');
                            startQRCheckInterval();
                            isCheckingQR = false;
                            return;
                        }
                    } else if (status === 'authenticated' || status === 'connected' || status === 'WORKING') {
                        console.log('Already connected!');
                        closeQRModal();
                        updateConnectionStatus('connected', statusResult.data);
                        loadContacts();
                        isCheckingQR = false;
                        return;
                    } else {
                        console.log('Status:', status, '- waiting...');
                        setTimeout(() => {
                            isCheckingQR = false;
                            checkForQRCode();
                        }, 2000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error checking for QR:', error);
                setTimeout(() => {
                    isCheckingQR = false;
                    checkForQRCode();
                }, 5000);
            }
        }
        
        // Start QR check interval
        function startQRCheckInterval() {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
            }
            
            qrCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        console.log('QR check - Status:', result.data.status);
                        
                        if (result.data.status === 'authenticated' || result.data.status === 'connected' || result.data.status === 'WORKING') {
                            console.log('WhatsApp connected!');
                            clearInterval(qrCheckInterval);
                            closeQRModal();
                            updateConnectionStatus('connected', result.data);
                            loadContacts();
                        } else if (result.data.status !== 'SCAN_QR_CODE') {
                            // Session failed or stopped
                            clearInterval(qrCheckInterval);
                            closeQRModal();
                            updateConnectionStatus('disconnected');
                        }
                    }
                } catch (error) {
                    console.error('Error checking QR status:', error);
                }
            }, 2000);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing WhatsApp CRM...');
            
            // Create particles
            createParticles();
            
            // Initialize socket connection
            initializeSocket();
            
            // Check initial connection status
            checkConnectionStatus();
            
            // Load contacts
            loadContacts();
            
            // Start compliance monitoring
            startComplianceMonitoring();
            
            // Start health check
            startHealthCheck();
        });
    </script>
</body>
</html>