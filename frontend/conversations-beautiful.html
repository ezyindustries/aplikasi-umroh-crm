<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Conversations - Vauza Tamma</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="shortcut icon" href="favicon.svg">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/conversations.css">
    <script src="https://cdn.socket.io/4.6.2/socket.io.min.js"></script>
    <script src="js/waha-plus-integration.js"></script>
    <style>
        /* Enhanced Glass Morphism for Conversations */
        body {
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 60% 60%, rgba(251, 146, 60, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 30% 30%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
            z-index: -1;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .conversations-container {
            display: grid;
            grid-template-columns: 380px 1fr 320px;
            gap: 24px;
            height: calc(100vh - 100px);
            padding: 24px;
            flex: 1;
        }
        
        /* Contact List Section */
        .contacts-section {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .contacts-header {
            padding: 24px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.5));
            position: relative;
            overflow: hidden;
        }
        
        .contacts-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .contacts-search {
            position: relative;
            margin-bottom: 16px;
        }
        
        .contacts-search input {
            width: 100%;
            padding: 12px 20px 12px 48px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .contacts-search input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .contacts-search .material-icons {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .filter-tab {
            padding: 8px 16px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            color: #94a3b8;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Make entire tab clickable including child elements */
        .filter-tab * {
            pointer-events: none;
        }
        
        .filter-tab.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(236, 72, 153, 0.2));
            border-color: rgba(139, 92, 246, 0.5);
            color: #e2e8f0;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        
        .filter-tab:hover {
            background: rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
        }
        
        .filter-count {
            font-size: 11px;
            font-weight: 600;
            opacity: 0.8;
            margin-left: 4px;
        }
        
        .filter-tab.active .filter-count {
            opacity: 1;
            color: #c4b5fd;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            padding: 40px;
        }
        
        .empty-state-content {
            text-align: center;
            max-width: 300px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            color: #64748b;
            margin-bottom: 16px;
            opacity: 0.6;
        }
        
        .empty-state-title {
            color: #e2e8f0;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .empty-state-message {
            color: #94a3b8;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        .clear-search-btn-empty {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clear-search-btn-empty:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Contact List */
        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            position: relative;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 8px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .contact-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s;
        }
        
        .contact-item:hover::before {
            left: 100%;
        }
        
        .contact-item:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateX(5px);
        }
        
        .contact-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }
        
        /* Highlight animation for updated contacts */
        .contact-item.highlight {
            animation: contactHighlight 1s ease-out;
        }
        
        @keyframes contactHighlight {
            0% {
                background: rgba(59, 130, 246, 0.3);
                border-color: rgba(59, 130, 246, 0.6);
                transform: scale(1.02);
            }
            50% {
                background: rgba(59, 130, 246, 0.2);
                border-color: rgba(59, 130, 246, 0.4);
                transform: scale(1.01);
            }
            100% {
                background: rgba(71, 85, 105, 0.2);
                border-color: rgba(71, 85, 105, 0.3);
                transform: scale(1);
            }
        }
        
        /* Contacts Action Bar */
        .contacts-action-bar {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(15, 23, 42, 0.5);
        }
        
        .load-history-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            color: #3b82f6;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        .load-history-btn:hover {
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .load-history-btn:active {
            transform: translateY(0);
        }
        
        .load-history-btn span.material-icons {
            font-size: 18px;
        }
        
        .refresh-contacts-btn {
            padding: 10px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 10px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .refresh-contacts-btn:hover {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.5);
            color: #cbd5e1;
            transform: rotate(180deg);
        }
        
        .refresh-contacts-btn span.material-icons {
            font-size: 18px;
        }
        
        /* Loading state for history button */
        .load-history-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .load-history-btn.loading span.material-icons {
            animation: spin 1s linear infinite;
        }
        
        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            margin-right: 16px;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }
        
        .contact-avatar:nth-child(1) { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .contact-item:nth-child(odd) .contact-avatar { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .contact-item:nth-child(even) .contact-avatar { background: linear-gradient(135deg, #10b981, #059669); }
        .contact-item:nth-child(3n) .contact-avatar { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .contact-item:nth-child(4n) .contact-avatar { background: linear-gradient(135deg, #ec4899, #db2777); }
        .contact-item:nth-child(5n) .contact-avatar { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        
        .contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .contact-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-message {
            font-size: 13px;
            color: #94a3b8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .contact-time {
            font-size: 12px;
            color: #64748b;
        }
        
        .unread-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: badgePulse 2s infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Chat Section */
        .chat-section {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 24px;
            background: 
                linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.9) 50%, rgba(51, 65, 85, 0.85) 100%),
                radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            min-height: 110px;
            box-shadow: 
                inset 0 1px 0 rgba(148, 163, 184, 0.1),
                0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(59, 130, 246, 0.6) 20%, 
                rgba(139, 92, 246, 0.6) 50%,
                rgba(16, 185, 129, 0.6) 80%, 
                transparent 100%);
            animation: shimmer 4s ease-in-out infinite;
        }
        
        .chat-header::after {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(59, 130, 246, 0.03) 90deg, transparent 180deg);
            animation: rotate-gradient 20s linear infinite;
            pointer-events: none;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) scaleX(0); }
            50% { transform: translateX(100%) scaleX(1); }
        }
        
        @keyframes rotate-gradient {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
            max-width: calc(100% - 180px); /* Leave space for action buttons */
            overflow: hidden;
        }
        
        .chat-header-avatar {
            width: 54px;
            height: 54px;
            border-radius: 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 22px;
            box-shadow: 
                0 12px 28px rgba(59, 130, 246, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.15),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-header-avatar.group-avatar {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%);
            box-shadow: 
                0 12px 28px rgba(139, 92, 246, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.15),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .chat-header-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            border-radius: inherit;
        }
        
        .chat-header-avatar::after {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: avatar-shine 4s ease-in-out infinite;
        }
        
        @keyframes avatar-shine {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .chat-header-details {
            flex: 1;
            min-width: 0; /* Allow text to truncate */
            overflow: visible;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 60px;
        }
        
        .chat-header-details h3 {
            font-size: 18px;
            font-weight: 600;
            color: #f8fafc;
            margin: 0 0 8px 0;
            letter-spacing: -0.025em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }
        
        .chat-status {
            font-size: 13px;
            color: #94a3b8;
            display: flex;
            align-items: flex-start;
            flex-direction: column;
            gap: 4px;
            font-weight: 400;
            line-height: 1.4;
            margin: 0;
            padding: 0;
            overflow: visible;
            min-height: auto;
        }
        
        .chat-status.online {
            color: #10b981;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        .status-indicator.online {
            color: #10b981;
        }
        
        .status-indicator.offline {
            color: #64748b;
        }
        
        .status-indicator.recently {
            color: #f59e0b;
        }
        
        /* === CLEAN CHAT HEADER STATUS STYLES === */
        
        .header-status-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
            min-height: 24px;
            overflow: hidden;
        }
        
        /* Individual Contact Styles */
        .phone-number {
            font-size: 14px;
            color: #e2e8f0;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.025em;
            flex: 1;
            min-width: 120px; /* Minimum width to show phone numbers */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Prevent too much space taken */
        }
        
        .last-seen-badge {
            font-size: 11px;
            color: #f1f5f9;
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.2));
            backdrop-filter: blur(12px);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: fit-content;
            box-shadow: 
                inset 0 1px 0 rgba(248, 250, 252, 0.15),
                0 3px 8px rgba(59, 130, 246, 0.15);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* Group Contact Styles */
        .status-icon {
            font-size: 16px;
            color: #8b5cf6;
            margin-right: 4px;
        }
        
        .status-text {
            font-size: 13px;
            color: #c4b5fd;
            font-weight: 500;
            background: rgba(139, 92, 246, 0.15);
            backdrop-filter: blur(8px);
            padding: 2px 8px;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: inset 0 1px 0 rgba(196, 181, 253, 0.1);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            animation: pulse-glow 2s ease-in-out infinite;
            box-shadow: 
                0 0 0 2px rgba(16, 185, 129, 0.3), 
                0 0 12px rgba(16, 185, 129, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-dot.offline {
            background: linear-gradient(135deg, #64748b, #475569);
            box-shadow: 
                0 0 0 2px rgba(100, 116, 139, 0.3), 
                0 0 8px rgba(100, 116, 139, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: none;
        }
        
        .status-dot.recently {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 
                0 0 0 2px rgba(245, 158, 11, 0.3), 
                0 0 10px rgba(245, 158, 11, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: pulse-warning 3s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 
                    0 0 0 2px rgba(16, 185, 129, 0.3), 
                    0 0 12px rgba(16, 185, 129, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 
                    0 0 0 4px rgba(16, 185, 129, 0.4), 
                    0 0 20px rgba(16, 185, 129, 0.8),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }
        
        @keyframes pulse-warning {
            0%, 100% { 
                box-shadow: 
                    0 0 0 2px rgba(245, 158, 11, 0.3), 
                    0 0 10px rgba(245, 158, 11, 0.5),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 
                    0 0 0 3px rgba(245, 158, 11, 0.4), 
                    0 0 15px rgba(245, 158, 11, 0.7),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }
        
        .chat-header-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-items: center;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(145deg, rgba(71, 85, 105, 0.4), rgba(51, 65, 85, 0.3));
            border: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            color: #cbd5e1;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .icon-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3) 0%, transparent 70%);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }
        
        .icon-btn:hover {
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
            color: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .icon-btn:hover::before {
            width: 100px;
            height: 100px;
        }
        
        .icon-btn:active {
            transform: translateY(0);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.2),
                inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .icon-btn.group-manage-btn {
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.2));
            border-color: rgba(139, 92, 246, 0.3);
        }
        
        .icon-btn.group-manage-btn:hover {
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.4), rgba(124, 58, 237, 0.3));
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 
                0 8px 20px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            .chat-header {
                padding: 16px 20px;
                min-height: 95px;
            }
            
            .chat-header-info {
                max-width: calc(100% - 150px);
            }
            
            .chat-header-avatar {
                width: 42px;
                height: 42px;
            }
            
            .chat-header-details h3 {
                font-size: 15px;
                margin-bottom: 6px;
            }
            
            .chat-status {
                font-size: 11px;
                gap: 2px;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
            }
            
            .chat-header-actions {
                gap: 6px;
            }
            
            .group-member-count {
                font-size: 10px;
                padding: 1px 4px;
            }
            
            .group-id-display {
                font-size: 9px;
                max-width: 80px;
            }
            
            .header-status-content {
                gap: 8px;
                min-height: 20px;
            }
            
            .phone-number {
                font-size: 13px;
                min-width: 100px;
                max-width: 140px;
            }
            
            .last-seen-badge {
                font-size: 10px;
                padding: 3px 8px;
                border-radius: 10px;
            }
            
            .status-text {
                font-size: 12px;
                padding: 1px 6px;
            }
        }
        
        .icon-btn:nth-child(1):hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            color: #a78bfa;
        }
        
        .icon-btn:nth-child(2):hover {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
            color: #34d399;
        }
        
        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
        }
        
        .message {
            display: flex;
            margin-bottom: 16px;
            animation: messageSlide 0.3s ease;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.sent {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.received .message-bubble {
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-bottom-left-radius: 4px;
        }
        
        .message.sent .message-bubble {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2));
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 10px rgba(34, 197, 94, 0.2);
        }
        
        .message-text {
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Media message styles */
        .message-media {
            margin-bottom: 8px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .message-media img {
            max-width: 100%;
            max-height: 300px;
            object-fit: cover;
            display: block;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .message-media img:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            filter: brightness(1.05);
        }
        
        .message-media-loading {
            width: 250px;
            height: 150px;
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.3) 0%, rgba(71, 85, 105, 0.5) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        .message-document {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(71, 85, 105, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .message-document:hover {
            background: rgba(71, 85, 105, 0.3);
            transform: translateY(-1px);
        }
        
        .document-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .document-info {
            flex: 1;
            min-width: 0;
        }
        
        .document-name {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .document-size {
            color: #94a3b8;
            font-size: 12px;
        }
        
        .message-caption {
            margin-top: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .message-time {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .message.sent .message-time {
            justify-content: flex-end;
        }
        
        /* Message status icons */
        .message-time .material-icons {
            font-size: 16px !important;
            vertical-align: middle;
        }
        
        /* Status icon colors */
        .message-time .material-icons.pending {
            color: #64748b; /* Gray for pending */
        }
        
        .message-time .material-icons.sent {
            color: #64748b; /* Gray for sent */
        }
        
        .message-time .material-icons.delivered {
            color: #64748b; /* Gray for delivered */
        }
        
        .message-time .material-icons.read {
            color: #3b82f6; /* Blue for read */
        }
        
        .message-time .material-icons.failed {
            color: #ef4444; /* Red for failed */
        }

        /* Group Message Sender Info */
        .message-sender-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            margin: -12px -16px 8px -16px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.25), rgba(15, 23, 42, 0.15));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.15);
            border-radius: 12px 12px 4px 4px;
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
        }

        .message-sender-info::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(71, 85, 105, 0.2), transparent);
        }

        .sender-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .sender-details {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .sender-name {
            font-size: 12px;
            font-weight: 500;
            line-height: 1.3;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: rgba(226, 232, 240, 0.9);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sender-phone {
            font-size: 10px;
            color: rgba(148, 163, 184, 0.8);
            font-weight: 400;
            opacity: 0.6;
            line-height: 1.2;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Sender color variations - Subtle glass morphism approach */
        .sender-color-1 { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.6));
        }
        .sender-color-1 .sender-name { 
            color: rgba(147, 197, 253, 0.95); 
        }

        .sender-color-2 { 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.8), rgba(124, 58, 237, 0.6));
        }
        .sender-color-2 .sender-name { 
            color: rgba(196, 181, 253, 0.95); 
        }

        .sender-color-3 { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.8), rgba(217, 119, 6, 0.6));
        }
        .sender-color-3 .sender-name { 
            color: rgba(251, 191, 36, 0.95); 
        }

        .sender-color-4 { 
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.8), rgba(219, 39, 119, 0.6));
        }
        .sender-color-4 .sender-name { 
            color: rgba(249, 168, 212, 0.95); 
        }

        .sender-color-5 { 
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.8), rgba(13, 148, 136, 0.6));
        }
        .sender-color-5 .sender-name { 
            color: rgba(94, 234, 212, 0.95); 
        }

        .sender-color-6 { 
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.8), rgba(14, 165, 233, 0.6));
        }
        .sender-color-6 .sender-name { 
            color: rgba(125, 211, 252, 0.95); 
        }

        /* Adjust message bubble for group messages */
        .message.received.group-message .message-bubble {
            padding-top: 12px;
        }

        .message.received.group-message .message-text {
            margin-top: 0;
        }

        /* Mobile adjustments for group messages */
        @media (max-width: 768px) {
            .message-sender-info {
                padding: 6px 10px;
                gap: 8px;
                margin: -12px -16px 6px -16px;
            }

            .sender-avatar {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .sender-name {
                font-size: 12px;
            }

            .sender-phone {
                font-size: 10px;
            }

            .message-bubble {
                max-width: 85%;
                padding: 10px 14px;
            }

            .message.received.group-message .message-bubble {
                padding-top: 10px;
            }
        }
        
        /* Chat Input */
        .chat-input-section {
            padding: 20px 24px;
            background: rgba(30, 41, 59, 0.6);
            border-top: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 24px;
            color: #e2e8f0;
            font-size: 14px;
            resize: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .emoji-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .emoji-btn:hover {
            color: #e2e8f0;
        }
        
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .send-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .send-btn:active::before {
            width: 100px;
            height: 100px;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        /* Info Section */
        .info-section {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            padding: 24px;
            overflow-y: auto;
        }
        
        .info-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .info-avatar {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 32px;
            margin: 0 auto 16px;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
            position: relative;
        }
        
        .info-avatar::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(135deg, #f59e0b, #ec4899, #8b5cf6, #3b82f6);
            border-radius: 24px;
            z-index: -1;
            opacity: 0.5;
            animation: borderRotate 3s linear infinite;
        }
        
        @keyframes borderRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Override some style.css properties for this page */
        .header {
            margin-bottom: 0;
            position: relative;
            z-index: 100;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }

        /* Back Button Styling - Beautiful Glass Morphism */
        .btn-back {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            color: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 15px rgba(59, 130, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-back::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .btn-back:hover::before {
            left: 100%;
        }

        .btn-back:hover {
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.25), rgba(139, 92, 246, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(59, 130, 246, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-back .material-icons {
            font-size: 20px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-back:hover .material-icons {
            transform: translateX(-3px);
        }

        .btn-back-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.5px;
        }

        .btn-back:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
            flex: 1;
        }
        
        /* Fix header layout */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            gap: 20px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: nowrap;
        }
        
        /* Adjust button sizes */
        .header-actions .btn {
            padding: 10px 20px;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .header-actions .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .header-actions .btn-text {
            display: inline-block;
        }
        
        
        /* Notification and user profile adjustment */
        .notification-btn {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(71, 85, 105, 0.2);
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .info-name {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .info-phone {
            font-size: 14px;
            color: #94a3b8;
        }
        
        .info-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-card {
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.4);
        }
        
        .info-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            color: #e2e8f0;
        }
        
        .label-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .label-tag {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .label-tag:nth-child(1) {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .label-tag:nth-child(2) {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        .label-tag:nth-child(3) {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2), rgba(245, 158, 11, 0.1));
            border: 1px solid rgba(251, 146, 60, 0.3);
            color: #fbbf24;
        }
        
        .label-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 5px;
            margin: 10px 0;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.5), rgba(59, 130, 246, 0.5));
            border-radius: 5px;
            border: 2px solid rgba(30, 41, 59, 0.4);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.7), rgba(59, 130, 246, 0.7));
        }
        
        /* Additional Visual Effects */
        .messages-area {
            background: 
                linear-gradient(to bottom, transparent, rgba(30, 41, 59, 0.1)),
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.03) 0%, transparent 50%);
        }
        
        /* Gradient text for headers */
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 5s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(30deg); }
        }
        
        /* Floating particles effect */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0.3;
            animation: float 20s infinite;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% {
                transform: translateY(-100vh) translateX(100px) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Ripple effect */
        @keyframes ripple {
            to {
                width: 200px;
                height: 200px;
                opacity: 0;
            }
        }
        
        /* Contact hover glow */
        .contact-item::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                rgba(139, 92, 246, 0.1) 0%, 
                transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .contact-item:hover::after {
            opacity: 1;
        }
        
        /* Fix user profile styling */
        .user-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .user-info .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.2;
        }
        
        .user-info .user-role {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.2;
        }
        
        /* Ensure proper button spacing */
        .btn-icon.btn-secondary {
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .btn-icon.btn-secondary:hover {
            background: rgba(71, 85, 105, 0.3);
            border-color: rgba(71, 85, 105, 0.5);
        }
        
        /* Fix logo styling */
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            height: 40px;
            padding: 0 16px;
        }
        
        .logo .material-icons {
            font-size: 28px;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        /* AI Title Styling - Glass Morphism Colorful Theme */
        button.ai-title {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 10px 24px;
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.08), 
                rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(139, 92, 246, 0.3),
                0 4px 16px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            animation: aiFloat 4s ease-in-out infinite;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        button.ai-title:hover {
            transform: translateY(-2px) scale(1.02);
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.12), 
                rgba(255, 255, 255, 0.08));
            box-shadow: 
                0 12px 40px rgba(139, 92, 246, 0.4),
                0 6px 20px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }
        
        button.ai-title:active {
            transform: translateY(0) scale(0.98);
        }
        
        @keyframes aiFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        .ai-title::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg at 50% 50%,
                #8b5cf6 0deg,
                #3b82f6 60deg,
                #10b981 120deg,
                #f59e0b 180deg,
                #ec4899 240deg,
                #8b5cf6 360deg
            );
            animation: rainbowSpin 8s linear infinite;
            opacity: 0.3;
            filter: blur(30px);
        }
        
        @keyframes rainbowSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .ai-title::after {
            content: '';
            position: absolute;
            inset: -1px;
            background: linear-gradient(90deg,
                #8b5cf6,
                #3b82f6,
                #10b981,
                #f59e0b,
                #ec4899,
                #8b5cf6
            );
            border-radius: 24px;
            z-index: -1;
            opacity: 0.5;
            background-size: 300% 100%;
            animation: borderFlow 6s linear infinite;
            filter: blur(2px);
        }
        
        @keyframes borderFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }
        
        .ai-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.9), 
                rgba(59, 130, 246, 0.9));
            border-radius: 12px;
            position: relative;
            box-shadow: 
                0 4px 15px rgba(139, 92, 246, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 4px 15px rgba(139, 92, 246, 0.5),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 
                    0 6px 20px rgba(139, 92, 246, 0.7),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
        }
        
        .ai-icon .material-icons {
            font-size: 22px;
            color: white;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
            animation: iconGlow 3s ease-in-out infinite;
        }
        
        @keyframes iconGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.8)); }
        }
        
        .ai-text {
            font-size: 15px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            background: linear-gradient(135deg,
                #8b5cf6,
                #3b82f6,
                #10b981,
                #f59e0b
            );
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            animation: textGradient 5s ease infinite;
        }
        
        @keyframes textGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Extra sparkle effects */
        .ai-title {
            position: relative;
        }
        
        .ai-title::before {
            pointer-events: none;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            button.ai-title {
                padding: 8px 16px;
                gap: 10px;
            }
            
            .ai-text {
                font-size: 13px;
                letter-spacing: 1px;
            }
            
            .ai-icon {
                width: 32px;
                height: 32px;
            }
            
            .ai-icon .material-icons {
                font-size: 18px;
            }
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .header-actions {
                gap: 12px;
            }
            
            .header-actions .btn-text {
                display: none;
            }
            
            .whatsapp-status {
                min-width: 150px;
            }
            
            .whatsapp-status .status-text {
                font-size: 12px;
            }
            
            .user-profile .user-info {
                display: none;
            }
        }
        
        @media (max-width: 1200px) {
            .conversations-container {
                grid-template-columns: 320px 1fr;
            }
            
            .info-section {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .conversations-container {
                grid-template-columns: 1fr;
                padding: 12px;
                height: calc(100vh - 80px);
            }
            
            .contacts-section {
                display: none;
            }
            
            .header .logo {
                font-size: 20px;
            }
            
            .header .logo .material-icons {
                font-size: 24px !important;
            }

            .btn-back-text {
                display: none;
            }

            .btn-back {
                padding: 10px 16px;
            }
        }

        /* WhatsApp Connection Status Styling */
        .whatsapp-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 10px 6px 12px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            height: 40px;
            min-width: 180px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #64748b;
            box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .status-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0;
            }
        }

        /* Status Colors */
        .whatsapp-status.connected .status-dot,
        .whatsapp-status.WORKING .status-dot {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .whatsapp-status.connecting .status-dot {
            background: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
            animation: blink 1s infinite;
        }

        .whatsapp-status.disconnected .status-dot {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        }

        .whatsapp-status.qr-required .status-dot {
            background: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-text {
            font-size: 13px;
            font-weight: 500;
            color: #e2e8f0;
            white-space: nowrap;
        }

        .status-refresh {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 50%;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .status-refresh .material-icons {
            font-size: 18px;
        }

        .status-refresh:hover {
            background: rgba(71, 85, 105, 0.4);
            color: #e2e8f0;
            transform: rotate(180deg);
        }

        .status-refresh.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* QR Code Modal */
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .qr-modal.show {
            display: flex;
            opacity: 1;
        }

        .qr-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            min-width: 400px;
            max-width: 500px;
            width: 90%;
        }

        .qr-modal.show .qr-content {
            transform: scale(1);
        }

        .qr-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .qr-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .qr-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }

        .qr-code-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 280px;
            position: relative;
            overflow: hidden;
            flex-direction: column;
        }
        
        .qr-code-container img {
            max-width: 280px;
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }

        .qr-code-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: scan-qr 3s linear infinite;
        }

        @keyframes scan-qr {
            from { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            to { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .qr-loading {
            text-align: center;
            color: #64748b;
        }

        .qr-loading .material-icons {
            font-size: 48px;
            margin-bottom: 16px;
            animation: spin 2s linear infinite;
        }

        .qr-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #94a3b8;
        }

        .qr-timer-bar {
            width: 100%;
            height: 4px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .qr-timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
            transition: width 1s linear;
        }

        .qr-actions {
            display: flex;
            gap: 12px;
        }

        .qr-actions button {
            flex: 1;
        }

        /* Connection Info Panel */
        .connection-info {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .connection-info.show {
            transform: translateX(0);
        }

        .info-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 50%;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            transform: rotate(90deg);
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-title .material-icons {
            font-size: 24px;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .info-value.number {
            color: #3b82f6;
            font-family: 'Courier New', monospace;
        }

        .info-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
        }

        .info-actions button {
            flex: 1;
            padding: 10px;
            font-size: 13px;
        }
        
        /* Additional Button Styles */
        .btn-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #10b981;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.25));
            border-color: rgba(16, 185, 129, 0.6);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.25));
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        /* Connection Control Animation */
        @keyframes connectionPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }
        
        .whatsapp-status.connected,
        .whatsapp-status.WORKING {
            animation: connectionPulse 3s infinite;
        }
        
        /* Compliance styles */
        .info-divider {
            height: 1px;
            background: rgba(71, 85, 105, 0.3);
            margin: 16px 0;
        }
        
        .compliance-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #f87171;
            font-size: 14px;
        }
        
        .compliance-warning .material-icons {
            font-size: 20px;
        }
        
        
        .compliance-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .compliance-indicator.warning {
            background: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        
        .compliance-indicator.danger {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Image Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
        }
        
        .image-modal.show {
            opacity: 1;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            max-width: 90vw;
            max-height: 90vh;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .image-modal.show .modal-content {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        
        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            object-fit: contain;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10001;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .modal-close span {
            color: white;
            font-size: 28px;
        }
        
        .modal-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            padding: 15px 25px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 50px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-modal.show .modal-controls {
            opacity: 1;
            transition-delay: 0.2s;
        }
        
        .modal-btn {
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .modal-btn span {
            color: white;
            font-size: 24px;
        }
        
        .modal-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            display: none;
        }
        
        .modal-loading.show {
            display: block;
        }
        
        .modal-loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Zoom controls */
        .zoom-level {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-modal.show .zoom-level {
            opacity: 1;
            transition-delay: 0.2s;
        }
        
        /* Image container for panning */
        .modal-image-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            cursor: grab;
        }
        
        .modal-image-container.grabbing {
            cursor: grabbing;
        }
        
        .modal-image-container img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.3s ease;
        }
        
        /* General Modal Styles for Media Preview */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal.show {
            display: flex !important;
            opacity: 1;
        }
        
        .modal .modal-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            padding: 0;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
        }
        
        .modal.show .modal-content {
            transform: scale(1);
        }
        
        .modal .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal .modal-header h3 {
            margin: 0;
            color: #e2e8f0;
            font-size: 20px;
        }
        
        .modal .modal-body {
            padding: 24px;
            color: #e2e8f0;
        }
        
        .modal .close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .modal .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal .close-btn span {
            color: #94a3b8;
        }
        
        .modal .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .modal .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .modal .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .modal .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            margin-bottom: 20px;
        }
        
        .modal .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .modal .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body>
    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
        <div class="modal-close" onclick="closeImageModal()">
            <span class="material-icons">close</span>
        </div>
        
        <div class="zoom-level" id="zoomLevel">100%</div>
        
        <div class="modal-loading" id="modalLoading">Loading image</div>
        
        <div class="modal-content">
            <div class="modal-image-container" id="imageContainer">
                <img class="modal-image" id="modalImage" alt="Full resolution image">
            </div>
        </div>
        
        <div class="modal-controls">
            <div class="modal-btn" onclick="zoomOut()" title="Zoom Out">
                <span class="material-icons">zoom_out</span>
            </div>
            <div class="modal-btn" onclick="resetZoom()" title="Reset Zoom">
                <span class="material-icons">fit_screen</span>
            </div>
            <div class="modal-btn" onclick="zoomIn()" title="Zoom In">
                <span class="material-icons">zoom_in</span>
            </div>
            <div class="modal-btn" onclick="downloadImage()" title="Download">
                <span class="material-icons">download</span>
            </div>
            <div class="modal-btn" onclick="rotateImage()" title="Rotate">
                <span class="material-icons">rotate_right</span>
            </div>
        </div>
    </div>
    <div class="app-container">
        <!-- Main Header -->
        <div class="header">
            <div class="header-left">
                <button class="btn-back" onclick="window.location.href='crm-main.html'" title="Back to Dashboard">
                    <span class="material-icons">arrow_back</span>
                    <span class="btn-back-text">Dashboard</span>
                </button>
                <button class="ai-title" onclick="window.location.href='ai-automation.html'" title="Go to AI Automation">
                    <span class="ai-icon">
                        <span class="material-icons">psychology</span>
                    </span>
                    <span class="ai-text">AI Based Chat Engine</span>
                </button>
            </div>
            <div class="header-actions">
                <!-- WhatsApp Connection Status -->
                <div class="whatsapp-status" id="whatsappStatus">
                    <div class="status-indicator" id="statusIndicator">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking...</span>
                    </div>
                    <button class="btn-icon status-refresh" onclick="checkConnectionStatus()" title="Refresh Status">
                        <span class="material-icons">refresh</span>
                    </button>
                </div>
                
                <button class="btn btn-primary" id="connectBtn" onclick="connectWhatsApp()">
                    <span class="material-icons">link</span>
                    <span class="btn-text">Connect</span>
                </button>
                
                <button class="btn-icon btn-secondary" onclick="showConnectionInfo()" title="Info">
                    <span class="material-icons">info</span>
                </button>
                
                <div class="notification-btn">
                    <span class="material-icons">notifications</span>
                    <span class="notification-badge">5</span>
                </div>
                
                <div class="user-profile">
                    <div class="user-avatar">
                        <span class="avatar-initials">A</span>
                    </div>
                    <div class="user-info">
                        <div class="user-name">Admin</div>
                        <div class="user-role">WhatsApp Agent</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversations Container -->
        <div class="conversations-container">
            <!-- Contacts List -->
            <div class="contacts-section">
                <div class="contacts-header">
                    <div class="contacts-search">
                        <span class="material-icons">search</span>
                        <input type="text" placeholder="Search contacts..." id="search-contacts">
                    </div>
                    <div class="filter-tabs">
                        <div class="filter-tab active" onclick="filterContacts('all', this)">All</div>
                        <div class="filter-tab" onclick="filterContacts('unread', this)">Unread</div>
                        <div class="filter-tab" onclick="filterContacts('groups', this)">Groups</div>
                    </div>
                </div>
                
                <!-- Action Bar for Load History -->
                <div class="contacts-action-bar" id="contactsActionBar">
                    <button class="load-history-btn" onclick="loadWhatsAppHistory()">
                        <span class="material-icons">history</span>
                        <span>Load Chat History</span>
                    </button>
                    <button class="refresh-contacts-btn" onclick="loadContacts('all')" title="Refresh contacts">
                        <span class="material-icons">refresh</span>
                    </button>
                </div>
                
                <div class="contacts-list" id="contacts-list">
                    <!-- Contacts will be loaded here after WhatsApp connection -->
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-section">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="chat-header-avatar">AH</div>
                        <div class="chat-header-details">
                            <h3>Select a contact</h3>
                            <div class="chat-status">
                                <span class="status-dot"></span>
                                Online
                            </div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="icon-btn" onclick="searchInChat()">
                            <span class="material-icons">search</span>
                        </button>
                        <button class="icon-btn" onclick="makeCall()">
                            <span class="material-icons">call</span>
                        </button>
                        <button class="icon-btn" onclick="showChatMenu()">
                            <span class="material-icons">more_vert</span>
                        </button>
                    </div>
                </div>

                <div class="messages-area" id="messages-area">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b; text-align: center;">
                        <div>
                            <span class="material-icons" style="font-size: 48px; opacity: 0.3;">chat_bubble_outline</span>
                            <p style="margin-top: 16px; font-size: 16px;">Connect WhatsApp and select a contact to start chatting</p>
                        </div>
                    </div>
                </div>

                <div class="chat-input-section">
                    <button class="icon-btn" onclick="attachFile()">
                        <span class="material-icons">attach_file</span>
                    </button>
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                        <button class="emoji-btn" onclick="showEmoji()">
                            <span class="material-icons">mood</span>
                        </button>
                        <div class="compliance-indicator" id="complianceIndicator"></div>
                    </div>
                    <button class="send-btn" onclick="sendMessage()">
                        <span class="material-icons">send</span>
                    </button>
                </div>
            </div>

            <!-- Contact Info -->
            <div class="info-section">
                <div class="info-header">
                    <div class="info-avatar">AH</div>
                    <div class="info-name">No contact selected</div>
                    <div class="info-phone">-</div>
                </div>

                <div class="info-section-title">Contact Info</div>
                <div class="info-card">
                    <div class="info-label">Email</div>
                    <div class="info-value" id="contact-email">Belum teridentifikasi</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Location</div>
                    <div class="info-value" id="contact-location">Belum teridentifikasi</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Paket Umroh</div>
                    <div class="info-value" id="contact-package">Belum teridentifikasi</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Status</div>
                    <div class="info-value" id="contact-status">Belum teridentifikasi</div>
                </div>

                <div class="info-section-title">Labels</div>
                <div class="info-card">
                    <div class="label-tags" id="contact-labels">
                        <span class="label-tag">Belum ada label</span>
                    </div>
                </div>

                <div class="info-section-title">Media & Files</div>
                <div class="info-card">
                    <div class="info-value" id="contact-media">0 Photos, 0 Documents</div>
                </div>

                <div class="info-section-title">Insights</div>
                <div class="info-card">
                    <div class="info-label">Total Messages</div>
                    <div class="info-value" id="total-messages">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">First Contact</div>
                    <div class="info-value" id="first-contact">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Last Chat</div>
                    <div class="info-value" id="last-chat">-</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Keywords</div>
                    <div class="info-value" id="contact-keywords">Belum teridentifikasi</div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-content">
            <div class="qr-header">
                <h2 class="qr-title">Scan QR Code</h2>
                <p class="qr-subtitle">Scan this code with WhatsApp on your phone</p>
            </div>
            
            <div class="qr-code-container" id="qrCodeContainer">
                <div class="qr-loading">
                    <span class="material-icons">qr_code_scanner</span>
                    <p>Loading QR Code...</p>
                </div>
            </div>
            
            <div class="qr-timer">
                <span class="material-icons" style="font-size: 16px;">schedule</span>
                <span>QR expires in <span id="qrTimer">60</span> seconds</span>
            </div>
            
            <div class="qr-timer-bar">
                <div class="qr-timer-fill" id="qrTimerFill" style="width: 100%"></div>
            </div>
            
            <div class="qr-actions">
                <button class="btn btn-secondary" onclick="refreshQR()">
                    <span class="material-icons">refresh</span>
                    Refresh QR
                </button>
                <button class="btn btn-primary" onclick="closeQRModal()">
                    <span class="material-icons">close</span>
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Connection Info Panel -->
    <div class="connection-info" id="connectionInfo" style="display: none;">
        <button class="info-close" onclick="hideConnectionInfo()">
            <span class="material-icons">close</span>
        </button>
        
        <div class="info-title">
            <span class="material-icons">info</span>
            Connection Details
        </div>
        
        <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value" id="infoStatus">-</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Phone Number</span>
            <span class="info-value number" id="infoPhone">-</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Session ID</span>
            <span class="info-value" id="infoSession">-</span>
        </div>
        
        <div class="info-divider"></div>
        
        <div class="info-title">
            <span class="material-icons">security</span>
            WAHA Compliance Status
        </div>
        
        <div class="info-item">
            <span class="info-label">Daily Limit</span>
            <span class="info-value" id="complianceDaily">0/50 contacts</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Messages Today</span>
            <span class="info-value" id="complianceMessages">0 sent</span>
        </div>
        
        
        <div class="info-item">
            <span class="info-label">Compliance Score</span>
            <span class="info-value" id="complianceScore">
                <span style="color: #10b981;">Good </span>
            </span>
        </div>
        
        <div class="compliance-warning" id="complianceWarning" style="display: none;">
            <span class="material-icons">warning</span>
            <span id="complianceWarningText"></span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Connected Since</span>
            <span class="info-value" id="infoConnectedTime">-</span>
        </div>
        
        <div class="info-item">
            <span class="info-label">Messages Today</span>
            <span class="info-value number" id="infoMessages">0</span>
        </div>
        
        <div class="info-actions">
            <button class="btn btn-secondary" onclick="testConnection()">
                <span class="material-icons">speed</span>
                Test
            </button>
            <button class="btn btn-danger" onclick="disconnectWhatsApp()">
                <span class="material-icons">link_off</span>
                Disconnect
            </button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95)); backdrop-filter: blur(20px); border-radius: 20px; padding: 24px; max-width: 400px; width: 90%; border: 1px solid rgba(71, 85, 105, 0.3); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #e2e8f0; font-size: 20px;">Scan QR Code</h3>
                <button class="close-btn" onclick="document.getElementById('qrModal').style.display='none'" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px;">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div id="qrCodeContainer" style="background: white; padding: 20px; border-radius: 12px; text-align: center; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                <div style="color: #64748b;">
                    <span class="material-icons" style="font-size: 48px; opacity: 0.5;">qr_code_scanner</span>
                    <p style="margin-top: 16px;">Loading QR Code...</p>
                </div>
            </div>
            <p style="margin-top: 16px; color: #94a3b8; text-align: center; font-size: 14px;">
                Open WhatsApp on your phone and scan this QR code to connect
            </p>
        </div>
    </div>

    <script>
        // Backend Configuration
        const API_CONFIG = {
            baseUrl: 'http://localhost:3003/api', // Backend API endpoint
            wahaUrl: 'http://localhost:3000', // WAHA Plus direct URL
            sessionId: 'default',
            healthCheckInterval: 10000, // 10 seconds
            apiKey: 'your-api-key' // WAHA Plus API key
        };
        
        // Initialize WAHA Plus integration
        let wahaIntegration = null;
        let stopMonitoring = null;
        
        // Socket.IO will be initialized in initializeSocket() function

        // Connection state - make it global for debugging
        window.connectionState = {
            status: 'disconnected', // connected, connecting, disconnected, qr-required
            phone: null,
            connectedAt: null,
            sessionInfo: null
        };
        
        // Also keep local reference
        let connectionState = window.connectionState;



        // Check WhatsApp connection status
        async function checkConnectionStatus() {
            const statusEl = document.getElementById('whatsappStatus');
            const refreshBtn = statusEl.querySelector('.status-refresh');
            const statusText = statusEl.querySelector('.status-text');
            const connectBtn = document.getElementById('connectBtn');
            
            // Show loading
            refreshBtn.classList.add('spinning');
            statusText.textContent = 'Checking...';
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                const result = await response.json();
                
                if (result.success) {
                    updateConnectionStatus(result.data.status || 'disconnected', result.data);
                } else {
                    updateConnectionStatus('disconnected');
                }
            } catch (error) {
                console.error('Failed to check status:', error);
                updateConnectionStatus('disconnected');
            } finally {
                refreshBtn.classList.remove('spinning');
            }
        }

        // Update connection status UI
        function updateConnectionStatus(status, data = {}) {
            console.log('updateConnectionStatus called with:', status, data);
            
            const statusEl = document.getElementById('whatsappStatus');
            const statusText = statusEl.querySelector('.status-text');
            const connectBtn = document.getElementById('connectBtn');
            
            connectionState.status = status;
            console.log('connectionState updated to:', connectionState);
            
            statusEl.className = 'whatsapp-status ' + status;
            
            switch (status) {
                case 'connected':
                case 'authenticated':
                case 'WORKING':
                    statusText.textContent = 'Connected';
                    // Change button to disconnect when connected
                    connectBtn.innerHTML = `
                        <span class="material-icons">link_off</span>
                        <span class="btn-text">Disconnect</span>
                    `;
                    connectBtn.classList.remove('btn-success', 'btn-primary');
                    connectBtn.classList.add('btn-danger');
                    connectBtn.setAttribute('onclick', 'disconnectWhatsApp()');
                    connectionState.phone = data.phone || data.phoneNumber;
                    connectionState.connectedAt = data.connectedAt || new Date();
                    // Load contacts when authenticated
                    loadContacts();
                    break;
                    
                case 'connecting':
                    statusText.textContent = 'Connecting...';
                    connectBtn.innerHTML = `
                        <span class="material-icons">sync</span>
                        <span class="btn-text">Connecting...</span>
                    `;
                    break;
                    
                case 'qr-required':
                    statusText.textContent = 'Scan QR Code';
                    connectBtn.innerHTML = `
                        <span class="material-icons">qr_code</span>
                        <span class="btn-text">Scan QR</span>
                    `;
                    break;
                    
                default:
                    statusText.textContent = 'Disconnected';
                    connectBtn.innerHTML = `
                        <span class="material-icons">link</span>
                        <span class="btn-text">Connect WhatsApp</span>
                    `;
                    connectBtn.classList.remove('btn-success', 'btn-danger');
                    connectBtn.classList.add('btn-primary');
                    connectBtn.setAttribute('onclick', 'connectWhatsApp()');
                    connectionState.phone = null;
                    connectionState.connectedAt = null;
            }
            
            updateConnectionInfo();
        }
        
        // Check WAHA session status
        async function checkWAHAStatus() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/status`);
                if (!response.ok) {
                    throw new Error('Failed to get session status');
                }
                
                const result = await response.json();
                console.log('WAHA status:', result.data);
                
                if (result.data.status === 'SCAN_QR_CODE' || result.data.status === 'STARTING') {
                    // Show QR code modal for both SCAN_QR_CODE and STARTING status
                    await showWAHAQRCode();
                } else if (result.data.status === 'WORKING' || result.data.status === 'connected') {
                    // Already connected - pass the status and full data
                    updateConnectionStatus(result.data.status, result.data);
                    if (result.data.phoneNumber || result.data.phone) {
                        connectionState.phoneNumber = result.data.phoneNumber || result.data.phone;
                        updateConnectionInfo();
                    }
                    if (result.data.pushName) {
                        console.log('Connected as:', result.data.pushName);
                    }
                    // Remove alert for smoother UX
                    console.log('WhatsApp is already connected!');
                } else if (result.data.status === 'STOPPED') {
                    // Session is stopped, need to wait for it to start
                    console.log('Session is starting, waiting for QR...');
                    
                    // Poll for QR code after a short delay
                    setTimeout(async () => {
                        await checkForQRCode();
                    }, 2000);
                } else {
                    // Other status
                    console.log('Session status:', result.data.status);
                }
            } catch (error) {
                console.error('Error checking WAHA status:', error);
            }
        }
        
        // Show WAHA QR Code
        async function showWAHAQRCode() {
            try {
                // Get QR code from WAHA
                const qrResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/qr`);
                if (!qrResponse.ok) {
                    const errorData = await qrResponse.json().catch(() => ({}));
                    console.error('QR endpoint error:', {
                        status: qrResponse.status,
                        statusText: qrResponse.statusText,
                        error: errorData
                    });
                    
                    // If 500 error, it might mean session needs time to initialize
                    if (qrResponse.status === 500) {
                        console.log('Session might still be initializing, retrying...');
                        // Retry after 2 seconds
                        setTimeout(() => checkForQRCode(), 2000);
                        return;
                    }
                    
                    throw new Error(`Failed to get QR code: ${qrResponse.status} ${errorData.error || qrResponse.statusText}`);
                }
                
                const qrData = await qrResponse.json();
                console.log('QR Response:', qrData);
                
                if (!qrData.success) {
                    throw new Error(qrData.error || 'Failed to get QR code');
                }
                
                if (!qrData.data || !qrData.data.qr) {
                    console.log('No QR in response, checking status...');
                    // If no QR, check if already connected
                    const statusCheck = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/status`);
                    const statusData = await statusCheck.json();
                    if (statusData.data.status === 'WORKING') {
                        updateConnectionStatus('connected');
                        alert('WhatsApp is already connected!');
                        return;
                    }
                    throw new Error('No QR code available. Please try reconnecting.');
                }
                
                // Show QR modal
                const qrModal = document.getElementById('qrModal');
                const qrContainer = document.getElementById('qrCodeContainer');
                
                // Display QR code as base64 image
                qrContainer.innerHTML = `<img src="${qrData.data.qr}" alt="WhatsApp QR Code" style="max-width: 100%; height: auto;">`;
                qrModal.style.display = 'flex';
                
                // Start polling for status
                const statusInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId || 'default'}/status`);
                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            if (statusData.data.status === 'WORKING' || statusData.data.status === 'connected' || statusData.data.status === 'authenticated') {
                                clearInterval(statusInterval);
                                qrModal.style.display = 'none';
                                // Pass the actual status and data
                                updateConnectionStatus(statusData.data.status, statusData.data);
                                showNotification('WhatsApp berhasil terhubung!', 'success');
                            }
                        }
                    } catch (error) {
                        console.error('Error polling status:', error);
                    }
                }, 3000); // Check every 3 seconds
                
                // Clean up interval when modal is closed
                const closeBtn = qrModal.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        clearInterval(statusInterval);
                        qrModal.style.display = 'none';
                    };
                }
                
            } catch (error) {
                console.error('Error showing QR code:', error);
                alert('Failed to get QR code. Please try again.');
            }
        }
        
        // Check for QR code
        async function checkForQRCode() {
            console.log('checkForQRCode called');
            
            // Clear any existing interval first
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
            }
            
            // Check immediately first
            try {
                console.log('Checking QR status immediately...');
                
                // First try direct QR endpoint
                const qrResponse = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/qr`);
                if (qrResponse.ok) {
                    const qrResult = await qrResponse.json();
                    console.log('Direct QR check:', qrResult);
                    if (qrResult.success && qrResult.data.qr) {
                        console.log('QR found via direct endpoint');
                        showQRModal(qrResult.data.qr);
                        // Continue with interval checking
                    }
                }
                
                // Also check status
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                
                if (!response.ok) {
                    console.error('Failed to check QR status:', response.status);
                    return;
                }
                
                const result = await response.json();
                console.log('QR check result:', result);
                
                if (result.success && result.data) {
                    if (result.data.qr) {
                        console.log('QR code received, showing modal');
                        showQRModal(result.data.qr);
                    }
                }
            } catch (error) {
                console.error('Error checking QR immediately:', error);
            }
            
            // Set up interval to check for QR - less frequent to avoid multiple QR generation
            let qrShown = false;
            qrCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/status`);
                    
                    if (!response.ok) {
                        console.error('Failed to check QR status');
                        return;
                    }
                    
                    const result = await response.json();
                    console.log('QR interval check:', result.data?.status, 'QR:', !!result.data?.qr);
                    
                    if (result.success && result.data) {
                        if (result.data.qr && !qrShown) {
                            // Show QR code only once
                            showQRModal(result.data.qr);
                            qrShown = true;
                        } else if (result.data.status === 'authenticated' || result.data.status === 'connected' || result.data.status === 'WORKING') {
                            // Connected successfully
                            console.log('WhatsApp connected! Status:', result.data.status);
                            closeQRModal();
                            updateConnectionStatus(result.data.status, result.data);
                            clearInterval(qrCheckInterval);
                            qrCheckInterval = null;
                            qrShown = false;
                            
                            // Emit connected event
                            if (socket) {
                                socket.emit('session:connected', {
                                    sessionId: API_CONFIG.sessionId,
                                    status: result.data.status
                                });
                            }
                        } else if (result.data.status === 'disconnected') {
                            // Not connected, but no QR
                            console.log('Session disconnected, no QR available');
                            qrShown = false;
                        }
                    }
                } catch (error) {
                    console.error('Error checking QR:', error);
                }
            }, 3000); // Check every 3 seconds
        }

        // Disconnect WhatsApp
        async function disconnectWhatsApp() {
            if (confirm('Are you sure you want to disconnect WhatsApp?')) {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/stop`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        updateConnectionStatus('disconnected');
                        hideConnectionInfo();
                    } else {
                        throw new Error(result.error || 'Failed to stop session');
                    }
                } catch (error) {
                    console.error('Disconnect error:', error);
                    alert('Failed to disconnect: ' + error.message);
                }
            }
        }

        // Show QR Modal
        function showQRModal(qrCode) {
            const modal = document.getElementById('qrModal');
            const container = document.getElementById('qrCodeContainer');
            
            // Prevent showing multiple modals
            if (modal.classList.contains('show')) {
                console.log('QR modal already showing, skipping');
                return;
            }
            
            console.log('Showing QR modal with code:', qrCode ? 'Present' : 'Missing');
            console.log('QR preview:', qrCode ? qrCode.substring(0, 50) + '...' : 'N/A');
            
            // Clear any existing QR first
            container.innerHTML = '';
            
            // Display QR code - WAHA returns base64 image
            if (qrCode && (qrCode.startsWith('data:') || qrCode.startsWith('http'))) {
                // Add timestamp to prevent caching
                const img = document.createElement('img');
                img.src = qrCode;
                img.alt = 'WhatsApp QR Code';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.onload = () => {
                    console.log('QR image loaded successfully');
                };
                img.onerror = () => {
                    console.error('Failed to load QR image');
                };
                container.appendChild(img);
            } else {
                // Fallback if no image
                container.innerHTML = `
                    <div class="qr-loading">
                        <span class="material-icons">qr_code_scanner</span>
                        <p>QR Code is loading...</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #94a3b8;">
                            Check the backend terminal window if QR doesn't appear here
                        </p>
                    </div>
                `;
            }
            
            modal.classList.add('show');
            startQRTimer();
        }

        // Close QR Modal
        function closeQRModal() {
            const modal = document.getElementById('qrModal');
            modal.classList.remove('show');
            stopQRTimer();
            
            // Clear QR check interval
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
        }

        // Refresh QR Code
        async function refreshQR() {
            const container = document.getElementById('qrCodeContainer');
            container.innerHTML = `
                <div class="qr-loading">
                    <span class="material-icons">qr_code_scanner</span>
                    <p>Loading new QR Code...</p>
                </div>
            `;
            
            // Stop current timer
            stopQRTimer();
            
            try {
                // First disconnect current session
                console.log('Disconnecting current session...');
                await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/stop`, {
                    method: 'POST'
                });
                
                // Wait a bit
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Start new session
                console.log('Starting new session...');
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: API_CONFIG.sessionId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to start new session');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('New session started, checking for QR...');
                    // Start checking for new QR
                    checkForQRCode();
                    // Restart timer
                    startQRTimer();
                } else {
                    throw new Error(result.error || 'Failed to start session');
                }
            } catch (error) {
                console.error('Error refreshing QR:', error);
                container.innerHTML = `
                    <div class="qr-loading">
                        <span class="material-icons">error</span>
                        <p>Failed to refresh QR. Please try connecting again.</p>
                    </div>
                `;
            }
        }

        // QR Timer
        function startQRTimer() {
            // Stop any existing timer first
            stopQRTimer();
            
            // Only start new timer if modal is showing
            const modal = document.getElementById('qrModal');
            if (!modal.classList.contains('show')) {
                return;
            }
            
            qrCountdown = 60;
            updateQRTimer();
            
            qrTimer = setInterval(() => {
                // Check if modal still showing
                if (!modal.classList.contains('show')) {
                    stopQRTimer();
                    return;
                }
                
                qrCountdown--;
                updateQRTimer();
                
                if (qrCountdown <= 0) {
                    stopQRTimer();
                    // Don't auto-refresh, let user manually refresh
                    document.getElementById('qrTimer').textContent = 'Expired';
                    document.getElementById('qrTimerFill').style.width = '0%';
                }
            }, 1000);
        }

        function stopQRTimer() {
            if (qrTimer) {
                clearInterval(qrTimer);
                qrTimer = null;
            }
        }

        function updateQRTimer() {
            document.getElementById('qrTimer').textContent = qrCountdown;
            document.getElementById('qrTimerFill').style.width = (qrCountdown / 60 * 100) + '%';
        }

        // Connection Info Panel
        function showConnectionInfo() {
            const infoPanel = document.getElementById('connectionInfo');
            infoPanel.style.display = 'block';
            infoPanel.classList.add('show');
            updateConnectionInfo();
        }

        function hideConnectionInfo() {
            const infoPanel = document.getElementById('connectionInfo');
            infoPanel.classList.remove('show');
            setTimeout(() => {
                infoPanel.style.display = 'none';
            }, 300);
        }

        function updateConnectionInfo() {
            document.getElementById('infoStatus').textContent = 
                connectionState.status.charAt(0).toUpperCase() + connectionState.status.slice(1);
            
            document.getElementById('infoPhone').textContent = 
                connectionState.phone || '-';
            
            document.getElementById('infoSession').textContent = 
                API_CONFIG.sessionId;
            
            document.getElementById('infoConnectedTime').textContent = 
                connectionState.connectedAt ? 
                new Date(connectionState.connectedAt).toLocaleString() : '-';
            
            // Simulate message count
            document.getElementById('infoMessages').textContent = 
                connectionState.status === 'connected' ? '847' : '0';
        }

        // Test Connection
        async function testConnection() {
            alert('Connection test successful! Response time: 23ms');
        }

        // Start health check
        function startHealthCheck() {
            healthCheckTimer = setInterval(() => {
                if (connectionState.status === 'connected') {
                    checkConnectionStatus();
                }
            }, 30000); // Check every 30 seconds
        }

        // Stop health check
        function stopHealthCheck() {
            if (healthCheckTimer) {
                clearInterval(healthCheckTimer);
                healthCheckTimer = null;
            }
        }

        // Create floating particles
        function createParticles() {
            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899'];
            const container = document.body;
            
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.width = particle.style.height = Math.random() * 10 + 5 + 'px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.borderRadius = '50%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 20) + 's';
                container.appendChild(particle);
            }
        }
        
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notificationHtml = `
                <div class="notification notification-${type}" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(71, 85, 105, 0.4);
                    border-radius: 12px;
                    padding: 16px 24px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    color: #e2e8f0;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    transition: opacity 0.3s;
                ">
                    <span class="material-icons">${type === 'error' ? 'error' : 'info'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = notificationHtml;
            document.body.appendChild(tempDiv.firstElementChild);
            
            setTimeout(() => {
                const notification = document.querySelector('.notification');
                if (notification) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }


        // Removed duplicate sendMessage function - using async version below

        // Auto-resize textarea
        const chatInput = document.getElementById('messageInput');
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            checkMessageCompliance(this.value);
        });

        // Enter to send
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Current conversation state
        let currentConversation = null;
        let currentContact = null;
        let socket = null;
        let qrCheckInterval = null;
        let qrTimer = null;
        let qrCountdown = 60;
        let healthCheckTimer = null;
        let isLoadingContacts = false;
        let contactsLoaded = false;
        
        // Socket.IO connection
        function initializeSocket() {
            const socketUrl = API_CONFIG.baseUrl.replace('/api', '');
            console.log('Connecting to socket:', socketUrl);
            socket = io(socketUrl, {
                transports: ['polling', 'websocket'], // Start with polling, then upgrade
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 5,
                timeout: 20000,
                autoConnect: true,
                forceNew: false,
                multiplex: true,
                path: '/socket.io/',
                query: {
                    sessionId: API_CONFIG.sessionId
                }
            });
            
            socket.on('connect', () => {
                console.log('Connected to backend socket');
                console.log('Socket ID:', socket.id);
                console.log('Transport:', socket.io.engine.transport.name);
                initializeSocketListeners();
            });
            
            socket.on('disconnect', (reason) => {
                console.log('Disconnected from backend socket:', reason);
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error.message);
                console.error('Error type:', error.type);
                // If WebSocket fails, Socket.IO will automatically fallback to polling
            });
            
            socket.io.on('upgrade', (transport) => {
                console.log('Socket transport upgraded to:', transport.name);
            });
        }
        
        // Load contacts
        async function loadContacts(filter = 'all', searchTerm = '') {
            console.log('=== loadContacts called ===');
            console.log('Filter:', filter);
            console.log('API_CONFIG:', API_CONFIG);
            
            // Prevent double loading
            if (isLoadingContacts) {
                console.log('Already loading contacts, skipping...');
                return;
            }
            
            isLoadingContacts = true;
            
            try {
                // Get conversations instead of just contacts - this includes last message
                let url = `${API_CONFIG.baseUrl}/conversations?status=active&limit=50`;
                if (filter === 'unread') {
                    url += '&hasUnread=true';
                } else if (filter === 'groups') {
                    url += '&isGroup=true';
                }
                
                // Add search parameter if provided
                if (searchTerm && searchTerm.trim().length > 0) {
                    url += `&search=${encodeURIComponent(searchTerm.trim())}`;
                }
                
                console.log('Fetching from URL:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('API Result:', result);
                
                if (result.success) {
                    console.log(`Found ${result.data.length} conversations`);
                    console.log('Raw conversation data:', result.data);
                    
                    // Transform conversations data to match displayContacts format
                    const contactsData = result.data.map(conv => {
                        const lastMessageAt = conv.lastMessageAt || conv.messages?.[0]?.createdAt || conv.updatedAt;
                        console.log(`Contact ${conv.contact.name}: lastMessageAt = ${lastMessageAt}`);
                        
                        return {
                            ...conv.contact,
                            conversations: [conv],
                            lastMessage: conv.messages?.[0],
                            isWithin24hWindow: conv.isWithin24hWindow,
                            lastMessageAt: lastMessageAt,
                            unreadCount: conv.unreadCount || 0
                        };
                    });
                    
                    // Apply client-side filtering if backend doesn't support it
                    let filteredData = contactsData;
                    
                    // Apply search filter client-side if needed
                    if (searchTerm && searchTerm.trim().length > 0) {
                        const search = searchTerm.toLowerCase().trim();
                        filteredData = filteredData.filter(contact => {
                            const name = (contact.name || '').toLowerCase();
                            const phoneNumber = (contact.phoneNumber || '').toLowerCase();
                            const lastMessageText = (contact.lastMessage?.body || '').toLowerCase();
                            
                            return name.includes(search) || 
                                   phoneNumber.includes(search) || 
                                   lastMessageText.includes(search);
                        });
                    }
                    
                    // Apply filter-specific logic client-side
                    if (filter === 'unread') {
                        filteredData = filteredData.filter(contact => contact.unreadCount > 0);
                    } else if (filter === 'groups') {
                        filteredData = filteredData.filter(contact => contact.isGroup === true);
                    }
                    
                    // Sort by last message time (most recent first)
                    filteredData.sort((a, b) => {
                        const timeA = new Date(a.lastMessageAt || 0).getTime();
                        const timeB = new Date(b.lastMessageAt || 0).getTime();
                        return timeB - timeA;
                    });
                    
                    console.log('Transformed, filtered and sorted data:', filteredData);
                    displayContacts(filteredData);
                    
                    // Update filter tab counts
                    updateFilterTabCounts(contactsData);
                    
                    // Show total conversations loaded
                    console.log(`Loaded ${result.data.length} conversations (Total: ${result.pagination.total})`);
                    
                    // Add load more button if there are more conversations
                    if (result.pagination.total > 50) {
                        addLoadMoreButton(result.pagination.total);
                    }
                } else {
                    console.error('API returned error:', result.error);
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                console.error('Stack trace:', error.stack);
            } finally {
                isLoadingContacts = false;
                contactsLoaded = true;
            }
        }
        
        // Add load more button
        function addLoadMoreButton(totalConversations) {
            const contactsList = document.getElementById('contacts-list');
            const existingButton = document.getElementById('load-more-btn');
            
            if (existingButton) {
                existingButton.remove();
            }
            
            const loadMoreBtn = document.createElement('div');
            loadMoreBtn.id = 'load-more-btn';
            loadMoreBtn.className = 'load-more-button';
            loadMoreBtn.innerHTML = `
                <button onclick="loadMoreConversations()" style="
                    width: 100%;
                    padding: 12px;
                    margin: 10px 0;
                    background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
                    border: 1px solid rgba(59, 130, 246, 0.3);
                    border-radius: 8px;
                    color: #60a5fa;
                    cursor: pointer;
                    font-weight: 500;
                    transition: all 0.3s ease;
                ">
                    Load More Conversations (Showing 50 of ${totalConversations})
                </button>
            `;
            contactsList.appendChild(loadMoreBtn);
        }
        
        // Load more conversations
        let currentOffset = 0;
        async function loadMoreConversations() {
            currentOffset += 50;
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/conversations?status=active&limit=50&offset=${currentOffset}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const contactsData = result.data.map(conv => ({
                        ...conv.contact,
                        conversations: [conv],
                        lastMessage: conv.messages?.[0],
                        isWithin24hWindow: conv.isWithin24hWindow
                    }));
                    
                    // Append to existing contacts
                    appendContacts(contactsData);
                    
                    // Update or remove load more button
                    if (currentOffset + 50 < result.pagination.total) {
                        const btn = document.querySelector('#load-more-btn button');
                        if (btn) {
                            btn.textContent = `Load More Conversations (Showing ${currentOffset + 50} of ${result.pagination.total})`;
                        }
                    } else {
                        document.getElementById('load-more-btn')?.remove();
                    }
                }
            } catch (error) {
                console.error('Error loading more conversations:', error);
                showNotification('Failed to load more conversations', 'error');
            }
        }
        
        // Append contacts to existing list
        function appendContacts(contacts) {
            const contactsList = document.getElementById('contacts-list');
            const loadMoreBtn = document.getElementById('load-more-btn');
            
            contacts.forEach((contact, index) => {
                const conversation = contact.conversations?.[0];
                const lastMessage = conversation?.messages?.[0];
                const unreadCount = conversation?.unreadCount || 0;
                
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.dataset.contactId = contact.id;
                contactItem.dataset.conversationId = conversation?.id || '';
                contactItem.dataset.lastActivity = contact.lastMessageAt || '';
                contactItem.style.animationDelay = `${index * 50}ms`;
                
                console.log(`Contact item created - ID: ${contact.id}, Conv ID: ${conversation?.id}`);
                contactItem.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    selectContact(contact, conversation, contactItem);
                };
                
                // Check if it's a group chat
                const isGroup = contact.isGroup || false;
                const groupIcon = isGroup ? 'group' : 'person';
                const avatarBg = isGroup ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'linear-gradient(135deg, #3b82f6, #2563eb)';
                
                // Debug group info
                if (isGroup) {
                    console.log('Group info:', {
                        name: contact.name,
                        groupName: contact.groupName,
                        phoneNumber: contact.phoneNumber,
                        groupId: contact.groupId
                    });
                }
                
                contactItem.innerHTML = `
                    <div class="contact-avatar" style="background: ${avatarBg}">
                        ${isGroup ? 
                            `<span class="material-icons" style="color: white; font-size: 24px;">${groupIcon}</span>` : 
                            getInitials(contact.name || contact.phoneNumber)
                        }
                    </div>
                    <div class="contact-info">
                        <div class="contact-name" style="display: flex; align-items: center; gap: 6px;">
                            ${contact.name || contact.groupName || contact.phoneNumber}
                            ${isGroup ? `<span style="color: #94a3b8; font-size: 12px;">(${contact.participantCount || 0} members)</span>` : ''}
                        </div>
                        <div class="contact-message">
                            ${lastMessage?.isGroupMessage && lastMessage?.groupParticipant ? 
                                `<span style="color: #60a5fa;">${formatSenderName(lastMessage.groupParticipant)}:</span> ` : 
                                ''
                            }
                            ${getMessagePreview(lastMessage)}
                        </div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${formatTime(lastMessage?.createdAt)}</div>
                        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                    </div>
                `;
                
                // Insert before load more button if it exists
                if (loadMoreBtn) {
                    contactsList.insertBefore(contactItem, loadMoreBtn);
                } else {
                    contactsList.appendChild(contactItem);
                }
            });
        }
        
        // Display contacts in UI
        function displayContacts(contacts) {
            console.log('=== displayContacts called ===');
            console.log('Number of contacts:', contacts.length);
            
            const contactsList = document.getElementById('contacts-list');
            if (!contactsList) {
                console.error('ERROR: contacts-list element not found!');
                return;
            }
            
            console.log('Clearing contacts list...');
            contactsList.innerHTML = '';
            
            if (contacts.length === 0) {
                // Show empty state message
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-state-content">
                        <span class="material-icons empty-state-icon">search_off</span>
                        <h3 class="empty-state-title">No contacts found</h3>
                        <p class="empty-state-message">
                            ${currentSearchTerm ? 
                                `No contacts match your search for "${currentSearchTerm}"` : 
                                currentFilter === 'unread' ? 
                                    'No unread conversations found' :
                                    currentFilter === 'groups' ?
                                        'No group conversations found' :
                                        'No contacts available'
                            }
                        </p>
                        ${currentSearchTerm ? 
                            '<button class="clear-search-btn-empty" onclick="clearSearch()">Clear Search</button>' : 
                            ''
                        }
                    </div>
                `;
                contactsList.appendChild(emptyState);
                return;
            }
            
            contacts.forEach((contact, index) => {
                console.log(`Processing contact ${index}:`, contact);
                const conversation = contact.conversations?.[0];
                const lastMessage = conversation?.messages?.[0];
                const unreadCount = conversation?.unreadCount || 0;
                
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.dataset.contactId = contact.id;
                contactItem.dataset.conversationId = conversation?.id || '';
                contactItem.dataset.lastActivity = contact.lastMessageAt || '';
                contactItem.style.animationDelay = `${index * 50}ms`;
                
                console.log(`Contact item created - ID: ${contact.id}, Conv ID: ${conversation?.id}`);
                contactItem.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    selectContact(contact, conversation, contactItem);
                };
                
                // Check if it's a group chat
                const isGroup = contact.isGroup || false;
                const groupIcon = isGroup ? 'group' : 'person';
                const avatarBg = isGroup ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'linear-gradient(135deg, #3b82f6, #2563eb)';
                
                // Debug group info
                if (isGroup) {
                    console.log('Group info:', {
                        name: contact.name,
                        groupName: contact.groupName,
                        phoneNumber: contact.phoneNumber,
                        groupId: contact.groupId
                    });
                }
                
                contactItem.innerHTML = `
                    <div class="contact-avatar" style="background: ${avatarBg}">
                        ${isGroup ? 
                            `<span class="material-icons" style="color: white; font-size: 24px;">${groupIcon}</span>` : 
                            getInitials(contact.name || contact.phoneNumber)
                        }
                    </div>
                    <div class="contact-info">
                        <div class="contact-name" style="display: flex; align-items: center; gap: 6px;">
                            ${contact.name || contact.groupName || contact.phoneNumber}
                            ${isGroup ? `<span style="color: #94a3b8; font-size: 12px;">(${contact.participantCount || 0} members)</span>` : ''}
                        </div>
                        <div class="contact-message">
                            ${lastMessage?.isGroupMessage && lastMessage?.groupParticipant ? 
                                `<span style="color: #60a5fa;">${formatSenderName(lastMessage.groupParticipant)}:</span> ` : 
                                ''
                            }
                            ${getMessagePreview(lastMessage)}
                        </div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${formatTime(lastMessage?.createdAt)}</div>
                        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                    </div>
                `;
                
                contactsList.appendChild(contactItem);
            });
        }
        
        // Select contact and load conversation
        async function selectContact(contact, conversation, element = null) {
            console.log('Selecting contact:', contact);
            currentContact = contact;
            
            // Update UI
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked element
            if (element) {
                element.classList.add('active');
            }
            
            // Update chat header
            updateChatHeader(contact);
            
            // Clear current messages
            const messagesArea = document.getElementById('messages-area');
            messagesArea.innerHTML = '<div class="loading-messages">Loading messages...</div>';
            
            // Load or create conversation
            try {
                if (conversation) {
                    currentConversation = conversation;
                    await loadMessages(conversation.id);
                } else {
                    await createConversation(contact.id);
                }
                
                // Join socket room
                if (currentConversation && socket) {
                    socket.emit('join:conversation', currentConversation.id);
                }
            } catch (error) {
                console.error('Error selecting contact:', error);
                messagesArea.innerHTML = '<div class="error-message">Failed to load messages</div>';
            }
        }
        
        // Update chat header - FRESH START
        function updateChatHeader(contact) {
            console.log('=== CHAT HEADER UPDATE ===');
            console.log('Contact data:', contact);
            
            const isGroup = contact.isGroup || false;
            
            // 1. Update Avatar
            updateHeaderAvatar(contact, isGroup);
            
            // 2. Update Title
            updateHeaderTitle(contact, isGroup);
            
            // 3. Update Status/Info Line
            updateHeaderStatus(contact, isGroup);
        }
        
        function updateHeaderAvatar(contact, isGroup) {
            const avatarElement = document.querySelector('.chat-header-avatar');
            if (!avatarElement) return;
            
            avatarElement.className = `chat-header-avatar ${isGroup ? 'group-avatar' : ''}`;
            
            if (isGroup) {
                avatarElement.innerHTML = '<span class="material-icons">group</span>';
            } else {
                avatarElement.textContent = getInitials(contact.name || contact.phoneNumber || 'U');
            }
        }
        
        function updateHeaderTitle(contact, isGroup) {
            const titleElement = document.querySelector('.chat-header-details h3');
            if (!titleElement) return;
            
            let title;
            if (isGroup) {
                title = contact.groupName || contact.name || 'WhatsApp Group';
            } else {
                title = contact.name || contact.phoneNumber || 'WhatsApp Contact';
            }
            
            titleElement.textContent = title;
            console.log('Title set to:', title);
        }
        
        function updateHeaderStatus(contact, isGroup) {
            const statusElement = document.querySelector('.chat-header-details .chat-status');
            if (!statusElement) return;
            
            statusElement.className = 'chat-status';
            
            if (isGroup) {
                // GROUP: Show member count
                const memberCount = contact.participantCount || 0;
                statusElement.innerHTML = `
                    <div class="header-status-content">
                        <span class="material-icons status-icon">people</span>
                        <span class="status-text">${memberCount} members</span>
                    </div>
                `;
            } else {
                // INDIVIDUAL: Show phone + last seen with better styling
                let phoneNumber = contact.phoneNumber || contact.phone || contact.id || 'Unknown';
                
                // Format phone number for better display
                if (phoneNumber && phoneNumber !== 'Unknown') {
                    // Clean up phone number
                    phoneNumber = phoneNumber.replace('@c.us', '').replace('@s.whatsapp.net', '');
                    // Add + if it starts with digits and doesn't have +
                    if (/^\d+$/.test(phoneNumber) && !phoneNumber.startsWith('+')) {
                        phoneNumber = '+' + phoneNumber;
                    }
                }
                
                const lastSeen = getLastSeenStatus(contact);
                
                console.log('Individual contact header update:', { 
                    originalPhone: contact.phoneNumber,
                    formattedPhone: phoneNumber, 
                    lastSeen,
                    contactData: contact 
                });
                
                // Display phone number and last seen in a simple, visible way
                statusElement.innerHTML = `
                    <div style="display: block !important;">
                        <div style="
                            font-size: 14px !important;
                            color: #e2e8f0 !important;
                            font-weight: 500 !important;
                            margin-bottom: 2px !important;
                        ">${phoneNumber}</div>
                        ${lastSeen ? `<div style="
                            font-size: 12px !important;
                            color: #94a3b8 !important;
                        ">${lastSeen}</div>` : ''}
                    </div>
                `;
            }
        }
        
        // Create new conversation
        async function createConversation(contactId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/conversations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contactId,
                        sessionId: API_CONFIG.sessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentConversation = result.data;
                    loadMessages(currentConversation.id);
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
            }
        }
        
        // Load messages
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/messages/${conversationId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayMessages(result.data);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        // Display messages
        function displayMessages(messages) {
            const messagesArea = document.getElementById('messages-area');
            messagesArea.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = createMessageElement(message);
                messagesArea.appendChild(messageDiv);
            });
            
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Analyze messages for contact info
            analyzeConversation(messages);
        }
        
        // Create message element with media support
        function createMessageElement(message) {
            // Debug log
            console.log('Creating message:', {
                id: message.id,
                type: message.messageType,
                mediaId: message.mediaId,
                mediaUrl: message.mediaUrl,
                content: message.content,
                hasContent: !!message.content,
                contentLength: message.content ? message.content.length : 0,
                isGroupMessage: message.isGroupMessage,
                groupParticipant: message.groupParticipant,
                direction: message.direction
            });
            
            // Extra check for problematic messages - only warn for actual text messages, not media
            if (!message.content && message.messageType === 'text' && !message.mediaId && !message.mediaUrl) {
                console.warn('Text message with no content:', message);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.direction === 'inbound' ? 'received' : 'sent'}`;
            messageDiv.dataset.messageId = message.whatsappMessageId || message.id;
            
            let messageContent = '';
            
            // Handle different message types - also check for 'chat' type with media
            if (message.messageType === 'chat' && message.mediaId) {
                // Force to image type if has mediaId but type is chat
                console.log('Converting chat with mediaId to image type');
                message.messageType = 'image';
            }
            
            switch (message.messageType) {
                case 'image':
                    messageContent = renderImageMessage(message);
                    break;
                case 'video':
                    messageContent = renderVideoMessage(message);
                    break;
                case 'audio':
                    messageContent = renderAudioMessage(message);
                    break;
                case 'document':
                    messageContent = renderDocumentMessage(message);
                    break;
                case 'location':
                    messageContent = renderLocationMessage(message);
                    break;
                case 'contact':
                    messageContent = renderContactMessage(message);
                    break;
                case 'sticker':
                    messageContent = renderStickerMessage(message);
                    break;
                case 'chat':
                    // System messages
                    messageContent = `<div class="message-text" style="color: #64748b; font-style: italic;">[System message]</div>`;
                    break;
                case 'e2e_notification':
                    messageContent = `<div class="message-text" style="color: #64748b; font-style: italic;"> Messages are end-to-end encrypted</div>`;
                    break;
                case 'gp2':
                    messageContent = `<div class="message-text" style="color: #64748b; font-style: italic;">[Group notification]</div>`;
                    break;
                case 'pinned_message':
                    messageContent = `<div class="message-text" style="color: #64748b; font-style: italic;"> Pinned message</div>`;
                    break;
                case 'revoked':
                    messageContent = `<div class="message-text" style="color: #64748b; font-style: italic;"> This message was deleted</div>`;
                    break;
                default:
                    // For text messages or empty content
                    if (!message.content || message.content.trim() === '') {
                        // Check if it's a media message without caption
                        if (message.mediaId || message.mediaUrl) {
                            messageContent = `<div class="message-text" style="color: #64748b; font-style: italic;">[Media without caption]</div>`;
                        } else {
                            messageContent = `<div class="message-text" style="color: #64748b; font-style: italic;">[Empty message]</div>`;
                        }
                    } else {
                        messageContent = `<div class="message-text">${message.content}</div>`;
                    }
            }
            
            // Add group participant info for group messages
            let senderInfoHtml = '';
            if (message.isGroupMessage && message.groupParticipant && message.direction === 'inbound') {
                console.log('Group message participant:', {
                    raw: message.groupParticipant,
                    fromNumber: message.fromNumber,
                    toNumber: message.toNumber,
                    wholeMessage: message
                });
                
                const senderInfo = formatSenderInfo(message.groupParticipant);
                const colorIndex = getSenderColorIndex(message.groupParticipant);
                
                console.log('Formatted sender info:', senderInfo);
                
                senderInfoHtml = `
                    <div class="message-sender-info">
                        <div class="sender-avatar sender-color-${colorIndex}">
                            ${senderInfo.initials}
                        </div>
                        <div class="sender-details">
                            <div class="sender-name">${senderInfo.name}</div>
                        </div>
                    </div>
                `;
                
                // Add group-message class to the message div
                messageDiv.classList.add('group-message');
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${senderInfoHtml}
                    ${messageContent}
                    <div class="message-time">
                        ${formatTime(message.createdAt)}
                        ${message.direction === 'outbound' ? getStatusIcon(message.status) : ''}
                    </div>
                </div>
            `;
            
            return messageDiv;
        }
        
        // Render image message
        function renderImageMessage(message) {
            // Build media URL - use backend endpoint for WAHA media
            let imageUrl = message.mediaUrl || (message.mediaId ? `${API_CONFIG.baseUrl}/messages/media/${message.mediaId}` : '');
            
            // If mediaUrl is relative, prepend the base URL (without /api)
            if (imageUrl && imageUrl.startsWith('/')) {
                // Remove /api from baseUrl and append the mediaUrl
                const baseUrl = API_CONFIG.baseUrl.replace(/\/api$/, '');
                imageUrl = baseUrl + imageUrl;
            }
            
            const thumbnailUrl = message.thumbnailUrl || imageUrl;
            const caption = message.mediaCaption || message.content || '';
            
            return `
                <div class="message-media">
                    ${imageUrl ? 
                        `<img src="${thumbnailUrl}" alt="Image" onclick="openMediaViewer('${imageUrl}')" 
                            loading="lazy"
                            onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'message-media-loading\\'><span class=\\'material-icons\\' style=\\'color: #64748b;\\'>broken_image</span></div>'" />` :
                        `<div class="message-media-loading">
                            <span class="material-icons" style="color: #64748b;">image</span>
                            <div style="color: #64748b; font-size: 12px; margin-top: 8px;">Loading image...</div>
                        </div>`
                    }
                </div>
                ${caption ? `<div class="message-caption">${caption}</div>` : ''}
            `;
        }
        
        // Render video message
        function renderVideoMessage(message) {
            let videoUrl = message.mediaUrl || (message.mediaId ? `${API_CONFIG.baseUrl}/messages/media/${message.mediaId}` : '');
            
            // If mediaUrl is relative, prepend the base URL (without /api)
            if (videoUrl && videoUrl.startsWith('/')) {
                // Remove /api from baseUrl and append the mediaUrl
                const baseUrl = API_CONFIG.baseUrl.replace(/\/api$/, '');
                videoUrl = baseUrl + videoUrl;
            }
            
            const thumbnailUrl = message.thumbnailUrl || '';
            const caption = message.mediaCaption || message.content || '';
            const duration = message.mediaDuration ? formatDuration(message.mediaDuration) : '';
            
            return `
                <div class="message-media">
                    ${videoUrl ? 
                        `<div class="video-container" style="position: relative;">
                            ${thumbnailUrl ? 
                                `<img src="${thumbnailUrl}" alt="Video thumbnail" style="max-width: 100%; max-height: 300px; border-radius: 12px; cursor: pointer;" 
                                    onclick="playVideo(this, '${videoUrl}')" />
                                <div class="play-button" onclick="playVideo(this.previousElementSibling, '${videoUrl}')" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                    <span class="material-icons" style="color: white; font-size: 32px;">play_arrow</span>
                                </div>` :
                                `<video controls style="max-width: 100%; max-height: 300px; border-radius: 12px;">
                                    <source src="${videoUrl}" type="${message.mediaMimeType || 'video/mp4'}">
                                    Your browser does not support the video tag.
                                </video>`
                            }
                            ${duration ? `<div class="video-duration" style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${duration}</div>` : ''}
                        </div>` :
                        `<div class="message-media-loading">
                            <span class="material-icons" style="color: #64748b;">videocam</span>
                            <div style="color: #64748b; font-size: 12px; margin-top: 8px;">Loading video...</div>
                        </div>`
                    }
                </div>
                ${caption ? `<div class="message-caption">${caption}</div>` : ''}
            `;
        }
        
        // Render audio message
        function renderAudioMessage(message) {
            const audioUrl = message.mediaUrl || (message.mediaId ? `${API_CONFIG.baseUrl}/messages/media/${message.mediaId}` : '');
            const duration = message.mediaDuration ? formatDuration(message.mediaDuration) : '';
            
            return `
                <div style="padding: 8px;">
                    <div class="message-audio" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                        <div class="audio-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: white;">headset</span>
                        </div>
                        ${audioUrl ? 
                            `<div style="flex: 1;">
                                <audio controls style="width: 100%; max-width: 300px;">
                                    <source src="${audioUrl}" type="${message.mediaMimeType || 'audio/mpeg'}">
                                    Your browser does not support the audio tag.
                                </audio>
                                ${duration ? `<div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">Duration: ${duration}</div>` : ''}
                            </div>` :
                            `<div class="message-media-loading" style="flex: 1; text-align: center;">
                                <span class="material-icons" style="color: #64748b;">audiotrack</span>
                                <div style="color: #64748b; font-size: 12px;">Loading audio...</div>
                            </div>`
                        }
                    </div>
                </div>
            `;
        }
        
        // Render document message
        function renderDocumentMessage(message) {
            let docUrl = message.mediaUrl || (message.mediaId ? `${API_CONFIG.baseUrl}/messages/media/${message.mediaId}` : '');
            
            // If mediaUrl is relative, prepend the base URL (without /api)
            if (docUrl && docUrl.startsWith('/')) {
                // Remove /api from baseUrl and append the mediaUrl
                const baseUrl = API_CONFIG.baseUrl.replace(/\/api$/, '');
                docUrl = baseUrl + docUrl;
            }
            
            const fileName = message.fileName || message.content || 'Document';
            const fileSize = message.mediaSize ? formatFileSize(message.mediaSize) : '';
            const fileIcon = getFileIcon(message.mediaMimeType);
            
            return `
                <div class="message-document" ${docUrl ? `onclick="window.open('${docUrl}', '_blank')"` : ''} 
                    style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(71, 85, 105, 0.2); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                    <div class="document-icon" style="background: linear-gradient(135deg, #60a5fa, #3b82f6); border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="color: white; font-size: 24px;">${fileIcon}</span>
                    </div>
                    <div class="document-info" style="flex: 1;">
                        <div class="document-name" style="color: #e2e8f0; font-weight: 500; word-break: break-word;">${fileName}</div>
                        ${fileSize ? `<div class="document-size" style="color: #94a3b8; font-size: 12px; margin-top: 2px;">${fileSize}</div>` : ''}
                    </div>
                    <span class="material-icons" style="color: #64748b;">download</span>
                </div>
            `;
        }
        
        // Get file icon based on mime type
        function getFileIcon(mimeType) {
            if (!mimeType) return 'description';
            
            if (mimeType.includes('pdf')) return 'picture_as_pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'description';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'table_chart';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'slideshow';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('compressed')) return 'folder_zip';
            if (mimeType.includes('text')) return 'text_snippet';
            
            return 'insert_drive_file';
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Format duration for audio/video
        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Render location message
        function renderLocationMessage(message) {
            const lat = message.locationLatitude;
            const lng = message.locationLongitude;
            const name = message.locationName || 'Location';
            const address = message.locationAddress || '';
            
            if (!lat || !lng) {
                return `<div class="message-text"> Location</div>`;
            }
            
            const mapUrl = `https://maps.google.com/maps?q=${lat},${lng}`;
            const staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=300x200&markers=color:red%7C${lat},${lng}&key=YOUR_API_KEY`;
            
            return `
                <div class="message-location" onclick="window.open('${mapUrl}', '_blank')" style="cursor: pointer;">
                    <div class="location-preview" style="width: 280px; height: 150px; background: #1e293b; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                        <span class="material-icons" style="font-size: 48px; color: #64748b;">location_on</span>
                    </div>
                    <div class="location-info" style="padding: 8px;">
                        <div style="color: #e2e8f0; font-weight: 500;">${name}</div>
                        ${address ? `<div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">${address}</div>` : ''}
                        <div style="color: #60a5fa; font-size: 12px; margin-top: 4px;">Tap to open in maps</div>
                    </div>
                </div>
            `;
        }

        // Render contact message
        function renderContactMessage(message) {
            const vcard = message.contactVcard || '';
            const contactName = message.content || 'Contact';
            
            return `
                <div class="message-contact" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                    <div class="contact-avatar" style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons" style="color: white;">person</span>
                    </div>
                    <div class="contact-info" style="flex: 1;">
                        <div style="color: #e2e8f0; font-weight: 500;">${contactName}</div>
                        <div style="color: #94a3b8; font-size: 12px; margin-top: 2px;">Contact Card</div>
                    </div>
                    ${vcard ? `<span class="material-icons" style="color: #64748b; cursor: pointer;" onclick="downloadVCard('${btoa(vcard)}', '${contactName}')">download</span>` : ''}
                </div>
            `;
        }

        // Render sticker message
        function renderStickerMessage(message) {
            const stickerUrl = message.mediaUrl || (message.mediaId ? `${API_CONFIG.baseUrl}/messages/media/${message.mediaId}` : '');
            
            return `
                <div class="message-sticker">
                    ${stickerUrl ? 
                        `<img src="${stickerUrl}" alt="Sticker" style="max-width: 150px; max-height: 150px;" />` :
                        `<div class="message-media-loading" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #64748b;">emoji_emotions</span>
                        </div>`
                    }
                </div>
            `;
        }

        // Helper function to play video
        function playVideo(thumbnail, videoUrl) {
            const container = thumbnail.parentElement;
            container.innerHTML = `
                <video controls autoplay style="max-width: 100%; max-height: 300px; border-radius: 12px;">
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            `;
        }

        // Helper function to download vCard
        function downloadVCard(encodedVcard, name) {
            const vcard = atob(encodedVcard);
            const blob = new Blob([vcard], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.vcf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Open media viewer (for images)
        // Image Modal Variables
        let currentZoom = 1;
        let currentRotation = 0;
        let imageUrl = '';
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let translateX = 0;
        let translateY = 0;
        
        function openMediaViewer(url) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const loading = document.getElementById('modalLoading');
            const container = document.getElementById('imageContainer');
            
            // Reset states
            currentZoom = 1;
            currentRotation = 0;
            translateX = 0;
            translateY = 0;
            imageUrl = url;
            
            // Show modal with animation
            modal.style.display = 'block';
            loading.classList.add('show');
            
            // Force reflow
            modal.offsetHeight;
            
            // Add show class for animation
            modal.classList.add('show');
            
            // Create new image to load full resolution
            const img = new Image();
            img.onload = function() {
                modalImage.src = url;
                loading.classList.remove('show');
                updateImageTransform();
            };
            
            img.onerror = function() {
                loading.textContent = 'Failed to load image';
                setTimeout(() => closeImageModal(), 2000);
            };
            
            img.src = url;
            
            // Add mouse events for panning
            container.addEventListener('mousedown', startDrag);
            container.addEventListener('mousemove', drag);
            container.addEventListener('mouseup', endDrag);
            container.addEventListener('mouseleave', endDrag);
            
            // Add touch events for mobile
            container.addEventListener('touchstart', startDrag);
            container.addEventListener('touchmove', drag);
            container.addEventListener('touchend', endDrag);
            
            // Add wheel event for zoom
            container.addEventListener('wheel', handleWheel);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyPress);
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const container = document.getElementById('imageContainer');
            
            modal.classList.remove('show');
            
            // Remove event listeners
            container.removeEventListener('mousedown', startDrag);
            container.removeEventListener('mousemove', drag);
            container.removeEventListener('mouseup', endDrag);
            container.removeEventListener('mouseleave', endDrag);
            container.removeEventListener('touchstart', startDrag);
            container.removeEventListener('touchmove', drag);
            container.removeEventListener('touchend', endDrag);
            container.removeEventListener('wheel', handleWheel);
            document.removeEventListener('keydown', handleKeyPress);
            
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('modalImage').src = '';
            }, 300);
        }
        
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 5);
            updateImageTransform();
        }
        
        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.5);
            updateImageTransform();
        }
        
        function resetZoom() {
            currentZoom = 1;
            currentRotation = 0;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
        }
        
        function rotateImage() {
            currentRotation += 90;
            updateImageTransform();
        }
        
        function updateImageTransform() {
            const modalImage = document.getElementById('modalImage');
            const zoomLevel = document.getElementById('zoomLevel');
            
            modalImage.style.transform = `translate(-50%, -50%) scale(${currentZoom}) rotate(${currentRotation}deg) translate(${translateX}px, ${translateY}px)`;
            zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
        }
        
        function downloadImage() {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = 'whatsapp-image-' + new Date().getTime() + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function startDrag(e) {
            if (currentZoom <= 1) return;
            
            isDragging = true;
            document.getElementById('imageContainer').classList.add('grabbing');
            
            startX = (e.type === 'mousedown' ? e.clientX : e.touches[0].clientX) - translateX;
            startY = (e.type === 'mousedown' ? e.clientY : e.touches[0].clientY) - translateY;
            
            e.preventDefault();
        }
        
        function drag(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            const currentX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
            const currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
            
            translateX = currentX - startX;
            translateY = currentY - startY;
            
            updateImageTransform();
        }
        
        function endDrag() {
            isDragging = false;
            document.getElementById('imageContainer').classList.remove('grabbing');
        }
        
        function handleWheel(e) {
            e.preventDefault();
            
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        }
        
        function handleKeyPress(e) {
            switch(e.key) {
                case 'Escape':
                    closeImageModal();
                    break;
                case '+':
                case '=':
                    zoomIn();
                    break;
                case '-':
                case '_':
                    zoomOut();
                    break;
                case '0':
                    resetZoom();
                    break;
                case 'r':
                case 'R':
                    rotateImage();
                    break;
                case 'd':
                case 'D':
                    downloadImage();
                    break;
            }
        }
        
        // Click outside to close
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                return; // Empty message, do nothing
            }
            
            if (!currentContact || !currentConversation) {
                showNotification('Please select a contact first to send a message', 'warning');
                return;
            }
            
            // Check compliance before sending
            if (!checkComplianceBeforeSend()) {
                return;
            }
            
            console.log('Sending message:', { conversationId: currentConversation.id, toNumber: currentContact.phoneNumber });
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/messages/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversationId: currentConversation.id,
                        toNumber: currentContact.phoneNumber,
                        content: message,
                        messageType: 'text'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    input.value = '';
                    input.style.height = 'auto';
                    
                    // Add optimistic UI update
                    const tempId = 'temp-' + Date.now();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message sent';
                    messageDiv.dataset.messageId = tempId;
                    messageDiv.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-text">${message}</div>
                            <div class="message-time">
                                ${formatTime(new Date())}
                                ${getStatusIcon('pending')}
                            </div>
                        </div>
                    `;
                    
                    // Store temp ID mapping for later update
                    if (result.data && result.data.id) {
                        messageDiv.dataset.messageId = result.data.whatsappMessageId || result.data.id;
                    }
                    
                    document.getElementById('messages-area').appendChild(messageDiv);
                    document.getElementById('messages-area').scrollTop = document.getElementById('messages-area').scrollHeight;
                } else {
                    // Check for rate limit error
                    if (response.status === 429) {
                        const retryAfter = result.retryAfter || 60;
                        showNotification(`Rate limit exceeded. Please wait ${retryAfter} seconds before sending more messages.`, 'warning');
                        
                        // Disable input temporarily
                        input.disabled = true;
                        const sendBtn = document.querySelector('.send-btn');
                        if (sendBtn) {
                            sendBtn.disabled = true;
                            setTimeout(() => {
                                input.disabled = false;
                                if (sendBtn) sendBtn.disabled = false;
                                input.focus();
                            }, retryAfter * 1000);
                        }
                    } else {
                        showNotification('Failed to send message: ' + (result.error || 'Unknown error'), 'error');
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    conversationId: currentConversation?.id,
                    toNumber: currentContact?.phoneNumber
                });
                showNotification('Failed to send message: ' + error.message, 'error');
            }
        }
        
        // Format time for display
        function formatTime(date) {
            const d = new Date(date);
            const hours = d.getHours().toString().padStart(2, '0');
            const minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Get color index for sender based on phone number
        function getSenderColorIndex(phoneNumber) {
            if (!phoneNumber) return 1;
            
            // Generate a hash from the phone number
            let hash = 0;
            for (let i = 0; i < phoneNumber.length; i++) {
                const char = phoneNumber.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            
            // Return a color index between 1-6
            return (Math.abs(hash) % 6) + 1;
        }

        // Format sender information - Clean display with phone only
        function formatSenderInfo(participant) {
            if (!participant) return { name: 'Unknown', phone: '', initials: '?' };
            
            let phone = participant;
            let initials = '?';
            
            // Extract phone number if it includes @c.us or @s.whatsapp.net
            if (participant.includes('@')) {
                phone = participant.split('@')[0];
            }
            
            // Format phone number for display
            if (/^\d+$/.test(phone)) {
                // It's a phone number - format it nicely
                const phoneDigits = phone.replace(/\D/g, '');
                
                let displayName;
                // Try to format as Indonesian number first
                if (phoneDigits.startsWith('62')) {
                    const localNumber = phoneDigits.substring(2);
                    if (localNumber.length >= 7) {
                        displayName = `+62 ${localNumber.substring(0, 3)}-${localNumber.substring(3, 7)}-${localNumber.substring(7)}`;
                    } else {
                        displayName = `+62 ${localNumber}`;
                    }
                } else {
                    // Generic formatting
                    displayName = '+' + phoneDigits;
                }
                
                // Generate initials from phone number (last 2 digits)
                initials = phoneDigits.slice(-2);
                
                return { name: displayName, phone: '', initials: initials, isPhoneOnly: true };
            }
            
            // If it's not just numbers, treat it as a name
            // Generate initials from name
            const nameParts = phone.split(' ');
            if (nameParts.length >= 2) {
                initials = nameParts[0][0] + nameParts[1][0];
            } else if (phone.length > 0) {
                initials = phone.substring(0, 2);
            }
            
            return { name: phone, phone: '', initials: initials.toUpperCase(), isPhoneOnly: false };
        }
        
        // Display new message in chat area
        function displayNewMessage(message) {
            console.log('Displaying new message:', message);
            
            const messagesArea = document.getElementById('messages-area');
            if (!messagesArea) {
                console.error('Messages area not found');
                return;
            }
            
            const messageDiv = createMessageElement(message);
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Show notification if message is inbound
            if (message.direction === 'inbound') {
                showNotification(`New message from ${currentContact?.name || 'Unknown'}`, 'info');
            }
        }
        
        // Initialize Socket.IO listeners
        function initializeSocketListeners() {
            // Listen for connection success
            socket.on('connect:success', (data) => {
                console.log('Socket connection successful:', data);
            });

            // Join default session room
            socket.emit('join:session', API_CONFIG.sessionId);

            // Listen for join success
            socket.on('join:session:success', (data) => {
                console.log('Successfully joined session:', data.sessionId);
            });
            
            // Listen for QR code
            socket.on('session:qr', (data) => {
                console.log('QR code received:', data);
                if (data.sessionName === API_CONFIG.sessionId && data.qr) {
                    showQRModal(data.qr);
                }
            });
            
            // Listen for connection success
            socket.on('session:connected', (data) => {
                console.log('WhatsApp connected:', data);
                closeQRModal();
                updateConnectionStatus('connected', data);
                // Only load contacts if not already loaded
                if (!contactsLoaded) {
                    loadContacts();
                }
            });
            
            // Listen for chats loaded event
            socket.on('chats:loaded', (data) => {
                console.log('Chats loaded:', data);
                if (data.message) {
                    // Show a temporary message to user
                    showNotification(data.message, 'info');
                }
                // Reload contacts to show loaded chats
                setTimeout(() => {
                    loadContacts();
                }, 1000);
            });
            
            // Listen for new messages
            socket.on('message:new', (data) => {
                console.log('=== Socket: New message received ===', data);
                console.log('Conversation ID from message:', data.conversationId);
                console.log('Message:', data.message);
                
                if (currentConversation && data.conversationId === currentConversation.id) {
                    // Check if message already exists to avoid duplicates
                    const messageId = data.message?.whatsappMessageId || data.message?.id;
                    const existingMessage = document.querySelector(`[data-message-id="${messageId}"]`);
                    
                    if (!existingMessage) {
                        displayNewMessage(data.message);
                    } else {
                        console.log('Message already exists, skipping duplicate');
                        // Update status if needed
                        if (data.message?.status) {
                            updateMessageStatus(messageId, data.message.status);
                        }
                    }
                }
                
                // Update contact position with animation and message preview
                const messageContent = data.message?.content || '';
                updateContactPosition(data.conversationId, messageContent);
            });
            
            // Listen for conversation updates
            socket.on('conversation:updated', (data) => {
                console.log('Conversation updated:', data);
                // Update contact position with animation
                const messagePreview = data.conversation?.lastMessagePreview || '';
                updateContactPosition(data.conversationId || data.id, messagePreview);
            });
            
            // Listen for status updates
            socket.on('message:status', (update) => {
                updateMessageStatus(update.messageId, update.status);
            });
            
            // Listen for session status
            socket.on('session:status', (update) => {
                if (update.sessionId === API_CONFIG.sessionId) {
                    updateConnectionStatus(update.status);
                }
            });
            
            // Listen for conversation updates
            socket.on('conversation:update', (update) => {
                if (currentConversation && update.conversationId === currentConversation.id) {
                    // Update UI accordingly
                }
                
                // Don't update position here - it's already handled by conversation:updated
            });
        }
        
        // Remove duplicate displayNewMessage function - use the one above that calls createMessageElement
        
        // Update message status
        function updateMessageStatus(messageId, status) {
            console.log('Updating message status:', { messageId, status });
            
            // Find message element by ID
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) {
                console.log('Message element not found for ID:', messageId);
                return;
            }
            
            // Only update status for sent messages
            if (!messageElement.classList.contains('sent')) {
                return;
            }
            
            // Find the time element and update status icon
            const timeElement = messageElement.querySelector('.message-time');
            if (timeElement) {
                // Remove existing status icon
                const existingIcon = timeElement.querySelector('.material-icons');
                if (existingIcon) {
                    existingIcon.remove();
                }
                
                // Add new status icon
                timeElement.innerHTML = timeElement.textContent.trim() + ' ' + getStatusIcon(status);
            }
        }
        
        // Helper functions
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return parts[0][0] + parts[1][0];
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        function formatSenderName(participant) {
            if (!participant) return '';
            // Remove @c.us or @s.whatsapp.net
            let name = participant.split('@')[0];
            // Format phone number if it's just digits
            if (/^\d+$/.test(name)) {
                name = '+' + name;
            }
            return name;
        }

        // Get online status for contact
        function getOnlineStatus(contact) {
            // Generate mock status for demo purposes if no lastSeen data
            if (!contact.lastSeen) {
                // Generate random status based on contact ID for consistent behavior
                const hash = contact.id ? contact.id.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0) : 0;
                const randomStatus = Math.abs(hash) % 3;
                return ['online', 'recently', 'offline'][randomStatus];
            }
            
            const lastSeenTime = new Date(contact.lastSeen);
            const now = new Date();
            const diffMinutes = (now - lastSeenTime) / (1000 * 60);
            
            if (diffMinutes < 5) return 'online';
            if (diffMinutes < 60) return 'recently';
            return 'offline';
        }

        // Get last seen status text
        function getLastSeenStatus(contact) {
            // If no real lastSeen data, generate mock data for demo
            if (!contact.lastSeen) {
                const hash = contact.id ? contact.id.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0) : 0;
                const randomMinutes = Math.abs(hash) % 1440; // Random within 24 hours
                
                // Always show last seen for demo purposes (except for very recent)
                if (randomMinutes < 2) return null; // Only skip for very recent
                if (randomMinutes < 60) return `${Math.max(randomMinutes, 2)}m ago`;
                if (randomMinutes < 1440) return `${Math.floor(randomMinutes / 60)}h ago`;
                return 'Yesterday';
            }
            
            const lastSeenTime = new Date(contact.lastSeen);
            const now = new Date();
            const diffMinutes = (now - lastSeenTime) / (1000 * 60);
            const diffHours = diffMinutes / 60;
            const diffDays = diffHours / 24;
            
            if (diffMinutes < 5) return null; // Don't show for online users
            if (diffMinutes < 60) return `${Math.floor(diffMinutes)}m ago`;
            if (diffHours < 24) return `${Math.floor(diffHours)}h ago`;
            if (diffDays < 7) return `${Math.floor(diffDays)}d ago`;
            
            return lastSeenTime.toLocaleDateString();
        }

        // Get status text based on status class
        function getStatusText(contact, statusClass) {
            switch (statusClass) {
                case 'online':
                    return 'Online';
                case 'recently':
                    return 'Recently active';
                case 'offline':
                default:
                    return contact.phoneNumber || 'Offline';
            }
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
            if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            return date.toLocaleDateString();
        }
        
        // Update contact position with smooth animation
        function updateContactPosition(conversationId, messageContent = null) {
            console.log('=== updateContactPosition called ===');
            console.log('Conversation ID:', conversationId);
            console.log('Message content:', messageContent);
            
            const contactsList = document.getElementById('contacts-list');
            if (!contactsList) {
                console.error('Contacts list not found');
                return;
            }
            
            // Find the contact item by conversation ID
            const contactItem = contactsList.querySelector(`[data-conversation-id="${conversationId}"]`);
            console.log('Found contact item:', contactItem);
            
            if (!contactItem) {
                console.log('Contact item not found, not reloading to avoid duplicates');
                // Don't reload automatically to avoid duplicate contacts
                return;
            }
            
            // Update message preview if provided
            if (messageContent) {
                const messageElement = contactItem.querySelector('.contact-message');
                if (messageElement) {
                    messageElement.textContent = messageContent;
                    console.log('Updated message preview to:', messageContent);
                }
            }
            
            // Update last activity time
            const now = new Date().toISOString();
            contactItem.dataset.lastActivity = now;
            
            // Get all contact items
            const allContacts = Array.from(contactsList.querySelectorAll('.contact-item'));
            const currentIndex = allContacts.indexOf(contactItem);
            
            console.log('Current contact index:', currentIndex);
            console.log('Total contacts:', allContacts.length);
            
            // If already at top, just highlight
            if (currentIndex === 0) {
                console.log('Contact already at top, just highlighting');
                contactItem.classList.add('highlight');
                setTimeout(() => contactItem.classList.remove('highlight'), 1000);
                
                // Update time
                const timeElement = contactItem.querySelector('.contact-time');
                if (timeElement) timeElement.textContent = 'Just now';
                return;
            }
            
            // Calculate positions for smooth animation
            const contactRect = contactItem.getBoundingClientRect();
            const containerRect = contactsList.getBoundingClientRect();
            const startY = contactRect.top - containerRect.top;
            
            // Clone the contact for smooth animation
            const clone = contactItem.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.top = startY + 'px';
            clone.style.left = '0';
            clone.style.right = '0';
            clone.style.zIndex = '1000';
            clone.style.pointerEvents = 'none';
            clone.style.margin = '0';
            
            // Prepare container and hide original
            contactsList.style.position = 'relative';
            contactItem.style.opacity = '0';
            contactsList.appendChild(clone);
            
            // Get contacts that need to move down
            const itemsToMove = [];
            const itemHeight = contactItem.offsetHeight + 8;
            for (let i = 0; i < currentIndex; i++) {
                itemsToMove.push(allContacts[i]);
            }
            
            // Use requestAnimationFrame for smooth animation
            requestAnimationFrame(() => {
                // Apply smooth cubic-bezier transition
                const transitionStyle = 'all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1)';
                
                // Move clone to top
                clone.style.transition = transitionStyle;
                clone.style.top = '0px';
                
                // Move other items down smoothly
                itemsToMove.forEach((item, index) => {
                    item.style.transition = transitionStyle;
                    item.style.transform = `translateY(${itemHeight}px)`;
                });
                
                // After animation completes
                setTimeout(() => {
                    // Move in DOM
                    contactsList.insertBefore(contactItem, contactsList.firstChild);
                    
                    // Show original with fade in
                    contactItem.style.transition = 'opacity 0.2s ease-in';
                    contactItem.style.opacity = '1';
                    
                    // Remove clone
                    clone.remove();
                    
                    // Reset transforms with no transition
                    itemsToMove.forEach((item) => {
                        item.style.transition = 'none';
                        item.style.transform = '';
                    });
                    
                    // Force reflow to apply changes immediately
                    contactsList.offsetHeight;
                    
                    // Add subtle highlight
                    contactItem.style.transition = 'background-color 0.8s ease';
                    contactItem.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    
                    // Update time
                    const timeElement = contactItem.querySelector('.contact-time');
                    if (timeElement) timeElement.textContent = 'Just now';
                    
                    // Remove highlight after animation
                    setTimeout(() => {
                        contactItem.style.transition = '';
                        contactItem.style.backgroundColor = '';
                    }, 800);
                }, 500);
            });
        }
        
        function getStatusIcon(status) {
            const icons = {
                'pending': '<span class="material-icons" style="font-size: 16px; color: #64748b;">schedule</span>',
                'sent': '<span class="material-icons" style="font-size: 16px; color: #64748b;">done</span>',
                'delivered': '<span class="material-icons" style="font-size: 16px; color: #64748b;">done_all</span>',
                'read': '<span class="material-icons" style="font-size: 16px; color: #3b82f6;">done_all</span>',
                'failed': '<span class="material-icons" style="font-size: 16px; color: #ef4444;">error</span>'
            };
            
            return icons[status] || '';
        }

        // Get message preview for contact list
        function getMessagePreview(message) {
            if (!message) return 'No messages yet';
            
            if (message.content) {
                return message.content;
            }
            
            // Show media type with emoji
            const mediaTypeEmoji = {
                'image': ' Photo',
                'video': ' Video',
                'audio': ' Audio',
                'document': ' Document',
                'location': ' Location',
                'contact': ' Contact',
                'sticker': ' Sticker'
            };
            
            return mediaTypeEmoji[message.messageType] || `[${message.messageType || 'Message'}]`;
        }
        
        // Update contact info panel
        function updateContactInfoPanel(contact) {
            // Reset all fields to default
            document.getElementById('contact-email').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-location').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-package').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-status').textContent = 'Belum teridentifikasi';
            document.getElementById('contact-keywords').textContent = 'Belum teridentifikasi';
            document.getElementById('total-messages').textContent = '0';
            document.getElementById('first-contact').textContent = '-';
            document.getElementById('last-chat').textContent = '-';
            document.getElementById('contact-media').textContent = '0 Photos, 0 Documents';
            
            // Update labels
            const labelsContainer = document.getElementById('contact-labels');
            labelsContainer.innerHTML = '<span class="label-tag">Belum ada label</span>';
        }
        
        // Analyze conversation to extract contact info
        function analyzeConversation(messages) {
            if (!messages || messages.length === 0) return;
            
            // Extract information from messages
            const analysis = {
                email: null,
                location: null,
                package: null,
                status: null,
                keywords: new Set(),
                mediaCount: { photos: 0, documents: 0 },
                firstContact: null,
                lastContact: null,
                totalMessages: messages.length
            };
            
            // Email pattern
            const emailPattern = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            
            // Location patterns
            const locationPatterns = [
                /\b(jakarta|bandung|surabaya|medan|semarang|makassar|palembang|tangerang|depok|bekasi)\b/gi,
                /\b(jawa\s*(barat|timur|tengah)|sumatra|kalimantan|sulawesi|bali)\b/gi
            ];
            
            // Package patterns
            const packagePatterns = [
                /\b(paket\s*(regular|vip|eksekutif|ekonomi|premium))\b/gi,
                /\b(ramadhan|syawal|dzulhijjah|muharram)\s*\d{4}/gi,
                /\b(9\s*hari|12\s*hari|15\s*hari|21\s*hari|plus\s*turki)\b/gi
            ];
            
            // Status patterns
            const statusPatterns = {
                'Prospek': /\b(tanya|info|berapa|harga|jadwal|kapan)\b/gi,
                'Hot Prospect': /\b(serius|minat|tertarik|booking|daftar)\b/gi,
                'Jamaah': /\b(sudah\s*transfer|dp|lunas|bayar)\b/gi,
                'Repeat': /\b(lagi|kembali|umroh\s*ke-?\d+)\b/gi
            };
            
            // Analyze each message
            messages.forEach((message, index) => {
                const content = message.content || '';
                
                // Extract email
                const emailMatches = content.match(emailPattern);
                if (emailMatches && !analysis.email) {
                    analysis.email = emailMatches[0];
                }
                
                // Extract location
                locationPatterns.forEach(pattern => {
                    const matches = content.match(pattern);
                    if (matches && !analysis.location) {
                        analysis.location = matches[0];
                    }
                });
                
                // Extract package
                packagePatterns.forEach(pattern => {
                    const matches = content.match(pattern);
                    if (matches && !analysis.package) {
                        analysis.package = matches[0];
                    }
                });
                
                // Determine status
                for (const [status, pattern] of Object.entries(statusPatterns)) {
                    if (pattern.test(content) && !analysis.status) {
                        analysis.status = status;
                    }
                }
                
                // Extract keywords (nouns and important words)
                const keywordPatterns = /\b(umroh|haji|visa|paspor|hotel|pesawat|makkah|madinah|ziarah|manasik)\b/gi;
                const keywordMatches = content.match(keywordPatterns);
                if (keywordMatches) {
                    keywordMatches.forEach(kw => analysis.keywords.add(kw.toLowerCase()));
                }
                
                // Count media
                if (message.messageType === 'image') analysis.mediaCount.photos++;
                if (message.messageType === 'document') analysis.mediaCount.documents++;
                
                // First contact (oldest message)
                if (index === messages.length - 1) {
                    analysis.firstContact = message.createdAt;
                }
                
                // Last contact (newest message)
                if (index === 0) {
                    analysis.lastContact = message.createdAt;
                }
            });
            
            // Update UI with analysis results
            if (analysis.email) document.getElementById('contact-email').textContent = analysis.email;
            if (analysis.location) document.getElementById('contact-location').textContent = analysis.location;
            if (analysis.package) document.getElementById('contact-package').textContent = analysis.package;
            if (analysis.status) document.getElementById('contact-status').textContent = analysis.status;
            
            document.getElementById('total-messages').textContent = analysis.totalMessages;
            document.getElementById('first-contact').textContent = analysis.firstContact ? formatDate(analysis.firstContact) : '-';
            document.getElementById('last-chat').textContent = analysis.lastContact ? formatDate(analysis.lastContact) : '-';
            document.getElementById('contact-media').textContent = `${analysis.mediaCount.photos} Photos, ${analysis.mediaCount.documents} Documents`;
            
            if (analysis.keywords.size > 0) {
                document.getElementById('contact-keywords').textContent = Array.from(analysis.keywords).join(', ');
            }
            
            // Update labels based on analysis
            updateContactLabels(analysis);
        }
        
        // Update contact labels based on analysis
        function updateContactLabels(analysis) {
            const labelsContainer = document.getElementById('contact-labels');
            labelsContainer.innerHTML = '';
            
            const labels = [];
            
            // Add status label
            if (analysis.status) {
                labels.push(analysis.status);
            }
            
            // Add package label
            if (analysis.package) {
                if (analysis.package.toLowerCase().includes('ramadhan')) {
                    labels.push('Ramadhan 2025');
                } else if (analysis.package.toLowerCase().includes('vip')) {
                    labels.push('VIP');
                }
            }
            
            // Add engagement label
            if (analysis.totalMessages > 20) {
                labels.push('Aktif');
            }
            
            // Add location label
            if (analysis.location) {
                labels.push(analysis.location);
            }
            
            // Display labels or default
            if (labels.length > 0) {
                labels.forEach(label => {
                    const span = document.createElement('span');
                    span.className = 'label-tag';
                    span.textContent = label;
                    labelsContainer.appendChild(span);
                });
            } else {
                labelsContainer.innerHTML = '<span class="label-tag">Belum ada label</span>';
            }
        }
        
        // Format date helper
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }
        
        // Handle history button click - this was the missing function wrapper
        async function handleHistoryButtonClick(btn) {
            // Show loading state
            btn.classList.add('loading');
            btn.disabled = true;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `
                <span class="material-icons">sync</span>
                <span>Loading...</span>
            `;
            
            try {
                console.log('Loading WhatsApp history...');
                
                // Call backend to load chats - note the correct endpoint
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/load-history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        limit: 50 // Load last 50 chats
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Memuat riwayat chat dari WhatsApp...', 'success');
                    
                    // Wait a moment for backend to process, then reload contacts
                    setTimeout(() => {
                        loadContacts();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to load chats');
                }
            } catch (error) {
                console.error('Error loading WhatsApp history:', error);
                showNotification('Gagal memuat riwayat chat: ' + error.message, 'error');
            } finally {
                // Restore button state
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // Search in chat
        function searchInChat() {
            // Implement search functionality
            showNotification('Fitur pencarian dalam chat akan segera tersedia', 'info');
        }
        
        // Make call
        function makeCall() {
            if (!currentContact) {
                showNotification('Silakan pilih kontak terlebih dahulu', 'error');
                return;
            }
            
            showNotification('Fitur panggilan belum tersedia', 'info');
        }
        
        // Show chat menu
        function showChatMenu() {
            // Implement chat menu
            showNotification('Menu chat akan segera tersedia', 'info');
        }
        
        // Sound alert for disconnection (optional)
        function playDisconnectSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF');
            audio.volume = 0.5;
            audio.play().catch(() => {});
        }
        
        // Compliance monitoring
        function startComplianceMonitoring() {
            // Placeholder for compliance monitoring
            console.log('Compliance monitoring started');
        }
        
        // Check message compliance
        function checkMessageCompliance(message) {
            // Basic compliance check
            if (message.length > 1000) {
                showNotification('Pesan terlalu panjang. Maksimal 1000 karakter.', 'warning');
                return false;
            }
            return true;
        }
        
        // Check compliance before sending
        function checkComplianceBeforeSend() {
            // Basic compliance check before sending
            return true;
        }
        
        // Connect WhatsApp
        async function connectWhatsApp() {
            const connectBtn = document.getElementById('connectBtn');
            const originalContent = connectBtn.innerHTML;
            
            try {
                // Show loading state
                connectBtn.innerHTML = '<span class="material-icons">sync</span><span class="btn-text">Connecting...</span>';
                connectBtn.disabled = true;
                
                // Initialize WAHA Plus integration if not already done
                if (!wahaIntegration) {
                    wahaIntegration = new WAHAPlusIntegration({
                        apiUrl: API_CONFIG.baseUrl,
                        wahaUrl: API_CONFIG.wahaUrl,
                        sessionId: API_CONFIG.sessionId,
                        apiKey: API_CONFIG.apiKey,
                        onStatusChange: (status, data) => {
                            console.log('Status changed:', status, data);
                            updateConnectionStatus(status, data);
                        },
                        onQRReceived: (qrCode) => {
                            console.log('QR received, showing modal');
                            showQRModal(qrCode);
                        }
                    });
                }
                
                // Connect and start monitoring
                stopMonitoring = await wahaIntegration.connect();
                
            } catch (error) {
                console.error('Error connecting WhatsApp:', error);
                showNotification('Error menghubungkan WhatsApp: ' + error.message, 'error');
                updateConnectionStatus('disconnected');
            } finally {
                connectBtn.innerHTML = originalContent;
                connectBtn.disabled = false;
            }
        }
        
        // Disconnect WhatsApp
        async function disconnectWhatsApp() {
            if (!confirm('Apakah Anda yakin ingin disconnect dari WhatsApp? Anda perlu scan QR code lagi untuk reconnect.')) {
                return;
            }
            
            const connectBtn = document.getElementById('connectBtn');
            const originalContent = connectBtn.innerHTML;
            
            try {
                // Show loading state
                connectBtn.innerHTML = '<span class="material-icons">sync</span><span class="btn-text">Disconnecting...</span>';
                connectBtn.disabled = true;
                
                // Stop monitoring if active
                if (stopMonitoring) {
                    stopMonitoring();
                    stopMonitoring = null;
                }
                
                // Stop session using WAHA integration
                if (wahaIntegration) {
                    await wahaIntegration.stopSession();
                }
                
                updateConnectionStatus('disconnected');
                showNotification('WhatsApp berhasil disconnected', 'success');
                
                // Clear contacts and messages
                document.getElementById('contacts-list').innerHTML = '';
                const messagesArea = document.getElementById('messages-area');
                if (messagesArea) {
                    messagesArea.innerHTML = '';
                }
                
                // Reset current conversation
                currentConversation = null;
                currentContact = null;
            } catch (error) {
                console.error('Error disconnecting WhatsApp:', error);
                showNotification('Error saat disconnect', 'error');
            } finally {
                connectBtn.innerHTML = originalContent;
                connectBtn.disabled = false;
                
                // Check status again
                setTimeout(checkConnectionStatus, 1000);
            }
        }
        
        // Load WhatsApp chat history
        async function loadWhatsAppHistory() {
            const statusEl = document.getElementById('whatsappStatus');
            const statusText = statusEl.querySelector('.status-text');
            const historyBtn = document.querySelector('.load-history-btn');
            
            // Check if connected
            if (connectionState.status !== 'connected') {
                showNotification('Please connect WhatsApp first', 'warning');
                return;
            }
            
            // Show loading state
            historyBtn.classList.add('loading');
            historyBtn.innerHTML = '<span class="material-icons">hourglass_empty</span><span>Loading...</span>';
            statusText.textContent = 'Loading chats...';
            showNotification('Loading chat history from WhatsApp...', 'info');
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/load-history`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Chat history is being loaded. This may take a few moments...', 'success');
                    statusText.textContent = 'Connected';
                } else {
                    showNotification('Failed to load chat history: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                showNotification('Error loading chat history', 'error');
            } finally {
                historyBtn.classList.remove('loading');
                historyBtn.innerHTML = '<span class="material-icons">history</span><span>Load Chat History</span>';
                checkConnectionStatus();
            }
        }
        
        // Show notification helper
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-family: Inter, sans-serif;
                font-size: 14px;
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Monitor connection changes
        let lastStatus = connectionState.status;
        setInterval(() => {
            if (lastStatus === 'connected' && connectionState.status === 'disconnected') {
                playDisconnectSound();
            }
            lastStatus = connectionState.status;
        }, 1000);

        // Global variables for filter and search state
        let currentFilter = 'all';
        let currentSearchTerm = '';

        // Update filter contacts function
        function filterContacts(filter, element) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find the filter tab element (in case a child element was clicked)
            const filterTab = element ? (element.closest('.filter-tab') || element) : event.target.closest('.filter-tab');
            if (filterTab) {
                filterTab.classList.add('active');
            }
            
            // Update current filter state
            currentFilter = filter;
            
            // Load contacts with current filter and search term
            loadContacts(filter, currentSearchTerm);
        }
        
        // Sync contacts from WhatsApp
        async function syncContacts() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/contacts/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: API_CONFIG.sessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Synced ${result.total} contacts`);
                    loadContacts();
                } else {
                    alert('Failed to sync contacts: ' + result.error);
                }
            } catch (error) {
                console.error('Error syncing contacts:', error);
                alert('Failed to sync contacts');
            }
        }
        
        // Search contacts
        let searchTimeout;
        document.getElementById('search-contacts').addEventListener('input', function(e) {
            const searchValue = e.target.value;
            currentSearchTerm = searchValue;
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Debounce search to avoid too many API calls
            searchTimeout = setTimeout(() => {
                // Search with minimum 0 characters (immediate search) or when cleared
                if (searchValue.length >= 2 || searchValue.length === 0) {
                    loadContacts(currentFilter, searchValue);
                }
            }, 300); // 300ms debounce
        });
        
        // Handle search input focus and blur for better UX
        document.getElementById('search-contacts').addEventListener('focus', function(e) {
            e.target.parentElement.style.borderColor = '#3b82f6';
            e.target.parentElement.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
        });
        
        document.getElementById('search-contacts').addEventListener('blur', function(e) {
            e.target.parentElement.style.borderColor = 'rgba(71, 85, 105, 0.3)';
            e.target.parentElement.style.boxShadow = 'none';
        });
        
        // Update filter tab counts
        function updateFilterTabCounts(allContactsData) {
            const allCount = allContactsData.length;
            const unreadCount = allContactsData.filter(contact => contact.unreadCount > 0).length;
            const groupsCount = allContactsData.filter(contact => contact.isGroup === true).length;
            
            // Update tab text with counts
            const tabs = document.querySelectorAll('.filter-tab');
            tabs.forEach(tab => {
                const filterType = tab.onclick.toString().match(/filterContacts\('(\w+)'\)/)?.[1];
                let count;
                
                switch(filterType) {
                    case 'all':
                        count = allCount;
                        break;
                    case 'unread':
                        count = unreadCount;
                        break;
                    case 'groups':
                        count = groupsCount;
                        break;
                    default:
                        count = 0;
                }
                
                // Add count badge to tab
                const originalText = tab.textContent.split(' (')[0]; // Remove existing count
                tab.innerHTML = `${originalText} ${count > 0 ? `<span class="filter-count">(${count})</span>` : ''}`;
            });
        }
        
        // Clear search function
        function clearSearch() {
            const searchInput = document.getElementById('search-contacts');
            searchInput.value = '';
            currentSearchTerm = '';
            loadContacts(currentFilter, '');
        }
        
        // Add clear search button functionality and keyboard shortcuts
        document.addEventListener('DOMContentLoaded', function() {
            // Add clear button to search input if it doesn't exist
            const searchContainer = document.querySelector('.contacts-search');
            const searchInput = document.getElementById('search-contacts');
            
            if (searchContainer && !searchContainer.querySelector('.clear-search-btn')) {
                const clearBtn = document.createElement('span');
                clearBtn.className = 'material-icons clear-search-btn';
                clearBtn.textContent = 'clear';
                clearBtn.style.cssText = `
                    position: absolute;
                    right: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    cursor: pointer;
                    color: #64748b;
                    font-size: 18px;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                clearBtn.onclick = clearSearch;
                
                // Make search container relative
                searchContainer.style.position = 'relative';
                searchContainer.appendChild(clearBtn);
                
                // Show/hide clear button based on input content
                searchInput.addEventListener('input', function() {
                    clearBtn.style.opacity = this.value.length > 0 ? '1' : '0';
                });
            }
            
            // Add keyboard shortcuts for filters
            document.addEventListener('keydown', function(e) {
                // Only activate shortcuts if search input is not focused
                if (document.activeElement !== searchInput) {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case '1':
                                e.preventDefault();
                                filterContacts('all', document.querySelector('.filter-tab[onclick*="all"]'));
                                break;
                            case '2':
                                e.preventDefault();
                                filterContacts('unread', document.querySelector('.filter-tab[onclick*="unread"]'));
                                break;
                            case '3':
                                e.preventDefault();
                                filterContacts('groups', document.querySelector('.filter-tab[onclick*="groups"]'));
                                break;
                            case 'f':
                            case 'F':
                                e.preventDefault();
                                searchInput.focus();
                                break;
                        }
                    }
                    // ESC to clear search
                    if (e.key === 'Escape' && currentSearchTerm) {
                        clearSearch();
                    }
                }
            });
        });
        
        // Placeholder functions for future implementation
        function searchInChat() { 
            alert('Search in chat feature coming soon!');
        }
        
        // Open group management page
        function openGroupManagement(groupId) {
            if (!groupId) {
                showNotification('Group ID not found', 'error');
                return;
            }
            // Open in new tab/window
            window.open(`group-management.html?groupId=${encodeURIComponent(groupId)}`, '_blank');
        }
        
        // Load WhatsApp chat history
        async function loadWhatsAppHistory() {
            const statusEl = document.getElementById('whatsappStatus');
            const statusText = statusEl?.querySelector('.status-text');
            const historyBtn = document.querySelector('.load-history-btn');
            
            // Check if connected
            if (connectionState.status !== 'connected' && connectionState.status !== 'WORKING') {
                showNotification('Please connect WhatsApp first', 'warning');
                return;
            }
            
            // Show loading state
            if (historyBtn) {
                historyBtn.classList.add('loading');
                historyBtn.innerHTML = '<span class="material-icons">hourglass_empty</span><span>Loading...</span>';
            }
            
            if (statusText) {
                statusText.textContent = 'Loading chats...';
            }
            
            showNotification('Loading chat history from WhatsApp...', 'info');
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/sessions/${API_CONFIG.sessionId}/load-history`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Chat history is being loaded. This may take a few moments...', 'success');
                    if (statusText) {
                        statusText.textContent = 'Connected';
                    }
                    // Reload contacts after a delay
                    setTimeout(() => loadContacts('all'), 3000);
                } else {
                    showNotification('Failed to load chat history: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                showNotification('Error loading chat history', 'error');
            } finally {
                // Reset button state
                if (historyBtn) {
                    historyBtn.classList.remove('loading');
                    historyBtn.innerHTML = '<span class="material-icons">history</span><span>Load Chat History</span>';
                }
            }
        }
        
        function makeCall() { 
            alert('Voice/Video call feature coming soon!');
        }
        
        function showChatMenu() { 
            alert('Chat menu coming soon!');
        }
        
        function attachFile() { 
            // Create file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = false;
            fileInput.accept = 'image/*,video/*,application/pdf,.doc,.docx,.xls,.xlsx';
            
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (16MB limit for WAHA Plus)
                const maxSize = 16 * 1024 * 1024; // 16MB
                if (file.size > maxSize) {
                    showNotification('File size exceeds 16MB limit', 'error');
                    return;
                }
                
                // Show uploading status
                showNotification('Uploading file...', 'info');
                
                try {
                    console.log('Starting file upload:', file.name, file.type, file.size);
                    
                    // Upload file to backend
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    console.log('Uploading to:', `${API_CONFIG.baseUrl}/media/upload`);
                    
                    const uploadResponse = await fetch(`${API_CONFIG.baseUrl}/media/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('Upload response status:', uploadResponse.status);
                    
                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        console.error('Upload failed:', errorText);
                        throw new Error(`Upload failed: ${uploadResponse.status} ${errorText}`);
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    console.log('Upload result:', uploadResult);
                    
                    if (uploadResult.success) {
                        // Show preview and send options
                        console.log('Upload successful, showing media preview dialog...');
                        showNotification('Upload successful!', 'success');
                        showMediaPreviewDialog(uploadResult, file);
                    } else {
                        throw new Error(uploadResult.error || 'Upload failed');
                    }
                    
                } catch (error) {
                    console.error('Error uploading file:', error);
                    showNotification('Failed to upload file: ' + error.message, 'error');
                }
            };
            
            // Trigger file selection
            fileInput.click();
        }
        
        function showEmoji() { 
            alert('Emoji picker coming soon!');
        }
        
        // Show media preview dialog before sending
        function showMediaPreviewDialog(uploadResult, file) {
            console.log('showMediaPreviewDialog called with:', uploadResult, file);
            
            // Remove any existing modal first
            const existingModal = document.getElementById('mediaPreviewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create a simpler modal structure
            const modal = document.createElement('div');
            modal.id = 'mediaPreviewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #1e293b;
                border-radius: 20px;
                padding: 24px;
                max-width: 600px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
            `;
            
            // Create content
            let previewHtml = '';
            if (file.type.startsWith('image/')) {
                previewHtml = `<img src="${uploadResult.url}" style="max-width: 100%; max-height: 400px; border-radius: 8px; display: block; margin: 0 auto;">`;
            } else if (file.type.startsWith('video/')) {
                previewHtml = `<video src="${uploadResult.url}" controls style="max-width: 100%; max-height: 400px; border-radius: 8px; display: block; margin: 0 auto;"></video>`;
            } else {
                previewHtml = `
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <span class="material-icons" style="font-size: 64px; color: #94a3b8;">insert_drive_file</span>
                        <p style="margin-top: 16px; font-weight: 500; color: #e2e8f0;">${uploadResult.originalName}</p>
                        <p style="color: #94a3b8; font-size: 14px;">${formatFileSize(uploadResult.size)}</p>
                    </div>
                `;
            }
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #e2e8f0;">Send Media</h3>
                    <button onclick="closeMediaPreview()" style="background: transparent; border: none; cursor: pointer; padding: 4px;">
                        <span class="material-icons" style="color: #94a3b8;">close</span>
                    </button>
                </div>
                <div style="margin-bottom: 20px;">
                    ${previewHtml}
                </div>
                <div>
                    <input type="text" id="mediaCaption" placeholder="Add a caption (optional)" 
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); 
                                  border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; 
                                  color: white; margin-bottom: 16px; box-sizing: border-box;">
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeMediaPreview()" 
                                style="padding: 10px 20px; background: rgba(255,255,255,0.1); 
                                       color: #e2e8f0; border: 1px solid rgba(255,255,255,0.2); 
                                       border-radius: 8px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="sendMediaFromModal('${uploadResult.url}', '${uploadResult.mimetype}', '${uploadResult.filename}')" 
                                style="padding: 10px 20px; background: #3b82f6; color: white; 
                                       border: none; border-radius: 8px; cursor: pointer; 
                                       display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons" style="font-size: 20px;">send</span>
                            Send
                        </button>
                    </div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Focus on caption input
            setTimeout(() => {
                const captionInput = document.getElementById('mediaCaption');
                if (captionInput) {
                    captionInput.focus();
                }
            }, 100);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeMediaPreview();
                }
            });
        }
        
        // New function to send media from modal
        window.sendMediaFromModal = function(mediaUrl, mimetype, filename) {
            const caption = document.getElementById('mediaCaption')?.value || '';
            sendMediaMessage(mediaUrl, mimetype, filename, caption);
        }
        
        // Close media preview modal
        window.closeMediaPreview = function() {
            const modal = document.getElementById('mediaPreviewModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Send media message (image, video, document)
        async function sendMediaMessage(mediaUrl, mimetype, filename, captionOverride) {
            if (!currentConversation || !currentContact) {
                showNotification('Please select a conversation first', 'error');
                closeMediaPreview();
                return;
            }
            
            // Use captionOverride if provided, otherwise get from input field
            const caption = captionOverride !== undefined ? captionOverride : (document.getElementById('mediaCaption')?.value || '');
            
            try {
                // Ensure phone number has correct format
                let toNumber = currentContact.phoneNumber;
                if (!toNumber.includes('@')) {
                    toNumber = toNumber + '@c.us';
                }
                
                const payload = {
                    conversationId: currentConversation.id,
                    toNumber: toNumber,
                    content: caption || '', // Add content field for caption
                    mediaUrl: mediaUrl,
                    mimetype: mimetype,
                    filename: filename,
                    caption: caption,
                    sessionId: API_CONFIG.sessionId
                };
                
                console.log('Sending media message:', payload);
                
                const response = await fetch(`${API_CONFIG.baseUrl}/messages/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                if (result.success) {
                    showNotification('Media sent successfully', 'success');
                    closeMediaPreview();
                    
                    // Add message to UI immediately if we have the data
                    if (result.data) {
                        const messageData = {
                            id: result.data.id,
                            conversationId: currentConversation.id,
                            content: caption || '',
                            messageType: 'image', // Will be determined by backend based on mimetype
                            mediaUrl: mediaUrl,
                            mediaMimeType: mimetype,
                            fileName: filename,
                            direction: 'outbound',
                            status: 'sent',
                            createdAt: new Date().toISOString(),
                            fromNumber: 'You'
                        };
                        
                        // Use existing displayMessages to add the new message
                        const messagesArea = document.getElementById('messages-area');
                        const messageDiv = createMessageElement(messageData);
                        messagesArea.appendChild(messageDiv);
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }
                } else {
                    throw new Error(result.error || 'Failed to send media');
                }
                
            } catch (error) {
                console.error('Error sending media:', error);
                showNotification('Failed to send media: ' + error.message, 'error');
            }
        }
        
        // =================== WAHA Compliance Functions ===================
        
        let complianceData = {
            dailyContacts: 0,
            dailyMessages: 0,
            lastMessageTime: null,
            sessionStartTime: null,
            warnings: []
        };
        
        // Start compliance monitoring
        async function startComplianceMonitoring() {
            updateComplianceStatus();
            
            // Update every minute
            setInterval(() => {
                updateComplianceStatus();
            }, 60000);
        }
        
        // Update compliance status
        async function updateComplianceStatus() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/compliance/status`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const report = result.data;
                    
                    // Update UI
                    const uniqueContacts = typeof report.metrics === 'object' ? 
                        (report.metrics.uniqueContacts || 0) : 0;
                    document.getElementById('complianceDaily').textContent = 
                        `${uniqueContacts}/50 contacts`;
                    document.getElementById('complianceMessages').textContent = 
                        `${report.metrics.messagesSent || 0} sent`;
                    
                    // Update compliance score
                    const score = calculateComplianceScore(report);
                    updateComplianceIndicator(score);
                    
                    // Show warnings if any
                    if (report.recommendations && report.recommendations.length > 0) {
                        showComplianceWarning(report.recommendations[0]);
                    }
                }
            } catch (error) {
                console.error('Error updating compliance status:', error);
            }
        }
        
        // Calculate compliance score
        function calculateComplianceScore(report) {
            const metrics = report.metrics || {};
            const contacts = metrics.uniqueContacts || 0;
            const failed = metrics.failedCount || 0;
            
            if (contacts >= 45) return 'danger'; // Near limit
            if (contacts >= 35) return 'warning'; // Getting close
            if (failed > 5) return 'warning'; // High failure rate
            
            return 'good';
        }
        
        // Update compliance indicator
        function updateComplianceIndicator(score) {
            const indicator = document.getElementById('complianceIndicator');
            const scoreEl = document.getElementById('complianceScore');
            
            indicator.className = 'compliance-indicator';
            
            switch (score) {
                case 'danger':
                    indicator.classList.add('danger');
                    scoreEl.innerHTML = '<span style="color: #ef4444;">Critical </span>';
                    break;
                case 'warning':
                    indicator.classList.add('warning');
                    scoreEl.innerHTML = '<span style="color: #f59e0b;">Warning !</span>';
                    break;
                default:
                    scoreEl.innerHTML = '<span style="color: #10b981;">Good </span>';
            }
        }
        
        
        // Check message compliance
        function checkMessageCompliance(message) {
            const prohibitedWords = [
                'gratis', 'menang', 'hadiah', 'promo gila',
                'click here', 'klik disini', 'urgent',
                'bitcoin', 'crypto', 'forex', 'trading',
                'judi', 'togel', 'slot', 'casino'
            ];
            
            const messageLower = message.toLowerCase();
            
            for (const word of prohibitedWords) {
                if (messageLower.includes(word)) {
                    return false;
                }
            }
            
            // Check message length
            if (message.length > 1000) {
                return false;
            }
            
            return true;
        }
        
        // Check compliance before sending
        function checkComplianceBeforeSend() {
            const message = document.getElementById('messageInput').value;
            
            // Check message compliance
            if (!checkMessageCompliance(message)) {
                alert('Message contains prohibited content. Please review and modify.');
                return false;
            }
            
            // Check rate limiting
            if (complianceData.lastMessageTime) {
                const timeSinceLastMessage = Date.now() - complianceData.lastMessageTime;
                if (timeSinceLastMessage < 5000) { // 5 seconds
                    const waitTime = Math.ceil((5000 - timeSinceLastMessage) / 1000);
                    alert(`Please wait ${waitTime} seconds before sending another message`);
                    return false;
                }
            }
            
            // Check daily limits
            if (complianceData.dailyContacts >= 50) {
                alert('Daily contact limit reached (50 contacts). Please try again tomorrow.');
                return false;
            }
            
            // Update metrics
            complianceData.lastMessageTime = Date.now();
            complianceData.dailyMessages++;
            
            return true;
        }
        
        // Show compliance warning
        function showComplianceWarning(message) {
            const warningEl = document.getElementById('complianceWarning');
            const warningText = document.getElementById('complianceWarningText');
            
            if (message) {
                warningEl.style.display = 'flex';
                warningText.textContent = message;
            } else {
                warningEl.style.display = 'none';
            }
        }
        
        // Format time with compliance info
        function formatTimeWithCompliance(timestamp) {
            const time = formatTime(timestamp);
            const now = new Date();
            const messageTime = new Date(timestamp);
            const hoursSince = (now - messageTime) / (1000 * 60 * 60);
            
            // Add indicator if outside 24-hour window
            if (hoursSince > 24) {
                return `${time} (template required)`;
            }
            
            return time;
        }
        
        // Note: connectWhatsApp function is defined above with WAHA Plus integration
        
        // Start QR check interval (kept for compatibility)
        function startQRCheckInterval() {
            // This functionality is now handled by WAHAPlusIntegration.monitorConnection()
            console.log('QR check interval handled by WAHA Plus integration');
        }
        
        // Clear QR check interval when needed
        function clearQRCheckInterval() {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing WhatsApp CRM...');
            
            // Create particles
            createParticles();
            
            // Initialize socket connection
            initializeSocket();
            
            // Check initial connection status
            checkConnectionStatus();
            
            // Load contacts with initial filter
            loadContacts(currentFilter, currentSearchTerm);
            
            // Start compliance monitoring
            startComplianceMonitoring();
            
            // Start health check
            startHealthCheck();
        });
    </script>
</body>
</html>