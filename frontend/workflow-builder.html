<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Builder - WhatsApp CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #3b82f6;
            --primary-green: #10b981;
            --primary-purple: #8b5cf6;
            --primary-orange: #f59e0b;
            --primary-pink: #ec4899;
            --dark-bg: #0f172a;
            --darker-bg: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.85);
            --border-color: rgba(71, 85, 105, 0.3);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        /* Main Layout */
        .container {
            position: relative;
            z-index: 2;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.85));
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Step Types Panel */
        .step-types {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .step-category {
            margin-bottom: 24px;
        }

        .step-category h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .step-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .step-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .step-item:hover::before {
            opacity: 1;
        }

        .step-item:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .step-item-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .step-icon.template { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .step-icon.keyword { background: linear-gradient(135deg, #10b981, #059669); }
        .step-icon.ai { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .step-icon.input { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .step-icon.conditional { background: linear-gradient(135deg, #ec4899, #db2777); }
        .step-icon.action { background: linear-gradient(135deg, #06b6d4, #0891b2); }

        .step-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .canvas-header {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.85));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .workflow-name {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .workflow-name input {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            min-width: 300px;
        }

        .canvas-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.3);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.5);
        }

        /* Canvas */
        .canvas {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: 
                radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 40%);
        }

        .canvas-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(71, 85, 105, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(71, 85, 105, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .canvas-content {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        /* Workflow Steps on Canvas */
        .workflow-step {
            position: absolute;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            min-width: 280px;
            cursor: move;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .workflow-step.selected {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .workflow-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .workflow-step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .workflow-step-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .workflow-step-actions {
            display: flex;
            gap: 8px;
        }

        .step-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(71, 85, 105, 0.3);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .step-action-btn:hover {
            background: rgba(71, 85, 105, 0.5);
        }

        .step-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .workflow-step-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Connection Points */
        .connection-point {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--primary-blue);
            border: 3px solid var(--dark-bg);
            border-radius: 50%;
            cursor: crosshair;
            transition: all 0.3s ease;
        }

        .connection-point:hover {
            transform: scale(1.3);
            box-shadow: 0 0 16px rgba(59, 130, 246, 0.6);
        }

        .connection-point.input {
            top: 50%;
            left: -8px;
            transform: translateY(-50%);
        }

        .connection-point.output {
            top: 50%;
            right: -8px;
            transform: translateY(-50%);
        }

        /* SVG Connections */
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .connection-line {
            stroke: var(--primary-blue);
            stroke-width: 3;
            fill: none;
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.4));
        }

        .connection-line.animated {
            stroke-dasharray: 8 4;
            animation: dash 0.5s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -12;
            }
        }

        /* Properties Panel */
        .properties-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 400px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .properties-panel.open {
            transform: translateX(0);
        }

        .properties-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .properties-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        /* Step Type Specific Styles */
        .step-config {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .config-section {
            margin-bottom: 24px;
        }

        .config-section h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        /* Keywords Input */
        .keyword-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .keyword-input {
            flex: 1;
        }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .keyword-tag {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keyword-tag .remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .keyword-tag .remove:hover {
            opacity: 1;
        }

        /* Conditions Builder */
        .condition-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .condition-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .condition-row select,
        .condition-row input {
            flex: 1;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 50;
        }

        .fab:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.5);
        }

        /* Empty State */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 14px;
        }

        /* Loading State */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 250px;
            }
            
            .properties-panel {
                width: 350px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                bottom: 0;
                z-index: 200;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .canvas-container {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Ezy Industries AI Center</h2>
            </div>
            
            <div class="step-types">
                <!-- Basic Steps -->
                <div class="step-category">
                    <h3>Basic Steps</h3>
                    
                    <div class="step-item" draggable="true" data-step-type="template">
                        <div class="step-item-header">
                            <div class="step-icon template">
                                <span class="material-icons">message</span>
                            </div>
                            <div class="step-info">
                                <h4>Template Message</h4>
                                <p>Send a pre-defined message</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-item" draggable="true" data-step-type="input">
                        <div class="step-item-header">
                            <div class="step-icon input">
                                <span class="material-icons">input</span>
                            </div>
                            <div class="step-info">
                                <h4>Collect Input</h4>
                                <p>Ask for user input</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Smart Steps -->
                <div class="step-category">
                    <h3>Smart Steps</h3>
                    
                    <div class="step-item" draggable="true" data-step-type="keyword">
                        <div class="step-item-header">
                            <div class="step-icon keyword">
                                <span class="material-icons">label</span>
                            </div>
                            <div class="step-info">
                                <h4>Keyword Match</h4>
                                <p>Match specific keywords</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-item" draggable="true" data-step-type="ai_agent">
                        <div class="step-item-header">
                            <div class="step-icon ai">
                                <span class="material-icons">psychology</span>
                            </div>
                            <div class="step-info">
                                <h4>AI Response</h4>
                                <p>Generate AI-powered reply</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Flow Control -->
                <div class="step-category">
                    <h3>Flow Control</h3>
                    
                    <div class="step-item" draggable="true" data-step-type="conditional">
                        <div class="step-item-header">
                            <div class="step-icon conditional">
                                <span class="material-icons">call_split</span>
                            </div>
                            <div class="step-info">
                                <h4>Conditional Branch</h4>
                                <p>Route based on conditions</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-item" draggable="true" data-step-type="action">
                        <div class="step-item-header">
                            <div class="step-icon action">
                                <span class="material-icons">bolt</span>
                            </div>
                            <div class="step-info">
                                <h4>Action</h4>
                                <p>Perform system action</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Canvas Container -->
        <div class="canvas-container">
            <div class="canvas-header">
                <div class="workflow-name">
                    <input type="text" id="workflowName" placeholder="Workflow Name" value="Customer Consultation Flow">
                </div>
                
                <div class="canvas-actions">
                    <button class="btn btn-secondary" onclick="clearCanvas()">
                        <span class="material-icons">clear</span>
                        Clear
                    </button>
                    <button class="btn btn-secondary" onclick="testWorkflow()">
                        <span class="material-icons">play_arrow</span>
                        Test
                    </button>
                    <button class="btn btn-primary" onclick="saveWorkflow()">
                        <span class="material-icons">save</span>
                        Save Workflow
                    </button>
                </div>
            </div>
            
            <div class="canvas" id="canvas">
                <div class="canvas-grid"></div>
                <svg class="connections-layer" id="connectionsLayer"></svg>
                <div class="canvas-content" id="canvasContent">
                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">
                            <span class="material-icons">account_tree</span>
                        </div>
                        <h3>Start Building Your Workflow</h3>
                        <p>Drag and drop steps from the sidebar to get started</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="properties-header">
                <h3>Step Properties</h3>
                <button class="step-action-btn" onclick="closeProperties()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div class="properties-content" id="propertiesContent">
                <!-- Dynamic content based on selected step -->
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" onclick="toggleSidebar()">
        <span class="material-icons">add</span>
    </button>
    
    <script>
        // Global variables
        let workflowSteps = [];
        let connections = [];
        let selectedStep = null;
        let draggedElement = null;
        let connectionStart = null;
        let stepIdCounter = 1;
        let ruleId = null; // Will be set when creating workflow rule
        
        const API_URL = 'http://localhost:3001/api';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDragAndDrop();
            initCanvas();
            
            // Check if editing existing workflow
            const urlParams = new URLSearchParams(window.location.search);
            const workflowId = urlParams.get('id');
            if (workflowId) {
                loadWorkflow(workflowId);
            }
        });
        
        // Drag and Drop
        function initDragAndDrop() {
            // Step items from sidebar
            document.querySelectorAll('.step-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        
        function handleDragStart(e) {
            draggedElement = e.target.closest('.step-item');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('stepType', draggedElement.dataset.stepType);
        }
        
        function handleDragEnd(e) {
            draggedElement = null;
        }
        
        function initCanvas() {
            const canvas = document.getElementById('canvas');
            const canvasContent = document.getElementById('canvasContent');
            
            canvas.addEventListener('dragover', handleCanvasDragOver);
            canvas.addEventListener('drop', handleCanvasDrop);
            
            // Click outside to deselect
            canvas.addEventListener('click', (e) => {
                if (e.target === canvas || e.target === canvasContent) {
                    deselectAllSteps();
                    closeProperties();
                }
            });
        }
        
        function handleCanvasDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }
        
        function handleCanvasDrop(e) {
            e.preventDefault();
            
            const stepType = e.dataTransfer.getData('stepType');
            if (!stepType) return;
            
            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left - 140; // Center the step
            const y = e.clientY - rect.top - 50;
            
            createWorkflowStep(stepType, x, y);
        }
        
        // Create workflow step
        function createWorkflowStep(type, x, y) {
            const stepId = `step_${stepIdCounter++}`;
            const stepData = {
                id: stepId,
                type: type,
                name: getStepTypeName(type),
                x: x,
                y: y,
                config: getDefaultConfig(type)
            };
            
            workflowSteps.push(stepData);
            
            const stepElement = createStepElement(stepData);
            document.getElementById('canvasContent').appendChild(stepElement);
            
            // Hide empty state
            document.getElementById('emptyState').style.display = 'none';
            
            // Select the new step
            selectStep(stepId);
            
            return stepId;
        }
        
        function createStepElement(stepData) {
            const div = document.createElement('div');
            div.className = 'workflow-step';
            div.id = stepData.id;
            div.style.left = stepData.x + 'px';
            div.style.top = stepData.y + 'px';
            
            div.innerHTML = `
                <div class="workflow-step-header">
                    <div class="workflow-step-title">
                        <div class="step-icon ${stepData.type}">
                            <span class="material-icons">${getStepIcon(stepData.type)}</span>
                        </div>
                        <h4>${stepData.name}</h4>
                    </div>
                    <div class="workflow-step-actions">
                        <button class="step-action-btn" onclick="editStep('${stepData.id}')">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="step-action-btn delete" onclick="deleteStep('${stepData.id}')">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                </div>
                <div class="workflow-step-content">
                    ${getStepDescription(stepData)}
                </div>
                <div class="connection-point input" onclick="handleConnectionClick('${stepData.id}', 'input')"></div>
                <div class="connection-point output" onclick="handleConnectionClick('${stepData.id}', 'output')"></div>
            `;
            
            // Make draggable
            makeDraggable(div);
            
            // Click to select
            div.addEventListener('click', (e) => {
                if (!e.target.closest('.step-action-btn') && !e.target.closest('.connection-point')) {
                    selectStep(stepData.id);
                }
            });
            
            return div;
        }
        
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.addEventListener('mousedown', dragMouseDown);
            
            function dragMouseDown(e) {
                if (e.target.closest('.step-action-btn') || e.target.closest('.connection-point')) {
                    return;
                }
                
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                const newTop = element.offsetTop - pos2;
                const newLeft = element.offsetLeft - pos1;
                
                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
                
                // Update step data
                const step = workflowSteps.find(s => s.id === element.id);
                if (step) {
                    step.x = newLeft;
                    step.y = newTop;
                }
                
                // Update connections
                updateConnections();
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        // Step selection
        function selectStep(stepId) {
            deselectAllSteps();
            
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('selected');
                selectedStep = workflowSteps.find(s => s.id === stepId);
                showProperties(selectedStep);
            }
        }
        
        function deselectAllSteps() {
            document.querySelectorAll('.workflow-step').forEach(step => {
                step.classList.remove('selected');
            });
            selectedStep = null;
        }
        
        // Step actions
        function editStep(stepId) {
            selectStep(stepId);
        }
        
        function deleteStep(stepId) {
            if (confirm('Are you sure you want to delete this step?')) {
                // Remove from array
                workflowSteps = workflowSteps.filter(s => s.id !== stepId);
                
                // Remove connections
                connections = connections.filter(c => c.from !== stepId && c.to !== stepId);
                
                // Remove element
                const element = document.getElementById(stepId);
                if (element) {
                    element.remove();
                }
                
                // Update connections display
                updateConnections();
                
                // Close properties if this step was selected
                if (selectedStep && selectedStep.id === stepId) {
                    closeProperties();
                }
                
                // Show empty state if no steps
                if (workflowSteps.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                }
            }
        }
        
        // Connections
        function handleConnectionClick(stepId, type) {
            if (!connectionStart) {
                if (type === 'output') {
                    connectionStart = { stepId, type };
                    // Visual feedback
                    document.querySelector(`#${stepId} .connection-point.output`).style.background = '#10b981';
                }
            } else {
                if (type === 'input' && connectionStart.stepId !== stepId) {
                    // Create connection
                    createConnection(connectionStart.stepId, stepId);
                    
                    // Reset visual feedback
                    document.querySelector(`#${connectionStart.stepId} .connection-point.output`).style.background = '';
                    connectionStart = null;
                } else {
                    // Cancel connection
                    document.querySelector(`#${connectionStart.stepId} .connection-point.output`).style.background = '';
                    connectionStart = null;
                }
            }
        }
        
        function createConnection(fromId, toId) {
            // Check if connection already exists
            const exists = connections.some(c => c.from === fromId && c.to === toId);
            if (!exists) {
                connections.push({ from: fromId, to: toId });
                updateConnections();
            }
        }
        
        function updateConnections() {
            const svg = document.getElementById('connectionsLayer');
            svg.innerHTML = '';
            
            connections.forEach(conn => {
                const fromElement = document.getElementById(conn.from);
                const toElement = document.getElementById(conn.to);
                
                if (fromElement && toElement) {
                    const fromRect = fromElement.getBoundingClientRect();
                    const toRect = toElement.getBoundingClientRect();
                    const canvasRect = svg.getBoundingClientRect();
                    
                    const x1 = fromRect.right - canvasRect.left;
                    const y1 = fromRect.top + fromRect.height / 2 - canvasRect.top;
                    const x2 = toRect.left - canvasRect.left;
                    const y2 = toRect.top + toRect.height / 2 - canvasRect.top;
                    
                    // Create curved path
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const midX = (x1 + x2) / 2;
                    const d = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                    path.setAttribute('d', d);
                    path.setAttribute('class', 'connection-line');
                    
                    svg.appendChild(path);
                }
            });
        }
        
        // Properties panel
        function showProperties(step) {
            const panel = document.getElementById('propertiesPanel');
            const content = document.getElementById('propertiesContent');
            
            panel.classList.add('open');
            content.innerHTML = generatePropertiesForm(step);
            
            // Initialize any special inputs
            if (step.type === 'keyword' || step.type === 'ai_agent') {
                initKeywordInput();
            }
        }
        
        function closeProperties() {
            document.getElementById('propertiesPanel').classList.remove('open');
        }
        
        function generatePropertiesForm(step) {
            let html = `
                <div class="form-group">
                    <label class="form-label">Step Name</label>
                    <input type="text" class="form-control" id="stepName" value="${step.name}" onchange="updateStepProperty('name', this.value)">
                </div>
            `;
            
            // Type-specific fields
            switch(step.type) {
                case 'template':
                    html += `
                        <div class="form-group">
                            <label class="form-label">Message Template</label>
                            <textarea class="form-control" id="templateText" placeholder="Enter your message template..." onchange="updateStepConfig('templateText', this.value)">${step.config.templateText || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delay Before Send (seconds)</label>
                            <input type="number" class="form-control" min="0" value="${step.config.delayBefore || 0}" onchange="updateStepConfig('delayBefore', parseInt(this.value))">
                        </div>
                    `;
                    break;
                    
                case 'input':
                    html += `
                        <div class="form-group">
                            <label class="form-label">Question/Prompt</label>
                            <textarea class="form-control" placeholder="What would you like to ask?" onchange="updateStepConfig('prompt', this.value)">${step.config.prompt || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Input Type</label>
                            <select class="form-control" onchange="updateStepConfig('inputType', this.value)">
                                <option value="text" ${step.config.inputType === 'text' ? 'selected' : ''}>Text</option>
                                <option value="number" ${step.config.inputType === 'number' ? 'selected' : ''}>Number</option>
                                <option value="choice" ${step.config.inputType === 'choice' ? 'selected' : ''}>Multiple Choice</option>
                                <option value="date" ${step.config.inputType === 'date' ? 'selected' : ''}>Date</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Save Response To Variable</label>
                            <input type="text" class="form-control" placeholder="e.g., customerName" value="${step.config.saveToVariable || ''}" onchange="updateStepConfig('saveToVariable', this.value)">
                        </div>
                    `;
                    break;
                    
                case 'keyword':
                    html += `
                        <div class="form-group">
                            <label class="form-label">Response Message</label>
                            <textarea class="form-control" placeholder="Message to send when keywords match" onchange="updateStepConfig('responseMessage', this.value)">${step.config.responseMessage || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Keywords to Match</label>
                            <div class="keyword-input-container">
                                <input type="text" class="form-control keyword-input" id="keywordInput" placeholder="Type keyword and press Enter">
                                <button class="btn btn-primary" onclick="addKeyword()">Add</button>
                            </div>
                            <div class="keyword-tags" id="keywordTags">
                                ${(step.config.keywords || []).map(k => `
                                    <span class="keyword-tag">
                                        ${k}
                                        <span class="material-icons remove" onclick="removeKeyword('${k}')">close</span>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'ai_agent':
                    html += `
                        <div class="form-group">
                            <label class="form-label">AI Model</label>
                            <select class="form-control" onchange="updateStepConfig('model', this.value)">
                                <option value="phi3:medium" ${step.config.model === 'phi3:medium' ? 'selected' : ''}>Phi-3 Medium (Recommended)</option>
                                <option value="mistral:7b-instruct" ${step.config.model === 'mistral:7b-instruct' ? 'selected' : ''}>Mistral 7B</option>
                                <option value="deepseek-coder:1.3b" ${step.config.model === 'deepseek-coder:1.3b' ? 'selected' : ''}>Deepseek 1.3B (Fast)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">System Prompt</label>
                            <textarea class="form-control" rows="6" placeholder="Define AI behavior..." onchange="updateStepConfig('systemPrompt', this.value)">${step.config.systemPrompt || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Sentences</label>
                            <input type="number" class="form-control" min="1" max="10" value="${step.config.maxSentences || 2}" onchange="updateStepConfig('maxSentences', parseInt(this.value))">
                        </div>
                    `;
                    break;
                    
                case 'conditional':
                    html += `
                        <div class="form-group">
                            <label class="form-label">Conditions</label>
                            <div id="conditionsList">
                                ${generateConditionsHTML(step.config.conditions || [])}
                            </div>
                            <button class="btn btn-secondary" onclick="addCondition()">
                                <span class="material-icons">add</span>
                                Add Condition
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'action':
                    html += `
                        <div class="form-group">
                            <label class="form-label">Action Type</label>
                            <select class="form-control" onchange="updateStepConfig('actionType', this.value)">
                                <option value="update_phase" ${step.config.actionType === 'update_phase' ? 'selected' : ''}>Update Customer Phase</option>
                                <option value="add_tag" ${step.config.actionType === 'add_tag' ? 'selected' : ''}>Add Tag</option>
                                <option value="send_notification" ${step.config.actionType === 'send_notification' ? 'selected' : ''}>Send Internal Notification</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Action Value</label>
                            <input type="text" class="form-control" placeholder="e.g., INTEREST, vip_customer" value="${step.config.actionValue || ''}" onchange="updateStepConfig('actionValue', this.value)">
                        </div>
                    `;
                    break;
            }
            
            return html;
        }
        
        // Update step properties
        function updateStepProperty(property, value) {
            if (selectedStep) {
                selectedStep[property] = value;
                
                // Update display
                const stepElement = document.getElementById(selectedStep.id);
                if (stepElement && property === 'name') {
                    stepElement.querySelector('h4').textContent = value;
                }
            }
        }
        
        function updateStepConfig(property, value) {
            if (selectedStep) {
                selectedStep.config[property] = value;
                
                // Update display
                const stepElement = document.getElementById(selectedStep.id);
                if (stepElement) {
                    stepElement.querySelector('.workflow-step-content').innerHTML = getStepDescription(selectedStep);
                }
            }
        }
        
        // Keywords management
        function initKeywordInput() {
            const input = document.getElementById('keywordInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addKeyword();
                    }
                });
            }
        }
        
        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (keyword && selectedStep) {
                if (!selectedStep.config.keywords) {
                    selectedStep.config.keywords = [];
                }
                
                if (!selectedStep.config.keywords.includes(keyword)) {
                    selectedStep.config.keywords.push(keyword);
                    input.value = '';
                    showProperties(selectedStep); // Refresh display
                }
            }
        }
        
        function removeKeyword(keyword) {
            if (selectedStep && selectedStep.config.keywords) {
                selectedStep.config.keywords = selectedStep.config.keywords.filter(k => k !== keyword);
                showProperties(selectedStep); // Refresh display
            }
        }
        
        // Conditions management
        function generateConditionsHTML(conditions) {
            return conditions.map((cond, index) => `
                <div class="condition-item">
                    <div class="condition-row">
                        <select class="form-control" onchange="updateCondition(${index}, 'type', this.value)">
                            <option value="keyword_match" ${cond.type === 'keyword_match' ? 'selected' : ''}>Keyword Match</option>
                            <option value="variable_equals" ${cond.type === 'variable_equals' ? 'selected' : ''}>Variable Equals</option>
                            <option value="variable_contains" ${cond.type === 'variable_contains' ? 'selected' : ''}>Variable Contains</option>
                        </select>
                        <input type="text" class="form-control" placeholder="Value" value="${cond.value || ''}" onchange="updateCondition(${index}, 'value', this.value)">
                        <button class="step-action-btn delete" onclick="removeCondition(${index})">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                </div>
            `).join('') || '<p style="color: var(--text-secondary); font-size: 14px;">No conditions defined</p>';
        }
        
        function addCondition() {
            if (selectedStep) {
                if (!selectedStep.config.conditions) {
                    selectedStep.config.conditions = [];
                }
                
                selectedStep.config.conditions.push({
                    type: 'keyword_match',
                    value: ''
                });
                
                showProperties(selectedStep);
            }
        }
        
        function updateCondition(index, property, value) {
            if (selectedStep && selectedStep.config.conditions) {
                selectedStep.config.conditions[index][property] = value;
            }
        }
        
        function removeCondition(index) {
            if (selectedStep && selectedStep.config.conditions) {
                selectedStep.config.conditions.splice(index, 1);
                showProperties(selectedStep);
            }
        }
        
        // Save workflow
        async function saveWorkflow() {
            const workflowName = document.getElementById('workflowName').value.trim();
            
            if (!workflowName) {
                alert('Please enter a workflow name');
                return;
            }
            
            if (workflowSteps.length === 0) {
                alert('Please add at least one step to the workflow');
                return;
            }
            
            showLoading(true);
            
            try {
                // First create the automation rule if not exists
                if (!ruleId) {
                    const ruleResponse = await fetch(`${API_URL}/automation/rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: workflowName,
                            description: `Workflow: ${workflowName}`,
                            ruleType: 'workflow',
                            isActive: true,
                            triggerConditions: [],
                            responseMessages: []
                        })
                    });
                    
                    const ruleResult = await ruleResponse.json();
                    if (!ruleResult.success) {
                        throw new Error(ruleResult.error || 'Failed to create rule');
                    }
                    
                    ruleId = ruleResult.data.id;
                }
                
                // Prepare steps data
                const stepsData = workflowSteps.map((step, index) => {
                    // Find connections for this step
                    const nextConnection = connections.find(c => c.from === step.id);
                    const nextStepIndex = nextConnection ? workflowSteps.findIndex(s => s.id === nextConnection.to) : null;
                    
                    return {
                        stepType: step.type,
                        name: step.name,
                        description: getStepDescription(step),
                        config: step.config,
                        templateText: step.config.templateText,
                        keywords: step.config.keywords,
                        aiPrompt: step.config.systemPrompt,
                        aiConfig: {
                            model: step.config.model,
                            maxSentences: step.config.maxSentences
                        },
                        inputType: step.config.inputType,
                        saveToVariable: step.config.saveToVariable,
                        defaultNextStep: nextStepIndex,
                        position: { x: step.x, y: step.y }
                    };
                });
                
                // Create workflow
                const response = await fetch(`${API_URL}/automation/workflows`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ruleId: ruleId,
                        name: workflowName,
                        description: `Visual workflow created with ${workflowSteps.length} steps`,
                        steps: stepsData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Workflow saved successfully!');
                    // Redirect to automation page
                    window.location.href = '/ai-automation.html';
                } else {
                    throw new Error(result.error || 'Failed to save workflow');
                }
            } catch (error) {
                console.error('Error saving workflow:', error);
                alert('Error saving workflow: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // Test workflow
        function testWorkflow() {
            if (workflowSteps.length === 0) {
                alert('Please add steps to test the workflow');
                return;
            }
            
            // Open test modal or redirect to test page
            alert('Test feature coming soon!');
        }
        
        // Clear canvas
        function clearCanvas() {
            if (confirm('Are you sure you want to clear the entire workflow?')) {
                workflowSteps = [];
                connections = [];
                selectedStep = null;
                stepIdCounter = 1;
                
                document.getElementById('canvasContent').innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('connectionsLayer').innerHTML = '';
                
                closeProperties();
            }
        }
        
        // Utility functions
        function getStepTypeName(type) {
            const names = {
                'template': 'Send Message',
                'input': 'Collect Input',
                'keyword': 'Keyword Match',
                'ai_agent': 'AI Response',
                'conditional': 'Conditional',
                'action': 'Action'
            };
            return names[type] || type;
        }
        
        function getStepIcon(type) {
            const icons = {
                'template': 'message',
                'input': 'input',
                'keyword': 'label',
                'ai_agent': 'psychology',
                'conditional': 'call_split',
                'action': 'bolt'
            };
            return icons[type] || 'help';
        }
        
        function getStepDescription(step) {
            switch(step.type) {
                case 'template':
                    return step.config.templateText || 'No message configured';
                case 'input':
                    return step.config.prompt || 'Collecting user input';
                case 'keyword':
                    const keywords = step.config.keywords || [];
                    return keywords.length > 0 ? `Matching: ${keywords.join(', ')}` : 'No keywords configured';
                case 'ai_agent':
                    return `AI: ${step.config.model || 'Default model'}`;
                case 'conditional':
                    const conditions = step.config.conditions || [];
                    return `${conditions.length} condition(s)`;
                case 'action':
                    return step.config.actionType || 'No action configured';
                default:
                    return 'Configure this step';
            }
        }
        
        function getDefaultConfig(type) {
            const configs = {
                'template': { templateText: '', delayBefore: 0 },
                'input': { prompt: '', inputType: 'text', saveToVariable: '' },
                'keyword': { keywords: [], responseMessage: '' },
                'ai_agent': { model: 'phi3:medium', systemPrompt: '', maxSentences: 2 },
                'conditional': { conditions: [] },
                'action': { actionType: 'update_phase', actionValue: '' }
            };
            return configs[type] || {};
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }
        
        // Window resize handler
        window.addEventListener('resize', updateConnections);
    </script>
</body>
</html>