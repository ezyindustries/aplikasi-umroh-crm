<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Automation - WhatsApp CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background overlay effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Floating particles effect */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            display: block;
            pointer-events: none;
            opacity: 0.5;
        }
        
        /* Main container */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo .material-icons {
            font-size: 28px;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-menu {
            display: flex;
            gap: 36px;
            align-items: center;
            margin: 0 auto;
        }
        
        .nav-item {
            color: #94a3b8;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-item:hover {
            color: #e2e8f0;
        }
        
        .nav-item.active {
            color: #3b82f6;
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 2px;
        }
        
        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .notification-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: linear-gradient(135deg, #ec4899, #f43f5e);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.5);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px 8px 8px;
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border-radius: 40px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-profile:hover {
            background: linear-gradient(145deg, rgba(71, 85, 105, 0.6), rgba(51, 65, 85, 0.4));
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-name {
            font-weight: 500;
            font-size: 14px;
            color: #e2e8f0;
        }
        
        .user-role {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* Page Title */
        .page-title {
            margin-bottom: 32px;
        }
        
        .page-title h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .page-title p {
            color: #94a3b8;
            font-size: 16px;
        }
        
        /* Main layout */
        .automation-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        
        /* Sidebar */
        .sidebar {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar-section {
            margin-bottom: 24px;
        }
        
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        .rule-type {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        
        .rule-type:hover {
            background: linear-gradient(145deg, rgba(71, 85, 105, 0.6), rgba(51, 65, 85, 0.4));
            transform: translateX(4px);
        }
        
        .rule-type.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .rule-type .material-icons {
            font-size: 20px;
            color: #3b82f6;
        }
        
        .rule-type-label {
            flex: 1;
            font-weight: 500;
        }
        
        .rule-count {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .content-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 8px 16px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.5);
            transform: translateY(-2px);
        }
        
        /* Rule Cards */
        .rules-grid {
            display: grid;
            gap: 16px;
        }
        
        .rule-card {
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .rule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .rule-info {
            flex: 1;
        }
        
        .rule-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .rule-description {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .rule-toggle {
            width: 48px;
            height: 26px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rule-toggle.active {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .rule-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .rule-toggle.active::after {
            transform: translateX(22px);
        }
        
        .rule-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .rule-stat {
            background: rgba(30, 41, 59, 0.5);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .rule-stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        
        .rule-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .rule-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: #94a3b8;
            transition: all 0.3s ease;
        }
        
        .btn-icon:hover {
            background: rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
            transform: translateY(-2px);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
        }
        
        .empty-state .material-icons {
            font-size: 80px;
            color: #475569;
            margin-bottom: 24px;
        }
        
        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #e2e8f0;
        }
        
        .empty-state p {
            color: #94a3b8;
            margin-bottom: 24px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: flex-start;
            justify-content: center;
            padding: 24px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            margin: 20px auto;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 92, 246, 0.3) rgba(30, 41, 59, 0.3);
        }
        
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            color: #e2e8f0;
            transform: rotate(90deg);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            position: relative;
            z-index: 10;
        }
        
        /* Ensure all inputs are clickable */
        .reply-message-item textarea,
        .reply-message-item input {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .form-helper {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        /* Keyword Tags */
        .keyword-input-container {
            position: relative;
        }
        
        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .keyword-tag {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .keyword-tag .remove {
            cursor: pointer;
            color: #94a3b8;
            font-size: 16px;
        }
        
        .keyword-tag .remove:hover {
            color: #ef4444;
        }
        
        /* Schedule Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .schedule-day {
            text-align: center;
            padding: 8px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .schedule-day.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .stat-icon.blue {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            color: #3b82f6;
        }
        
        .stat-icon.green {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: #10b981;
        }
        
        .stat-icon.purple {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
            color: #8b5cf6;
        }
        
        .stat-icon.orange {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: #f59e0b;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 8px;
        }
        
        .stat-trend.positive {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .stat-trend.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .stat-trend .material-icons {
            font-size: 16px;
        }
        
        /* Pipeline Cards */
        .pipeline-section {
            margin-bottom: 32px;
        }
        
        .pipeline-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .pipeline-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .pipeline-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            opacity: 0.8;
        }
        
        .pipeline-card.interest::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .pipeline-card.closing::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .pipeline-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 30px 50px rgba(0, 0, 0, 0.4);
        }
        
        .pipeline-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .pipeline-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .pipeline-icon.leads-icon {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            color: #3b82f6;
        }
        
        .pipeline-icon.interest-icon {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: #f59e0b;
        }
        
        .pipeline-icon.closing-icon {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: #10b981;
        }
        
        .pipeline-icon .material-icons {
            font-size: 24px;
        }
        
        .pipeline-info {
            flex: 1;
        }
        
        .pipeline-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #e2e8f0;
            letter-spacing: 0.5px;
        }
        
        .pipeline-description {
            font-size: 12px;
            color: #94a3b8;
            margin: 0;
        }
        
        .pipeline-metrics {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .pipeline-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .pipeline-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .pipeline-trend.positive {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .pipeline-trend.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .pipeline-trend .material-icons {
            font-size: 16px;
        }
        
        .pipeline-details {
            margin-bottom: 20px;
        }
        
        .pipeline-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .pipeline-stat:last-child {
            border-bottom: none;
        }
        
        .pipeline-stat .stat-label {
            font-size: 13px;
            color: #94a3b8;
        }
        
        .pipeline-stat .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .pipeline-conversion {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .conversion-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .conversion-bar {
            width: 100%;
            height: 6px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .conversion-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 3px;
            transition: width 0.8s ease;
        }
        
        .leads .conversion-fill {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }
        
        .interest .conversion-fill {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .conversion-text {
            font-size: 12px;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        /* Reply Messages Styles */
        .reply-message-item {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            transition: all 0.3s ease;
            z-index: 1;
        }
        
        .reply-message-item * {
            position: relative;
            z-index: 2;
        }
        
        .reply-message-item:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(71, 85, 105, 0.4);
        }
        
        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .reply-number {
            font-weight: 600;
            color: #3b82f6;
            font-size: 14px;
        }
        
        .reply-type-selector {
            display: flex;
            gap: 4px;
            background: rgba(15, 23, 42, 0.6);
            padding: 4px;
            border-radius: 8px;
        }
        
        .type-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #94a3b8;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .type-btn:hover {
            background: rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
        }
        
        .type-btn.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2));
            color: #3b82f6;
        }
        
        .type-btn .material-icons {
            font-size: 16px;
        }
        
        .reply-content {
            position: relative;
        }
        
        .reply-content .text-content,
        .reply-content .image-content {
            display: none;
        }
        
        .reply-content .text-content {
            display: block;
        }
        
        /* Ensure form controls are accessible */
        .reply-content textarea,
        .reply-content input {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
        }
        
        .reply-content textarea.form-control {
            width: 100%;
            resize: vertical;
        }
        
        .image-upload-area {
            position: relative;
            border: 2px dashed rgba(71, 85, 105, 0.5);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .image-upload-area:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .image-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            cursor: pointer;
            text-align: center;
        }
        
        .upload-label .material-icons {
            font-size: 48px;
            color: #475569;
            margin-bottom: 12px;
        }
        
        .upload-label span:nth-child(2) {
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .file-info {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .image-preview {
            position: relative;
            padding: 0;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
        }
        
        .remove-image {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-image:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .remove-image .material-icons {
            font-size: 18px;
        }
        
        .btn-add-reply {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        
        .btn-add-reply:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .btn-add-reply .material-icons {
            font-size: 20px;
        }
        
        .remove-reply-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 50%;
            color: #ef4444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
            padding: 0;
        }
        
        .remove-reply-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.1);
        }
        
        /* Loading and Error States */
        .loading-spinner {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
            font-size: 16px;
        }
        
        .loading-spinner::before {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            text-align: center;
            padding: 40px;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .automation-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .pipeline-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }
            
            .container {
                padding: 16px;
            }
            
            .header {
                padding: 16px 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .rule-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Floating particles background -->
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="material-icons">hub</span>
                Vauza Tamma CRM
            </div>
            
            <nav class="nav-menu">
                <a href="crm-main.html" class="nav-item">Dashboard</a>
                <a href="conversations-beautiful.html" class="nav-item">WhatsApp</a>
                <a href="ai-automation.html" class="nav-item active">AI</a>
                <a href="#" class="nav-item">Leads</a>
                <a href="#" class="nav-item">Campaigns</a>
                <a href="#" class="nav-item">Analytics</a>
            </nav>
            
            <div class="header-actions">
                <div class="notification-btn">
                    <span class="material-icons">notifications</span>
                    <span class="notification-badge">3</span>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">
                        <span class="avatar-initials">A</span>
                    </div>
                    <div>
                        <div class="user-name">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page Title -->
        <div class="page-title">
            <h1>AI Automation</h1>
            <p>Atur rules otomatis untuk auto-reply WhatsApp dan tingkatkan efisiensi customer service</p>
        </div>
        
        <!-- Pipeline Overview -->
        <div class="pipeline-section">
            <h2 class="pipeline-title">Customer Journey Pipeline - Bulan Ini</h2>
            <div class="pipeline-grid">
                <div class="pipeline-card leads">
                    <div class="pipeline-header">
                        <div class="pipeline-icon leads-icon">
                            <span class="material-icons">person_add</span>
                        </div>
                        <div class="pipeline-info">
                            <h3 class="pipeline-name">LEADS</h3>
                            <p class="pipeline-description">Initial inquiry & package matching</p>
                        </div>
                    </div>
                    <div class="pipeline-metrics">
                        <div class="pipeline-value" id="leadsCount">127</div>
                        <div class="pipeline-trend positive">
                            <span class="material-icons">trending_up</span>
                            +23.4%
                        </div>
                    </div>
                    <div class="pipeline-details">
                        <div class="pipeline-stat">
                            <span class="stat-label">Dari Instagram</span>
                            <span class="stat-value">68</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Dari Referral</span>
                            <span class="stat-value">41</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Direct WhatsApp</span>
                            <span class="stat-value">18</span>
                        </div>
                    </div>
                    <div class="pipeline-conversion">
                        <div class="conversion-label">Konversi ke Interest</div>
                        <div class="conversion-bar">
                            <div class="conversion-fill" style="width: 65%"></div>
                        </div>
                        <div class="conversion-text">65% (83 orang)</div>
                    </div>
                </div>
                
                <div class="pipeline-card interest">
                    <div class="pipeline-header">
                        <div class="pipeline-icon interest-icon">
                            <span class="material-icons">psychology</span>
                        </div>
                        <div class="pipeline-info">
                            <h3 class="pipeline-name">INTEREST</h3>
                            <p class="pipeline-description">Detailed consultation & negotiation</p>
                        </div>
                    </div>
                    <div class="pipeline-metrics">
                        <div class="pipeline-value" id="interestCount">83</div>
                        <div class="pipeline-trend positive">
                            <span class="material-icons">trending_up</span>
                            +18.7%
                        </div>
                    </div>
                    <div class="pipeline-details">
                        <div class="pipeline-stat">
                            <span class="stat-label">Paket 9 Hari</span>
                            <span class="stat-value">31</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Paket 12 Hari</span>
                            <span class="stat-value">38</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Plus Turkey</span>
                            <span class="stat-value">14</span>
                        </div>
                    </div>
                    <div class="pipeline-conversion">
                        <div class="conversion-label">Konversi ke Closing</div>
                        <div class="conversion-bar">
                            <div class="conversion-fill" style="width: 42%"></div>
                        </div>
                        <div class="conversion-text">42% (35 orang)</div>
                    </div>
                </div>
                
                <div class="pipeline-card closing">
                    <div class="pipeline-header">
                        <div class="pipeline-icon closing-icon">
                            <span class="material-icons">payments</span>
                        </div>
                        <div class="pipeline-info">
                            <h3 class="pipeline-name">CLOSING</h3>
                            <p class="pipeline-description">Payment confirmation & documentation</p>
                        </div>
                    </div>
                    <div class="pipeline-metrics">
                        <div class="pipeline-value" id="closingCount">35</div>
                        <div class="pipeline-trend positive">
                            <span class="material-icons">trending_up</span>
                            +12.9%
                        </div>
                    </div>
                    <div class="pipeline-details">
                        <div class="pipeline-stat">
                            <span class="stat-label">DP Received</span>
                            <span class="stat-value">32</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Docs Complete</span>
                            <span class="stat-value">28</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Fully Paid</span>
                            <span class="stat-value">24</span>
                        </div>
                    </div>
                    <div class="pipeline-conversion">
                        <div class="conversion-label">Completion Rate</div>
                        <div class="conversion-bar">
                            <div class="conversion-fill" style="width: 89%"></div>
                        </div>
                        <div class="conversion-text">89% (31 dari 35)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <span class="material-icons">smart_toy</span>
                </div>
                <div class="stat-value">8</div>
                <div class="stat-label">Active Rules</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_up</span>
                    +2 this week
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon green">
                    <span class="material-icons">reply_all</span>
                </div>
                <div class="stat-value">1,247</div>
                <div class="stat-label">Auto Replies Sent</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_up</span>
                    +18.5%
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon purple">
                    <span class="material-icons">timer</span>
                </div>
                <div class="stat-value">0.8s</div>
                <div class="stat-label">Avg Response Time</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_down</span>
                    -0.3s
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon orange">
                    <span class="material-icons">thumb_up</span>
                </div>
                <div class="stat-value">94%</div>
                <div class="stat-label">Customer Satisfaction</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_up</span>
                    +2.1%
                </div>
            </div>
        </div>
        
        <!-- Main Content Grid -->
        <div class="automation-grid">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Rule Types</h3>
                    <div class="rule-type active" onclick="filterRules('all')">
                        <span class="material-icons">dashboard</span>
                        <span class="rule-type-label">All Rules</span>
                        <span class="rule-count">12</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('welcome')">
                        <span class="material-icons">waving_hand</span>
                        <span class="rule-type-label">Welcome Messages</span>
                        <span class="rule-count">2</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('away')">
                        <span class="material-icons">schedule</span>
                        <span class="rule-type-label">Away Messages</span>
                        <span class="rule-count">3</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('keyword')">
                        <span class="material-icons">text_fields</span>
                        <span class="rule-type-label">Keyword Replies</span>
                        <span class="rule-count">5</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('workflow')">
                        <span class="material-icons">account_tree</span>
                        <span class="rule-type-label">Workflows</span>
                        <span class="rule-count">2</span>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Quick Actions</h3>
                    <button class="btn btn-primary" style="width: 100%;" onclick="openCreateModal()">
                        <span class="material-icons">add</span>
                        Create New Rule
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="showTemplates()">
                        <span class="material-icons">content_copy</span>
                        Browse Templates
                    </button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <div class="content-header">
                    <h2 class="content-title">Active Automation Rules</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportRules()">
                            <span class="material-icons">download</span>
                            Export Rules
                        </button>
                        <button class="btn btn-primary" onclick="openCreateModal()">
                            <span class="material-icons">add</span>
                            Add Rule
                        </button>
                    </div>
                </div>
                
                <!-- Rules List -->
                <div class="rules-grid" id="rulesGrid">
                    <!-- Welcome Message Rule -->
                    <div class="rule-card" data-type="welcome">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Welcome New Customers</h3>
                                <p class="rule-description">Automatically greet new contacts with package information</p>
                            </div>
                            <div class="rule-toggle active" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Triggered</div>
                                <div class="rule-stat-value">342</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Success Rate</div>
                                <div class="rule-stat-value">98%</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Last Used</div>
                                <div class="rule-stat-value">2 min ago</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Away Message Rule -->
                    <div class="rule-card" data-type="away">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Out of Office Hours</h3>
                                <p class="rule-description">Reply when messages received outside business hours</p>
                            </div>
                            <div class="rule-toggle active" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Triggered</div>
                                <div class="rule-stat-value">128</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Schedule</div>
                                <div class="rule-stat-value">Mon-Fri</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Time</div>
                                <div class="rule-stat-value">17:00-08:00</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Keyword Reply Rule -->
                    <div class="rule-card" data-type="keyword">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Price Inquiry Response</h3>
                                <p class="rule-description">Auto-reply with package prices when keywords detected</p>
                            </div>
                            <div class="rule-toggle active" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Keywords</div>
                                <div class="rule-stat-value">8</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Triggered</div>
                                <div class="rule-stat-value">567</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Conversion</div>
                                <div class="rule-stat-value">23%</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Workflow Rule -->
                    <div class="rule-card" data-type="workflow">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Appointment Booking Flow</h3>
                                <p class="rule-description">Guide customers through appointment scheduling process</p>
                            </div>
                            <div class="rule-toggle" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Steps</div>
                                <div class="rule-stat-value">5</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Completed</div>
                                <div class="rule-stat-value">89</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Drop Rate</div>
                                <div class="rule-stat-value">12%</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Empty State (hidden by default) -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <span class="material-icons">smart_toy</span>
                    <h3>No Automation Rules Yet</h3>
                    <p>Create your first automation rule to start saving time and improving response rates</p>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <span class="material-icons">add</span>
                        Create First Rule
                    </button>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Create/Edit Rule Modal -->
    <div class="modal" id="ruleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Automation Rule</h2>
                <button class="close-btn" onclick="hideModal('rule')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <form id="ruleForm">
                <div class="form-group">
                    <label class="form-label">Rule Name</label>
                    <input type="text" class="form-control" id="ruleName" placeholder="e.g., Welcome New Customers" required>
                    <span class="form-helper">Give your rule a descriptive name</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="ruleDescription" rows="2" placeholder="Describe what this rule does..."></textarea>
                    <span class="form-helper">Optional description for your reference</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rule Type</label>
                    <select class="form-control" onchange="updateRuleTypeFields(this.value)" required>
                        <option value="">Select rule type...</option>
                        <option value="welcome">Welcome Message</option>
                        <option value="away">Away Message</option>
                        <option value="keyword" selected>Keyword Reply</option>
                        <option value="workflow">Conversation Workflow</option>
                    </select>
                </div>
                
                <!-- Welcome Message Fields -->
                <div id="welcomeFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Trigger Condition</label>
                        <select class="form-control">
                            <option>First message from new contact</option>
                            <option>Contact joins group</option>
                            <option>Contact opts in</option>
                        </select>
                    </div>
                </div>
                
                <!-- Away Message Fields -->
                <div id="awayFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Schedule Days</label>
                        <div class="schedule-grid">
                            <div class="schedule-day">Sun</div>
                            <div class="schedule-day active">Mon</div>
                            <div class="schedule-day active">Tue</div>
                            <div class="schedule-day active">Wed</div>
                            <div class="schedule-day active">Thu</div>
                            <div class="schedule-day active">Fri</div>
                            <div class="schedule-day">Sat</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Active Hours</label>
                        <div class="time-inputs">
                            <input type="time" class="form-control" value="09:00">
                            <input type="time" class="form-control" value="17:00">
                        </div>
                    </div>
                </div>
                
                <!-- Keyword Reply Fields -->
                <div id="keywordFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Trigger Keywords</label>
                        <div class="keyword-input-container">
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" class="form-control" id="keywordInput" placeholder="Type keyword" onkeypress="addKeyword(event)" style="flex: 1;">
                                <button type="button" class="btn btn-primary" onclick="addKeywordButton()" style="padding: 12px 20px;">
                                    <span class="material-icons">add</span>
                                    Add
                                </button>
                            </div>
                            <div class="keyword-tags" id="keywordTags">
                                <!-- Keywords will be added dynamically here -->
                            </div>
                        </div>
                        <span class="form-helper" style="color: #f59e0b;">⚠️ Add keywords by typing and pressing ENTER key</span>
                    </div>
                </div>
                
                <!-- Reply Messages Section -->
                <div class="form-group">
                    <label class="form-label">Reply Messages</label>
                    <div id="replyMessagesContainer">
                        <!-- First reply message (default) -->
                        <div class="reply-message-item" data-index="0">
                            <div class="reply-header">
                                <span class="reply-number">Reply 1</span>
                                <div class="reply-type-selector">
                                    <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(0, 'text')">
                                        <span class="material-icons">text_fields</span>
                                        Text
                                    </button>
                                    <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(0, 'image')">
                                        <span class="material-icons">image</span>
                                        Image
                                    </button>
                                </div>
                            </div>
                            
                            <div class="reply-content">
                                <div class="text-content" id="textContent0">
                                    <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                                    <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                                </div>
                                
                                <div class="image-content" id="imageContent0" style="display: none;">
                                    <div class="image-upload-area">
                                        <input type="file" accept="image/*" class="image-input" id="imageInput0" onchange="handleImageSelect(0, this)">
                                        <label for="imageInput0" class="upload-label">
                                            <span class="material-icons">cloud_upload</span>
                                            <span>Click to upload image</span>
                                            <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                        </label>
                                        <div class="image-preview" id="imagePreview0" style="display: none;">
                                            <img src="" alt="Preview">
                                            <button type="button" class="remove-image" onclick="removeImage(0)">
                                                <span class="material-icons">close</span>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add-reply" onclick="addReplyMessage()">
                        <span class="material-icons">add_circle</span>
                        Add Another Reply
                    </button>
                    <span class="form-helper">Messages will be sent in sequence with delays between each</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Delay (seconds)</label>
                    <input type="number" class="form-control" id="responseDelay" value="2" min="0" max="10">
                    <span class="form-helper">Delay before sending the first response</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message Delay (seconds)</label>
                    <input type="number" class="form-control" id="messageDelay" value="1" min="0" max="5">
                    <span class="form-helper">Delay between multiple messages in sequence</span>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="clearForm()" style="margin-right: auto;">
                        <span class="material-icons">clear_all</span>
                        Hapus Semua
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideModal('rule')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        <span id="submitButtonText">Save Rule</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Backend Configuration
        const API_CONFIG = {
            baseUrl: 'http://localhost:3001/api',
            sessionId: 'default'
        };
        
        // Load pipeline statistics
        async function loadPipelineStats() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/dashboard/pipeline-stats`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        updatePipelineCards(data);
                    } else {
                        console.warn('API returned error:', data.error || 'Unknown error');
                        loadDemoPipelineData();
                    }
                } else {
                    console.warn(`Failed to load pipeline stats: ${response.status} ${response.statusText}`);
                    loadDemoPipelineData();
                }
            } catch (error) {
                console.error('Error loading pipeline stats:', error);
                loadDemoPipelineData();
            }
        }
        
        // Load demo pipeline data as fallback
        function loadDemoPipelineData() {
            const demoData = {
                success: true,
                data: {
                    leads: {
                        total: 127,
                        trend: 15,
                        sources: { instagram: 68, referral: 41, whatsapp: 18 },
                        conversionRate: 65,
                        converted: 83
                    },
                    interest: {
                        total: 83,
                        trend: 8,
                        packages: { '9H': 31, '12H': 38, 'TUR': 14 },
                        conversionRate: 42,
                        converted: 35
                    },
                    closing: {
                        total: 35,
                        trend: -5,
                        payments: { dp_received: 32, full: 24, partial: 8 },
                        conversionRate: 89,
                        converted: 31
                    }
                }
            };
            console.log('Using demo pipeline data');
            updatePipelineCards(demoData);
        }
        
        // Update pipeline cards with data
        function updatePipelineCards(data) {
            if (data.success && data.data) {
                const stats = data.data;
                
                // Update LEADS card
                if (stats.leads) {
                    document.getElementById('leadsCount').textContent = stats.leads.total || 127;
                    updatePipelineDetails('leads', stats.leads);
                }
                
                // Update INTEREST card
                if (stats.interest) {
                    document.getElementById('interestCount').textContent = stats.interest.total || 83;
                    updatePipelineDetails('interest', stats.interest);
                }
                
                // Update CLOSING card
                if (stats.closing) {
                    document.getElementById('closingCount').textContent = stats.closing.total || 35;
                    updatePipelineDetails('closing', stats.closing);
                }
            }
        }
        
        // Update pipeline details for specific phase
        function updatePipelineDetails(phase, data) {
            const card = document.querySelector(`.pipeline-card.${phase}`);
            if (!card) return;
            
            // Update trend
            const trendEl = card.querySelector('.pipeline-trend');
            if (data.trend) {
                const percentage = data.trend > 0 ? `+${data.trend}%` : `${data.trend}%`;
                const trendClass = data.trend > 0 ? 'positive' : 'negative';
                const icon = data.trend > 0 ? 'trending_up' : 'trending_down';
                
                trendEl.className = `pipeline-trend ${trendClass}`;
                trendEl.innerHTML = `
                    <span class="material-icons">${icon}</span>
                    ${percentage}
                `;
            }
            
            // Update conversion rates
            const conversionBar = card.querySelector('.conversion-fill');
            const conversionText = card.querySelector('.conversion-text');
            if (data.conversionRate && conversionBar && conversionText) {
                conversionBar.style.width = `${data.conversionRate}%`;
                conversionText.textContent = `${data.conversionRate}% (${data.converted || 0} orang)`;
            }
        }
        
        // Initialize particles background
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 10;
            
            for (let i = 0; i < particleCount; i++) {
                createParticle(particlesContainer);
            }
        }
        
        function createParticle(container) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Random size
            const size = Math.random() * 100 + 50;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            
            // Random position
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            
            // Random color
            const colors = [
                'radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%)',
                'radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%)',
                'radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%)'
            ];
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            // Random animation
            const duration = Math.random() * 20 + 20;
            const delay = Math.random() * 20;
            
            particle.style.animation = `float ${duration}s ${delay}s infinite ease-in-out`;
            
            container.appendChild(particle);
        }
        
        // Add floating animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes float {
                0%, 100% {
                    transform: translate(0, 0) scale(1);
                    opacity: 0.5;
                }
                25% {
                    transform: translate(100px, -100px) scale(1.1);
                    opacity: 0.7;
                }
                50% {
                    transform: translate(-100px, -200px) scale(0.9);
                    opacity: 0.4;
                }
                75% {
                    transform: translate(-50px, -100px) scale(1.05);
                    opacity: 0.6;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Filter rules by type
        function filterRules(type) {
            // Update active state in sidebar
            document.querySelectorAll('.rule-type').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.rule-type').classList.add('active');
            
            // Filter rule cards
            const ruleCards = document.querySelectorAll('.rule-card');
            let visibleCount = 0;
            
            ruleCards.forEach(card => {
                if (type === 'all' || card.dataset.type === type) {
                    card.style.display = '';
                    card.style.animation = 'fadeIn 0.3s ease';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show empty state if no rules match filter
            const rulesGrid = document.getElementById('rulesGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (visibleCount === 0 && ruleCards.length > 0) {
                rulesGrid.innerHTML = `
                    <div class="empty-filter-state" style="text-align: center; padding: 60px; color: #94a3b8;">
                        <span class="material-icons" style="font-size: 60px; color: #475569; margin-bottom: 16px; display: block;">filter_alt_off</span>
                        <h3 style="margin-bottom: 8px;">No ${type} rules found</h3>
                        <p>Try creating a new ${type} rule or select a different filter.</p>
                    </div>
                `;
            }
        }
        
        // Add fade in animation
        const fadeInStyle = document.createElement('style');
        fadeInStyle.textContent = `
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(fadeInStyle);
        
        // Toggle rule active state
        async function toggleRule(ruleId, toggleElement) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to toggle rule');
                
                const result = await response.json();
                if (result.success) {
                    toggleElement.classList.toggle('active', result.data.isActive);
                    showToast(`Rule ${result.data.isActive ? 'activated' : 'deactivated'}`, 'success');
                } else {
                    throw new Error(result.error || 'Failed to toggle rule');
                }
            } catch (error) {
                console.error('Error toggling rule:', error);
                showToast('Failed to toggle rule', 'error');
                // Revert toggle state
                toggleElement.classList.toggle('active');
            }
        }
        
        // Open create modal with fresh form
        function openCreateModal() {
            const form = document.getElementById('ruleForm');
            
            // Force reset mode
            form.dataset.mode = 'create';
            delete form.dataset.ruleId;
            
            // Reset form
            form.reset();
            
            // Clear all inputs explicitly
            document.getElementById('ruleName').value = '';
            document.getElementById('ruleDescription').value = '';
            document.getElementById('responseDelay').value = '2';
            document.getElementById('messageDelay').value = '1';
            
            // Clear keywords
            const keywordTags = document.getElementById('keywordTags');
            if (keywordTags) {
                keywordTags.innerHTML = '';
            }
            
            // Reset to keyword type
            const ruleTypeSelect = form.querySelector('select');
            ruleTypeSelect.value = 'keyword';
            // Force update fields
            setTimeout(() => {
                updateRuleTypeFields('keyword');
            }, 50);
            
            // Reset modal title and button
            document.querySelector('#ruleModal .modal-title').textContent = 'Create Automation Rule';
            document.getElementById('submitButtonText').textContent = 'Save Rule';
            
            // Reset reply messages
            resetReplyMessages();
            
            // Show modal
            showModal('rule');
        }
        
        // Show modal
        function showModal(type) {
            const modal = document.getElementById(type + 'Modal');
            
            // Reset form if opening for new rule
            if (type === 'rule') {
                const form = document.getElementById('ruleForm');
                // Only reset if NOT in edit mode
                if (!form.dataset.mode || form.dataset.mode !== 'edit') {
                    // Clear form completely for new rule
                    form.reset();
                    form.dataset.mode = 'create';
                    delete form.dataset.ruleId;
                    
                    // Reset modal title and button
                    document.querySelector('#ruleModal .modal-title').textContent = 'Create Automation Rule';
                    document.getElementById('submitButtonText').textContent = 'Save Rule';
                    
                    // Clear all fields
                    document.getElementById('ruleName').value = '';
                    document.getElementById('ruleDescription').value = '';
                    document.getElementById('responseDelay').value = '2';
                    document.getElementById('messageDelay').value = '1';
                    
                    // Clear keywords
                    const keywordTags = document.getElementById('keywordTags');
                    if (keywordTags) {
                        keywordTags.innerHTML = '';
                    }
                    
                    // Reset to keyword type and ensure fields are shown
                    const ruleTypeSelect = form.querySelector('select');
                    ruleTypeSelect.value = 'keyword';
                    // Force update fields
                    setTimeout(() => {
                        updateRuleTypeFields('keyword');
                    }, 50);
                    
                    // Reset reply messages to default empty state
                    resetReplyMessages();
                    
                    // Reset reply messages to default
                    const replyContainer = document.getElementById('replyMessagesContainer');
                    replyContainer.innerHTML = `
                        <div class="reply-message-item" data-index="0">
                            <div class="reply-header">
                                <span class="reply-number">Reply 1</span>
                                <div class="reply-type-selector">
                                    <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(0, 'text')">
                                        <span class="material-icons">text_fields</span>
                                        Text
                                    </button>
                                    <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(0, 'image')">
                                        <span class="material-icons">image</span>
                                        Image
                                    </button>
                                </div>
                            </div>
                            
                            <div class="reply-content">
                                <div class="text-content" id="textContent0">
                                    <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                                    <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                                </div>
                                
                                <div class="image-content" id="imageContent0" style="display: none;">
                                    <div class="image-upload-area">
                                        <input type="file" accept="image/*" class="image-input" id="imageInput0" onchange="handleImageSelect(0, this)">
                                        <label for="imageInput0" class="upload-label">
                                            <span class="material-icons">cloud_upload</span>
                                            <span>Click to upload image</span>
                                            <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                        </label>
                                        <div class="image-preview" id="imagePreview0" style="display: none;">
                                            <img src="" alt="Preview">
                                            <button type="button" class="remove-image" onclick="removeImage(0)">
                                                <span class="material-icons">close</span>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                                </div>
                            </div>
                        </div>
                    `;
                    replyMessageCount = 1;
                    
                    // Reset keywords
                    document.getElementById('keywordTags').innerHTML = '';
                    
                    // Hide type-specific fields
                    document.getElementById('welcomeFields').style.display = 'none';
                    document.getElementById('awayFields').style.display = 'none';
                    document.getElementById('keywordFields').style.display = 'none';
                }
            }
            
            modal.style.display = 'flex';
        }
        
        // Hide modal
        function hideModal(type) {
            const modal = document.getElementById(type + 'Modal');
            modal.style.display = 'none';
            
            // Clear form mode when closing
            if (type === 'rule') {
                const form = document.getElementById('ruleForm');
                form.dataset.mode = '';
                delete form.dataset.ruleId;
            }
        }
        
        // Update form fields based on rule type
        function updateRuleTypeFields(type) {
            // Hide all type-specific fields
            document.getElementById('welcomeFields').style.display = 'none';
            document.getElementById('awayFields').style.display = 'none';
            document.getElementById('keywordFields').style.display = 'none';
            
            // Show relevant fields
            if (type === 'welcome') {
                document.getElementById('welcomeFields').style.display = 'block';
            } else if (type === 'away') {
                document.getElementById('awayFields').style.display = 'block';
            } else if (type === 'keyword') {
                document.getElementById('keywordFields').style.display = 'block';
            }
        }
        
        // Add keyword
        function addKeyword(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addKeywordButton();
            }
        }
        
        // Add keyword via button
        function addKeywordButton() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (keyword) {
                const tagsContainer = document.getElementById('keywordTags');
                const tag = document.createElement('span');
                tag.className = 'keyword-tag';
                tag.innerHTML = `${keyword}<span class="remove" onclick="removeKeyword(this)">&times;</span>`;
                tagsContainer.appendChild(tag);
                input.value = '';
                
                // Visual feedback
                input.focus();
                
                // Debug log
                console.log('Keyword added:', keyword);
                const allTags = tagsContainer.querySelectorAll('.keyword-tag');
                console.log('Total keywords now:', allTags.length);
                
                // Show success feedback
                showToast(`Keyword "${keyword}" added`, 'success');
            } else {
                showToast('Please enter a keyword', 'warning');
            }
        }
        
        // Remove keyword
        function removeKeyword(element) {
            element.parentElement.remove();
        }
        
        // Toggle schedule day
        document.querySelectorAll('.schedule-day').forEach(day => {
            day.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });
        
        // Reply message counter
        let replyMessageCount = 1;
        
        // Change reply type (text/image)
        function changeReplyType(index, type) {
            const item = document.querySelector(`.reply-message-item[data-index="${index}"]`);
            if (!item) return;
            
            // Update button states
            item.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            // Show/hide content areas
            const textContent = item.querySelector('.text-content');
            const imageContent = item.querySelector('.image-content');
            
            if (type === 'text') {
                textContent.style.display = 'block';
                imageContent.style.display = 'none';
            } else {
                textContent.style.display = 'none';
                imageContent.style.display = 'block';
            }
        }
        
        // Add new reply message
        function addReplyMessage() {
            const container = document.getElementById('replyMessagesContainer');
            const newIndex = replyMessageCount++;
            
            const newReplyHtml = `
                <div class="reply-message-item" data-index="${newIndex}">
                    <button type="button" class="remove-reply-btn" onclick="removeReplyMessage(${newIndex})" title="Remove reply">
                        <span class="material-icons">close</span>
                    </button>
                    <div class="reply-header">
                        <span class="reply-number">Reply ${newIndex + 1}</span>
                        <div class="reply-type-selector">
                            <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(${newIndex}, 'text')">
                                <span class="material-icons">text_fields</span>
                                Text
                            </button>
                            <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(${newIndex}, 'image')">
                                <span class="material-icons">image</span>
                                Image
                            </button>
                        </div>
                    </div>
                    
                    <div class="reply-content">
                        <div class="text-content" id="textContent${newIndex}">
                            <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                            <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                        </div>
                    
                        <div class="image-content" id="imageContent${newIndex}" style="display: none;">
                            <div class="image-upload-area">
                                <input type="file" accept="image/*" class="image-input" id="imageInput${newIndex}" onchange="handleImageSelect(${newIndex}, this)">
                                <label for="imageInput${newIndex}" class="upload-label">
                                    <span class="material-icons">cloud_upload</span>
                                    <span>Click to upload image</span>
                                    <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                </label>
                                <div class="image-preview" id="imagePreview${newIndex}" style="display: none;">
                                    <img src="" alt="Preview">
                                    <button type="button" class="remove-image" onclick="removeImage(${newIndex})">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                            </div>
                            <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newReplyHtml);
            updateReplyNumbers();
        }
        
        // Remove reply message
        function removeReplyMessage(index) {
            const item = document.querySelector(`.reply-message-item[data-index="${index}"]`);
            if (item) {
                item.remove();
                updateReplyNumbers();
            }
        }
        
        // Update reply numbers after add/remove
        function updateReplyNumbers() {
            const items = document.querySelectorAll('.reply-message-item');
            items.forEach((item, idx) => {
                const numberEl = item.querySelector('.reply-number');
                if (numberEl) {
                    numberEl.textContent = `Reply ${idx + 1}`;
                }
            });
        }
        
        // Handle image selection
        function handleImageSelect(index, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB');
                input.value = '';
                return;
            }
            
            // Validate file type
            if (!file.type.match(/^image\/(jpeg|png|gif|webp)$/)) {
                alert('Please select a valid image file (JPG, PNG, GIF, or WebP)');
                input.value = '';
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(`imagePreview${index}`);
                const uploadLabel = preview.parentElement.querySelector('.upload-label');
                
                preview.querySelector('img').src = e.target.result;
                preview.style.display = 'block';
                uploadLabel.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        // Remove image
        function removeImage(index) {
            const preview = document.getElementById(`imagePreview${index}`);
            const input = document.getElementById(`imageInput${index}`);
            const uploadLabel = preview.parentElement.querySelector('.upload-label');
            
            preview.style.display = 'none';
            uploadLabel.style.display = 'flex';
            input.value = '';
        }
        
        // Clear form function
        function clearForm() {
            const form = document.getElementById('ruleForm');
            form.reset();
            
            // Clear keyword tags
            const keywordTags = document.getElementById('keywordTags');
            if (keywordTags) {
                keywordTags.innerHTML = '';
            }
            
            // Reset reply messages
            resetReplyMessages();
            
            // Reset rule type fields
            updateRuleTypeFields('keyword');
            
            showToast('Form cleared', 'info');
        }
        
        // Reset reply messages to default
        function resetReplyMessages() {
            const replyContainer = document.getElementById('replyMessagesContainer');
            replyContainer.innerHTML = `
                <div class="reply-message-item" data-index="0">
                    <div class="reply-header">
                        <span class="reply-number">Reply 1</span>
                        <div class="reply-type-selector">
                            <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(0, 'text')">
                                <span class="material-icons">text_fields</span>
                                Text
                            </button>
                            <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(0, 'image')">
                                <span class="material-icons">image</span>
                                Image
                            </button>
                        </div>
                    </div>
                    <div class="reply-content">
                        <div class="text-content" id="textContent0">
                            <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                            <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                        </div>
                        
                        <div class="image-content" id="imageContent0" style="display: none;">
                            <div class="image-upload-area">
                                <input type="file" accept="image/*" class="image-input" id="imageInput0" onchange="handleImageSelect(0, this)">
                                <label for="imageInput0" class="upload-label">
                                    <span class="material-icons">cloud_upload</span>
                                    <span>Click to upload image</span>
                                    <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                </label>
                                <div class="image-preview" id="imagePreview0" style="display: none;">
                                    <img src="" alt="Preview">
                                    <button type="button" class="remove-image" onclick="removeImage(0)">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                            </div>
                            <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                        </div>
                    </div>
                </div>
            `;
            replyMessageCount = 1;
        }
        
        // Handle form submission
        document.getElementById('ruleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const isEditMode = this.dataset.mode === 'edit';
            const ruleId = this.dataset.ruleId;
            
            // Collect form data
            const formData = new FormData();
            const ruleName = document.getElementById('ruleName').value;
            const ruleDescription = document.getElementById('ruleDescription').value;
            const ruleType = this.querySelector('select').value;
            
            // Collect reply messages
            const replyMessages = [];
            const replyItems = document.querySelectorAll('.reply-message-item');
            
            replyItems.forEach((item, index) => {
                const isText = item.querySelector('.text-content').style.display !== 'none';
                
                if (isText) {
                    const text = item.querySelector('textarea').value;
                    if (text.trim()) {
                        replyMessages.push({
                            type: 'text',
                            content: text,
                            order: index
                        });
                    }
                } else {
                    const imageInput = item.querySelector('.image-input');
                    const caption = item.querySelector('.image-content input[type="text"]').value;
                    
                    if (imageInput.files[0]) {
                        replyMessages.push({
                            type: 'image',
                            file: imageInput.files[0],
                            caption: caption,
                            order: index
                        });
                        formData.append(`image_${index}`, imageInput.files[0]);
                    }
                }
            });
            
            // Collect keywords if keyword rule
            let keywords = [];
            if (ruleType === 'keyword') {
                const keywordTags = document.querySelectorAll('#keywordTags .keyword-tag');
                keywords = Array.from(keywordTags).map(tag => {
                    // Get text content and clean it up
                    let text = tag.textContent || tag.innerText || '';
                    // Remove the × symbol and any whitespace
                    text = text.replace(/×/g, '').replace(/\s+/g, ' ').trim();
                    return text;
                }).filter(keyword => keyword.length > 0); // Filter out empty keywords
                
                console.log('Collected keywords:', keywords); // Debug log
                console.log('Keyword tags found:', keywordTags.length); // Debug log
                
                // Show warning only if no keywords found and it's really needed
                if (keywords.length === 0 && ruleType === 'keyword') {
                    console.warn('Warning: No keywords collected! Please add keywords by typing and pressing Enter.');
                    // Remove the alert for better UX - just log to console
                }
            }
            
            // Build rule data
            const ruleData = {
                name: ruleName,
                description: ruleDescription,
                ruleType: ruleType,
                responseMessages: replyMessages,
                responseDelay: parseInt(document.getElementById('responseDelay').value),
                messageDelay: parseInt(document.getElementById('messageDelay').value),
                keywords: keywords,
                // Add other fields based on rule type
            };
            
            // Debug log to see what's being sent
            console.log('Sending rule data:', ruleData);
            console.log('Keywords being sent:', ruleData.keywords);
            console.log('Keywords type:', typeof ruleData.keywords);
            console.log('Keywords is array:', Array.isArray(ruleData.keywords));
            
            // Add to formData - ensure proper JSON encoding
            const jsonData = JSON.stringify(ruleData);
            console.log('JSON stringified data:', jsonData);
            formData.append('ruleData', jsonData);
            
            try {
                // Send to API
                const url = isEditMode 
                    ? `${API_CONFIG.baseUrl}/automation/rules/${ruleId}`
                    : `${API_CONFIG.baseUrl}/automation/rules`;
                    
                const method = isEditMode ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                if (response.ok) {
                    showToast(`Rule ${isEditMode ? 'updated' : 'created'} successfully`, 'success');
                    hideModal('rule');
                    // Reset form
                    this.reset();
                    this.dataset.mode = '';
                    this.dataset.ruleId = '';
                    document.querySelector('#ruleModal .modal-title').textContent = 'Create Automation Rule';
                    // Reload rules list
                    loadAutomationRules();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || `Failed to ${isEditMode ? 'update' : 'save'} rule`);
                }
            } catch (error) {
                console.error('Error saving rule:', error);
                showToast(error.message || `Error ${isEditMode ? 'updating' : 'saving'} rule`, 'error');
            }
        });
        
        // Delete rule with confirmation
        async function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to delete rule');
                
                const result = await response.json();
                if (result.success) {
                    // Remove card from UI
                    const card = document.querySelector(`[data-rule-id="${ruleId}"]`);
                    if (card) {
                        card.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => {
                            card.remove();
                            // Check if grid is empty
                            const remainingCards = document.querySelectorAll('.rule-card');
                            if (remainingCards.length === 0) {
                                document.getElementById('rulesGrid').style.display = 'none';
                                document.getElementById('emptyState').style.display = 'block';
                            }
                        }, 300);
                    }
                    showToast('Rule deleted successfully', 'success');
                    loadAutomationRules(); // Reload to update counts
                } else {
                    throw new Error(result.error || 'Failed to delete rule');
                }
            } catch (error) {
                console.error('Error deleting rule:', error);
                showToast('Failed to delete rule', 'error');
            }
        }
        
        // Edit rule
        async function editRule(ruleId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}`);
                if (!response.ok) throw new Error('Failed to load rule');
                
                const result = await response.json();
                if (result.success && result.data) {
                    const rule = result.data;
                    
                    // Set form to edit mode
                    const form = document.getElementById('ruleForm');
                    form.dataset.mode = 'edit';
                    form.dataset.ruleId = ruleId;
                    
                    // Update modal title and button
                    document.querySelector('#ruleModal .modal-title').textContent = 'Edit Automation Rule';
                    document.getElementById('submitButtonText').textContent = 'Update Rule';
                    
                    // Populate form fields
                    document.getElementById('ruleName').value = rule.name;
                    document.getElementById('ruleDescription').value = rule.description || '';
                    form.querySelector('select').value = rule.ruleType;
                    
                    // Trigger rule type fields update
                    updateRuleTypeFields(rule.ruleType);
                    
                    // Handle keywords for keyword rules
                    if (rule.ruleType === 'keyword' && rule.keywords) {
                        const keywordTags = document.getElementById('keywordTags');
                        if (keywordTags) {
                            keywordTags.innerHTML = '';
                            rule.keywords.forEach(keyword => {
                                const tag = document.createElement('span');
                                tag.className = 'keyword-tag';
                                tag.innerHTML = `${keyword}<span class="remove" onclick="removeKeyword(this)">&times;</span>`;
                                keywordTags.appendChild(tag);
                            });
                        }
                    }
                    
                    // Handle response messages
                    const replyContainer = document.getElementById('replyMessagesContainer');
                    
                    // Clear and reset reply messages
                    resetReplyMessages();
                    
                    // Use setTimeout to ensure DOM is ready before populating data
                    setTimeout(() => {
                    
                    if (rule.responseMessages && rule.responseMessages.length > 0) {
                        rule.responseMessages.forEach((msg, index) => {
                            if (index === 0) {
                                // Update first message
                                const firstItem = replyContainer.querySelector('.reply-message-item[data-index="0"]');
                                if (firstItem) {
                                    if (msg.type === 'text') {
                                        const textarea = firstItem.querySelector('.text-content textarea');
                                        if (textarea) {
                                            textarea.value = msg.content || '';
                                            // Ensure textarea is not disabled
                                            textarea.disabled = false;
                                            textarea.readOnly = false;
                                        }
                                    } else if (msg.type === 'image') {
                                        changeReplyType(0, 'image');
                                        setTimeout(() => {
                                            const captionInput = firstItem.querySelector('.image-content input[type="text"]');
                                            if (captionInput && msg.caption) {
                                                captionInput.value = msg.caption;
                                            }
                                            // Handle existing image URL if available
                                            if (msg.mediaUrl) {
                                                const preview = document.getElementById('imagePreview0');
                                                const uploadLabel = firstItem.querySelector('.upload-label');
                                                if (preview && uploadLabel) {
                                                    const img = preview.querySelector('img');
                                                    if (img) {
                                                        img.src = msg.mediaUrl;
                                                        preview.style.display = 'block';
                                                        uploadLabel.style.display = 'none';
                                                    }
                                                }
                                            }
                                        }, 50);
                                    }
                                }
                            } else {
                                // Add additional messages
                                addReplyMessage();
                                const newIndex = replyMessageCount - 1;
                                setTimeout(() => {
                                    const newItem = document.querySelector(`[data-index="${newIndex}"]`);
                                    if (newItem) {
                                        if (msg.type === 'text') {
                                            const textarea = newItem.querySelector('.text-content textarea');
                                            if (textarea) {
                                                textarea.value = msg.content || '';
                                                // Ensure textarea is not disabled
                                                textarea.disabled = false;
                                                textarea.readOnly = false;
                                            }
                                        } else if (msg.type === 'image') {
                                            changeReplyType(newIndex, 'image');
                                            setTimeout(() => {
                                                const captionInput = newItem.querySelector('.image-content input[type="text"]');
                                                if (captionInput && msg.caption) {
                                                    captionInput.value = msg.caption;
                                                }
                                                // Handle existing image URL
                                                if (msg.mediaUrl) {
                                                    const preview = document.getElementById(`imagePreview${newIndex}`);
                                                    const uploadLabel = newItem.querySelector('.upload-label');
                                                    if (preview && uploadLabel) {
                                                        const img = preview.querySelector('img');
                                                        if (img) {
                                                            img.src = msg.mediaUrl;
                                                            preview.style.display = 'block';
                                                            uploadLabel.style.display = 'none';
                                                        }
                                                    }
                                                }
                                            }, 50);
                                        }
                                    }
                                }, 50);
                            }
                        });
                    } else if (rule.responseMessage) {
                        // Legacy single message
                        const textarea = document.querySelector('.reply-message-item .text-content textarea');
                        if (textarea) {
                            textarea.value = rule.responseMessage;
                            // Ensure textarea is not disabled
                            textarea.disabled = false;
                            textarea.readOnly = false;
                        }
                    }
                    
                    // Set delays
                    document.getElementById('responseDelay').value = rule.responseDelay || 2;
                    document.getElementById('messageDelay').value = rule.messageDelay || 1;
                    
                    // Show modal
                    showModal('rule');
                    }, 100); // End of setTimeout
                } else {
                    throw new Error(result.error || 'Failed to load rule');
                }
            } catch (error) {
                console.error('Error loading rule:', error);
                showToast('Failed to load rule details', 'error');
            }
        }
        
        // Duplicate rule
        async function duplicateRule(ruleId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}`);
                if (!response.ok) throw new Error('Failed to load rule');
                
                const result = await response.json();
                if (result.success && result.data) {
                    const rule = result.data;
                    
                    // Create duplicate with new name
                    const duplicateData = {
                        ...rule,
                        name: `${rule.name} (Copy)`,
                        id: undefined,
                        createdAt: undefined,
                        updatedAt: undefined,
                        lastTriggeredAt: undefined,
                        triggerCount: 0,
                        successCount: 0,
                        failureCount: 0
                    };
                    
                    // Create new rule
                    const createResponse = await fetch(`${API_CONFIG.baseUrl}/automation/rules`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ruleData: JSON.stringify(duplicateData) })
                    });
                    
                    if (!createResponse.ok) throw new Error('Failed to duplicate rule');
                    
                    const createResult = await createResponse.json();
                    if (createResult.success) {
                        showToast('Rule duplicated successfully', 'success');
                        loadAutomationRules();
                    } else {
                        throw new Error(createResult.error || 'Failed to duplicate rule');
                    }
                }
            } catch (error) {
                console.error('Error duplicating rule:', error);
                showToast('Failed to duplicate rule', 'error');
            }
        }
        
        // Show analytics
        function showAnalytics(ruleId) {
            // TODO: Implement analytics modal
            showToast('Analytics feature coming soon!', 'info');
        }
        
        // Export rules
        async function exportRules() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules`);
                if (!response.ok) throw new Error('Failed to load rules');
                
                const result = await response.json();
                if (result.success && result.data) {
                    const rules = result.data;
                    
                    // Create JSON file
                    const dataStr = JSON.stringify(rules, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Download file
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `automation-rules-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('Rules exported successfully', 'success');
                }
            } catch (error) {
                console.error('Error exporting rules:', error);
                showToast('Failed to export rules', 'error');
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                `;
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 
                             type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' :
                             'linear-gradient(135deg, #3b82f6, #2563eb)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                margin-bottom: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideIn 0.3s ease;
                min-width: 300px;
            `;
            
            const icon = document.createElement('span');
            icon.className = 'material-icons';
            icon.textContent = type === 'success' ? 'check_circle' : 
                              type === 'error' ? 'error' : 'info';
            
            const text = document.createElement('span');
            text.textContent = message;
            
            toast.appendChild(icon);
            toast.appendChild(text);
            toastContainer.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add animations
        const toastStyle = document.createElement('style');
        toastStyle.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: scale(1);
                }
                to {
                    opacity: 0;
                    transform: scale(0.9);
                }
            }
        `;
        document.head.appendChild(toastStyle);
        
        // Show templates (placeholder)
        function showTemplates() {
            showToast('Template browser coming soon!', 'info');
        }
        
        // Load automation rules from API
        async function loadAutomationRules() {
            try {
                // Show loading state
                const rulesGrid = document.getElementById('rulesGrid');
                const emptyState = document.getElementById('emptyState');
                
                rulesGrid.innerHTML = '<div class="loading-spinner">Loading rules...</div>';
                
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules`);
                if (!response.ok) throw new Error('Failed to load rules');
                
                const data = await response.json();
                const rules = data.data || [];
                
                if (rules.length === 0) {
                    rulesGrid.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    rulesGrid.style.display = 'grid';
                    emptyState.style.display = 'none';
                    renderRules(rules);
                }
                
                // Update rule counts in sidebar
                updateRuleCounts(rules);
                
            } catch (error) {
                console.error('Error loading rules:', error);
                document.getElementById('rulesGrid').innerHTML = 
                    '<div class="error-message">Failed to load automation rules. Please refresh the page.</div>';
            }
        }
        
        // Render rules to grid
        function renderRules(rules) {
            const rulesGrid = document.getElementById('rulesGrid');
            rulesGrid.innerHTML = '';
            
            rules.forEach(rule => {
                const ruleCard = createRuleCard(rule);
                rulesGrid.appendChild(ruleCard);
            });
        }
        
        // Create rule card element
        function createRuleCard(rule) {
            const card = document.createElement('div');
            card.className = 'rule-card';
            card.dataset.type = rule.ruleType;
            card.dataset.ruleId = rule.id;
            
            const lastUsed = rule.lastTriggeredAt 
                ? formatTimeAgo(new Date(rule.lastTriggeredAt))
                : 'Never';
            
            const successRate = rule.triggerCount > 0 
                ? Math.round((rule.successCount / rule.triggerCount) * 100)
                : 0;
            
            card.innerHTML = `
                <div class="rule-header">
                    <div class="rule-info">
                        <h3 class="rule-name">${escapeHtml(rule.name)}</h3>
                        <p class="rule-description">${escapeHtml(rule.description || getDefaultDescription(rule.ruleType))}</p>
                    </div>
                    <div class="rule-toggle ${rule.isActive ? 'active' : ''}" onclick="toggleRule('${rule.id}', this)"></div>
                </div>
                
                <div class="rule-details">
                    <div class="rule-stat">
                        <div class="rule-stat-label">Triggered</div>
                        <div class="rule-stat-value">${rule.triggerCount || 0}</div>
                    </div>
                    <div class="rule-stat">
                        <div class="rule-stat-label">Success Rate</div>
                        <div class="rule-stat-value">${successRate}%</div>
                    </div>
                    <div class="rule-stat">
                        <div class="rule-stat-label">Last Used</div>
                        <div class="rule-stat-value">${lastUsed}</div>
                    </div>
                </div>
                
                <div class="rule-actions">
                    <button class="btn-icon" title="Edit" onclick="editRule('${rule.id}')">
                        <span class="material-icons">edit</span>
                    </button>
                    <button class="btn-icon" title="Duplicate" onclick="duplicateRule('${rule.id}')">
                        <span class="material-icons">content_copy</span>
                    </button>
                    <button class="btn-icon" title="Analytics" onclick="showAnalytics('${rule.id}')">
                        <span class="material-icons">analytics</span>
                    </button>
                    <button class="btn-icon" title="Delete" onclick="deleteRule('${rule.id}')">
                        <span class="material-icons">delete</span>
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // Update rule counts in sidebar
        function updateRuleCounts(rules) {
            const counts = {
                all: rules.length,
                welcome: 0,
                away: 0,
                keyword: 0,
                workflow: 0
            };
            
            rules.forEach(rule => {
                if (counts[rule.ruleType] !== undefined) {
                    counts[rule.ruleType]++;
                }
            });
            
            // Update sidebar counts
            document.querySelectorAll('.rule-type').forEach(el => {
                const type = el.onclick.toString().match(/filterRules\('(.+?)'\)/)?.[1];
                if (type && counts[type] !== undefined) {
                    const countEl = el.querySelector('.rule-count');
                    if (countEl) {
                        countEl.textContent = counts[type];
                    }
                }
            });
        }
        
        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getDefaultDescription(ruleType) {
            const descriptions = {
                welcome: 'Automatically greet new contacts',
                away: 'Reply when outside business hours',
                keyword: 'Respond to specific keywords',
                workflow: 'Multi-step conversation flow'
            };
            return descriptions[ruleType] || 'Automation rule';
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';
            if (interval === 1) return '1 year ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';
            if (interval === 1) return '1 month ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';
            if (interval === 1) return '1 day ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';
            if (interval === 1) return '1 hour ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';
            if (interval === 1) return '1 minute ago';
            
            return 'Just now';
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initParticles();
            loadPipelineStats();
            loadAutomationRules();
            
            // Initialize default rule type fields
            updateRuleTypeFields('keyword');
        });
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>