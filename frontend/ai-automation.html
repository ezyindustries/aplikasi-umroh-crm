<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Automation - WhatsApp CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background overlay effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Floating particles effect */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            display: block;
            pointer-events: none;
            opacity: 0.5;
        }
        
        /* Main container */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo .material-icons {
            font-size: 28px;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-menu {
            display: flex;
            gap: 36px;
            align-items: center;
            margin: 0 auto;
        }
        
        .nav-item {
            color: #94a3b8;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-item:hover {
            color: #e2e8f0;
        }
        
        .nav-item.active {
            color: #3b82f6;
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 2px;
        }
        
        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .notification-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(71, 85, 105, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: linear-gradient(135deg, #ec4899, #f43f5e);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.5);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px 8px 8px;
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border-radius: 40px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-profile:hover {
            background: linear-gradient(145deg, rgba(71, 85, 105, 0.6), rgba(51, 65, 85, 0.4));
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-name {
            font-weight: 500;
            font-size: 14px;
            color: #e2e8f0;
        }
        
        .user-role {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* Page Title */
        .page-title {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title-content {
            flex: 1;
        }
        
        .page-title h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .page-title p {
            color: #94a3b8;
            font-size: 16px;
        }
        
        /* Main layout */
        .automation-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        
        /* Sidebar */
        .sidebar {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar-section {
            margin-bottom: 24px;
        }
        
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        .rule-type {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        
        .rule-type:hover {
            background: linear-gradient(145deg, rgba(71, 85, 105, 0.6), rgba(51, 65, 85, 0.4));
            transform: translateX(4px);
        }
        
        .rule-type.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .rule-type .material-icons {
            font-size: 20px;
            color: #3b82f6;
        }
        
        .rule-type-label {
            flex: 1;
            font-weight: 500;
        }
        
        .rule-count {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .content-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 8px 16px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.5);
            transform: translateY(-2px);
        }
        
        /* Rule Cards */
        .rules-grid {
            display: grid;
            gap: 16px;
        }
        
        .rule-card {
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .rule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .rule-info {
            flex: 1;
        }
        
        .rule-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .rule-description {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .rule-toggle {
            width: 48px;
            height: 26px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rule-toggle.active {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .rule-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .rule-toggle.active::after {
            transform: translateX(22px);
        }
        
        .rule-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .rule-stat {
            background: rgba(30, 41, 59, 0.5);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .rule-stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        
        .rule-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .rule-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: #94a3b8;
            transition: all 0.3s ease;
        }
        
        .btn-icon:hover {
            background: rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
            transform: translateY(-2px);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
        }
        
        .empty-state .material-icons {
            font-size: 80px;
            color: #475569;
            margin-bottom: 24px;
        }
        
        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #e2e8f0;
        }
        
        .empty-state p {
            color: #94a3b8;
            margin-bottom: 24px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: flex-start;
            justify-content: center;
            padding: 24px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 0;
            max-width: 600px;
            width: 100%;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            margin: 20px auto;
            max-height: calc(100vh - 48px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .modal-body {
            padding: 24px 32px;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 92, 246, 0.3) rgba(30, 41, 59, 0.3);
            min-height: 200px;
        }
        
        #ruleForm {
            display: block !important;
        }
        
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            color: #e2e8f0;
            transform: rotate(90deg);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            position: relative;
            z-index: 10;
        }
        
        /* Ensure all inputs are clickable */
        .reply-message-item textarea,
        .reply-message-item input {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .form-helper {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 20px 32px;
            border-top: 1px solid rgba(71, 85, 105, 0.2);
            background: rgba(15, 23, 42, 0.3);
            border-radius: 0 0 20px 20px;
        }
        
        /* Keyword Tags */
        .keyword-input-container {
            position: relative;
        }
        
        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .keyword-tag {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .keyword-tag .remove {
            cursor: pointer;
            color: #94a3b8;
            font-size: 16px;
        }
        
        .keyword-tag .remove:hover {
            color: #ef4444;
        }
        
        /* Schedule Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .schedule-day {
            text-align: center;
            padding: 8px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .schedule-day.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .stat-icon.blue {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            color: #3b82f6;
        }
        
        .stat-icon.green {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: #10b981;
        }
        
        .stat-icon.purple {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
            color: #8b5cf6;
        }
        
        .stat-icon.orange {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: #f59e0b;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 8px;
        }
        
        .stat-trend.positive {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .stat-trend.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .stat-trend .material-icons {
            font-size: 16px;
        }
        
        /* Pipeline Cards */
        .pipeline-section {
            margin-bottom: 32px;
        }
        
        .pipeline-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .pipeline-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .pipeline-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            opacity: 0.8;
        }
        
        .pipeline-card.interest::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .pipeline-card.closing::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .pipeline-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 30px 50px rgba(0, 0, 0, 0.4);
        }
        
        .pipeline-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .pipeline-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .pipeline-icon.leads-icon {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            color: #3b82f6;
        }
        
        .pipeline-icon.interest-icon {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: #f59e0b;
        }
        
        .pipeline-icon.closing-icon {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: #10b981;
        }
        
        .pipeline-icon .material-icons {
            font-size: 24px;
        }
        
        .pipeline-info {
            flex: 1;
        }
        
        .pipeline-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #e2e8f0;
            letter-spacing: 0.5px;
        }
        
        .pipeline-description {
            font-size: 12px;
            color: #94a3b8;
            margin: 0;
        }
        
        .pipeline-metrics {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .pipeline-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .pipeline-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .pipeline-trend.positive {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .pipeline-trend.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .pipeline-trend .material-icons {
            font-size: 16px;
        }
        
        .pipeline-details {
            margin-bottom: 20px;
        }
        
        .pipeline-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }
        
        .pipeline-stat:last-child {
            border-bottom: none;
        }
        
        .pipeline-stat .stat-label {
            font-size: 13px;
            color: #94a3b8;
        }
        
        .pipeline-stat .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .pipeline-conversion {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .conversion-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .conversion-bar {
            width: 100%;
            height: 6px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .conversion-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 3px;
            transition: width 0.8s ease;
        }
        
        .leads .conversion-fill {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }
        
        .interest .conversion-fill {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .conversion-text {
            font-size: 12px;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        /* Reply Messages Styles */
        .reply-message-item {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            transition: all 0.3s ease;
            z-index: 1;
        }
        
        .reply-message-item * {
            position: relative;
            z-index: 2;
        }
        
        .reply-message-item:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(71, 85, 105, 0.4);
        }
        
        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .reply-number {
            font-weight: 600;
            color: #3b82f6;
            font-size: 14px;
        }
        
        .reply-type-selector {
            display: flex;
            gap: 4px;
            background: rgba(15, 23, 42, 0.6);
            padding: 4px;
            border-radius: 8px;
        }
        
        .type-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #94a3b8;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .type-btn:hover {
            background: rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
        }
        
        .type-btn.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2));
            color: #3b82f6;
        }
        
        .type-btn .material-icons {
            font-size: 16px;
        }
        
        .reply-content {
            position: relative;
        }
        
        .reply-content .text-content,
        .reply-content .image-content {
            display: none;
        }
        
        .reply-content .text-content {
            display: block;
        }
        
        /* Ensure form controls are accessible */
        .reply-content textarea,
        .reply-content input {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
        }
        
        .reply-content textarea.form-control {
            width: 100%;
            resize: vertical;
        }
        
        .image-upload-area {
            position: relative;
            border: 2px dashed rgba(71, 85, 105, 0.5);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .image-upload-area:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .image-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            cursor: pointer;
            text-align: center;
        }
        
        .upload-label .material-icons {
            font-size: 48px;
            color: #475569;
            margin-bottom: 12px;
        }
        
        .upload-label span:nth-child(2) {
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .file-info {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .waha-plus-note {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 8px;
        }
        
        /* Toggle Styles */
        .toggle-container {
            display: flex;
            align-items: center;
        }
        
        .toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(71, 85, 105, 0.5);
            transition: .4s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle input:checked + .toggle-slider {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* Analytics Modal Styles */
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .analytics-title {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .analytics-period {
            display: flex;
            gap: 8px;
        }
        
        .period-btn {
            padding: 6px 12px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            color: #94a3b8;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .period-btn.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: transparent;
        }
        
        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.5));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #94a3b8;
        }
        
        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 12px;
        }
        
        .trend-up {
            color: #10b981;
        }
        
        .trend-down {
            color: #ef4444;
        }
        
        .analytics-chart {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.5));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            height: 300px;
            position: relative;
        }
        
        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
            font-size: 14px;
        }
        
        .analytics-logs {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.5));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 20px;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .logs-title {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .log-entry {
            padding: 12px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-info {
            flex: 1;
        }
        
        .log-contact {
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .log-message {
            font-size: 13px;
            color: #94a3b8;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 400px;
        }
        
        .log-time {
            font-size: 12px;
            color: #64748b;
        }
        
        .log-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-skipped {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .image-preview {
            position: relative;
            padding: 0;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
        }
        
        .remove-image {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-image:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .remove-image .material-icons {
            font-size: 18px;
        }
        
        .btn-add-reply {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        
        .btn-add-reply:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .btn-add-reply .material-icons {
            font-size: 20px;
        }
        
        .remove-reply-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 50%;
            color: #ef4444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
            padding: 0;
        }
        
        .remove-reply-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.1);
        }
        
        /* Loading and Error States */
        .loading-spinner {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
            font-size: 16px;
        }
        
        .loading-spinner::before {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            text-align: center;
            padding: 40px;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
        }
        
        /* Master Switch Styles */
        .master-switch-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.75));
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .master-switch-label {
            font-size: 14px;
            font-weight: 500;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .master-switch-label .material-icons {
            font-size: 20px;
            color: #94a3b8;
        }
        
        .master-switch {
            position: relative;
            width: 56px;
            height: 28px;
            background: rgba(71, 85, 105, 0.4);
            border-radius: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .master-switch.active {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        
        .master-switch-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #e2e8f0;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .master-switch.active .master-switch-slider {
            left: 31px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .master-switch-status {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .master-switch-status.on {
            color: #10b981;
        }
        
        .master-switch-status.off {
            color: #ef4444;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .automation-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .pipeline-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }
            
            .container {
                padding: 16px;
            }
            
            .header {
                padding: 16px 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .rule-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Floating particles background -->
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="material-icons">hub</span>
                Vauza Tamma CRM
            </div>
            
            <nav class="nav-menu">
                <a href="crm-main.html" class="nav-item">Dashboard</a>
                <a href="conversations-beautiful.html" class="nav-item">WhatsApp</a>
                <a href="ai-automation.html" class="nav-item active">AI</a>
                <a href="#" class="nav-item">Leads</a>
                <a href="#" class="nav-item">Campaigns</a>
                <a href="#" class="nav-item">Analytics</a>
            </nav>
            
            <div class="header-actions">
                <button class="btn-icon btn-secondary" onclick="window.location.href='template-manager.html'" title="Template Manager" style="margin-right: 8px;">
                    <span class="material-icons">text_snippet</span>
                </button>
                <button class="btn-icon btn-primary" onclick="window.location.href='ai-llm-dashboard.html'" title="AI Super Assistant" style="margin-right: 16px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); border: none;">
                    <span class="material-icons">smart_toy</span>
                </button>
                <div class="notification-btn">
                    <span class="material-icons">notifications</span>
                    <span class="notification-badge">3</span>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">
                        <span class="avatar-initials">A</span>
                    </div>
                    <div>
                        <div class="user-name">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page Title -->
        <div class="page-title">
            <div class="page-title-content">
                <h1>AI Automation</h1>
                <p>Atur rules otomatis untuk auto-reply WhatsApp dan tingkatkan efisiensi customer service</p>
            </div>
            
            <!-- Master Automation Switch -->
            <div class="master-switch-container">
                <div class="master-switch-label">
                    <span class="material-icons">power_settings_new</span>
                    <span>All Automation</span>
                </div>
                <div class="master-switch active" id="masterSwitch" onclick="toggleMasterSwitch()">
                    <div class="master-switch-slider"></div>
                </div>
                <div class="master-switch-status on" id="switchStatus">ON</div>
            </div>
        </div>
        
        <!-- Pipeline Overview -->
        <div class="pipeline-section">
            <h2 class="pipeline-title">Customer Journey Pipeline - Bulan Ini</h2>
            <div class="pipeline-grid">
                <div class="pipeline-card leads">
                    <div class="pipeline-header">
                        <div class="pipeline-icon leads-icon">
                            <span class="material-icons">person_add</span>
                        </div>
                        <div class="pipeline-info">
                            <h3 class="pipeline-name">LEADS</h3>
                            <p class="pipeline-description">Initial inquiry & package matching</p>
                        </div>
                    </div>
                    <div class="pipeline-metrics">
                        <div class="pipeline-value" id="leadsCount">127</div>
                        <div class="pipeline-trend positive">
                            <span class="material-icons">trending_up</span>
                            +23.4%
                        </div>
                    </div>
                    <div class="pipeline-details">
                        <div class="pipeline-stat">
                            <span class="stat-label">Dari Instagram</span>
                            <span class="stat-value">68</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Dari Referral</span>
                            <span class="stat-value">41</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Direct WhatsApp</span>
                            <span class="stat-value">18</span>
                        </div>
                    </div>
                    <div class="pipeline-conversion">
                        <div class="conversion-label">Konversi ke Interest</div>
                        <div class="conversion-bar">
                            <div class="conversion-fill" style="width: 65%"></div>
                        </div>
                        <div class="conversion-text">65% (83 orang)</div>
                    </div>
                </div>
                
                <div class="pipeline-card interest">
                    <div class="pipeline-header">
                        <div class="pipeline-icon interest-icon">
                            <span class="material-icons">psychology</span>
                        </div>
                        <div class="pipeline-info">
                            <h3 class="pipeline-name">INTEREST</h3>
                            <p class="pipeline-description">Detailed consultation & negotiation</p>
                        </div>
                    </div>
                    <div class="pipeline-metrics">
                        <div class="pipeline-value" id="interestCount">83</div>
                        <div class="pipeline-trend positive">
                            <span class="material-icons">trending_up</span>
                            +18.7%
                        </div>
                    </div>
                    <div class="pipeline-details">
                        <div class="pipeline-stat">
                            <span class="stat-label">Paket 9 Hari</span>
                            <span class="stat-value">31</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Paket 12 Hari</span>
                            <span class="stat-value">38</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Plus Turkey</span>
                            <span class="stat-value">14</span>
                        </div>
                    </div>
                    <div class="pipeline-conversion">
                        <div class="conversion-label">Konversi ke Closing</div>
                        <div class="conversion-bar">
                            <div class="conversion-fill" style="width: 42%"></div>
                        </div>
                        <div class="conversion-text">42% (35 orang)</div>
                    </div>
                </div>
                
                <div class="pipeline-card closing">
                    <div class="pipeline-header">
                        <div class="pipeline-icon closing-icon">
                            <span class="material-icons">payments</span>
                        </div>
                        <div class="pipeline-info">
                            <h3 class="pipeline-name">CLOSING</h3>
                            <p class="pipeline-description">Payment confirmation & documentation</p>
                        </div>
                    </div>
                    <div class="pipeline-metrics">
                        <div class="pipeline-value" id="closingCount">35</div>
                        <div class="pipeline-trend positive">
                            <span class="material-icons">trending_up</span>
                            +12.9%
                        </div>
                    </div>
                    <div class="pipeline-details">
                        <div class="pipeline-stat">
                            <span class="stat-label">DP Received</span>
                            <span class="stat-value">32</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Docs Complete</span>
                            <span class="stat-value">28</span>
                        </div>
                        <div class="pipeline-stat">
                            <span class="stat-label">Fully Paid</span>
                            <span class="stat-value">24</span>
                        </div>
                    </div>
                    <div class="pipeline-conversion">
                        <div class="conversion-label">Completion Rate</div>
                        <div class="conversion-bar">
                            <div class="conversion-fill" style="width: 89%"></div>
                        </div>
                        <div class="conversion-text">89% (31 dari 35)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <span class="material-icons">smart_toy</span>
                </div>
                <div class="stat-value">8</div>
                <div class="stat-label">Active Rules</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_up</span>
                    +2 this week
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon green">
                    <span class="material-icons">reply_all</span>
                </div>
                <div class="stat-value">1,247</div>
                <div class="stat-label">Auto Replies Sent</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_up</span>
                    +18.5%
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon purple">
                    <span class="material-icons">timer</span>
                </div>
                <div class="stat-value">0.8s</div>
                <div class="stat-label">Avg Response Time</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_down</span>
                    -0.3s
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon orange">
                    <span class="material-icons">thumb_up</span>
                </div>
                <div class="stat-value">94%</div>
                <div class="stat-label">Customer Satisfaction</div>
                <div class="stat-trend positive">
                    <span class="material-icons">trending_up</span>
                    +2.1%
                </div>
            </div>
        </div>
        
        <!-- Main Content Grid -->
        <div class="automation-grid">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Rule Types</h3>
                    <div class="rule-type active" onclick="filterRules('all')">
                        <span class="material-icons">dashboard</span>
                        <span class="rule-type-label">All Rules</span>
                        <span class="rule-count">12</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('welcome')">
                        <span class="material-icons">waving_hand</span>
                        <span class="rule-type-label">Welcome Messages</span>
                        <span class="rule-count">2</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('away')">
                        <span class="material-icons">schedule</span>
                        <span class="rule-type-label">Away Messages</span>
                        <span class="rule-count">3</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('keyword')">
                        <span class="material-icons">text_fields</span>
                        <span class="rule-type-label">Keyword Replies</span>
                        <span class="rule-count">5</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('workflow')">
                        <span class="material-icons">account_tree</span>
                        <span class="rule-type-label">Workflows</span>
                        <span class="rule-count">2</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('template')">
                        <span class="material-icons">description</span>
                        <span class="rule-type-label">Template Based</span>
                        <span class="rule-count">0</span>
                    </div>
                    <div class="rule-type" onclick="filterRules('llm_agent')">
                        <span class="material-icons">psychology</span>
                        <span class="rule-type-label">AI Agent (LLM)</span>
                        <span class="rule-count">0</span>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Quick Actions</h3>
                    <button class="btn btn-primary" style="width: 100%;" onclick="openCreateModal()">
                        <span class="material-icons">add</span>
                        Create New Rule
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="showTemplates()">
                        <span class="material-icons">content_copy</span>
                        Browse Templates
                    </button>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 8px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);" onclick="window.location.href='template-manager.html'">
                        <span class="material-icons">text_snippet</span>
                        Template Manager
                    </button>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 8px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);" onclick="window.location.href='ai-llm-dashboard.html'">
                        <span class="material-icons">smart_toy</span>
                        AI Super Assistant
                    </button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <div class="content-header">
                    <h2 class="content-title">Active Automation Rules</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportRules()">
                            <span class="material-icons">download</span>
                            Export Rules
                        </button>
                        <button class="btn btn-secondary" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);" onclick="openWorkflowBuilder()">
                            <span class="material-icons">account_tree</span>
                            Workflow Builder
                        </button>
                        <button class="btn btn-primary" onclick="openCreateModal()">
                            <span class="material-icons">add</span>
                            Add Rule
                        </button>
                    </div>
                </div>
                
                <!-- Rules List -->
                <div class="rules-grid" id="rulesGrid">
                    <!-- Welcome Message Rule -->
                    <div class="rule-card" data-type="welcome">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Welcome New Customers</h3>
                                <p class="rule-description">Automatically greet new contacts with package information</p>
                            </div>
                            <div class="rule-toggle active" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Triggered</div>
                                <div class="rule-stat-value">342</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Success Rate</div>
                                <div class="rule-stat-value">98%</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Last Used</div>
                                <div class="rule-stat-value">2 min ago</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Away Message Rule -->
                    <div class="rule-card" data-type="away">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Out of Office Hours</h3>
                                <p class="rule-description">Reply when messages received outside business hours</p>
                            </div>
                            <div class="rule-toggle active" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Triggered</div>
                                <div class="rule-stat-value">128</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Schedule</div>
                                <div class="rule-stat-value">Mon-Fri</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Time</div>
                                <div class="rule-stat-value">17:00-08:00</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Keyword Reply Rule -->
                    <div class="rule-card" data-type="keyword">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Price Inquiry Response</h3>
                                <p class="rule-description">Auto-reply with package prices when keywords detected</p>
                            </div>
                            <div class="rule-toggle active" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Keywords</div>
                                <div class="rule-stat-value">8</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Triggered</div>
                                <div class="rule-stat-value">567</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Conversion</div>
                                <div class="rule-stat-value">23%</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Workflow Rule -->
                    <div class="rule-card" data-type="workflow">
                        <div class="rule-header">
                            <div class="rule-info">
                                <h3 class="rule-name">Appointment Booking Flow</h3>
                                <p class="rule-description">Guide customers through appointment scheduling process</p>
                            </div>
                            <div class="rule-toggle" onclick="toggleRule(this)"></div>
                        </div>
                        
                        <div class="rule-details">
                            <div class="rule-stat">
                                <div class="rule-stat-label">Steps</div>
                                <div class="rule-stat-value">5</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Completed</div>
                                <div class="rule-stat-value">89</div>
                            </div>
                            <div class="rule-stat">
                                <div class="rule-stat-label">Drop Rate</div>
                                <div class="rule-stat-value">12%</div>
                            </div>
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn-icon" title="Edit">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon" title="Duplicate">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <button class="btn-icon" title="Analytics">
                                <span class="material-icons">analytics</span>
                            </button>
                            <button class="btn-icon" title="Delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Empty State (hidden by default) -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <span class="material-icons">smart_toy</span>
                    <h3>No Automation Rules Yet</h3>
                    <p>Create your first automation rule to start saving time and improving response rates</p>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <span class="material-icons">add</span>
                        Create First Rule
                    </button>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Create/Edit Rule Modal -->
    <div class="modal" id="ruleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Automation Rule</h2>
                <button class="close-btn" onclick="hideModal('rule')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="ruleForm">
                    <div class="form-group">
                    <label class="form-label">Rule Name</label>
                    <input type="text" class="form-control" id="ruleName" placeholder="e.g., Welcome New Customers" required>
                    <span class="form-helper">Give your rule a descriptive name</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="ruleDescription" rows="2" placeholder="Describe what this rule does..."></textarea>
                    <span class="form-helper">Optional description for your reference</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rule Type</label>
                    <select class="form-control" onchange="updateRuleTypeFields(this.value)" required>
                        <option value="">Select rule type...</option>
                        <option value="welcome">Welcome Message</option>
                        <option value="away">Away Message</option>
                        <option value="keyword" selected>Keyword Reply</option>
                        <option value="workflow">Conversation Workflow</option>
                        <option value="template">Template Based</option>
                        <option value="llm_agent">AI Agent (LLM)</option>
                    </select>
                </div>
                
                <!-- Welcome Message Fields -->
                <div id="welcomeFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Trigger Condition</label>
                        <select class="form-control">
                            <option>First message from new contact</option>
                            <option>Contact joins group</option>
                            <option>Contact opts in</option>
                        </select>
                    </div>
                </div>
                
                <!-- Away Message Fields -->
                <div id="awayFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Schedule Days</label>
                        <div class="schedule-grid">
                            <div class="schedule-day">Sun</div>
                            <div class="schedule-day active">Mon</div>
                            <div class="schedule-day active">Tue</div>
                            <div class="schedule-day active">Wed</div>
                            <div class="schedule-day active">Thu</div>
                            <div class="schedule-day active">Fri</div>
                            <div class="schedule-day">Sat</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Active Hours</label>
                        <div class="time-inputs">
                            <input type="time" class="form-control" value="09:00">
                            <input type="time" class="form-control" value="17:00">
                        </div>
                    </div>
                </div>
                
                <!-- Keyword Reply Fields -->
                <div id="keywordFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Trigger Keywords</label>
                        <div class="keyword-input-container">
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" class="form-control" id="keywordInput" placeholder="Type keyword" onkeypress="addKeyword(event)" style="flex: 1;">
                                <button type="button" class="btn btn-primary" onclick="addKeywordButton()" style="padding: 12px 20px;">
                                    <span class="material-icons">add</span>
                                    Add
                                </button>
                            </div>
                            <div class="keyword-tags" id="keywordTags">
                                <!-- Keywords will be added dynamically here -->
                            </div>
                        </div>
                        <span class="form-helper" style="color: #f59e0b;"> Add keywords by typing and pressing ENTER key</span>
                    </div>
                </div>
                
                <!-- Template Based Fields -->
                <div id="templateFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Template Category</label>
                        <select class="form-control" id="templateCategory">
                            <option value="">All Categories</option>
                            <option value="greeting">Greeting Messages</option>
                            <option value="package">Package Information</option>
                            <option value="faq">FAQ Responses</option>
                            <option value="followup">Follow Up Messages</option>
                            <option value="document">Document Templates</option>
                        </select>
                        <span class="form-helper">Filter templates by category for better matching</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">AI Intent Detection</label>
                        <div class="toggle-container">
                            <label class="toggle">
                                <input type="checkbox" id="useIntentDetection" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="margin-left: 12px;">Use AI to detect intent for better matching</span>
                        </div>
                        <span class="form-helper">AI akan mendeteksi maksud customer untuk matching template yang lebih akurat</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fallback to AI</label>
                        <div class="toggle-container">
                            <label class="toggle">
                                <input type="checkbox" id="fallbackToLLM">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="margin-left: 12px;">Use AI Agent when no template matches</span>
                        </div>
                        <span class="form-helper">Enable this to provide AI-generated responses when templates don't match</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Template Manager
                            <a href="/template-manager.html" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 14px; margin-left: 12px;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">open_in_new</span>
                                Manage Templates
                            </a>
                        </label>
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 16px;">
                            <p style="margin: 0; color: #3b82f6; font-size: 14px;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">info</span>
                                Template-based rules automatically match customer messages with pre-defined templates for consistent responses.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- LLM Agent Fields -->
                <div id="llmFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">AI Model</label>
                        <select class="form-control" id="llmModel">
                            <option value="llama3.2:1b">Llama 3.2 1B (Fastest)</option>
                            <option value="llama3.2:3b">Llama 3.2 3B (Balanced)</option>
                            <option value="llama3.2:8b">Llama 3.2 8B (Recommended)</option>
                            <option value="llama3.2:11b-vision">Llama 3.2 11B Vision</option>
                            <option value="mistral:7b-instruct">Mistral 7B Instruct</option>
                            <option value="phi3:medium">Phi-3 Medium</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">System Prompt</label>
                        <div style="margin-bottom: 8px;">
                            <select class="form-control" id="promptTemplate" onchange="loadPromptTemplate()" style="margin-bottom: 8px;">
                                <option value="">-- Select Template (Optional) --</option>
                            </select>
                        </div>
                        <textarea class="form-control" id="systemPrompt" rows="6" placeholder="Enter the AI agent's personality and instructions..."></textarea>
                        <span class="form-helper">Define how the AI should behave and respond to customers</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Context Mode</label>
                        <select class="form-control" id="contextMode">
                            <option value="conversation">Conversation History Only</option>
                            <option value="customer_phase">Customer Phase Only</option>
                            <option value="both" selected>Both (Recommended)</option>
                        </select>
                        <span class="form-helper">What context to provide to the AI</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Temperature (Creativity)</label>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <input type="range" class="form-control" id="temperature" min="0" max="100" value="70" style="flex: 1;">
                            <span id="temperatureValue" style="min-width: 40px;">0.7</span>
                        </div>
                        <span class="form-helper">Lower = More focused, Higher = More creative</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-control" id="maxTokens" value="500" min="50" max="2000">
                        <span class="form-helper">Maximum length of AI response</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Max Sentences</label>
                        <input type="number" class="form-control" id="maxSentences" value="2" min="1" max="10">
                        <span class="form-helper">Limit response to this many sentences (1-10)</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Trigger Keywords (Optional)</label>
                        <div class="keyword-input-container">
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" class="form-control" id="llmKeywordInput" placeholder="Type keyword" onkeypress="addLLMKeyword(event)" style="flex: 1;">
                                <button type="button" class="btn btn-primary" onclick="addLLMKeywordButton()" style="padding: 12px 20px;">
                                    <span class="material-icons">add</span>
                                    Add
                                </button>
                            </div>
                            <div class="keyword-tags" id="llmKeywordTags">
                                <!-- Keywords will be added dynamically here -->
                            </div>
                        </div>
                        <span class="form-helper">Leave empty to respond to all messages</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Knowledge Base</label>
                        <div id="knowledgeBaseContainer">
                            <div class="knowledge-entry" style="margin-bottom: 8px;">
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" class="form-control" placeholder="Key (e.g., pricing)" style="flex: 1;">
                                    <input type="text" class="form-control" placeholder="Value (e.g., Paket mulai 25 juta)" style="flex: 2;">
                                    <button type="button" class="btn btn-secondary" onclick="removeKnowledgeEntry(this)">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addKnowledgeEntry()" style="margin-top: 8px;">
                            <span class="material-icons">add</span>
                            Add Knowledge Entry
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="testLLMPrompt()" style="width: 100%;">
                            <span class="material-icons">psychology</span>
                            Test AI Response
                        </button>
                    </div>
                </div>
                
                <!-- Reply Messages Section -->
                <div class="form-group">
                    <label class="form-label">Reply Messages</label>
                    <div id="replyMessagesContainer">
                        <!-- First reply message (default) -->
                        <div class="reply-message-item" data-index="0">
                            <div class="reply-header">
                                <span class="reply-number">Reply 1</span>
                                <div class="reply-type-selector">
                                    <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(0, 'text')">
                                        <span class="material-icons">text_fields</span>
                                        Text
                                    </button>
                                    <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(0, 'image')">
                                        <span class="material-icons">image</span>
                                        Image
                                    </button>
                                </div>
                            </div>
                            
                            <div class="reply-content">
                                <div class="text-content" id="textContent0">
                                    <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                                    <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                                </div>
                                
                                <div class="image-content" id="imageContent0" style="display: none;">
                                    <div class="image-upload-area">
                                        <input type="file" accept="image/*" class="image-input" id="imageInput0" onchange="handleImageSelect(0, this)">
                                        <label for="imageInput0" class="upload-label">
                                            <span class="material-icons">cloud_upload</span>
                                            <span>Click to upload image</span>
                                            <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                            <span class="waha-plus-note" style="color: #f59e0b; font-size: 11px; margin-top: 4px;">
                                                <span class="material-icons" style="font-size: 12px; vertical-align: middle;">info</span>
                                                Requires WAHA Plus for sending
                                            </span>
                                        </label>
                                        <div class="image-preview" id="imagePreview0" style="display: none;">
                                            <img src="" alt="Preview">
                                            <button type="button" class="remove-image" onclick="removeImage(0)">
                                                <span class="material-icons">close</span>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add-reply" onclick="addReplyMessage()">
                        <span class="material-icons">add_circle</span>
                        Add Another Reply
                    </button>
                    <span class="form-helper">Messages will be sent in sequence with delays between each</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Response Delay (seconds)</label>
                    <input type="number" class="form-control" id="responseDelay" value="2" min="0" max="10">
                    <span class="form-helper">Delay before sending the first response</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message Delay (seconds)</label>
                    <input type="number" class="form-control" id="messageDelay" value="1" min="0" max="5">
                    <span class="form-helper">Delay between multiple messages in sequence</span>
                </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="clearForm()" style="margin-right: auto;">
                    <span class="material-icons">clear_all</span>
                    Hapus Semua
                </button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('rule')">Cancel</button>
                <button type="submit" class="btn btn-primary" form="ruleForm">
                    <span class="material-icons">save</span>
                    <span id="submitButtonText">Save Rule</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Analytics Modal -->
    <div class="modal" id="analyticsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Rule Analytics</h2>
                <button class="close-btn" onclick="hideModal('analytics')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Analytics Content -->
                <div id="analyticsContent" style="padding: 24px;">
                    <!-- Loading State -->
                    <div class="analytics-loading" style="text-align: center; padding: 60px;">
                        <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                        <p style="color: #94a3b8;">Loading analytics data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Backend Configuration
        const API_CONFIG = {
            baseUrl: 'http://localhost:3003/api',
            sessionId: 'default'
        };
        
        // Master Switch State
        let masterAutomationEnabled = localStorage.getItem('masterAutomationEnabled') !== 'false';
        
        // Initialize master switch on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateMasterSwitchUI(masterAutomationEnabled);
        });
        
        // Toggle Master Automation Switch
        async function toggleMasterSwitch() {
            const switchElement = document.getElementById('masterSwitch');
            const statusElement = document.getElementById('switchStatus');
            const newState = !switchElement.classList.contains('active');
            
            try {
                // Update UI immediately for better UX
                updateMasterSwitchUI(newState);
                
                // Send request to backend
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/master-switch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        enabled: newState
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Save state to localStorage
                        localStorage.setItem('masterAutomationEnabled', newState.toString());
                        masterAutomationEnabled = newState;
                        
                        // Show notification
                        showNotification(
                            newState ? 'All automation rules are now ACTIVE' : 'All automation rules are now DISABLED',
                            newState ? 'success' : 'warning'
                        );
                        
                        // Update all rule cards
                        updateAllRuleStates(newState);
                    } else {
                        // Revert UI on error
                        updateMasterSwitchUI(!newState);
                        showNotification('Failed to update automation state: ' + (result.error || 'Unknown error'), 'error');
                    }
                } else {
                    // Revert UI on error
                    updateMasterSwitchUI(!newState);
                    showNotification('Failed to update automation state', 'error');
                }
            } catch (error) {
                console.error('Error toggling master switch:', error);
                // Revert UI on error
                updateMasterSwitchUI(!newState);
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        // Update Master Switch UI
        function updateMasterSwitchUI(enabled) {
            const switchElement = document.getElementById('masterSwitch');
            const statusElement = document.getElementById('switchStatus');
            
            if (enabled) {
                switchElement.classList.add('active');
                statusElement.textContent = 'ON';
                statusElement.classList.remove('off');
                statusElement.classList.add('on');
            } else {
                switchElement.classList.remove('active');
                statusElement.textContent = 'OFF';
                statusElement.classList.remove('on');
                statusElement.classList.add('off');
            }
        }
        
        // Update all rule card states
        function updateAllRuleStates(enabled) {
            const ruleCards = document.querySelectorAll('.rule-card');
            ruleCards.forEach(card => {
                if (enabled) {
                    card.classList.remove('disabled');
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                } else {
                    card.classList.add('disabled');
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 
                             type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' :
                             type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' :
                             'linear-gradient(135deg, #3b82f6, #2563eb)'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // Add to body
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                    style.remove();
                }, 300);
            }, 3000);
        }
        
        // Load pipeline statistics
        async function loadPipelineStats() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/dashboard/pipeline-stats`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        updatePipelineCards(data);
                    } else {
                        console.warn('API returned error:', data.error || 'Unknown error');
                        loadDemoPipelineData();
                    }
                } else {
                    console.warn(`Failed to load pipeline stats: ${response.status} ${response.statusText}`);
                    loadDemoPipelineData();
                }
            } catch (error) {
                console.error('Error loading pipeline stats:', error);
                loadDemoPipelineData();
            }
        }
        
        // Load demo pipeline data as fallback
        function loadDemoPipelineData() {
            const demoData = {
                success: true,
                data: {
                    leads: {
                        total: 127,
                        trend: 15,
                        sources: { instagram: 68, referral: 41, whatsapp: 18 },
                        conversionRate: 65,
                        converted: 83
                    },
                    interest: {
                        total: 83,
                        trend: 8,
                        packages: { '9H': 31, '12H': 38, 'TUR': 14 },
                        conversionRate: 42,
                        converted: 35
                    },
                    closing: {
                        total: 35,
                        trend: -5,
                        payments: { dp_received: 32, full: 24, partial: 8 },
                        conversionRate: 89,
                        converted: 31
                    }
                }
            };
            console.log('Using demo pipeline data');
            updatePipelineCards(demoData);
        }
        
        // Update pipeline cards with data
        function updatePipelineCards(data) {
            if (data.success && data.data) {
                const stats = data.data;
                
                // Update LEADS card
                if (stats.leads) {
                    document.getElementById('leadsCount').textContent = stats.leads.total || 127;
                    updatePipelineDetails('leads', stats.leads);
                }
                
                // Update INTEREST card
                if (stats.interest) {
                    document.getElementById('interestCount').textContent = stats.interest.total || 83;
                    updatePipelineDetails('interest', stats.interest);
                }
                
                // Update CLOSING card
                if (stats.closing) {
                    document.getElementById('closingCount').textContent = stats.closing.total || 35;
                    updatePipelineDetails('closing', stats.closing);
                }
            }
        }
        
        // Update pipeline details for specific phase
        function updatePipelineDetails(phase, data) {
            const card = document.querySelector(`.pipeline-card.${phase}`);
            if (!card) return;
            
            // Update trend
            const trendEl = card.querySelector('.pipeline-trend');
            if (data.trend) {
                const percentage = data.trend > 0 ? `+${data.trend}%` : `${data.trend}%`;
                const trendClass = data.trend > 0 ? 'positive' : 'negative';
                const icon = data.trend > 0 ? 'trending_up' : 'trending_down';
                
                trendEl.className = `pipeline-trend ${trendClass}`;
                trendEl.innerHTML = `
                    <span class="material-icons">${icon}</span>
                    ${percentage}
                `;
            }
            
            // Update conversion rates
            const conversionBar = card.querySelector('.conversion-fill');
            const conversionText = card.querySelector('.conversion-text');
            if (data.conversionRate && conversionBar && conversionText) {
                conversionBar.style.width = `${data.conversionRate}%`;
                conversionText.textContent = `${data.conversionRate}% (${data.converted || 0} orang)`;
            }
        }
        
        // Initialize particles background
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 10;
            
            for (let i = 0; i < particleCount; i++) {
                createParticle(particlesContainer);
            }
        }
        
        function createParticle(container) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Random size
            const size = Math.random() * 100 + 50;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            
            // Random position
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            
            // Random color
            const colors = [
                'radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%)',
                'radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%)',
                'radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%)'
            ];
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            // Random animation
            const duration = Math.random() * 20 + 20;
            const delay = Math.random() * 20;
            
            particle.style.animation = `float ${duration}s ${delay}s infinite ease-in-out`;
            
            container.appendChild(particle);
        }
        
        // Add floating animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes float {
                0%, 100% {
                    transform: translate(0, 0) scale(1);
                    opacity: 0.5;
                }
                25% {
                    transform: translate(100px, -100px) scale(1.1);
                    opacity: 0.7;
                }
                50% {
                    transform: translate(-100px, -200px) scale(0.9);
                    opacity: 0.4;
                }
                75% {
                    transform: translate(-50px, -100px) scale(1.05);
                    opacity: 0.6;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Filter rules by type
        function filterRules(type) {
            // Update active state in sidebar
            document.querySelectorAll('.rule-type').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.rule-type').classList.add('active');
            
            // Filter rule cards
            const ruleCards = document.querySelectorAll('.rule-card');
            let visibleCount = 0;
            
            ruleCards.forEach(card => {
                if (type === 'all' || card.dataset.type === type) {
                    card.style.display = '';
                    card.style.animation = 'fadeIn 0.3s ease';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show empty state if no rules match filter
            const rulesGrid = document.getElementById('rulesGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (visibleCount === 0 && ruleCards.length > 0) {
                rulesGrid.innerHTML = `
                    <div class="empty-filter-state" style="text-align: center; padding: 60px; color: #94a3b8;">
                        <span class="material-icons" style="font-size: 60px; color: #475569; margin-bottom: 16px; display: block;">filter_alt_off</span>
                        <h3 style="margin-bottom: 8px;">No ${type} rules found</h3>
                        <p>Try creating a new ${type} rule or select a different filter.</p>
                    </div>
                `;
            }
        }
        
        // Add fade in animation
        const fadeInStyle = document.createElement('style');
        fadeInStyle.textContent = `
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(fadeInStyle);
        
        // Toggle rule active state
        async function toggleRule(ruleId, toggleElement) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to toggle rule');
                
                const result = await response.json();
                if (result.success) {
                    toggleElement.classList.toggle('active', result.data.isActive);
                    showToast(`Rule ${result.data.isActive ? 'activated' : 'deactivated'}`, 'success');
                } else {
                    throw new Error(result.error || 'Failed to toggle rule');
                }
            } catch (error) {
                console.error('Error toggling rule:', error);
                showToast('Failed to toggle rule', 'error');
                // Revert toggle state
                toggleElement.classList.toggle('active');
            }
        }
        
        // Open create modal with fresh form
        function openCreateModal() {
            const form = document.getElementById('ruleForm');
            
            // Force reset mode
            form.dataset.mode = 'create';
            delete form.dataset.ruleId;
            
            // Reset form
            form.reset();
            
            // Clear all inputs explicitly
            document.getElementById('ruleName').value = '';
            document.getElementById('ruleDescription').value = '';
            document.getElementById('responseDelay').value = '2';
            document.getElementById('messageDelay').value = '1';
            
            // Clear keywords
            const keywordTags = document.getElementById('keywordTags');
            if (keywordTags) {
                keywordTags.innerHTML = '';
            }
            
            // Clear LLM fields to prevent validation issues
            document.getElementById('systemPrompt').value = '';
            document.getElementById('systemPrompt').removeAttribute('required');
            
            // Reset to keyword type
            const ruleTypeSelect = form.querySelector('select');
            ruleTypeSelect.value = 'keyword';
            // Force update fields
            setTimeout(() => {
                updateRuleTypeFields('keyword');
            }, 50);
            
            // Reset modal title and button
            document.querySelector('#ruleModal .modal-title').textContent = 'Create Automation Rule';
            document.getElementById('submitButtonText').textContent = 'Save Rule';
            
            // Reset reply messages
            resetReplyMessages();
            
            // Show modal
            showModal('rule');
        }
        
        // Show modal
        function showModal(type) {
            const modal = document.getElementById(type + 'Modal');
            
            // Reset form if opening for new rule
            if (type === 'rule') {
                const form = document.getElementById('ruleForm');
                // Only reset if NOT in edit mode
                if (!form.dataset.mode || form.dataset.mode !== 'edit') {
                    // Clear form completely for new rule
                    form.reset();
                    form.dataset.mode = 'create';
                    delete form.dataset.ruleId;
                    
                    // Reset modal title and button
                    document.querySelector('#ruleModal .modal-title').textContent = 'Create Automation Rule';
                    document.getElementById('submitButtonText').textContent = 'Save Rule';
                    
                    // Clear all fields
                    document.getElementById('ruleName').value = '';
                    document.getElementById('ruleDescription').value = '';
                    document.getElementById('responseDelay').value = '2';
                    document.getElementById('messageDelay').value = '1';
                    
                    // Clear keywords
                    const keywordTags = document.getElementById('keywordTags');
                    if (keywordTags) {
                        keywordTags.innerHTML = '';
                    }
                    
                    // Reset to keyword type and ensure fields are shown
                    const ruleTypeSelect = form.querySelector('select');
                    ruleTypeSelect.value = 'keyword';
                    // Force update fields
                    setTimeout(() => {
                        updateRuleTypeFields('keyword');
                    }, 50);
                    
                    // Reset reply messages to default empty state
                    resetReplyMessages();
                    
                    // Reset reply messages to default
                    const replyContainer = document.getElementById('replyMessagesContainer');
                    replyContainer.innerHTML = `
                        <div class="reply-message-item" data-index="0">
                            <div class="reply-header">
                                <span class="reply-number">Reply 1</span>
                                <div class="reply-type-selector">
                                    <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(0, 'text')">
                                        <span class="material-icons">text_fields</span>
                                        Text
                                    </button>
                                    <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(0, 'image')">
                                        <span class="material-icons">image</span>
                                        Image
                                    </button>
                                </div>
                            </div>
                            
                            <div class="reply-content">
                                <div class="text-content" id="textContent0">
                                    <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                                    <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                                </div>
                                
                                <div class="image-content" id="imageContent0" style="display: none;">
                                    <div class="image-upload-area">
                                        <input type="file" accept="image/*" class="image-input" id="imageInput0" onchange="handleImageSelect(0, this)">
                                        <label for="imageInput0" class="upload-label">
                                            <span class="material-icons">cloud_upload</span>
                                            <span>Click to upload image</span>
                                            <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                            <span class="waha-plus-note" style="color: #f59e0b; font-size: 11px; margin-top: 4px;">
                                                <span class="material-icons" style="font-size: 12px; vertical-align: middle;">info</span>
                                                Requires WAHA Plus for sending
                                            </span>
                                        </label>
                                        <div class="image-preview" id="imagePreview0" style="display: none;">
                                            <img src="" alt="Preview">
                                            <button type="button" class="remove-image" onclick="removeImage(0)">
                                                <span class="material-icons">close</span>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                                </div>
                            </div>
                        </div>
                    `;
                    replyMessageCount = 1;
                    
                    // Reset keywords
                    document.getElementById('keywordTags').innerHTML = '';
                    
                    // Hide type-specific fields
                    document.getElementById('welcomeFields').style.display = 'none';
                    document.getElementById('awayFields').style.display = 'none';
                    document.getElementById('keywordFields').style.display = 'none';
                }
            }
            
            modal.style.display = 'flex';
        }
        
        // Hide modal
        function hideModal(type) {
            const modal = document.getElementById(type + 'Modal');
            modal.style.display = 'none';
            
            // Clear form mode when closing
            if (type === 'rule') {
                const form = document.getElementById('ruleForm');
                form.dataset.mode = '';
                delete form.dataset.ruleId;
            }
        }
        
        // Update form fields based on rule type
        function updateRuleTypeFields(type) {
            // Hide all type-specific fields
            document.getElementById('welcomeFields').style.display = 'none';
            document.getElementById('awayFields').style.display = 'none';
            document.getElementById('keywordFields').style.display = 'none';
            document.getElementById('templateFields').style.display = 'none';
            document.getElementById('llmFields').style.display = 'none';
            
            // Remove required from hidden fields to prevent validation issues
            if (type !== 'llm_agent') {
                document.getElementById('systemPrompt').removeAttribute('required');
            }
            
            // Show/hide reply messages based on type
            const replyMessagesSection = document.querySelector('.form-group:has(#replyMessagesContainer)').parentElement;
            
            // Show relevant fields
            if (type === 'welcome') {
                document.getElementById('welcomeFields').style.display = 'block';
                replyMessagesSection.style.display = 'block';
            } else if (type === 'away') {
                document.getElementById('awayFields').style.display = 'block';
                replyMessagesSection.style.display = 'block';
            } else if (type === 'keyword') {
                document.getElementById('keywordFields').style.display = 'block';
                replyMessagesSection.style.display = 'block';
            } else if (type === 'template') {
                document.getElementById('templateFields').style.display = 'block';
                replyMessagesSection.style.display = 'none'; // Templates handle their own responses
            } else if (type === 'llm_agent') {
                document.getElementById('llmFields').style.display = 'block';
                replyMessagesSection.style.display = 'none'; // LLM generates its own responses
                loadLLMModels();
                loadPromptTemplates();
            } else if (type === 'workflow') {
                // For workflow, open the visual builder
                closeModal();
                window.location.href = '/workflow-builder.html';
            } else {
                replyMessagesSection.style.display = 'block';
            }
        }
        
        // Add keyword
        function addKeyword(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addKeywordButton();
            }
        }
        
        // Add keyword via button
        function addKeywordButton() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (keyword) {
                const tagsContainer = document.getElementById('keywordTags');
                const tag = document.createElement('span');
                tag.className = 'keyword-tag';
                tag.innerHTML = `${keyword}<span class="remove" onclick="removeKeyword(this)">&times;</span>`;
                tagsContainer.appendChild(tag);
                input.value = '';
                
                // Visual feedback
                input.focus();
                
                // Debug log
                console.log('Keyword added:', keyword);
                const allTags = tagsContainer.querySelectorAll('.keyword-tag');
                console.log('Total keywords now:', allTags.length);
                
                // Show success feedback
                showToast(`Keyword "${keyword}" added`, 'success');
            } else {
                showToast('Please enter a keyword', 'warning');
            }
        }
        
        // Remove keyword
        function removeKeyword(element) {
            element.parentElement.remove();
        }
        
        // LLM-specific functions
        let llmKeywords = [];
        
        // Temperature slider
        document.getElementById('temperature')?.addEventListener('input', function() {
            document.getElementById('temperatureValue').textContent = (this.value / 100).toFixed(2);
        });
        
        // Load LLM models
        async function loadLLMModels() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/llm/models`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    const select = document.getElementById('llmModel');
                    select.innerHTML = '';
                    
                    data.data.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading LLM models:', error);
            }
        }
        
        // Load prompt templates
        async function loadPromptTemplates() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/llm/templates`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    const select = document.getElementById('promptTemplate');
                    select.innerHTML = '<option value="">-- Select Template (Optional) --</option>';
                    
                    data.data.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        option.dataset.prompt = template.systemPrompt;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading prompt templates:', error);
            }
        }
        
        // Load selected prompt template
        function loadPromptTemplate() {
            const select = document.getElementById('promptTemplate');
            const selected = select.options[select.selectedIndex];
            
            if (selected && selected.dataset.prompt) {
                document.getElementById('systemPrompt').value = selected.dataset.prompt;
            }
        }
        
        // Add LLM keyword
        function addLLMKeyword(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addLLMKeywordButton();
            }
        }
        
        function addLLMKeywordButton() {
            const input = document.getElementById('llmKeywordInput');
            const keyword = input.value.trim();
            
            if (keyword) {
                const tagsContainer = document.getElementById('llmKeywordTags');
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="material-icons" onclick="removeLLMKeyword(this)">close</span>
                `;
                tagsContainer.appendChild(tag);
                
                input.value = '';
                llmKeywords.push(keyword);
            }
        }
        
        function removeLLMKeyword(element) {
            const tag = element.parentElement;
            const keyword = tag.textContent.trim();
            llmKeywords = llmKeywords.filter(k => k !== keyword);
            tag.remove();
        }
        
        // Knowledge base functions
        function addKnowledgeEntry() {
            const container = document.getElementById('knowledgeBaseContainer');
            const entry = document.createElement('div');
            entry.className = 'knowledge-entry';
            entry.style.marginBottom = '8px';
            entry.innerHTML = `
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-control" placeholder="Key (e.g., pricing)" style="flex: 1;">
                    <input type="text" class="form-control" placeholder="Value (e.g., Paket mulai 25 juta)" style="flex: 2;">
                    <button type="button" class="btn btn-secondary" onclick="removeKnowledgeEntry(this)">
                        <span class="material-icons">delete</span>
                    </button>
                </div>
            `;
            container.appendChild(entry);
        }
        
        function removeKnowledgeEntry(button) {
            button.closest('.knowledge-entry').remove();
        }
        
        // Test LLM prompt
        async function testLLMPrompt() {
            const systemPrompt = document.getElementById('systemPrompt').value;
            const model = document.getElementById('llmModel').value;
            const temperature = parseFloat(document.getElementById('temperatureValue').textContent);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            
            if (!systemPrompt) {
                showToast('Please enter a system prompt first', 'error');
                return;
            }
            
            // Show test modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Test AI Response</h3>
                        <button class="btn-icon" onclick="this.closest('.modal').remove()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Sample Customer Message</label>
                            <input type="text" class="form-control" id="testMessage" 
                                   placeholder="e.g., Halo, saya mau tanya paket umroh bulan Maret" 
                                   value="Halo, saya mau tanya paket umroh bulan Maret">
                        </div>
                        <button class="btn btn-primary" onclick="sendTestPrompt()" style="margin-bottom: 16px;">
                            <span class="material-icons">send</span>
                            Send Test
                        </button>
                        <div id="testResult" style="display: none;">
                            <h4>AI Response:</h4>
                            <div class="test-response" style="background: rgba(51, 65, 85, 0.3); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div id="aiResponse" style="white-space: pre-wrap;"></div>
                            </div>
                            <div class="test-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: rgba(71, 85, 105, 0.3); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #94a3b8;">Model</div>
                                    <div id="testModel"></div>
                                </div>
                                <div style="background: rgba(71, 85, 105, 0.3); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #94a3b8;">Tokens</div>
                                    <div id="testTokens"></div>
                                </div>
                                <div style="background: rgba(71, 85, 105, 0.3); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #94a3b8;">Duration</div>
                                    <div id="testDuration"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function sendTestPrompt() {
            const systemPrompt = document.getElementById('systemPrompt').value;
            const sampleMessage = document.getElementById('testMessage').value;
            const model = document.getElementById('llmModel').value;
            const temperature = parseFloat(document.getElementById('temperatureValue').textContent);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            
            const resultDiv = document.getElementById('testResult');
            const responseDiv = document.getElementById('aiResponse');
            
            responseDiv.textContent = 'Generating response...';
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/llm/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        systemPrompt,
                        sampleMessage,
                        llmConfig: {
                            model,
                            temperature,
                            maxTokens
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    responseDiv.textContent = data.data.response || 'No response generated';
                    
                    if (data.data.stats) {
                        document.getElementById('testModel').textContent = data.data.stats.model || model;
                        document.getElementById('testTokens').textContent = data.data.stats.tokens || 'N/A';
                        document.getElementById('testDuration').textContent = data.data.stats.duration 
                            ? `${(data.data.stats.duration / 1000000).toFixed(2)}ms` 
                            : 'N/A';
                    }
                } else {
                    responseDiv.textContent = `Error: ${data.data?.error || 'Failed to generate response'}`;
                }
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        // Toggle schedule day
        document.querySelectorAll('.schedule-day').forEach(day => {
            day.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });
        
        // Reply message counter
        let replyMessageCount = 1;
        
        // Change reply type (text/image)
        function changeReplyType(index, type) {
            const item = document.querySelector(`.reply-message-item[data-index="${index}"]`);
            if (!item) return;
            
            // Update button states
            item.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            // Show/hide content areas
            const textContent = item.querySelector('.text-content');
            const imageContent = item.querySelector('.image-content');
            
            if (type === 'text') {
                textContent.style.display = 'block';
                imageContent.style.display = 'none';
            } else {
                textContent.style.display = 'none';
                imageContent.style.display = 'block';
            }
        }
        
        // Add new reply message
        function addReplyMessage() {
            const container = document.getElementById('replyMessagesContainer');
            const newIndex = replyMessageCount++;
            
            const newReplyHtml = `
                <div class="reply-message-item" data-index="${newIndex}">
                    <button type="button" class="remove-reply-btn" onclick="removeReplyMessage(${newIndex})" title="Remove reply">
                        <span class="material-icons">close</span>
                    </button>
                    <div class="reply-header">
                        <span class="reply-number">Reply ${newIndex + 1}</span>
                        <div class="reply-type-selector">
                            <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(${newIndex}, 'text')">
                                <span class="material-icons">text_fields</span>
                                Text
                            </button>
                            <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(${newIndex}, 'image')">
                                <span class="material-icons">image</span>
                                Image
                            </button>
                        </div>
                    </div>
                    
                    <div class="reply-content">
                        <div class="text-content" id="textContent${newIndex}">
                            <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                            <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                        </div>
                    
                        <div class="image-content" id="imageContent${newIndex}" style="display: none;">
                            <div class="image-upload-area">
                                <input type="file" accept="image/*" class="image-input" id="imageInput${newIndex}" onchange="handleImageSelect(${newIndex}, this)">
                                <label for="imageInput${newIndex}" class="upload-label">
                                    <span class="material-icons">cloud_upload</span>
                                    <span>Click to upload image</span>
                                    <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                    <span class="waha-plus-note" style="color: #f59e0b; font-size: 11px; margin-top: 4px;">
                                        <span class="material-icons" style="font-size: 12px; vertical-align: middle;">info</span>
                                        Requires WAHA Plus for sending
                                    </span>
                                </label>
                                <div class="image-preview" id="imagePreview${newIndex}" style="display: none;">
                                    <img src="" alt="Preview">
                                    <button type="button" class="remove-image" onclick="removeImage(${newIndex})">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                            </div>
                            <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newReplyHtml);
            updateReplyNumbers();
        }
        
        // Remove reply message
        function removeReplyMessage(index) {
            const item = document.querySelector(`.reply-message-item[data-index="${index}"]`);
            if (item) {
                item.remove();
                updateReplyNumbers();
            }
        }
        
        // Update reply numbers after add/remove
        function updateReplyNumbers() {
            const items = document.querySelectorAll('.reply-message-item');
            items.forEach((item, idx) => {
                const numberEl = item.querySelector('.reply-number');
                if (numberEl) {
                    numberEl.textContent = `Reply ${idx + 1}`;
                }
            });
        }
        
        // Handle image selection
        function handleImageSelect(index, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB');
                input.value = '';
                return;
            }
            
            // Validate file type
            if (!file.type.match(/^image\/(jpeg|png|gif|webp)$/)) {
                alert('Please select a valid image file (JPG, PNG, GIF, or WebP)');
                input.value = '';
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(`imagePreview${index}`);
                const uploadLabel = preview.parentElement.querySelector('.upload-label');
                
                preview.querySelector('img').src = e.target.result;
                preview.style.display = 'block';
                uploadLabel.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        // Remove image
        function removeImage(index) {
            const preview = document.getElementById(`imagePreview${index}`);
            const input = document.getElementById(`imageInput${index}`);
            const uploadLabel = preview.parentElement.querySelector('.upload-label');
            
            preview.style.display = 'none';
            uploadLabel.style.display = 'flex';
            input.value = '';
        }
        
        // Clear form function
        function clearForm() {
            const form = document.getElementById('ruleForm');
            form.reset();
            
            // Clear keyword tags
            const keywordTags = document.getElementById('keywordTags');
            if (keywordTags) {
                keywordTags.innerHTML = '';
            }
            
            // Reset reply messages
            resetReplyMessages();
            
            // Reset rule type fields
            updateRuleTypeFields('keyword');
            
            showToast('Form cleared', 'info');
        }
        
        // Reset reply messages to default
        function resetReplyMessages() {
            const replyContainer = document.getElementById('replyMessagesContainer');
            replyContainer.innerHTML = `
                <div class="reply-message-item" data-index="0">
                    <div class="reply-header">
                        <span class="reply-number">Reply 1</span>
                        <div class="reply-type-selector">
                            <button type="button" class="type-btn active" data-type="text" onclick="changeReplyType(0, 'text')">
                                <span class="material-icons">text_fields</span>
                                Text
                            </button>
                            <button type="button" class="type-btn" data-type="image" onclick="changeReplyType(0, 'image')">
                                <span class="material-icons">image</span>
                                Image
                            </button>
                        </div>
                    </div>
                    <div class="reply-content">
                        <div class="text-content" id="textContent0">
                            <textarea class="form-control" rows="3" placeholder="Type your auto-reply message here..."></textarea>
                            <span class="form-helper">Use {name} for contact name, {time} for current time</span>
                        </div>
                        
                        <div class="image-content" id="imageContent0" style="display: none;">
                            <div class="image-upload-area">
                                <input type="file" accept="image/*" class="image-input" id="imageInput0" onchange="handleImageSelect(0, this)">
                                <label for="imageInput0" class="upload-label">
                                    <span class="material-icons">cloud_upload</span>
                                    <span>Click to upload image</span>
                                    <span class="file-info">Max size: 5MB | JPG, PNG, GIF</span>
                                </label>
                                <div class="image-preview" id="imagePreview0" style="display: none;">
                                    <img src="" alt="Preview">
                                    <button type="button" class="remove-image" onclick="removeImage(0)">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                            </div>
                            <input type="text" class="form-control" placeholder="Caption (optional)" style="margin-top: 12px;">
                        </div>
                    </div>
                </div>
            `;
            replyMessageCount = 1;
        }
        
        // Handle form submission
        document.getElementById('ruleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const isEditMode = this.dataset.mode === 'edit';
            const ruleId = this.dataset.ruleId;
            
            // Collect form data
            const formData = new FormData();
            const ruleName = document.getElementById('ruleName').value;
            const ruleDescription = document.getElementById('ruleDescription').value;
            const ruleType = this.querySelector('select').value;
            
            // Collect reply messages
            const replyMessages = [];
            const replyItems = document.querySelectorAll('.reply-message-item');
            
            replyItems.forEach((item, index) => {
                const isText = item.querySelector('.text-content').style.display !== 'none';
                
                if (isText) {
                    const text = item.querySelector('textarea').value;
                    if (text.trim()) {
                        replyMessages.push({
                            type: 'text',
                            content: text,
                            order: index
                        });
                    }
                } else {
                    const imageInput = item.querySelector('.image-input');
                    const caption = item.querySelector('.image-content input[type="text"]').value;
                    
                    if (imageInput.files[0]) {
                        replyMessages.push({
                            type: 'image',
                            file: imageInput.files[0],
                            caption: caption,
                            order: index
                        });
                        formData.append(`image_${index}`, imageInput.files[0]);
                    }
                }
            });
            
            // Collect keywords if keyword rule
            let keywords = [];
            if (ruleType === 'keyword') {
                const keywordTags = document.querySelectorAll('#keywordTags .keyword-tag');
                keywords = Array.from(keywordTags).map(tag => {
                    // Get text content and clean it up
                    let text = tag.textContent || tag.innerText || '';
                    // Remove the  symbol and any whitespace
                    text = text.replace(//g, '').replace(/\s+/g, ' ').trim();
                    return text;
                }).filter(keyword => keyword.length > 0); // Filter out empty keywords
                
                console.log('Collected keywords:', keywords); // Debug log
                console.log('Keyword tags found:', keywordTags.length); // Debug log
                
                // Show warning only if no keywords found and it's really needed
                if (keywords.length === 0 && ruleType === 'keyword') {
                    console.warn('Warning: No keywords collected! Please add keywords by typing and pressing Enter.');
                    // Remove the alert for better UX - just log to console
                }
            }
            
            // Build rule data
            const ruleData = {
                name: ruleName,
                description: ruleDescription,
                ruleType: ruleType,
                responseMessages: replyMessages,
                responseDelay: parseInt(document.getElementById('responseDelay').value),
                messageDelay: parseInt(document.getElementById('messageDelay').value),
                keywords: keywords,
                // Add other fields based on rule type
            };
            
            // Add LLM-specific fields if LLM agent rule
            if (ruleType === 'llm_agent') {
                // Get knowledge base entries
                const knowledgeBase = [];
                document.querySelectorAll('#knowledgeBaseContainer .knowledge-entry').forEach(entry => {
                    const inputs = entry.querySelectorAll('input');
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        knowledgeBase.push({ key, value });
                    }
                });
                
                // Get LLM keywords
                const llmKeywordTags = document.querySelectorAll('#llmKeywordTags .keyword-tag');
                const llmKeywords = Array.from(llmKeywordTags).map(tag => {
                    let text = tag.textContent || tag.innerText || '';
                    return text.replace(/close$/, '').trim();
                }).filter(k => k);
                
                ruleData.systemPrompt = document.getElementById('systemPrompt').value;
                ruleData.llmConfig = {
                    model: document.getElementById('llmModel').value,
                    temperature: parseFloat(document.getElementById('temperatureValue').textContent),
                    maxTokens: parseInt(document.getElementById('maxTokens').value),
                    maxSentences: parseInt(document.getElementById('maxSentences').value) || 2
                };
                ruleData.contextMode = document.getElementById('contextMode').value;
                ruleData.knowledgeBase = knowledgeBase;
                
                // Use triggerConditions for LLM keywords
                if (llmKeywords.length > 0) {
                    ruleData.triggerConditions = {
                        keywords: llmKeywords
                    };
                }
            }
            
            // Add template-specific fields if template rule
            if (ruleType === 'template') {
                const templateCategory = document.getElementById('templateCategory').value;
                const useIntentDetection = document.getElementById('useIntentDetection').checked;
                const fallbackToLLM = document.getElementById('fallbackToLLM').checked;
                
                ruleData.triggerConditions = {
                    templateCategory: templateCategory || null,
                    useIntentDetection: useIntentDetection,
                    fallbackToLLM: fallbackToLLM
                };
                
                // If fallback to LLM is enabled, include basic LLM config
                if (fallbackToLLM) {
                    ruleData.llmConfig = {
                        model: 'llama3.2:3b', // Default model for fallback
                        temperature: 0.7,
                        maxTokens: 300
                    };
                }
            }
            
            // Debug log to see what's being sent
            console.log('Sending rule data:', ruleData);
            console.log('Keywords being sent:', ruleData.keywords);
            console.log('Keywords type:', typeof ruleData.keywords);
            console.log('Keywords is array:', Array.isArray(ruleData.keywords));
            
            // Add to formData - ensure proper JSON encoding
            const jsonData = JSON.stringify(ruleData);
            console.log('JSON stringified data:', jsonData);
            formData.append('ruleData', jsonData);
            
            try {
                // Send to API
                const url = isEditMode 
                    ? `${API_CONFIG.baseUrl}/automation/rules/${ruleId}`
                    : `${API_CONFIG.baseUrl}/automation/rules`;
                    
                const method = isEditMode ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                if (response.ok) {
                    showToast(`Rule ${isEditMode ? 'updated' : 'created'} successfully`, 'success');
                    hideModal('rule');
                    // Reset form
                    this.reset();
                    this.dataset.mode = '';
                    this.dataset.ruleId = '';
                    document.querySelector('#ruleModal .modal-title').textContent = 'Create Automation Rule';
                    // Reload rules list
                    loadAutomationRules();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || `Failed to ${isEditMode ? 'update' : 'save'} rule`);
                }
            } catch (error) {
                console.error('Error saving rule:', error);
                showToast(error.message || `Error ${isEditMode ? 'updating' : 'saving'} rule`, 'error');
            }
        });
        
        // Delete rule with confirmation
        async function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to delete rule');
                
                const result = await response.json();
                if (result.success) {
                    // Remove card from UI
                    const card = document.querySelector(`[data-rule-id="${ruleId}"]`);
                    if (card) {
                        card.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => {
                            card.remove();
                            // Check if grid is empty
                            const remainingCards = document.querySelectorAll('.rule-card');
                            if (remainingCards.length === 0) {
                                document.getElementById('rulesGrid').style.display = 'none';
                                document.getElementById('emptyState').style.display = 'block';
                            }
                        }, 300);
                    }
                    showToast('Rule deleted successfully', 'success');
                    loadAutomationRules(); // Reload to update counts
                } else {
                    throw new Error(result.error || 'Failed to delete rule');
                }
            } catch (error) {
                console.error('Error deleting rule:', error);
                showToast('Failed to delete rule', 'error');
            }
        }
        
        // Edit rule
        async function editRule(ruleId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}`);
                if (!response.ok) throw new Error('Failed to load rule');
                
                const result = await response.json();
                if (result.success && result.data) {
                    const rule = result.data;
                    
                    // Set form to edit mode
                    const form = document.getElementById('ruleForm');
                    form.dataset.mode = 'edit';
                    form.dataset.ruleId = ruleId;
                    
                    // Update modal title and button
                    document.querySelector('#ruleModal .modal-title').textContent = 'Edit Automation Rule';
                    document.getElementById('submitButtonText').textContent = 'Update Rule';
                    
                    // Populate form fields
                    document.getElementById('ruleName').value = rule.name;
                    document.getElementById('ruleDescription').value = rule.description || '';
                    form.querySelector('select').value = rule.ruleType;
                    
                    // Trigger rule type fields update
                    updateRuleTypeFields(rule.ruleType);
                    
                    // Handle keywords for keyword rules
                    if (rule.ruleType === 'keyword' && rule.keywords) {
                        const keywordTags = document.getElementById('keywordTags');
                        if (keywordTags) {
                            keywordTags.innerHTML = '';
                            rule.keywords.forEach(keyword => {
                                const tag = document.createElement('span');
                                tag.className = 'keyword-tag';
                                tag.innerHTML = `${keyword}<span class="remove" onclick="removeKeyword(this)">&times;</span>`;
                                keywordTags.appendChild(tag);
                            });
                        }
                    }
                    
                    // Handle response messages
                    const replyContainer = document.getElementById('replyMessagesContainer');
                    
                    // Clear and reset reply messages
                    resetReplyMessages();
                    
                    // Use setTimeout to ensure DOM is ready before populating data
                    setTimeout(() => {
                    
                    if (rule.responseMessages && rule.responseMessages.length > 0) {
                        rule.responseMessages.forEach((msg, index) => {
                            if (index === 0) {
                                // Update first message
                                const firstItem = replyContainer.querySelector('.reply-message-item[data-index="0"]');
                                if (firstItem) {
                                    if (msg.type === 'text') {
                                        const textarea = firstItem.querySelector('.text-content textarea');
                                        if (textarea) {
                                            textarea.value = msg.content || '';
                                            // Ensure textarea is not disabled
                                            textarea.disabled = false;
                                            textarea.readOnly = false;
                                        }
                                    } else if (msg.type === 'image') {
                                        changeReplyType(0, 'image');
                                        setTimeout(() => {
                                            const captionInput = firstItem.querySelector('.image-content input[type="text"]');
                                            if (captionInput && msg.caption) {
                                                captionInput.value = msg.caption;
                                            }
                                            // Handle existing image URL if available
                                            if (msg.mediaUrl) {
                                                const preview = document.getElementById('imagePreview0');
                                                const uploadLabel = firstItem.querySelector('.upload-label');
                                                if (preview && uploadLabel) {
                                                    const img = preview.querySelector('img');
                                                    if (img) {
                                                        // Fix image URL to use backend port
                                                        const imageUrl = msg.mediaUrl.startsWith('http') 
                                                            ? msg.mediaUrl 
                                                            : `${API_CONFIG.baseUrl.replace('/api', '')}${msg.mediaUrl}`;
                                                        img.src = imageUrl;
                                                        preview.style.display = 'block';
                                                        uploadLabel.style.display = 'none';
                                                    }
                                                }
                                            }
                                        }, 50);
                                    }
                                }
                            } else {
                                // Add additional messages
                                addReplyMessage();
                                const newIndex = replyMessageCount - 1;
                                setTimeout(() => {
                                    const newItem = document.querySelector(`[data-index="${newIndex}"]`);
                                    if (newItem) {
                                        if (msg.type === 'text') {
                                            const textarea = newItem.querySelector('.text-content textarea');
                                            if (textarea) {
                                                textarea.value = msg.content || '';
                                                // Ensure textarea is not disabled
                                                textarea.disabled = false;
                                                textarea.readOnly = false;
                                            }
                                        } else if (msg.type === 'image') {
                                            changeReplyType(newIndex, 'image');
                                            setTimeout(() => {
                                                const captionInput = newItem.querySelector('.image-content input[type="text"]');
                                                if (captionInput && msg.caption) {
                                                    captionInput.value = msg.caption;
                                                }
                                                // Handle existing image URL
                                                if (msg.mediaUrl) {
                                                    const preview = document.getElementById(`imagePreview${newIndex}`);
                                                    const uploadLabel = newItem.querySelector('.upload-label');
                                                    if (preview && uploadLabel) {
                                                        const img = preview.querySelector('img');
                                                        if (img) {
                                                            // Fix image URL to use backend port
                                                            const imageUrl = msg.mediaUrl.startsWith('http') 
                                                                ? msg.mediaUrl 
                                                                : `${API_CONFIG.baseUrl.replace('/api', '')}${msg.mediaUrl}`;
                                                            img.src = imageUrl;
                                                            preview.style.display = 'block';
                                                            uploadLabel.style.display = 'none';
                                                        }
                                                    }
                                                }
                                            }, 50);
                                        }
                                    }
                                }, 50);
                            }
                        });
                    } else if (rule.responseMessage) {
                        // Legacy single message
                        const textarea = document.querySelector('.reply-message-item .text-content textarea');
                        if (textarea) {
                            textarea.value = rule.responseMessage;
                            // Ensure textarea is not disabled
                            textarea.disabled = false;
                            textarea.readOnly = false;
                        }
                    }
                    
                    // Set delays
                    document.getElementById('responseDelay').value = rule.responseDelay || 2;
                    document.getElementById('messageDelay').value = rule.messageDelay || 1;
                    
                    // Handle LLM agent fields
                    if (rule.ruleType === 'llm_agent') {
                        // Set system prompt
                        if (rule.systemPrompt) {
                            document.getElementById('systemPrompt').value = rule.systemPrompt;
                        }
                        
                        // Set LLM config
                        if (rule.llmConfig) {
                            if (rule.llmConfig.model) {
                                document.getElementById('llmModel').value = rule.llmConfig.model;
                            }
                            if (rule.llmConfig.temperature !== undefined) {
                                document.getElementById('temperature').value = rule.llmConfig.temperature * 100;
                                document.getElementById('temperatureValue').textContent = rule.llmConfig.temperature.toFixed(2);
                            }
                            if (rule.llmConfig.maxTokens) {
                                document.getElementById('maxTokens').value = rule.llmConfig.maxTokens;
                            }
                        }
                        
                        // Set context mode
                        if (rule.contextMode) {
                            document.getElementById('contextMode').value = rule.contextMode;
                        }
                        
                        // Handle LLM keywords from triggerConditions
                        if (rule.triggerConditions && rule.triggerConditions.keywords) {
                            const llmKeywordTags = document.getElementById('llmKeywordTags');
                            if (llmKeywordTags) {
                                llmKeywordTags.innerHTML = '';
                                llmKeywords = []; // Reset the global array
                                rule.triggerConditions.keywords.forEach(keyword => {
                                    const tag = document.createElement('div');
                                    tag.className = 'keyword-tag';
                                    tag.innerHTML = `
                                        ${keyword}
                                        <span class="material-icons" onclick="removeLLMKeyword(this)">close</span>
                                    `;
                                    llmKeywordTags.appendChild(tag);
                                    llmKeywords.push(keyword);
                                });
                            }
                        }
                        
                        // Handle knowledge base
                        if (rule.knowledgeBase && rule.knowledgeBase.length > 0) {
                            const container = document.getElementById('knowledgeBaseContainer');
                            container.innerHTML = ''; // Clear default entry
                            
                            rule.knowledgeBase.forEach(entry => {
                                const entryDiv = document.createElement('div');
                                entryDiv.className = 'knowledge-entry';
                                entryDiv.style.marginBottom = '8px';
                                entryDiv.innerHTML = `
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" class="form-control" placeholder="Key (e.g., pricing)" style="flex: 1;" value="${entry.key || ''}">
                                        <input type="text" class="form-control" placeholder="Value (e.g., Paket mulai 25 juta)" style="flex: 2;" value="${entry.value || ''}">
                                        <button type="button" class="btn btn-secondary" onclick="removeKnowledgeEntry(this)">
                                            <span class="material-icons">delete</span>
                                        </button>
                                    </div>
                                `;
                                container.appendChild(entryDiv);
                            });
                        }
                    }
                    
                    // Handle template rule settings
                    if (rule.ruleType === 'template' && rule.triggerConditions) {
                        if (rule.triggerConditions.templateCategory) {
                            document.getElementById('templateCategory').value = rule.triggerConditions.templateCategory;
                        }
                        if (rule.triggerConditions.useIntentDetection !== undefined) {
                            document.getElementById('useIntentDetection').checked = rule.triggerConditions.useIntentDetection;
                        }
                        if (rule.triggerConditions.fallbackToLLM !== undefined) {
                            document.getElementById('fallbackToLLM').checked = rule.triggerConditions.fallbackToLLM;
                        }
                    }
                    
                    // Show modal
                    showModal('rule');
                    }, 100); // End of setTimeout
                } else {
                    throw new Error(result.error || 'Failed to load rule');
                }
            } catch (error) {
                console.error('Error loading rule:', error);
                showToast('Failed to load rule details', 'error');
            }
        }
        
        // Duplicate rule
        async function duplicateRule(ruleId) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}`);
                if (!response.ok) throw new Error('Failed to load rule');
                
                const result = await response.json();
                if (result.success && result.data) {
                    const rule = result.data;
                    
                    // Create duplicate with new name
                    const duplicateData = {
                        ...rule,
                        name: `${rule.name} (Copy)`,
                        id: undefined,
                        createdAt: undefined,
                        updatedAt: undefined,
                        lastTriggeredAt: undefined,
                        triggerCount: 0,
                        successCount: 0,
                        failureCount: 0
                    };
                    
                    // Create new rule
                    const createResponse = await fetch(`${API_CONFIG.baseUrl}/automation/rules`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ruleData: JSON.stringify(duplicateData) })
                    });
                    
                    if (!createResponse.ok) throw new Error('Failed to duplicate rule');
                    
                    const createResult = await createResponse.json();
                    if (createResult.success) {
                        showToast('Rule duplicated successfully', 'success');
                        loadAutomationRules();
                    } else {
                        throw new Error(createResult.error || 'Failed to duplicate rule');
                    }
                }
            } catch (error) {
                console.error('Error duplicating rule:', error);
                showToast('Failed to duplicate rule', 'error');
            }
        }
        
        // Show analytics
        // Show analytics modal
        async function showAnalytics(ruleId) {
            try {
                // Show modal with loading state
                document.getElementById('analyticsModal').style.display = 'flex';
                
                // Reset content
                const analyticsContent = document.getElementById('analyticsContent');
                analyticsContent.innerHTML = `
                    <div class="analytics-loading" style="text-align: center; padding: 60px;">
                        <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                        <p style="color: #94a3b8;">Loading analytics data...</p>
                    </div>
                `;
                
                // Fetch analytics data
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}/analytics?period=7d`);
                if (!response.ok) throw new Error('Failed to load analytics');
                
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Failed to load analytics');
                
                const analytics = result.data;
                
                // Debug log
                console.log('Analytics data received:', analytics);
                
                // Ensure required data exists
                if (!analytics || !analytics.rule) {
                    console.error('Invalid analytics data:', analytics);
                    throw new Error('Invalid analytics data received');
                }
                
                // Render analytics content
                analyticsContent.innerHTML = `
                    <div class="analytics-header">
                        <div>
                            <h3 class="analytics-title">${analytics.rule.name}</h3>
                            <p style="color: #94a3b8; font-size: 14px; margin-top: 4px;">
                                ${analytics.rule.ruleType === 'keyword' && analytics.rule.keywords && analytics.rule.keywords.length > 0 
                                    ? `Keywords: ${analytics.rule.keywords.join(', ')}` 
                                    : analytics.rule.ruleType}
                            </p>
                        </div>
                        <div class="analytics-period">
                            <button class="period-btn" onclick="updateAnalyticsPeriod('${ruleId}', '24h')">24 Hours</button>
                            <button class="period-btn active" onclick="updateAnalyticsPeriod('${ruleId}', '7d')">7 Days</button>
                            <button class="period-btn" onclick="updateAnalyticsPeriod('${ruleId}', '30d')">30 Days</button>
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="analytics-stats">
                        <div class="stat-card">
                            <div class="stat-value" style="color: #3b82f6;">${analytics.summary?.totalTriggers || 0}</div>
                            <div class="stat-label">Total Triggers</div>
                            ${analytics.trends?.triggersChange && analytics.trends.triggersChange !== 0 ? `
                                <div class="stat-trend ${analytics.trends.triggersChange > 0 ? 'trend-up' : 'trend-down'}">
                                    <span class="material-icons" style="font-size: 16px;">
                                        ${analytics.trends.triggersChange > 0 ? 'trending_up' : 'trending_down'}
                                    </span>
                                    ${Math.abs(analytics.trends.triggersChange).toFixed(1)}%
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-value" style="color: #10b981;">${analytics.summary?.successCount || 0}</div>
                            <div class="stat-label">Successful</div>
                            <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
                                Success Rate: ${(analytics.summary?.successRate || 0).toFixed(1)}%
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-value" style="color: #ef4444;">${analytics.summary?.failedCount || 0}</div>
                            <div class="stat-label">Failed</div>
                            ${analytics.trends?.failureChange && analytics.trends.failureChange !== 0 ? `
                                <div class="stat-trend ${analytics.trends.failureChange > 0 ? 'trend-down' : 'trend-up'}">
                                    <span class="material-icons" style="font-size: 16px;">
                                        ${analytics.trends.failureChange > 0 ? 'trending_up' : 'trending_down'}
                                    </span>
                                    ${Math.abs(analytics.trends.failureChange).toFixed(1)}%
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-value" style="color: #8b5cf6;">${(analytics.summary?.averageResponseTime || 0).toFixed(0)}ms</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                    </div>
                    
                    <!-- Chart Section -->
                    <div class="analytics-chart">
                        <h4 style="margin-bottom: 16px; color: #e2e8f0;">Trigger Activity</h4>
                        <div class="chart-placeholder">
                            <canvas id="analyticsChart" width="100%" height="250"></canvas>
                        </div>
                    </div>
                    
                    <!-- Recent Logs -->
                    <div class="analytics-logs">
                        <div class="logs-header">
                            <h4 class="logs-title">Recent Activity</h4>
                            <span style="font-size: 12px; color: #64748b;">Last 10 triggers</span>
                        </div>
                        <div class="logs-list">
                            ${analytics.recentLogs && analytics.recentLogs.length > 0 ? analytics.recentLogs.map(log => {
                                const date = new Date(log.createdAt);
                                const timeAgo = getTimeAgo(date);
                                return `
                                    <div class="log-entry">
                                        <div class="log-info">
                                            <div class="log-contact">${log.contact?.name || log.contact?.phoneNumber || 'Unknown'}</div>
                                            <div class="log-message">${log.triggerData?.messageContent || 'No message'}</div>
                                            <div class="log-time">${timeAgo}</div>
                                        </div>
                                        <span class="log-status status-${log.status}">
                                            ${log.status}
                                        </span>
                                    </div>
                                `;
                            }).join('') : ''}
                            ${!analytics.recentLogs || analytics.recentLogs.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #64748b;">
                                    No activity in this period
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Draw chart
                drawAnalyticsChart(analytics.chartData || []);
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast(`Failed to load analytics: ${error.message}`, 'error');
            }
        }
        
        // Update analytics period
        async function updateAnalyticsPeriod(ruleId, period) {
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show loading
            const analyticsContent = document.getElementById('analyticsContent');
            const currentContent = analyticsContent.innerHTML;
            
            // Add loading overlay
            analyticsContent.style.position = 'relative';
            analyticsContent.insertAdjacentHTML('beforeend', `
                <div class="loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                     background: rgba(15, 23, 42, 0.8); display: flex; align-items: center; 
                     justify-content: center; border-radius: 12px; z-index: 10;">
                    <div class="loading-spinner"></div>
                </div>
            `);
            
            try {
                // Fetch analytics with new period
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules/${ruleId}/analytics?period=${period}`);
                if (!response.ok) throw new Error('Failed to load analytics');
                
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Failed to load analytics');
                
                // Re-render with new data
                showAnalytics(ruleId);
                
            } catch (error) {
                console.error('Error updating analytics period:', error);
                showToast('Failed to update analytics period', 'error');
                // Remove loading overlay
                analyticsContent.querySelector('.loading-overlay')?.remove();
            }
        }
        
        // Draw analytics chart
        function drawAnalyticsChart(chartData) {
            const canvas = document.getElementById('analyticsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 250;
            
            if (!chartData || chartData.length === 0) {
                // Show no data message
                ctx.fillStyle = '#64748b';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No data available for this period', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Simple line chart implementation
            const padding = 40;
            const chartWidth = canvas.width - (padding * 2);
            const chartHeight = canvas.height - (padding * 2);
            
            // Find max value
            const maxValue = Math.max(...chartData.map(d => d.total)) || 1;
            
            // Draw axes
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Draw data points and lines
            const pointSpacing = chartWidth / (chartData.length - 1 || 1);
            
            // Draw lines
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            chartData.forEach((data, index) => {
                const x = padding + (index * pointSpacing);
                const y = canvas.height - padding - ((data.total / maxValue) * chartHeight);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw points
            ctx.fillStyle = '#3b82f6';
            chartData.forEach((data, index) => {
                const x = padding + (index * pointSpacing);
                const y = canvas.height - padding - ((data.total / maxValue) * chartHeight);
                
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw value labels
                ctx.fillStyle = '#e2e8f0';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(data.total.toString(), x, y - 10);
                
                // Draw date labels
                ctx.fillStyle = '#64748b';
                ctx.font = '11px Inter';
                const date = new Date(data.date);
                const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                ctx.fillText(label, x, canvas.height - padding + 20);
            });
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            
            return date.toLocaleDateString();
        }
        
        // Export rules
        // Open Workflow Builder
        function openWorkflowBuilder() {
            window.location.href = '/workflow-builder.html';
        }
        
        async function exportRules() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules`);
                if (!response.ok) throw new Error('Failed to load rules');
                
                const result = await response.json();
                if (result.success && result.data) {
                    const rules = result.data;
                    
                    // Create JSON file
                    const dataStr = JSON.stringify(rules, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Download file
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `automation-rules-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('Rules exported successfully', 'success');
                }
            } catch (error) {
                console.error('Error exporting rules:', error);
                showToast('Failed to export rules', 'error');
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                `;
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 
                             type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' :
                             'linear-gradient(135deg, #3b82f6, #2563eb)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                margin-bottom: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideIn 0.3s ease;
                min-width: 300px;
            `;
            
            const icon = document.createElement('span');
            icon.className = 'material-icons';
            icon.textContent = type === 'success' ? 'check_circle' : 
                              type === 'error' ? 'error' : 'info';
            
            const text = document.createElement('span');
            text.textContent = message;
            
            toast.appendChild(icon);
            toast.appendChild(text);
            toastContainer.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add animations
        const toastStyle = document.createElement('style');
        toastStyle.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: scale(1);
                }
                to {
                    opacity: 0;
                    transform: scale(0.9);
                }
            }
        `;
        document.head.appendChild(toastStyle);
        
        // Show templates (placeholder)
        function showTemplates() {
            showToast('Template browser coming soon!', 'info');
        }
        
        // Load automation rules from API
        async function loadAutomationRules() {
            try {
                // Show loading state
                const rulesGrid = document.getElementById('rulesGrid');
                const emptyState = document.getElementById('emptyState');
                
                rulesGrid.innerHTML = '<div class="loading-spinner">Loading rules...</div>';
                
                const response = await fetch(`${API_CONFIG.baseUrl}/automation/rules`);
                if (!response.ok) throw new Error('Failed to load rules');
                
                const data = await response.json();
                const rules = data.data || [];
                
                if (rules.length === 0) {
                    rulesGrid.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    rulesGrid.style.display = 'grid';
                    emptyState.style.display = 'none';
                    renderRules(rules);
                }
                
                // Update rule counts in sidebar
                updateRuleCounts(rules);
                
            } catch (error) {
                console.error('Error loading rules:', error);
                document.getElementById('rulesGrid').innerHTML = 
                    '<div class="error-message">Failed to load automation rules. Please refresh the page.</div>';
            }
        }
        
        // Render rules to grid
        function renderRules(rules) {
            const rulesGrid = document.getElementById('rulesGrid');
            rulesGrid.innerHTML = '';
            
            rules.forEach(rule => {
                const ruleCard = createRuleCard(rule);
                rulesGrid.appendChild(ruleCard);
            });
        }
        
        // Create rule card element
        function createRuleCard(rule) {
            const card = document.createElement('div');
            card.className = 'rule-card';
            card.dataset.type = rule.ruleType;
            card.dataset.ruleId = rule.id;
            
            const lastUsed = rule.lastTriggeredAt 
                ? formatTimeAgo(new Date(rule.lastTriggeredAt))
                : 'Never';
            
            const successRate = rule.triggerCount > 0 
                ? Math.round((rule.successCount / rule.triggerCount) * 100)
                : 0;
            
            card.innerHTML = `
                <div class="rule-header">
                    <div class="rule-info">
                        <h3 class="rule-name">${escapeHtml(rule.name)}</h3>
                        <p class="rule-description">${escapeHtml(rule.description || getDefaultDescription(rule.ruleType))}</p>
                    </div>
                    <div class="rule-toggle ${rule.isActive ? 'active' : ''}" onclick="toggleRule('${rule.id}', this)"></div>
                </div>
                
                <div class="rule-details">
                    <div class="rule-stat">
                        <div class="rule-stat-label">Triggered</div>
                        <div class="rule-stat-value">${rule.triggerCount || 0}</div>
                    </div>
                    <div class="rule-stat">
                        <div class="rule-stat-label">Success Rate</div>
                        <div class="rule-stat-value">${successRate}%</div>
                    </div>
                    <div class="rule-stat">
                        <div class="rule-stat-label">Last Used</div>
                        <div class="rule-stat-value">${lastUsed}</div>
                    </div>
                </div>
                
                <div class="rule-actions">
                    <button class="btn-icon" title="Edit" onclick="editRule('${rule.id}')">
                        <span class="material-icons">edit</span>
                    </button>
                    <button class="btn-icon" title="Duplicate" onclick="duplicateRule('${rule.id}')">
                        <span class="material-icons">content_copy</span>
                    </button>
                    <button class="btn-icon" title="Analytics" onclick="showAnalytics('${rule.id}')">
                        <span class="material-icons">analytics</span>
                    </button>
                    <button class="btn-icon" title="Delete" onclick="deleteRule('${rule.id}')">
                        <span class="material-icons">delete</span>
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // Update rule counts in sidebar
        function updateRuleCounts(rules) {
            const counts = {
                all: rules.length,
                welcome: 0,
                away: 0,
                keyword: 0,
                workflow: 0
            };
            
            rules.forEach(rule => {
                if (counts[rule.ruleType] !== undefined) {
                    counts[rule.ruleType]++;
                }
            });
            
            // Update sidebar counts
            document.querySelectorAll('.rule-type').forEach(el => {
                const type = el.onclick.toString().match(/filterRules\('(.+?)'\)/)?.[1];
                if (type && counts[type] !== undefined) {
                    const countEl = el.querySelector('.rule-count');
                    if (countEl) {
                        countEl.textContent = counts[type];
                    }
                }
            });
        }
        
        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getDefaultDescription(ruleType) {
            const descriptions = {
                welcome: 'Automatically greet new contacts',
                away: 'Reply when outside business hours',
                keyword: 'Respond to specific keywords',
                workflow: 'Multi-step conversation flow'
            };
            return descriptions[ruleType] || 'Automation rule';
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';
            if (interval === 1) return '1 year ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';
            if (interval === 1) return '1 month ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';
            if (interval === 1) return '1 day ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';
            if (interval === 1) return '1 hour ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';
            if (interval === 1) return '1 minute ago';
            
            return 'Just now';
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initParticles();
            loadPipelineStats();
            loadAutomationRules();
            
            // Initialize default rule type fields
            updateRuleTypeFields('keyword');
        });
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>