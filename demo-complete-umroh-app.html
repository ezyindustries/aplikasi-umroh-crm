<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo - Aplikasi Manajemen Umroh</title>
    
    <!-- Material UI Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            min-height: 100vh;
            color: #f8fafc;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(71, 85, 105, 0.3);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .logo {
            text-align: center;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            padding: 20px 0;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 12px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.4), rgba(30, 41, 59, 0.3));
            border: 1px solid rgba(71, 85, 105, 0.3);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.1));
            transform: translateX(8px) scale(1.02);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 10px 30px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(59, 130, 246, 0.3);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.2));
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 
                0 10px 30px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(59, 130, 246, 0.4),
                inset 0 -1px 0 rgba(16, 185, 129, 0.2);
        }

        .nav-item .material-icons {
            margin-right: 15px;
            font-size: 24px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Glass Card */
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), rgba(16, 185, 129, 0.8), rgba(139, 92, 246, 0.6), transparent);
        }

        .glass-card h2 {
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        @media (min-width: 1200px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1600px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .header-section h2 {
            margin: 0;
        }

        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.8), rgba(30, 41, 59, 0.7));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(16, 185, 129, 0.1));
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 
                0 20px 40px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(59, 130, 246, 0.4);
        }

        /* Smaller stat cards for Marketing and Automation */
        .stat-card-small {
            background: linear-gradient(145deg, rgba(51, 65, 85, 0.8), rgba(30, 41, 59, 0.7));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            min-height: auto;
            height: fit-content;
        }

        .stat-card-small::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card-small:hover::before {
            opacity: 1;
        }

        .stat-card-small:hover {
            transform: translateY(-4px) scale(1.01);
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(16, 185, 129, 0.1));
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.3);
        }

        .stat-card-small .stat-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #ffffff, #e2e8f0);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .stat-card-small .stat-label {
            font-size: 10px;
            color: rgba(203, 213, 225, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            line-height: 1.2;
        }

        /* Horizontal layout for stat containers */
        .stat-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Extra compact layout for pages with multiple sections */
        .stat-container-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .stat-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }
            
            .stat-container-compact {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .stat-container, .stat-container-compact {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .stat-container, .stat-container-compact {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        .stat-card .stat-icon {
            font-size: 48px;
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(3deg);
        }

        .stat-card .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 10px;
        }

        .stat-card .stat-label {
            color: #cbd5e1;
            font-size: 14px;
            font-weight: 500;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* Date Input Styles */
        .date-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-manual-input {
            flex: 1;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 8px;
            padding: 12px 15px;
            color: #f1f5f9;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .date-manual-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }

        .date-picker-input {
            flex: 1;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 8px;
            padding: 12px 15px;
            color: #f1f5f9;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            display: none;
        }

        .date-picker-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }

        .date-picker-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-toggle-btn {
            background: rgba(79, 172, 254, 0.2);
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #4facfe;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
        }

        .date-toggle-btn:hover {
            background: rgba(79, 172, 254, 0.3);
            border-color: rgba(79, 172, 254, 0.5);
            color: #60a5fa;
            transform: scale(1.05);
        }

        .date-toggle-btn.active {
            background: rgba(79, 172, 254, 0.4);
            border-color: rgba(79, 172, 254, 0.6);
        }

        .date-toggle-btn .material-icons {
            font-size: 20px;
        }

        /* Document Upload Styles */
        .file-upload-container {
            position: relative;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed rgba(79, 172, 254, 0.4);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            gap: 8px;
        }

        .file-upload-label:hover {
            border-color: rgba(79, 172, 254, 0.6);
            background: rgba(79, 172, 254, 0.1);
            transform: translateY(-2px);
        }

        .file-upload-label .material-icons {
            font-size: 32px;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .file-upload-label > span:not(.material-icons) {
            color: #f1f5f9;
            font-weight: 500;
            font-size: 14px;
        }

        .file-upload-label small {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .document-preview {
            margin-top: 15px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .preview-image {
            width: 100%;
            max-width: 200px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.4);
            margin-bottom: 10px;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn-preview {
            padding: 6px 12px;
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 6px;
            background: rgba(30, 41, 59, 0.7);
            color: #f1f5f9;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-preview:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: rgba(79, 172, 254, 0.4);
        }

        .btn-preview.btn-danger {
            color: #ef4444;
        }

        .btn-preview.btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }

        .btn-preview .material-icons {
            font-size: 14px;
        }

        /* Hide file inputs */
        #jamaahKtpImage,
        #jamaahKkImage,
        #jamaahPhoto {
            display: none;
        }

        /* Brochure Upload Styles */
        .brochure-upload-container {
            margin-top: 15px;
        }

        .brochure-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            border: 2px dashed rgba(79, 172, 254, 0.4);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin-bottom: 20px;
        }

        .brochure-upload-area:hover {
            border-color: rgba(79, 172, 254, 0.6);
            background: rgba(79, 172, 254, 0.1);
            transform: translateY(-2px);
        }

        .brochure-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .brochure-preview-item {
            position: relative;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .brochure-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .brochure-preview-item img:hover {
            transform: scale(1.05);
        }

        .brochure-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .brochure-preview-item .remove-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        .brochure-preview-item .photo-index {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }

        .section {
            margin-bottom: 40px;
        }

        .section h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
        }

        .chart-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 1024px) {
            .chart-container {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Sizing */
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .chart-wrapper h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .chart-wrapper canvas {
            width: 100% !important;
            height: calc(100% - 50px) !important;
            max-height: 250px;
        }

        .dashboard-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .dashboard-charts {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }

        /* Group Cards */
        .group-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .group-card:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(71, 85, 105, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .group-title {
            flex: 1;
        }

        .group-title h3 {
            color: #f8fafc;
            margin: 0 0 3px 0;
            font-size: 17px;
            font-weight: 600;
            line-height: 1.3;
        }

        .group-package {
            color: rgba(79, 172, 254, 0.9);
            font-size: 13px;
            font-weight: 500;
        }

        .group-status-badge {
            flex-shrink: 0;
        }

        .group-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .group-info-item {
            text-align: center;
        }

        .group-info-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 3px;
        }

        .group-info-value {
            color: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            line-height: 1.2;
        }

        .group-info-value.highlight {
            color: #4facfe;
            font-size: 14px;
        }

        .group-logistics {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .group-logistics-title {
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .group-logistics-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .group-logistics-item:last-child {
            margin-bottom: 0;
        }

        .group-logistics-icon {
            width: 14px;
            text-align: center;
            font-size: 12px;
        }

        .group-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin-top: 15px;
        }

        .group-actions-row {
            display: flex;
            gap: 4px;
        }

        .group-actions .btn {
            font-size: 9px;
            padding: 4px 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            min-height: 28px;
        }

        .group-actions .btn .material-icons {
            font-size: 12px;
            margin-right: 2px;
        }

        .group-actions .btn-sm {
            font-size: 8px;
            padding: 3px 4px;
            min-height: 24px;
        }

        .group-actions .btn-sm .material-icons {
            font-size: 10px;
            margin-right: 1px;
        }

        @media (max-width: 768px) {
            .group-actions {
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }
        }

        @media (max-width: 480px) {
            .group-actions {
                grid-template-columns: 1fr 1fr;
                gap: 3px;
            }

            .group-actions .btn {
                font-size: 8px;
                padding: 4px 6px;
                min-height: 26px;
            }

            .group-actions .btn .material-icons {
                font-size: 10px;
                margin-right: 1px;
            }
        }

        /* Room Management Styles */
        .room-management {
            margin-top: 20px;
        }

        .room-allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .room-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .room-stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .room-stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #4facfe;
            margin-bottom: 4px;
        }

        .room-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .room-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .room-card:hover {
            transform: translateY(-2px);
            border-color: rgba(79, 172, 254, 0.5);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.2);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .room-number {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
        }

        .room-type {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .room-type.quad {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .room-type.triple {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .room-type.double {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .room-type.single {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .room-occupants {
            margin-bottom: 12px;
        }

        .occupant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.2);
        }

        .occupant-info {
            flex: 1;
        }

        .occupant-name {
            font-size: 13px;
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 2px;
        }

        .occupant-details {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        .bed-assignment {
            padding: 2px 6px;
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .empty-bed {
            padding: 8px 10px;
            background: rgba(71, 85, 105, 0.2);
            border: 1px dashed rgba(71, 85, 105, 0.4);
            border-radius: 8px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-bottom: 6px;
        }

        .room-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 12px;
        }

        .room-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 11px;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .room-actions .btn .material-icons {
            font-size: 14px;
        }

        .allocation-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .allocation-option {
            padding: 15px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .allocation-option:hover {
            border-color: rgba(79, 172, 254, 0.5);
            background: rgba(79, 172, 254, 0.1);
        }

        .allocation-option.active {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }

        .allocation-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #4facfe;
        }

        .allocation-title {
            font-size: 14px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
        }

        .allocation-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.3;
        }

        .unassigned-jamaah {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .unassigned-header {
            color: #f8fafc;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unassigned-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .unassigned-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .unassigned-item:hover {
            border-color: rgba(79, 172, 254, 0.5);
            background: rgba(79, 172, 254, 0.1);
        }

        .unassigned-item.selected {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }

        @media (max-width: 992px) {
            .room-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .room-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 10px;
            }
            
            .allocation-controls {
                grid-template-columns: 1fr;
            }
            
            .room-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .room-actions {
                gap: 6px;
            }
            
            .room-actions .btn {
                padding: 6px 8px;
                font-size: 10px;
            }
            
            .room-actions .btn .material-icons {
                font-size: 12px;
            }
        }

        @media (max-width: 576px) {
            .room-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .room-card {
                padding: 12px;
            }
            
            .room-actions {
                gap: 4px;
                margin-top: 8px;
            }
            
            .room-actions .btn {
                padding: 5px 6px;
                font-size: 9px;
                min-height: 28px;
            }
            
            .room-actions .btn .material-icons {
                font-size: 11px;
                margin-right: 2px;
            }
            
            .occupant-item {
                padding: 6px 8px;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .occupant-item .occupant-name {
                font-size: 11px;
            }
            
            .occupant-item .occupant-role {
                font-size: 10px;
            }
        }

        @media (max-width: 400px) {
            .room-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .room-card {
                padding: 10px;
                margin: 0 5px;
            }
            
            .room-actions {
                flex-direction: column;
                gap: 6px;
                margin-top: 10px;
            }
            
            .room-actions .btn {
                flex: none;
                width: 100%;
                justify-content: center;
                padding: 8px 12px;
                font-size: 10px;
                white-space: normal;
                text-overflow: none;
                overflow: visible;
            }
            
            .room-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .room-number {
                font-size: 14px;
            }
        }

        .group-progress {
            margin-bottom: 12px;
        }

        .group-progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .group-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
        }

        .group-progress-text {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 3px;
            text-align: center;
            line-height: 1.2;
        }

        .form-group label {
            display: block;
            color: #e2e8f0;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.6);
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(203, 213, 225, 0.6);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 120px;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 80px;
        }

        .btn-icon {
            padding: 8px;
            min-width: auto;
        }

        .btn-icon .material-icons {
            font-size: 18px;
        }

        .btn-flex {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-group .btn {
            flex: 1;
            min-width: 100px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(239, 68, 68, 0.4);
        }

        /* Table */
        .table-container {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(15px);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid rgba(71, 85, 105, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .table-actions {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }

        .table-actions .btn {
            padding: 5px 10px;
            min-width: auto;
        }

        .table-actions .btn .material-icons {
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
            color: #e2e8f0;
        }

        th {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(16, 185, 129, 0.1));
            font-weight: 600;
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
        }

        tr:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(25px);
            border: 2px solid;
            border-image: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.1)) 1;
            border-radius: 24px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #8b5cf6, #f59e0b);
        }

        .modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            background: linear-gradient(135deg, #60a5fa, #34d399, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            margin-left: auto;
        }

        /* Charts */
        .chart-container {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: white;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
        }

        /* File upload */
        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .file-upload.dragover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.2);
        }

        /* Status badges */
        .status-badge {
            padding: 6px 14px;
            margin: 4px 0;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            vertical-align: middle;
        }

        .status-verified { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .status-pending { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .status-rejected { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .status-active { 
            background: linear-gradient(135deg, #f97316, #ea580c); 
            color: white; 
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }
        
        /* New Group Status Styles */
        .status-open { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .status-full { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .status-canceled { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .status-depart { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .status-arrival { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
            color: white; 
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
            backdrop-filter: blur(15px);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            z-index: 1001;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Financial Report Cards */
        .report-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-card:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: rgba(79, 172, 254, 0.3);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.2);
        }

        .report-icon {
            font-size: 48px;
            color: #4facfe;
            margin-bottom: 15px;
        }

        .report-card h4 {
            color: #f8fafc;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .report-card p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            line-height: 1.4;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        /* Marketing Tools Styles */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(71, 85, 105, 0.3);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .tab-btn.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
            background: rgba(79, 172, 254, 0.05);
        }

        .marketing-tab {
            display: none;
        }

        .marketing-tab.active {
            display: block;
        }

        .lead-temperature {
            font-size: 18px;
            text-align: center;
        }

        .lead-score {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .lead-score.high {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .lead-score.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .lead-score.low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .follow-up-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .follow-up-card:hover {
            transform: translateY(-2px);
            border-color: rgba(79, 172, 254, 0.5);
        }

        .follow-up-overdue {
            border-color: rgba(239, 68, 68, 0.5);
            background: linear-gradient(145deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
        }

        .campaign-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .campaign-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .campaign-stat {
            padding: 10px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
        }

        .team-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7));
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .team-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        }

        .performance-metric:last-child {
            border-bottom: none;
        }

        .timeline-container {
            position: relative;
            padding-left: 30px;
        }

        .timeline-container::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(79, 172, 254, 0.3);
        }

        .timeline-item {
            position: relative;
            padding: 10px 15px;
            margin-bottom: 15px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4facfe;
            border: 2px solid #1e293b;
        }

        .campaign-grid, .team-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .lead-actions {
            display: flex;
            gap: 5px;
        }

        .lead-actions .btn {
            padding: 4px 8px;
            font-size: 11px;
        }

        .lead-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .lead-tag {
            padding: 2px 8px;
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            border-radius: 12px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                Vauza Tamma Management System
            </div>
            
            <div class="nav-item active" onclick="showPage('dashboard')">
                <span class="material-icons">dashboard</span>
                Dashboard
            </div>
            
            <div class="nav-item" onclick="showPage('jamaah')">
                <span class="material-icons">people</span>
                Manajemen Jamaah
            </div>
            
            <div class="nav-item" onclick="showPage('packages')">
                <span class="material-icons">card_travel</span>
                Paket Umroh
            </div>
            
            <div class="nav-item" onclick="showPage('payments')">
                <span class="material-icons">payment</span>
                Pembayaran
            </div>
            
            <div class="nav-item" onclick="showPage('documents')">
                <span class="material-icons">description</span>
                Dokumen
            </div>
            
            <div class="nav-item" onclick="showPage('groups')">
                <span class="material-icons">group</span>
                Grup Keberangkatan
            </div>
            
            <div class="nav-item" onclick="showPage('finance')">
                <span class="material-icons">account_balance</span>
                Keuangan
            </div>
            
            <div class="nav-item" onclick="showPage('marketing')">
                <span class="material-icons">campaign</span>
                Marketing Tools
            </div>
            
            <div class="nav-item" onclick="showPage('automation')">
                <span class="material-icons">smart_toy</span>
                WhatsApp Automation
            </div>
            
            <div class="nav-item" onclick="showPage('reports')">
                <span class="material-icons">assessment</span>
                Laporan
            </div>
            
            <div class="nav-item" onclick="showPage('excel')">
                <span class="material-icons">table_chart</span>
                Excel Import/Export
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">dashboard</span>Dashboard Umroh</h2>
                    <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 30px;">Ringkasan data dan statistik sistem manajemen umroh</p>
                    
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon material-icons">people</div>
                            <div class="stat-number" id="totalJamaah">1,247</div>
                            <div class="stat-label">Total Jamaah</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon material-icons">card_travel</div>
                            <div class="stat-number" id="activePackages">15</div>
                            <div class="stat-label">Paket Aktif</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon material-icons">attach_money</div>
                            <div class="stat-number" id="totalRevenue">24.8B</div>
                            <div class="stat-label">Total Revenue (IDR)</div>
                        </div>
                    </div>

                    <!-- Group Departure Statistics -->
                    <div class="glass-card" style="margin-bottom: 30px;">
                        <h3 style="color: #4facfe; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span class="material-icons">flight</span>
                            Status Keberangkatan Grup
                        </h3>
                        <div class="stats-grid">
                            <div class="stat-card" style="background: linear-gradient(145deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.1)); border-color: rgba(255, 193, 7, 0.3);">
                                <div class="stat-icon material-icons" style="color: #ffc107;">schedule</div>
                                <div class="stat-number" id="groupsPending" style="color: #ffc107;">0</div>
                                <div class="stat-label">Belum Berangkat</div>
                            </div>
                            
                            <div class="stat-card" style="background: linear-gradient(145deg, rgba(33, 150, 243, 0.15), rgba(30, 136, 229, 0.1)); border-color: rgba(33, 150, 243, 0.3);">
                                <div class="stat-icon material-icons" style="color: #2196f3;">flight_takeoff</div>
                                <div class="stat-number" id="groupsDeparted" style="color: #2196f3;">0</div>
                                <div class="stat-label">Sedang Berangkat</div>
                            </div>
                            
                            <div class="stat-card" style="background: linear-gradient(145deg, rgba(76, 175, 80, 0.15), rgba(67, 160, 71, 0.1)); border-color: rgba(76, 175, 80, 0.3);">
                                <div class="stat-icon material-icons" style="color: #4caf50;">flight_land</div>
                                <div class="stat-number" id="groupsReturned" style="color: #4caf50;">0</div>
                                <div class="stat-label">Sudah Pulang</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon material-icons">groups</div>
                                <div class="stat-number" id="totalGroups">0</div>
                                <div class="stat-label">Total Grup Musim Ini</div>
                            </div>
                        </div>
                        
                        <!-- Progress Visualization -->
                        <div style="margin-top: 25px; padding: 20px; background: rgba(30, 41, 59, 0.3); border-radius: 12px;">
                            <h4 style="color: #cbd5e1; margin-bottom: 15px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Progress Keberangkatan</h4>
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="flex: 1; background: rgba(255, 255, 255, 0.1); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #ffc107, #2196f3, #4caf50); border-radius: 6px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                                <span id="progressText" style="color: #cbd5e1; font-weight: 600; min-width: 60px;">0%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span style="color: #ffc107;"> Belum</span>
                                <span style="color: #2196f3;"> Sedang</span>
                                <span style="color: #4caf50;"> Selesai</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="dashboard-charts">
                        <div class="chart-wrapper">
                            <h3>Registrasi Jamaah Bulanan</h3>
                            <canvas id="jamaahChart"></canvas>
                        </div>
                        
                        <div class="chart-wrapper">
                            <h3>Revenue per Paket</h3>
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jamaah Management Page -->
            <div id="jamaah" class="page">
                <div class="glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">people</span>Manajemen Jamaah</h2>
                        <button class="btn btn-primary" onclick="openModal('jamaahModal')">
                            <span class="material-icons">add</span>
                            Tambah Jamaah
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <label>Cari Jamaah</label>
                            <input type="text" id="searchJamaah" placeholder="Nama, NIK, atau No. Telepon">
                        </div>
                        <div class="filter-group">
                            <label>Paket</label>
                            <select id="filterPackage">
                                <option value="">Semua Paket</option>
                                <option value="1">Umroh Ramadhan 2024</option>
                                <option value="2">Umroh Plus Turki</option>
                                <option value="3">Umroh Keluarga</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="filterStatus">
                                <option value="">Semua Status</option>
                                <option value="verified">Terverifikasi</option>
                                <option value="pending">Pending</option>
                                <option value="rejected">Ditolak</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="filterJamaah()">
                                <span class="material-icons">search</span>
                                Filter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Jamaah Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Lengkap</th>
                                    <th>NIK</th>
                                    <th>No. Telepon</th>
                                    <th>Paspor</th>
                                    <th>Dokumen</th>
                                    <th>Paket</th>
                                    <th>Status</th>
                                    <th>Total Bayar</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="jamaahTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Packages Page -->
            <div id="packages" class="page">
                <div class="glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">card_travel</span>Paket Umroh</h2>
                        <button class="btn btn-primary" onclick="openModal('packageModal')">
                            <span class="material-icons">add</span>
                            Tambah Paket
                        </button>
                    </div>
                    
                    <!-- Package Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;" id="packageGrid">
                        <!-- Package cards will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Payments Page -->
            <div id="payments" class="page">
                <div class="glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">payment</span>Manajemen Pembayaran Jamaah</h2>
                        <button class="btn btn-primary" onclick="openModal('paymentModal')">
                            <span class="material-icons">add</span>
                            Catat Pembayaran
                        </button>
                    </div>
                    
                    <!-- Search Section -->
                    <div style="margin-bottom: 20px;">
                        <div style="position: relative; max-width: 400px;">
                            <input type="text" 
                                   id="searchPayment" 
                                   placeholder="Cari berdasarkan nama jamaah atau nomor HP..." 
                                   style="width: 100%; padding: 12px 15px 12px 45px; background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(71, 85, 105, 0.4); border-radius: 8px; color: #f1f5f9; font-size: 14px;"
                                   onkeyup="searchPayments()">
                            <span class="material-icons" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.5); font-size: 20px;">search</span>
                        </div>
                    </div>
                    
                    <!-- Payment Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-number">Rp 24.8B</div>
                            <div class="stat-label">Total Pembayaran</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">Rp 22.1B</div>
                            <div class="stat-label">Terverifikasi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">Rp 2.7B</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">23</div>
                            <div class="stat-label">Transaksi Pending</div>
                        </div>
                    </div>
                    
                    <!-- Payment Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Jamaah</th>
                                    <th>Paket</th>
                                    <th>Jumlah Bayar</th>
                                    <th>Status Pembayaran</th>
                                    <th>H-Minus</th>
                                    <th>Metode</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Documents Page -->
            <div id="documents" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">description</span>Manajemen Dokumen</h2>
                    
                    <!-- Document Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div class="stat-card">
                            <div class="stat-number">1,247</div>
                            <div class="stat-label">Total Dokumen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">1,089</div>
                            <div class="stat-label">Terverifikasi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">158</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">23</div>
                            <div class="stat-label">Ditolak</div>
                        </div>
                    </div>
                    
                    <!-- Document Upload -->
                    <div class="file-upload" onclick="document.getElementById('docUpload').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <span class="material-icons" style="font-size: 48px; color: rgba(255, 255, 255, 0.6); margin-bottom: 10px;">cloud_upload</span>
                        <p style="color: white; margin-bottom: 10px;">Klik atau drag & drop untuk upload dokumen</p>
                        <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Mendukung: PDF, JPG, PNG, DOC, DOCX (Max: 10MB)</p>
                        <input type="file" id="docUpload" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                    
                    <!-- Document Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Jamaah</th>
                                    <th>Jenis Dokumen</th>
                                    <th>File</th>
                                    <th>Upload Date</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="documentTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Groups Page -->
            <div id="groups" class="page">
                <div class="glass-card">
                    <div class="header-section">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">group</span>Grup Keberangkatan</h2>
                        <button class="btn btn-primary" onclick="openModal('groupModal')">
                            <span class="material-icons">add</span>
                            Buat Grup Baru
                        </button>
                    </div>
                    
                    <!-- Group Cards -->
                    <div class="cards-grid" id="groupGrid">
                        <!-- Group cards will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Finance Page -->
            <div id="finance" class="page">
                <div class="glass-card">
                    <div class="header-section">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">account_balance</span>Manajemen Keuangan</h2>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="openModal('journalModal')">
                                <span class="material-icons">add</span>
                                Jurnal Umum
                            </button>
                            <button class="btn btn-primary" onclick="openModal('expenseModal')">
                                <span class="material-icons">payment</span>
                                Pengeluaran
                            </button>
                            <button class="btn btn-success" onclick="showFinanceTutorial()">
                                <span class="material-icons">help</span>
                                Tutorial
                            </button>
                        </div>
                    </div>
                    
                    <!-- Finance Stats -->
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-icon material-icons">account_balance_wallet</div>
                            <div class="stat-number" id="totalCash">Rp 0</div>
                            <div class="stat-label">Saldo Kas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon material-icons">trending_up</div>
                            <div class="stat-number" id="totalRevenue">Rp 0</div>
                            <div class="stat-label">Total Pendapatan</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon material-icons">trending_down</div>
                            <div class="stat-number" id="totalExpense">Rp 0</div>
                            <div class="stat-label">Total Pengeluaran</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon material-icons">attach_money</div>
                            <div class="stat-number" id="netProfit">Rp 0</div>
                            <div class="stat-label">Laba Bersih</div>
                        </div>
                    </div>

                    <!-- COA Section -->
                    <div class="glass-card" style="margin-bottom: 20px;">
                        <h3 style="color: #4facfe; margin-bottom: 15px;">Chart of Accounts (Daftar Akun)</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn btn-primary btn-sm" onclick="openModal('coaModal')">
                                <span class="material-icons">add</span>
                                Tambah Akun
                            </button>
                            <button class="btn btn-success btn-sm" onclick="loadDefaultCOA()">
                                <span class="material-icons">download</span>
                                Load Default COA
                            </button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Kode Akun</th>
                                        <th>Nama Akun</th>
                                        <th>Kategori</th>
                                        <th>Saldo Normal</th>
                                        <th>Saldo</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="coaTableBody">
                                    <!-- COA will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Financial Reports Section -->
                    <div class="glass-card">
                        <h3 style="color: #4facfe; margin-bottom: 20px;">Laporan Keuangan</h3>
                        <div class="report-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Balance Sheet -->
                            <div class="report-card" onclick="generateFinancialReport('balance_sheet')">
                                <div class="report-icon material-icons">account_balance</div>
                                <h4>Neraca (Balance Sheet)</h4>
                                <p>Laporan posisi keuangan yang menunjukkan aset, kewajiban, dan modal</p>
                            </div>
                            
                            <!-- Income Statement -->
                            <div class="report-card" onclick="generateFinancialReport('income_statement')">
                                <div class="report-icon material-icons">trending_up</div>
                                <h4>Laba Rugi (Income Statement)</h4>
                                <p>Laporan pendapatan dan beban untuk menghitung laba/rugi</p>
                            </div>
                            
                            <!-- Cash Flow -->
                            <div class="report-card" onclick="generateFinancialReport('cash_flow')">
                                <div class="report-icon material-icons">paid</div>
                                <h4>Arus Kas (Cash Flow)</h4>
                                <p>Laporan aliran kas masuk dan keluar dari aktivitas operasi, investasi, dan pendanaan</p>
                            </div>
                            
                            <!-- General Journal -->
                            <div class="report-card" onclick="generateFinancialReport('general_journal')">
                                <div class="report-icon material-icons">menu_book</div>
                                <h4>Jurnal Umum</h4>
                                <p>Catatan kronologis semua transaksi keuangan</p>
                            </div>
                            
                            <!-- Special Journal -->
                            <div class="report-card" onclick="generateFinancialReport('special_journal')">
                                <div class="report-icon material-icons">library_books</div>
                                <h4>Jurnal Khusus</h4>
                                <p>Jurnal penjualan, pembelian, penerimaan kas, dan pengeluaran kas</p>
                            </div>
                            
                            <!-- General Ledger -->
                            <div class="report-card" onclick="generateFinancialReport('general_ledger')">
                                <div class="report-icon material-icons">book</div>
                                <h4>Buku Besar</h4>
                                <p>Catatan pergerakan saldo untuk setiap akun</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="glass-card" style="margin-top: 20px;">
                        <h3 style="color: #4facfe; margin-bottom: 15px;">Transaksi Terbaru</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>No. Jurnal</th>
                                        <th>Deskripsi</th>
                                        <th>Debit</th>
                                        <th>Kredit</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="journalTableBody">
                                    <!-- Journals will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketing Tools Page -->
            <div id="marketing" class="page">
                <div class="glass-card">
                    <div class="header-section">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">campaign</span>Marketing Tools</h2>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="openModal('leadModal')">
                                <span class="material-icons">person_add</span>
                                Input Lead Baru
                            </button>
                            <button class="btn btn-success" onclick="openModal('broadcastModal')">
                                <span class="material-icons">send</span>
                                WhatsApp Broadcast
                            </button>
                            <button class="btn btn-warning" onclick="showCampaignReport()">
                                <span class="material-icons">analytics</span>
                                Campaign Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Marketing Stats -->
                    <div class="stat-container-compact">
                        <div class="stat-card-small" style="background: linear-gradient(145deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.1)); border-color: rgba(34, 197, 94, 0.3);">
                            <div class="stat-number" id="totalLeads" style="color: #22c55e;">0</div>
                            <div class="stat-label">Total Leads</div>
                        </div>
                        
                        <div class="stat-card-small" style="background: linear-gradient(145deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1)); border-color: rgba(251, 191, 36, 0.3);">
                            <div class="stat-number" id="hotLeads" style="color: #fbbf24;">0</div>
                            <div class="stat-label">Hot Leads </div>
                        </div>
                        
                        <div class="stat-card-small" style="background: linear-gradient(145deg, rgba(79, 172, 254, 0.15), rgba(56, 155, 255, 0.1)); border-color: rgba(79, 172, 254, 0.3);">
                            <div class="stat-number" id="conversionRate" style="color: #4facfe;">0%</div>
                            <div class="stat-label">Conversion Rate</div>
                        </div>
                        
                        <div class="stat-card-small">
                            <div class="stat-number" id="avgResponseTime">0h</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                    </div>

                    <!-- Conversion Funnel -->
                    <div class="glass-card" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px;">Conversion Funnel</h3>
                        <div class="funnel-container" style="display: flex; align-items: center; gap: 10px; padding: 20px; overflow-x: auto;">
                            <div class="funnel-stage" style="text-align: center; flex: 1; min-width: 120px;">
                                <div class="funnel-bar" style="background: #22c55e; height: 80px; border-radius: 8px 8px 0 0; position: relative;">
                                    <span class="funnel-count" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: white;" id="funnelLead">0</span>
                                </div>
                                <div class="funnel-label" style="margin-top: 8px; font-size: 12px; color: #cbd5e1;">Lead</div>
                            </div>
                            <span class="material-icons" style="color: #4facfe;">arrow_forward</span>
                            <div class="funnel-stage" style="text-align: center; flex: 1; min-width: 120px;">
                                <div class="funnel-bar" style="background: #fbbf24; height: 60px; border-radius: 8px 8px 0 0; position: relative;">
                                    <span class="funnel-count" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;" id="funnelContacted">0</span>
                                </div>
                                <div class="funnel-label" style="margin-top: 8px; font-size: 12px; color: #cbd5e1;">Contacted</div>
                            </div>
                            <span class="material-icons" style="color: #4facfe;">arrow_forward</span>
                            <div class="funnel-stage" style="text-align: center; flex: 1; min-width: 120px;">
                                <div class="funnel-bar" style="background: #f59e0b; height: 45px; border-radius: 8px 8px 0 0; position: relative;">
                                    <span class="funnel-count" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;" id="funnelInterested">0</span>
                                </div>
                                <div class="funnel-label" style="margin-top: 8px; font-size: 12px; color: #cbd5e1;">Interested</div>
                            </div>
                            <span class="material-icons" style="color: #4facfe;">arrow_forward</span>
                            <div class="funnel-stage" style="text-align: center; flex: 1; min-width: 120px;">
                                <div class="funnel-bar" style="background: #ef4444; height: 30px; border-radius: 8px 8px 0 0; position: relative;">
                                    <span class="funnel-count" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: white;" id="funnelClosing">0</span>
                                </div>
                                <div class="funnel-label" style="margin-top: 8px; font-size: 12px; color: #cbd5e1;">Closing</div>
                            </div>
                            <span class="material-icons" style="color: #4facfe;">arrow_forward</span>
                            <div class="funnel-stage" style="text-align: center; flex: 1; min-width: 120px;">
                                <div class="funnel-bar" style="background: #4facfe; height: 20px; border-radius: 8px 8px 0 0; position: relative;">
                                    <span class="funnel-count" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: white;" id="funnelConverted">0</span>
                                </div>
                                <div class="funnel-label" style="margin-top: 8px; font-size: 12px; color: #cbd5e1;">Converted</div>
                            </div>
                        </div>
                    </div>

                    <!-- Lead Management Tabs -->
                    <div class="tab-container" style="margin-bottom: 20px;">
                        <button class="tab-btn active" onclick="showMarketingTab('leads')">
                            <span class="material-icons">people</span>
                            Lead Management
                        </button>
                        <button class="tab-btn" onclick="showMarketingTab('followup')">
                            <span class="material-icons">schedule</span>
                            Follow-up Tracker
                        </button>
                        <button class="tab-btn" onclick="showMarketingTab('campaigns')">
                            <span class="material-icons">ads_click</span>
                            Campaigns
                        </button>
                        <button class="tab-btn" onclick="showMarketingTab('team')">
                            <span class="material-icons">groups</span>
                            Team Performance
                        </button>
                    </div>

                    <!-- Lead Management Tab -->
                    <div id="leadsTab" class="marketing-tab active">
                        <div class="filters" style="margin-bottom: 20px;">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchLead" placeholder="Nama/No. WhatsApp" onkeyup="filterLeads()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="filterLeadStatus" onchange="filterLeads()">
                                    <option value="">Semua Status</option>
                                    <option value="new">New</option>
                                    <option value="contacted">Contacted</option>
                                    <option value="interested">Interested</option>
                                    <option value="not_interested">Not Interested</option>
                                    <option value="converted">Converted</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Temperature</label>
                                <select id="filterLeadTemp" onchange="filterLeads()">
                                    <option value="">Semua</option>
                                    <option value="hot"> Hot</option>
                                    <option value="warm"> Warm</option>
                                    <option value="cold"> Cold</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Source</label>
                                <select id="filterLeadSource" onchange="filterLeads()">
                                    <option value="">Semua Source</option>
                                    <option value="fb_ads">FB Ads</option>
                                    <option value="google_ads">Google Ads</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="referral">Referral</option>
                                    <option value="website">Website</option>
                                    <option value="other">Lainnya</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Temp</th>
                                        <th>Nama</th>
                                        <th>No. WhatsApp</th>
                                        <th>Source</th>
                                        <th>Status</th>
                                        <th>Marketer</th>
                                        <th>Last Contact</th>
                                        <th>Score</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="leadTableBody">
                                    <!-- Lead data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Follow-up Tab -->
                    <div id="followupTab" class="marketing-tab">
                        <div class="follow-up-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                            <!-- Follow-up cards will be populated here -->
                        </div>
                    </div>

                    <!-- Campaigns Tab -->
                    <div id="campaignsTab" class="marketing-tab">
                        <div class="campaign-grid" id="campaignGrid">
                            <!-- Campaign cards will be populated here -->
                        </div>
                    </div>

                    <!-- Team Performance Tab -->
                    <div id="teamTab" class="marketing-tab">
                        <div class="team-performance-grid" id="teamGrid">
                            <!-- Team performance cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Automation Page -->
            <div id="automation" class="page">
                <div class="glass-card">
                    <div class="header-section">
                        <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">smart_toy</span>WhatsApp Automation</h2>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="openModal('automationRuleModal')">
                                <span class="material-icons">add</span>
                                Tambah Rule
                            </button>
                            <button class="btn btn-success" onclick="openModal('messageTemplateModal')">
                                <span class="material-icons">message</span>
                                Template Pesan
                            </button>
                            <button class="btn btn-warning" onclick="showQueueMonitor()">
                                <span class="material-icons">queue</span>
                                Monitor Queue
                            </button>
                            <button class="btn btn-info" onclick="testWAHAConnection()">
                                <span class="material-icons">wifi</span>
                                Test WAHA
                            </button>
                        </div>
                    </div>

                    <!-- Automation Status Cards -->
                    <div class="stat-container-compact">
                        <div class="stat-card-small" style="background: linear-gradient(145deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.1)); border-color: rgba(34, 197, 94, 0.3);">
                            <div class="stat-number" id="activeRules" style="color: #22c55e;">0</div>
                            <div class="stat-label">Active Rules</div>
                        </div>
                        
                        <div class="stat-card-small" style="background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1)); border-color: rgba(59, 130, 246, 0.3);">
                            <div class="stat-number" id="queuedMessages" style="color: #3b82f6;">0</div>
                            <div class="stat-label">Queued Messages</div>
                        </div>
                        
                        <div class="stat-card-small" style="background: linear-gradient(145deg, rgba(168, 85, 247, 0.15), rgba(147, 51, 234, 0.1)); border-color: rgba(168, 85, 247, 0.3);">
                            <div class="stat-number" id="sentToday" style="color: #a855f7;">0</div>
                            <div class="stat-label">Sent Today</div>
                        </div>
                        
                        <div class="stat-card-small">
                            <div class="stat-number" id="deliveryRate">95%</div>
                            <div class="stat-label">Delivery Rate</div>
                        </div>
                    </div>

                    <!-- WAHA Connection Status -->
                    <div class="glass-card" style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0;">WAHA Connection Status</h4>
                                <p style="margin: 5px 0; color: #cbd5e1;">WhatsApp HTTP API Integration</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div id="wahaStatus" class="status-badge status-pending">Disconnected</div>
                                <button class="btn btn-primary btn-sm" onclick="testWAHAConnection()">
                                    <span class="material-icons">refresh</span>
                                    Test Connection
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                            <p style="margin: 0; font-size: 14px; color: #cbd5e1;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">info</span>
                                WAHA server configuration akan dilakukan saat server sudah ready. 
                                Saat ini sistem automation sudah siap untuk integrasi.
                            </p>
                        </div>
                    </div>

                    <!-- Automation Tabs -->
                    <div class="tab-container" style="margin-bottom: 20px;">
                        <button class="tab-btn active" onclick="showAutomationTab('rules')">
                            <span class="material-icons">rule</span>
                            Automation Rules
                        </button>
                        <button class="tab-btn" onclick="showAutomationTab('templates')">
                            <span class="material-icons">message</span>
                            Message Templates
                        </button>
                        <button class="tab-btn" onclick="showAutomationTab('queue')">
                            <span class="material-icons">schedule_send</span>
                            Message Queue
                        </button>
                        <button class="tab-btn" onclick="showAutomationTab('analytics')">
                            <span class="material-icons">analytics</span>
                            Analytics
                        </button>
                    </div>

                    <!-- Rules Tab -->
                    <div id="rulesTab" class="automation-tab active">
                        <div class="automation-rules-grid" id="rulesGrid">
                            <!-- Rules will be populated here -->
                        </div>
                    </div>

                    <!-- Templates Tab -->
                    <div id="templatesTab" class="automation-tab">
                        <div class="templates-grid" id="templatesGrid">
                            <!-- Templates will be populated here -->
                        </div>
                    </div>

                    <!-- Queue Tab -->
                    <div id="queueTab" class="automation-tab">
                        <div class="filters" style="margin-bottom: 20px;">
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="filterQueueStatus" onchange="filterQueue()">
                                    <option value="">Semua Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="sending">Sending</option>
                                    <option value="sent">Sent</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Date Range</label>
                                <input type="date" id="filterQueueDate" onchange="filterQueue()">
                            </div>
                        </div>
                        
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Jamaah</th>
                                        <th>Phone</th>
                                        <th>Template</th>
                                        <th>Scheduled</th>
                                        <th>Status</th>
                                        <th>Sent</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="queueTableBody">
                                    <!-- Queue items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div id="analyticsTab" class="automation-tab">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div class="glass-card">
                                <h4>Message Performance</h4>
                                <canvas id="messageChart" width="300" height="200"></canvas>
                            </div>
                            <div class="glass-card">
                                <h4>Popular Templates</h4>
                                <div id="popularTemplates"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">assessment</span>Laporan & Analytics</h2>
                    
                    <!-- Report Buttons -->
                    <div class="report-grid">
                        <button class="btn btn-primary" onclick="generateReport('jamaah')">
                            <span class="material-icons">people</span>
                            Laporan Jamaah
                        </button>
                        <button class="btn btn-success" onclick="generateReport('payment')">
                            <span class="material-icons">payment</span>
                            Laporan Keuangan
                        </button>
                        <button class="btn btn-warning" onclick="generateReport('package')">
                            <span class="material-icons">card_travel</span>
                            Laporan Paket
                        </button>
                        <button class="btn btn-primary" onclick="generateReport('departure')">
                            <span class="material-icons">flight_takeoff</span>
                            Laporan Keberangkatan
                        </button>
                    </div>
                    
                    <!-- Analytics Charts -->
                    <div class="chart-container">
                        <div class="glass-card">
                            <div class="chart-wrapper" style="background: transparent; border: none; padding: 0;">
                                <h3>Trend Registrasi 6 Bulan</h3>
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="glass-card">
                            <div class="chart-wrapper" style="background: transparent; border: none; padding: 0;">
                                <h3>Distribusi Status Jamaah</h3>
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excel Page -->
            <div id="excel" class="page">
                <div class="glass-card">
                    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">table_chart</span>Excel Import & Export</h2>
                    
                    <!-- Import Section -->
                    <div class="section">
                        <h3>Import Data</h3>
                        
                        <div class="report-grid">
                            <button class="btn btn-primary" onclick="downloadTemplate('jamaah')">
                                <span class="material-icons">download</span>
                                Template Jamaah
                            </button>
                            <button class="btn btn-primary" onclick="downloadTemplate('package')">
                                <span class="material-icons">download</span>
                                Template Paket
                            </button>
                            <button class="btn btn-primary" onclick="downloadTemplate('payment')">
                                <span class="material-icons">download</span>
                                Template Pembayaran
                            </button>
                        </div>
                        
                        <div class="file-upload" onclick="document.getElementById('excelUpload').click()">
                            <span class="material-icons" style="font-size: 48px; color: rgba(255, 255, 255, 0.6); margin-bottom: 10px;">upload_file</span>
                            <p style="color: white; margin-bottom: 10px;">Upload file Excel untuk import data</p>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Format: .xlsx, .xls</p>
                            <input type="file" id="excelUpload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)">
                        </div>
                    </div>
                    
                    <!-- Export Section -->
                    <div class="section">
                        <h3>Export Data</h3>
                        
                        <div class="report-grid">
                            <button class="btn btn-success" onclick="exportToExcel('jamaah')">
                                <span class="material-icons">file_download</span>
                                Export Jamaah
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('package')">
                                <span class="material-icons">file_download</span>
                                Export Paket
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('payment')">
                                <span class="material-icons">file_download</span>
                                Export Pembayaran
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('all')">
                                <span class="material-icons">file_download</span>
                                Export Semua Data
                            </button>
                            <button class="btn btn-primary" onclick="exportToExcel('manifest')">
                                <span class="material-icons">description</span>
                                Export Manifest
                            </button>
                        </div>
                    </div>
                    
                    <!-- Import Results -->
                    <div id="importResults" style="margin-top: 30px; display: none;">
                        <h3 style="color: white; margin-bottom: 15px;">Hasil Import</h3>
                        <div id="importResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Jamaah Modal -->
    <div id="jamaahModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tambah/Edit Jamaah</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveJamaah(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="jamaahName" required>
                    </div>
                    <div class="form-group">
                        <label>NIK</label>
                        <input type="text" id="jamaahNik" maxlength="16" required>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Lahir</label>
                        <div class="date-input-container">
                            <input type="text" id="jamaahBirthDate" placeholder="ddmmyyyy (contoh: 15051985)" maxlength="8" pattern="[0-9]{8}" required class="date-manual-input">
                            <input type="date" id="jamaahBirthDatePicker" class="date-picker-input">
                            <button type="button" class="date-toggle-btn" onclick="toggleDateInput('jamaahBirthDate')">
                                <span class="material-icons">date_range</span>
                            </button>
                        </div>
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Ketik manual (ddmmyyyy) atau klik kalender</small>
                    </div>
                    <div class="form-group">
                        <label>Tempat Lahir</label>
                        <input type="text" id="jamaahBirthPlace" required>
                    </div>
                    <div class="form-group">
                        <label>Jenis Kelamin</label>
                        <select id="jamaahGender" required>
                            <option value="">Pilih</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>No. Telepon</label>
                        <input type="tel" id="jamaahPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="jamaahEmail">
                    </div>
                    <div class="form-group">
                        <label>Paket Umroh</label>
                        <select id="jamaahPackage" required>
                            <option value="">Pilih Paket</option>
                            <option value="1">Umroh Ramadhan 2024 - Rp 25.000.000</option>
                            <option value="2">Umroh Plus Turki - Rp 35.000.000</option>
                            <option value="3">Umroh Keluarga - Rp 22.000.000</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Alamat Lengkap</label>
                    <textarea id="jamaahAddress" rows="3" required></textarea>
                </div>

                <!-- Optional Regional Fields -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Regional (Opsional)</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Provinsi</label>
                            <select id="jamaahProvinsi">
                                <option value="">Pilih Provinsi</option>
                                <option value="Nanggroe Aceh Darussalam">Nanggroe Aceh Darussalam</option>
                                <option value="Sumatera Utara">Sumatera Utara</option>
                                <option value="Sumatera Selatan">Sumatera Selatan</option>
                                <option value="Sumatera Barat">Sumatera Barat</option>
                                <option value="Bengkulu">Bengkulu</option>
                                <option value="Riau">Riau</option>
                                <option value="Kepulauan Riau">Kepulauan Riau</option>
                                <option value="Jambi">Jambi</option>
                                <option value="Lampung">Lampung</option>
                                <option value="Bangka Belitung">Bangka Belitung</option>
                                <option value="Kalimantan Barat">Kalimantan Barat</option>
                                <option value="Kalimantan Timur">Kalimantan Timur</option>
                                <option value="Kalimantan Selatan">Kalimantan Selatan</option>
                                <option value="Kalimantan Tengah">Kalimantan Tengah</option>
                                <option value="Kalimantan Utara">Kalimantan Utara</option>
                                <option value="Banten">Banten</option>
                                <option value="DKI Jakarta">DKI Jakarta</option>
                                <option value="Jawa Barat">Jawa Barat</option>
                                <option value="Jawa Tengah">Jawa Tengah</option>
                                <option value="Daerah Istimewa Yogyakarta">Daerah Istimewa Yogyakarta</option>
                                <option value="Jawa Timur">Jawa Timur</option>
                                <option value="Bali">Bali</option>
                                <option value="Nusa Tenggara Timur">Nusa Tenggara Timur</option>
                                <option value="Nusa Tenggara Barat">Nusa Tenggara Barat</option>
                                <option value="Gorontalo">Gorontalo</option>
                                <option value="Sulawesi Barat">Sulawesi Barat</option>
                                <option value="Sulawesi Tengah">Sulawesi Tengah</option>
                                <option value="Sulawesi Utara">Sulawesi Utara</option>
                                <option value="Sulawesi Tenggara">Sulawesi Tenggara</option>
                                <option value="Sulawesi Selatan">Sulawesi Selatan</option>
                                <option value="Maluku Utara">Maluku Utara</option>
                                <option value="Maluku">Maluku</option>
                                <option value="Papua Barat">Papua Barat</option>
                                <option value="Papua">Papua</option>
                                <option value="Papua Tengah">Papua Tengah</option>
                                <option value="Papua Pegunungan">Papua Pegunungan</option>
                                <option value="Papua Selatan">Papua Selatan</option>
                                <option value="Papua Barat Daya">Papua Barat Daya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kabupaten/Kota</label>
                            <input type="text" id="jamaahKabupaten" placeholder="Contoh: Jakarta Pusat">
                        </div>
                        <div class="form-group">
                            <label>Kecamatan</label>
                            <input type="text" id="jamaahKecamatan" placeholder="Contoh: Gambir">
                        </div>
                        <div class="form-group">
                            <label>Kelurahan</label>
                            <input type="text" id="jamaahKelurahan" placeholder="Contoh: Petojo Utara">
                        </div>
                    </div>
                </div>

                <!-- Personal Status Fields -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Personal (Opsional)</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Status Pernikahan</label>
                            <select id="jamaahMaritalStatus">
                                <option value="">Pilih Status</option>
                                <option value="belum_kawin">Belum Kawin</option>
                                <option value="kawin">Kawin</option>
                                <option value="cerai_hidup">Cerai Hidup</option>
                                <option value="cerai_mati">Cerai Mati</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pendidikan Terakhir</label>
                            <select id="jamaahEducation">
                                <option value="">Pilih Pendidikan</option>
                                <option value="sd">SD</option>
                                <option value="smp">SMP</option>
                                <option value="sma">SMA/SMK</option>
                                <option value="d3">Diploma 3</option>
                                <option value="s1">Sarjana (S1)</option>
                                <option value="s2">Magister (S2)</option>
                                <option value="s3">Doktor (S3)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pekerjaan</label>
                            <input type="text" id="jamaahOccupation" placeholder="Contoh: Guru, Pegawai Swasta, Wiraswasta">
                        </div>
                    </div>
                </div>

                <!-- Family Information -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Keluarga</h4>
                    
                    <div class="form-group">
                        <label>Status dalam Keluarga</label>
                        <select id="jamaahFamilyRole" onchange="toggleFamilyFields(this)" required>
                            <option value="">Pilih Status</option>
                            <option value="kepala_keluarga">Kepala Keluarga</option>
                            <option value="istri">Istri</option>
                            <option value="anak">Anak</option>
                            <option value="individu">Individu (Tidak Ada Keluarga)</option>
                        </select>
                    </div>

                    <div id="mainFamilySection" style="display: none;">
                        <div class="form-group">
                            <label>Pilih Main Family (Kepala Keluarga)</label>
                            <select id="jamaahMainFamily">
                                <option value="">Pilih Kepala Keluarga</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Preferensi Kamar</label>
                            <select id="jamaahRoomPreference" required>
                                <option value="">Pilih Tipe Kamar</option>
                                <option value="quad" selected>Quad (4 orang) - Default</option>
                                <option value="triple">Triple (3 orang)</option>
                                <option value="double">Double (2 orang)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="jamaahFamilyRoomRequest">
                                <span>Request 1 Kamar untuk 1 Keluarga</span>
                            </label>
                            <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Centang jika ingin satu keluarga dalam satu kamar (berbeda gender diperbolehkan)</small>
                        </div>
                    </div>
                </div>

                <!-- Passport Information -->
                <div class="form-section">
                    <h4 style="color: #3b82f6; margin: 20px 0 15px 0; font-size: 16px;">Data Paspor</h4>
                    
                    <div class="form-group">
                        <label>Nama di Paspor</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="jamaahPassportName" placeholder="Nama lengkap sesuai paspor" style="flex: 1;">
                            <label style="display: flex; align-items: center; gap: 5px; color: rgba(255, 255, 255, 0.8); font-size: 12px; white-space: nowrap;">
                                <input type="checkbox" id="sameAsKtpName" onchange="togglePassportName(this)">
                                Sama dengan nama KTP
                            </label>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>No. Paspor</label>
                            <input type="text" id="jamaahPassportNumber" placeholder="Contoh: A1234567">
                        </div>
                        <div class="form-group">
                            <label>Kota Penerbitan Paspor</label>
                            <input type="text" id="jamaahPassportCity" placeholder="Contoh: Jakarta">
                        </div>
                        <div class="form-group">
                            <label>Tanggal Penerbitan</label>
                            <div class="date-input-container">
                                <input type="text" id="jamaahPassportIssueDate" placeholder="ddmmyyyy (contoh: 15012020)" maxlength="8" pattern="[0-9]{8}" class="date-manual-input">
                                <input type="date" id="jamaahPassportIssueDatePicker" class="date-picker-input">
                                <button type="button" class="date-toggle-btn" onclick="toggleDateInput('jamaahPassportIssueDate')">
                                    <span class="material-icons">date_range</span>
                                </button>
                            </div>
                            <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Ketik manual (ddmmyyyy) atau klik kalender</small>
                        </div>
                        <div class="form-group">
                            <label>Tanggal Kadaluarsa</label>
                            <div class="date-input-container">
                                <input type="text" id="jamaahPassportExpireDate" placeholder="ddmmyyyy (contoh: 15012030)" maxlength="8" pattern="[0-9]{8}" class="date-manual-input">
                                <input type="date" id="jamaahPassportExpireDatePicker" class="date-picker-input">
                                <button type="button" class="date-toggle-btn" onclick="toggleDateInput('jamaahPassportExpireDate')">
                                    <span class="material-icons">date_range</span>
                                </button>
                            </div>
                            <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">Ketik manual (ddmmyyyy) atau klik kalender</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Upload Foto Paspor</label>
                        <input type="file" id="jamaahPassportImage" accept="image/*" onchange="previewPassportImage(event)">
                        <div id="passportPreview" style="margin-top: 10px; display: none;">
                            <img id="passportImg" style="width: 100px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid rgba(71, 85, 105, 0.4);">
                        </div>
                    </div>
                </div>

                <!-- Additional Documents Section -->
                <div class="section">
                    <h3 style="color: #4facfe; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">folder_shared</span>
                        Dokumen Tambahan
                    </h3>
                    
                    <div class="form-row">
                        <!-- KTP Upload -->
                        <div class="form-group">
                            <label>Upload KTP</label>
                            <div class="file-upload-container">
                                <input type="file" id="jamaahKtpImage" accept="image/*" onchange="previewAdditionalDocument(event, 'ktp')">
                                <div class="file-upload-label" onclick="document.getElementById('jamaahKtpImage').click()">
                                    <span class="material-icons">credit_card</span>
                                    <span>Pilih File KTP</span>
                                    <small>JPG, PNG (max 5MB)</small>
                                </div>
                                <div id="ktpPreview" class="document-preview" style="display: none;">
                                    <img id="ktpImg" class="preview-image">
                                    <div class="preview-actions">
                                        <button type="button" class="btn-preview" onclick="viewDocumentImage('ktp')">
                                            <span class="material-icons">visibility</span>
                                            Lihat
                                        </button>
                                        <button type="button" class="btn-preview btn-danger" onclick="removeDocument('ktp')">
                                            <span class="material-icons">delete</span>
                                            Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KK Upload -->
                        <div class="form-group">
                            <label>Upload Kartu Keluarga</label>
                            <div class="file-upload-container">
                                <input type="file" id="jamaahKkImage" accept="image/*" onchange="previewAdditionalDocument(event, 'kk')">
                                <div class="file-upload-label" onclick="document.getElementById('jamaahKkImage').click()">
                                    <span class="material-icons">family_restroom</span>
                                    <span>Pilih File KK</span>
                                    <small>JPG, PNG (max 5MB)</small>
                                </div>
                                <div id="kkPreview" class="document-preview" style="display: none;">
                                    <img id="kkImg" class="preview-image">
                                    <div class="preview-actions">
                                        <button type="button" class="btn-preview" onclick="viewDocumentImage('kk')">
                                            <span class="material-icons">visibility</span>
                                            Lihat
                                        </button>
                                        <button type="button" class="btn-preview btn-danger" onclick="removeDocument('kk')">
                                            <span class="material-icons">delete</span>
                                            Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Jamaah Photo -->
                    <div class="form-group">
                        <label>Upload Foto Jamaah</label>
                        <div class="file-upload-container">
                            <input type="file" id="jamaahPhoto" accept="image/*" onchange="previewAdditionalDocument(event, 'photo')">
                            <div class="file-upload-label" onclick="document.getElementById('jamaahPhoto').click()">
                                <span class="material-icons">person</span>
                                <span>Pilih Foto Jamaah</span>
                                <small>JPG, PNG (max 5MB) - Foto terbaru jamaah</small>
                            </div>
                            <div id="photoPreview" class="document-preview" style="display: none;">
                                <img id="photoImg" class="preview-image">
                                <div class="preview-actions">
                                    <button type="button" class="btn-preview" onclick="viewDocumentImage('photo')">
                                        <span class="material-icons">visibility</span>
                                        Lihat
                                    </button>
                                    <button type="button" class="btn-preview btn-danger" onclick="removeDocument('photo')">
                                        <span class="material-icons">delete</span>
                                        Hapus
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
                            Dokumen tambahan membantu verifikasi identitas jamaah. Pastikan foto jelas dan ukuran file tidak lebih dari 5MB.
                        </small>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('jamaahModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tambah/Edit Paket Umroh</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="savePackage(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Paket</label>
                        <input type="text" id="packageName" required>
                    </div>
                    <div class="form-group">
                        <label>Kode Paket</label>
                        <input type="text" id="packageCode" placeholder="Contoh: PKG001" required>
                    </div>
                    <div class="form-group">
                        <label>Harga (IDR)</label>
                        <input type="number" id="packagePrice" required>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Keberangkatan</label>
                        <input type="date" id="packageDeparture" required>
                    </div>
                    <div class="form-group">
                        <label>Durasi (Hari)</label>
                        <input type="number" id="packageDuration" required>
                    </div>
                    <div class="form-group">
                        <label>Kuota</label>
                        <input type="number" id="packageQuota" required>
                    </div>
                    <div class="form-group">
                        <label>Hotel Makkah</label>
                        <input type="text" id="packageMakkahHotel" required>
                    </div>
                    <div class="form-group">
                        <label>Hotel Madinah</label>
                        <input type="text" id="packageMadinahHotel" required>
                    </div>
                    <div class="form-group">
                        <label>Malam di Makkah</label>
                        <input type="number" id="packageMakkahNights" required>
                    </div>
                    <div class="form-group">
                        <label>Malam di Madinah</label>
                        <input type="number" id="packageMadinahNights" required>
                    </div>
                    <div class="form-group">
                        <label>Maskapai</label>
                        <input type="text" id="packageAirline" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="packageDescription" rows="3"></textarea>
                </div>

                <!-- Flight Details Section -->
                <div class="section">
                    <h3 style="color: #4facfe; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">flight</span>
                        Detail Penerbangan
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pesawat Pergi</label>
                            <input type="text" id="packageDepartFlightNumber" placeholder="Contoh: GA 892">
                        </div>
                        <div class="form-group">
                            <label>Pesawat Pulang</label>
                            <input type="text" id="packageReturnFlightNumber" placeholder="Contoh: GA 893">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Transit Pergi</label>
                            <input type="text" id="packageDepartTransit" placeholder="Contoh: Dubai (DXB) - 2 jam">
                        </div>
                        <div class="form-group">
                            <label>Transit Pulang</label>
                            <input type="text" id="packageReturnTransit" placeholder="Contoh: Dubai (DXB) - 3 jam">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Rute Lengkap</label>
                            <textarea id="packageFlightRoute" rows="2" placeholder="Jakarta - Dubai - Jeddah - Madinah (pulang via Jeddah - Dubai - Jakarta)"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Catatan Penerbangan</label>
                            <textarea id="packageFlightNotes" rows="2" placeholder="Bagasi 30kg, hand carry 7kg, seat request bisa dilakukan"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Facilities Section -->
                <div class="section">
                    <h3 style="color: #4facfe; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">star</span>
                        Fasilitas & Bonus
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="packageHighSpeedTrain" style="margin-right: 8px;">
                                Kereta Cepat Haramain (Makkah-Madinah)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="packageThaifTour" style="margin-right: 8px;">
                                Tour Thaif + Cable Car
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="packageKitProvided" style="margin-right: 8px;">
                                Perlengkapan Umroh (Koper, Tas, Mukena, dll)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="packageVisaHandling" style="margin-right: 8px;">
                                Pengurusan Visa Gratis
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Fasilitas Tambahan</label>
                        <textarea id="packageAdditionalFacilities" rows="3" placeholder="- Ziarah ke Gua Hira dan Jabal Nur&#10;- City Tour Madinah (Masjid Quba, Uhud)&#10;- Makan 3x sehari dengan menu Indonesia&#10;- Air Zamzam 5 liter per jamaah"></textarea>
                    </div>
                </div>

                <!-- Brochure Photos Section -->
                <div class="section">
                    <h3 style="color: #4facfe; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">photo_library</span>
                        Foto Brosur Paket (Maksimal 10 Foto)
                    </h3>
                    
                    <div class="brochure-upload-container">
                        <div class="brochure-upload-area" onclick="document.getElementById('packageBrochurePhotos').click()">
                            <span class="material-icons" style="font-size: 48px; color: #4facfe; margin-bottom: 10px;">add_photo_alternate</span>
                            <p style="color: #f1f5f9; margin-bottom: 5px;">Klik untuk upload foto brosur</p>
                            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">JPG, PNG (max 5MB per foto)</p>
                            <input type="file" id="packageBrochurePhotos" multiple accept="image/*" style="display: none;" onchange="handleBrochureUpload(event)">
                        </div>
                        
                        <div id="brochurePreviewContainer" class="brochure-preview-grid" style="display: none;">
                            <!-- Preview images will be added here -->
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <small style="color: rgba(255, 255, 255, 0.6); font-size: 11px;">
                                <span class="material-icons" style="font-size: 12px; vertical-align: middle;">info</span>
                                Upload foto hotel, makanan, transportasi, dan fasilitas paket untuk menarik jamaah
                            </small>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('packageModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Catat Pembayaran</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="savePayment(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Jamaah</label>
                        <select id="paymentJamaah" required>
                            <option value="">Pilih Jamaah</option>
                            <option value="1">Ahmad Fauzi - 1234567890123456</option>
                            <option value="2">Siti Aisyah - 1234567890123457</option>
                            <option value="3">Muhammad Rizki - 1234567890123458</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jumlah Pembayaran</label>
                        <input type="number" id="paymentAmount" required>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Pembayaran</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Metode Pembayaran</label>
                        <select id="paymentMethod" required>
                            <option value="">Pilih Metode</option>
                            <option value="transfer_bank">Transfer Bank</option>
                            <option value="cash">Cash</option>
                            <option value="credit_card">Kartu Kredit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bank</label>
                        <input type="text" id="paymentBank">
                    </div>
                    <div class="form-group">
                        <label>No. Referensi</label>
                        <input type="text" id="paymentReference">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Catatan</label>
                    <textarea id="paymentNotes" rows="2"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('paymentModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Buat Grup Keberangkatan</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveGroup(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Grup</label>
                        <input type="text" id="groupName" required>
                    </div>
                    <div class="form-group">
                        <label>Paket</label>
                        <select id="groupPackage" required>
                            <option value="">Pilih Paket</option>
                            <option value="1">Umroh Ramadhan 2024</option>
                            <option value="2">Umroh Plus Turki</option>
                            <option value="3">Umroh Keluarga</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Keberangkatan</label>
                        <input type="date" id="groupDeparture" required>
                    </div>
                    <div class="form-group">
                        <label>Maksimal Anggota</label>
                        <input type="number" id="groupMaxMembers" value="45" required>
                    </div>
                    <div class="form-group">
                        <label>No. Bus</label>
                        <input type="text" id="groupBusNumber">
                    </div>
                    <div class="form-group">
                        <label>Waktu Kumpul</label>
                        <input type="time" id="groupMeetingTime">
                    </div>
                    <div class="form-group">
                        <label>Status Grup</label>
                        <select id="groupStatus" required>
                            <option value="open">Open</option>
                            <option value="full">Full</option>
                            <option value="canceled">Canceled</option>
                            <option value="depart">Depart</option>
                            <option value="arrival">Arrival</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Tempat Kumpul</label>
                    <textarea id="groupMeetingPoint" rows="2"></textarea>
                </div>

                <!-- Flight Details Section -->
                <div class="section">
                    <h3 style="color: #4facfe; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">flight</span>
                        Detail Penerbangan
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Flight Berangkat</label>
                            <input type="text" id="groupDepartureFlight" placeholder="Contoh: EK 357">
                        </div>
                        <div class="form-group">
                            <label>Waktu Berangkat</label>
                            <input type="time" id="groupDepartureTime">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Flight Pulang</label>
                            <input type="text" id="groupReturnFlight" placeholder="Contoh: EK 362">
                        </div>
                        <div class="form-group">
                            <label>Waktu Pulang</label>
                            <input type="time" id="groupReturnTime">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Info Transit</label>
                            <input type="text" id="groupTransitInfo" placeholder="Contoh: Dubai (DXB) - 2 jam">
                        </div>
                        <div class="form-group">
                            <label>Rute Penerbangan</label>
                            <input type="text" id="groupFlightRoute" placeholder="Contoh: CGK - DXB - JED">
                        </div>
                    </div>
                </div>

                <!-- Staff Information Section -->
                <div class="section">
                    <h3 style="color: #4facfe; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">person</span>
                        Tim Pembimbing
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Tour Leader</label>
                            <input type="text" id="groupTourLeaderName" placeholder="Contoh: Ustadz Ahmad Rahman">
                        </div>
                        <div class="form-group">
                            <label>No. HP Tour Leader</label>
                            <input type="tel" id="groupTourLeaderPhone" placeholder="081234567890">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pengalaman Tour Leader</label>
                            <input type="text" id="groupTourLeaderExperience" placeholder="Contoh: 15 tahun">
                        </div>
                        <div class="form-group">
                            <label>Bahasa Tour Leader</label>
                            <input type="text" id="groupTourLeaderLanguages" placeholder="Indonesia, Arab, English">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Muthawif</label>
                            <input type="text" id="groupMuthawifName" placeholder="Contoh: Sheikh Abdullah Al-Harami">
                        </div>
                        <div class="form-group">
                            <label>No. HP Muthawif</label>
                            <input type="tel" id="groupMuthawifPhone" placeholder="+966501234567">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pengalaman Muthawif</label>
                            <input type="text" id="groupMuthawifExperience" placeholder="Contoh: 20 tahun">
                        </div>
                        <div class="form-group">
                            <label>Spesialisasi Muthawif</label>
                            <input type="text" id="groupMuthawifSpecialization" placeholder="Sejarah Islam & Manasik Haji/Umroh">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Buat Grup
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('groupModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- COA Modal -->
    <div id="coaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tambah Akun (Chart of Accounts)</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveCOA(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Kode Akun</label>
                        <input type="text" id="coaCode" placeholder="Contoh: 1-10001" required>
                    </div>
                    <div class="form-group">
                        <label>Nama Akun</label>
                        <input type="text" id="coaName" placeholder="Contoh: Kas" required>
                    </div>
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="coaCategory" required onchange="updateNormalBalance()">
                            <option value="">Pilih Kategori</option>
                            <option value="asset">Aset</option>
                            <option value="liability">Kewajiban</option>
                            <option value="equity">Modal</option>
                            <option value="revenue">Pendapatan</option>
                            <option value="expense">Beban</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Saldo Normal</label>
                        <input type="text" id="coaNormalBalance" readonly>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('coaModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Journal Entry Modal -->
    <div id="journalModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Input Jurnal Umum</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveJournal(event)">
                <div class="form-group">
                    <label>Tanggal Transaksi</label>
                    <input type="date" id="journalDate" required>
                </div>
                
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="journalDescription" rows="2" placeholder="Deskripsi transaksi" required></textarea>
                </div>
                
                <!-- Journal Lines -->
                <div class="section">
                    <h4 style="color: #4facfe;">Detail Jurnal</h4>
                    <div id="journalLines">
                        <!-- Line 1 -->
                        <div class="journal-line" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select class="form-control" style="flex: 2;" required>
                                <option value="">Pilih Akun</option>
                            </select>
                            <input type="number" class="form-control" placeholder="Debit" style="flex: 1;">
                            <input type="number" class="form-control" placeholder="Kredit" style="flex: 1;">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeJournalLine(this)">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                        <!-- Line 2 -->
                        <div class="journal-line" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select class="form-control" style="flex: 2;" required>
                                <option value="">Pilih Akun</option>
                            </select>
                            <input type="number" class="form-control" placeholder="Debit" style="flex: 1;">
                            <input type="number" class="form-control" placeholder="Kredit" style="flex: 1;">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeJournalLine(this)">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-sm" onclick="addJournalLine()">
                        <span class="material-icons">add</span>
                        Tambah Baris
                    </button>
                    
                    <!-- Balance Check -->
                    <div style="margin-top: 15px; padding: 10px; background: rgba(30, 41, 59, 0.5); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total Debit: <span id="totalDebit">Rp 0</span></span>
                            <span>Total Kredit: <span id="totalCredit">Rp 0</span></span>
                            <span id="balanceStatus" style="font-weight: bold;">Tidak Balance</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="saveJournalBtn" disabled>
                        <span class="material-icons">save</span>
                        Simpan Jurnal
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('journalModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Input Pengeluaran</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveExpense(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label>Kategori Pengeluaran</label>
                        <select id="expenseCategory" required>
                            <option value="">Pilih Kategori</option>
                            <option value="hotel">Hotel</option>
                            <option value="flight">Tiket Pesawat</option>
                            <option value="visa">Visa</option>
                            <option value="transport">Transportasi</option>
                            <option value="meal">Makan</option>
                            <option value="guide">Guide/Muthawif</option>
                            <option value="admin">Administrasi</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jumlah</label>
                        <input type="number" id="expenseAmount" required>
                    </div>
                    <div class="form-group">
                        <label>Metode Pembayaran</label>
                        <select id="expenseMethod" required>
                            <option value="">Pilih Metode</option>
                            <option value="cash">Cash</option>
                            <option value="transfer">Transfer Bank</option>
                            <option value="credit_card">Kartu Kredit</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Vendor/Penerima</label>
                    <input type="text" id="expenseVendor" placeholder="Nama vendor atau penerima" required>
                </div>
                
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="expenseDescription" rows="3" placeholder="Detail pengeluaran"></textarea>
                </div>
                
                <div class="form-group">
                    <label>No. Referensi/Invoice</label>
                    <input type="text" id="expenseReference" placeholder="Nomor invoice atau referensi">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('expenseModal')">
                        <span class="material-icons">cancel</span>
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Room Management Modal -->
    <div id="roomModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h3 id="roomModalTitle">Room List - Grup Ramadhan A</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <div class="room-management">
                <!-- Room Allocation Header -->
                <div class="room-allocation-header">
                    <div>
                        <h4 style="color: #f8fafc; margin: 0;">Pengaturan Kamar Otomatis</h4>
                        <p style="color: rgba(255, 255, 255, 0.7); margin: 4px 0 0 0; font-size: 12px;">Sistem akan mengalokasikan kamar berdasarkan preferensi jamaah</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="autoAllocateRooms()">
                            <span class="material-icons">auto_awesome</span>
                            Auto Allocate
                        </button>
                        <button class="btn btn-warning" onclick="clearAllRooms()">
                            <span class="material-icons">clear_all</span>
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Room Statistics -->
                <div class="room-stats">
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="totalRooms">0</div>
                        <div class="room-stat-label">Total Kamar</div>
                    </div>
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="occupiedRooms">0</div>
                        <div class="room-stat-label">Kamar Terisi</div>
                    </div>
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="assignedJamaah">0</div>
                        <div class="room-stat-label">Jamaah Ditempatkan</div>
                    </div>
                    <div class="room-stat-item">
                        <div class="room-stat-number" id="unassignedJamaah">0</div>
                        <div class="room-stat-label">Belum Ditempatkan</div>
                    </div>
                </div>

                <!-- Allocation Strategy -->
                <div class="allocation-controls">
                    <div class="allocation-option active" data-strategy="auto" onclick="selectAllocationStrategy('auto')">
                        <div class="allocation-icon material-icons">auto_awesome</div>
                        <div class="allocation-title">Auto Smart</div>
                        <div class="allocation-desc">Sistem otomatis mengalokasikan berdasarkan preferensi dan gender</div>
                    </div>
                    <div class="allocation-option" data-strategy="preference" onclick="selectAllocationStrategy('preference')">
                        <div class="allocation-icon material-icons">tune</div>
                        <div class="allocation-title">By Preference</div>
                        <div class="allocation-desc">Prioritaskan preferensi kamar yang dipilih jamaah</div>
                    </div>
                    <div class="allocation-option" data-strategy="family" onclick="selectAllocationStrategy('family')">
                        <div class="allocation-icon material-icons">family_restroom</div>
                        <div class="allocation-title">Family First</div>
                        <div class="allocation-desc">Kelompokkan anggota keluarga dalam kamar yang sama</div>
                    </div>
                    <div class="allocation-option" data-strategy="manual" onclick="selectAllocationStrategy('manual')">
                        <div class="allocation-icon material-icons">pan_tool</div>
                        <div class="allocation-title">Manual</div>
                        <div class="allocation-desc">Atur penempatan kamar secara manual</div>
                    </div>
                </div>

                <!-- Unassigned Jamaah -->
                <div class="unassigned-jamaah" id="unassignedSection">
                    <div class="unassigned-header">
                        <span class="material-icons">person_off</span>
                        Jamaah Belum Ditempatkan (<span id="unassignedCount">0</span>)
                    </div>
                    <div class="unassigned-list" id="unassignedList">
                        <!-- Unassigned jamaah will be populated here -->
                    </div>
                </div>

                <!-- Room Grid -->
                <div class="room-grid" id="roomGrid">
                    <!-- Room cards will be populated here -->
                </div>

                <!-- Room Actions -->
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(71, 85, 105, 0.3);">
                    <button class="btn btn-success" onclick="exportRoomList()">
                        <span class="material-icons">download</span>
                        Export Room List
                    </button>
                    <button class="btn btn-primary" onclick="saveRoomAssignments()">
                        <span class="material-icons">save</span>
                        Simpan Pengaturan
                    </button>
                    <button class="btn btn-danger" onclick="closeModal('roomModal')">
                        <span class="material-icons">close</span>
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Input Lead Baru</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveLead(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="leadName">Nama <span class="required">*</span></label>
                        <input type="text" id="leadName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadPhone">No. WhatsApp <span class="required">*</span></label>
                        <input type="tel" id="leadPhone" placeholder="081234567890" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadSource">Source <span class="required">*</span></label>
                        <select id="leadSource" required>
                            <option value="">Pilih Source</option>
                            <option value="fb_ads">Facebook Ads</option>
                            <option value="google_ads">Google Ads</option>
                            <option value="instagram">Instagram</option>
                            <option value="referral">Referral</option>
                            <option value="website">Website</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadMarketer">Marketer <span class="required">*</span></label>
                        <select id="leadMarketer" required>
                            <option value="">Pilih Marketer</option>
                            <option value="1">Ani - Marketing 1</option>
                            <option value="2">Budi - Marketing 2</option>
                            <option value="3">Citra - Marketing 3</option>
                            <option value="4">Dodi - Marketing 4</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadBudget">Budget Range</label>
                        <select id="leadBudget">
                            <option value="">Belum Diketahui</option>
                            <option value="low">< 15 Juta</option>
                            <option value="medium">15-20 Juta</option>
                            <option value="high">> 20 Juta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="leadPackageInterest">Minat Paket</label>
                        <select id="leadPackageInterest">
                            <option value="">Belum Tahu</option>
                            <option value="1">Umroh Ramadhan</option>
                            <option value="2">Umroh Plus</option>
                            <option value="3">Umroh Keluarga</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="leadNotes">Catatan Awal</label>
                    <textarea id="leadNotes" rows="3" placeholder="Catatan dari percakapan awal..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Tags</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="leadTags" value="urgent">
                            <span>Urgent</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="leadTags" value="family">
                            <span>Keluarga</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="leadTags" value="first_time">
                            <span>First Timer</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="leadTags" value="repeat">
                            <span>Repeat Customer</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leadModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Broadcast Modal -->
    <div id="broadcastModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>WhatsApp Broadcast</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="sendBroadcast(event)">
                <div class="form-group">
                    <label>Target Audience <span class="required">*</span></label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="broadcastTarget" value="all_leads">
                            <span>Semua Leads (${leadData?.length || 0})</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="broadcastTarget" value="hot_leads">
                            <span>Hot Leads Only</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="broadcastTarget" value="new_leads">
                            <span>New Leads (< 7 hari)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="broadcastTarget" value="interested">
                            <span>Status Interested</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="broadcastTarget" value="no_response">
                            <span>Belum Ada Response</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="broadcastTarget" value="specific_package">
                            <span>Minat Paket Tertentu</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="broadcastTemplate">Template Pesan</label>
                    <select id="broadcastTemplate" onchange="loadMessageTemplate()">
                        <option value="">Custom Message</option>
                        <option value="promo">Promo Terbaru</option>
                        <option value="reminder">Follow-up Reminder</option>
                        <option value="info">Info Keberangkatan</option>
                        <option value="greeting">Salam & Perkenalan</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="broadcastMessage">Pesan <span class="required">*</span></label>
                    <textarea id="broadcastMessage" rows="6" required placeholder="Assalamualaikum {name},

Kami dari Vauza Tamma ingin menginformasikan...

Gunakan {name} untuk nama, {package} untuk paket interest"></textarea>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="broadcastSchedule">Jadwal Kirim</label>
                        <select id="broadcastSchedule">
                            <option value="now">Kirim Sekarang</option>
                            <option value="scheduled">Jadwalkan</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="scheduleTimeGroup" style="display: none;">
                        <label for="broadcastTime">Waktu Kirim</label>
                        <input type="datetime-local" id="broadcastTime">
                    </div>
                </div>
                
                <div style="background: rgba(251, 191, 36, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #fbbf24; font-size: 14px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">info</span>
                        Estimasi <span id="broadcastCount">0</span> pesan akan dikirim
                    </p>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('broadcastModal')">Batal</button>
                    <button type="submit" class="btn btn-success">
                        <span class="material-icons">send</span>
                        Kirim Broadcast
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lead Detail Modal -->
    <div id="leadDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Detail Lead</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <div style="padding: 20px;">
                <!-- Lead Info -->
                <div class="glass-card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h4 id="leadDetailName" style="margin: 0;">-</h4>
                            <p id="leadDetailPhone" style="margin: 5px 0; color: #cbd5e1;">-</p>
                        </div>
                        <div style="text-align: right;">
                            <div id="leadDetailTemp" style="font-size: 24px;">-</div>
                            <div id="leadDetailScore" class="lead-score">-</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <small style="color: #94a3b8;">Source</small>
                            <p id="leadDetailSource">-</p>
                        </div>
                        <div>
                            <small style="color: #94a3b8;">Status</small>
                            <p id="leadDetailStatus">-</p>
                        </div>
                        <div>
                            <small style="color: #94a3b8;">Marketer</small>
                            <p id="leadDetailMarketer">-</p>
                        </div>
                        <div>
                            <small style="color: #94a3b8;">Created</small>
                            <p id="leadDetailCreated">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Communication Timeline -->
                <div class="glass-card">
                    <h4 style="margin-bottom: 20px;">Timeline Komunikasi</h4>
                    <div class="timeline-container" id="leadTimeline">
                        <!-- Timeline items will be populated here -->
                    </div>
                    
                    <!-- Add Note Form -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(71, 85, 105, 0.3);">
                        <form onsubmit="addLeadNote(event)">
                            <input type="hidden" id="leadDetailId">
                            <div class="form-group">
                                <label>Tambah Catatan</label>
                                <textarea id="leadNewNote" rows="3" placeholder="Update komunikasi dengan lead..." required></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="leadUpdateStatus" style="flex: 1;">
                                    <option value="">Update Status (Optional)</option>
                                    <option value="contacted">Contacted</option>
                                    <option value="interested">Interested</option>
                                    <option value="not_interested">Not Interested</option>
                                    <option value="closing">Closing</option>
                                    <option value="converted">Converted</option>
                                </select>
                                <button type="submit" class="btn btn-primary">
                                    <span class="material-icons">add</span>
                                    Tambah Note
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Automation Rule Modal -->
    <div id="automationRuleModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Automation Rule</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveAutomationRule(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="ruleName">Nama Rule <span class="required">*</span></label>
                        <input type="text" id="ruleName" required placeholder="Payment Reminder H-7">
                    </div>
                    
                    <div class="form-group">
                        <label for="ruleStatus">Status</label>
                        <select id="ruleStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ruleTrigger">Trigger Type <span class="required">*</span></label>
                    <select id="ruleTrigger" required onchange="updateTriggerOptions()">
                        <option value="">Pilih Trigger</option>
                        <option value="time_based">Time Based (Daily/Weekly)</option>
                        <option value="date_based">Date Based (Days before/after)</option>
                        <option value="status_based">Status Change</option>
                        <option value="payment_based">Payment Related</option>
                        <option value="document_based">Document Related</option>
                    </select>
                </div>

                <div id="triggerOptions" style="display: none;">
                    <!-- Dynamic trigger options will appear here -->
                </div>

                <div class="form-group">
                    <label for="ruleConditions">Conditions (JavaScript Expression)</label>
                    <textarea id="ruleConditions" rows="3" placeholder="jamaah.total_paid < jamaah.total_amount && daysUntilDeparture <= 7"></textarea>
                    <small style="color: #94a3b8;">Available variables: jamaah, daysUntilDeparture, daysAfterRegistration</small>
                </div>

                <div class="form-group">
                    <label for="ruleTemplate">Message Template <span class="required">*</span></label>
                    <select id="ruleTemplate" required>
                        <option value="">Pilih Template</option>
                        <!-- Templates will be populated dynamically -->
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="ruleDelay">Delay (minutes)</label>
                        <input type="number" id="ruleDelay" min="0" value="0" placeholder="30">
                        <small style="color: #94a3b8;">Delay sebelum mengirim pesan</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="rulePriority">Priority</label>
                        <select id="rulePriority">
                            <option value="low">Low</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Sending Time Restrictions</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label for="ruleStartTime">Start Time</label>
                            <input type="time" id="ruleStartTime" value="08:00">
                        </div>
                        <div>
                            <label for="ruleEndTime">End Time</label>
                            <input type="time" id="ruleEndTime" value="20:00">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Options</label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="ruleSkipWeekends">
                            <span>Skip Weekends</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="ruleOncePerJamaah">
                            <span>Once per Jamaah</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="ruleRespectBlacklist" checked>
                            <span>Respect Blacklist</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('automationRuleModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Rule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Template Modal -->
    <div id="messageTemplateModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Message Template</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <form onsubmit="saveMessageTemplate(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="templateName">Nama Template <span class="required">*</span></label>
                        <input type="text" id="templateName" required placeholder="Payment Reminder">
                    </div>
                    
                    <div class="form-group">
                        <label for="templateCategory">Kategori</label>
                        <select id="templateCategory">
                            <option value="payment">Payment</option>
                            <option value="document">Document</option>
                            <option value="departure">Departure</option>
                            <option value="general">General</option>
                            <option value="greeting">Greeting</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="templateMessage">Pesan <span class="required">*</span></label>
                    <textarea id="templateMessage" rows="6" required placeholder="Assalamualaikum {name},

Kami ingin mengingatkan bahwa masih ada sisa pembayaran sebesar Rp {remaining_amount} untuk paket umroh {package}.

Mohon segera melunasi sebelum tanggal keberangkatan {departure_date}.

Terima kasih."></textarea>
                </div>

                <div class="form-group">
                    <label>Available Variables</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('name')">
                            {name}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('phone')">
                            {phone}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('package')">
                            {package}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('total_amount')">
                            {total_amount}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('remaining_amount')">
                            {remaining_amount}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('departure_date')">
                            {departure_date}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('days_left')">
                            {days_left}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('registration_number')">
                            {registration_number}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="insertVariable('group_name')">
                            {group_name}
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="templateMedia">Media Attachment (Optional)</label>
                    <input type="file" id="templateMedia" accept="image/*,application/pdf">
                    <small style="color: #94a3b8;">Supported: Images (JPG, PNG) and PDF files</small>
                </div>

                <div class="form-group">
                    <label>Template Preview</label>
                    <div id="templatePreview" style="padding: 15px; background: rgba(30, 41, 59, 0.4); border-radius: 8px; min-height: 100px; color: #cbd5e1;">
                        Preview akan muncul di sini...
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('messageTemplateModal')">Batal</button>
                    <button type="button" class="btn btn-warning" onclick="previewTemplate()">Preview</button>
                    <button type="submit" class="btn btn-primary">Simpan Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Queue Monitor Modal -->
    <div id="queueMonitorModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Message Queue Monitor</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <div style="padding: 20px;">
                <!-- Queue Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;" id="queuePending">0</div>
                        <div style="font-size: 12px; color: #94a3b8;">Pending</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #fbbf24;" id="queueSending">0</div>
                        <div style="font-size: 12px; color: #94a3b8;">Sending</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #22c55e;" id="queueSent">0</div>
                        <div style="font-size: 12px; color: #94a3b8;">Sent</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="queueFailed">0</div>
                        <div style="font-size: 12px; color: #94a3b8;">Failed</div>
                    </div>
                </div>

                <!-- Queue Actions -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="processQueue()">
                        <span class="material-icons">play_arrow</span>
                        Process Queue
                    </button>
                    <button class="btn btn-warning" onclick="pauseQueue()">
                        <span class="material-icons">pause</span>
                        Pause Queue
                    </button>
                    <button class="btn btn-danger" onclick="clearFailedQueue()">
                        <span class="material-icons">clear</span>
                        Clear Failed
                    </button>
                    <button class="btn btn-success" onclick="retryFailedQueue()">
                        <span class="material-icons">refresh</span>
                        Retry Failed
                    </button>
                </div>

                <!-- Queue Table -->
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Jamaah</th>
                                <th>Phone</th>
                                <th>Template</th>
                                <th>Scheduled</th>
                                <th>Status</th>
                                <th>Attempts</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="queueMonitorTableBody">
                            <!-- Queue items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample Data
        let jamaahData = [
            // Group 1 - Grup Ramadhan A (45 jamaah)
            {
                id: 1,
                name: "Ahmad Fauzi",
                nik: "1234567890123456",
                phone: "081234567890",
                email: "ahmad@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_paid: 15000000,
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "15051985",
                birth_place: "Jakarta",
                gender: "male",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzM0MTU1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2Y4ZmFmYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkFobWFkIEZhdXppPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNzAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiNjYmQ1ZTEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5QYXNwb3IgSW5kb25lc2lhPC90ZXh0Pjwvc3ZnPg==",
                passport_number: "A1234567",
                passport_name: "Ahmad Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "01012020",
                passport_expire_date: "01012030",
                provinsi: "DKI Jakarta",
                marital_status: "married",
                education: "s1",
                occupation: "Pegawai Swasta",
                emergency_contact_name: "Siti Fauzi",
                emergency_contact_phone: "081234567891",
                emergency_contact_relation: "Istri",
                mahram_name: "Sendiri",
                medical_conditions: "",
                medications: "",
                allergies: "",
                mobility_assistance: false,
                main_family_id: 1,
                family_role: "kepala_keluarga",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400001"
            },
            // Family 1 - Ahmad Fauzi's family (4 people - quad room)
            {
                id: 2,
                name: "Siti Fauzi",
                nik: "1234567890123457",
                phone: "081234567891",
                email: "siti.fauzi@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "10081987",
                birth_place: "Jakarta",
                gender: "female",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_number: "B2345678",
                passport_name: "Siti Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "15022020",
                passport_expire_date: "15022030",
                provinsi: "DKI Jakarta",
                marital_status: "married",
                education: "sma",
                occupation: "Ibu Rumah Tangga",
                emergency_contact_name: "Ahmad Fauzi",
                emergency_contact_phone: "081234567890",
                emergency_contact_relation: "Suami",
                mahram_name: "Ahmad Fauzi",
                main_family_id: 1,
                family_role: "istri",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400002"
            },
            {
                id: 3,
                name: "Fatimah Fauzi",
                nik: "1234567890123458",
                phone: "081234567892",
                email: "fatimah.fauzi@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 13000000,
                amount_paid: 13000000,
                birth_date: "05122010",
                birth_place: "Jakarta",
                gender: "female",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_number: "C3456789",
                passport_name: "Fatimah Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "20032022",
                passport_expire_date: "20032032",
                provinsi: "DKI Jakarta",
                marital_status: "single",
                education: "smp",
                occupation: "Pelajar",
                emergency_contact_name: "Ahmad Fauzi",
                emergency_contact_phone: "081234567890",
                emergency_contact_relation: "Ayah",
                mahram_name: "Ahmad Fauzi",
                main_family_id: 1,
                family_role: "anak",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400003"
            },
            {
                id: 4,
                name: "Muhammad Fauzi",
                nik: "1234567890123459",
                phone: "081234567893",
                email: "muhammad.fauzi@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 13000000,
                amount_paid: 13000000,
                birth_date: "15062012",
                birth_place: "Jakarta",
                gender: "male",
                address: "Jl. Merdeka No. 123, Jakarta",
                passport_number: "D4567890",
                passport_name: "Muhammad Fauzi",
                passport_city: "Jakarta",
                passport_issue_date: "10042022",
                passport_expire_date: "10042032",
                provinsi: "DKI Jakarta",
                marital_status: "single",
                education: "sd",
                occupation: "Pelajar",
                emergency_contact_name: "Ahmad Fauzi",
                emergency_contact_phone: "081234567890",
                emergency_contact_relation: "Ayah",
                mahram_name: "Ahmad Fauzi",
                main_family_id: 1,
                family_role: "anak",
                room_preference: "quad",
                family_room_request: true,
                registration_number: "UMR202400004"
            },
            // Family 2 - Budi's family (3 people - triple room)
            {
                id: 5,
                name: "Budi Santoso",
                nik: "1234567890123460",
                phone: "081234567894",
                email: "budi.santoso@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "20031982",
                birth_place: "Bandung",
                gender: "male",
                address: "Jl. Sudirman No. 456, Bandung",
                passport_number: "E5678901",
                passport_name: "Budi Santoso",
                passport_city: "Bandung",
                passport_issue_date: "05052021",
                passport_expire_date: "05052031",
                provinsi: "Jawa Barat",
                marital_status: "married",
                education: "s1",
                occupation: "Guru",
                emergency_contact_name: "Rina Santoso",
                emergency_contact_phone: "081234567895",
                emergency_contact_relation: "Istri",
                mahram_name: "Sendiri",
                main_family_id: 2,
                family_role: "kepala_keluarga",
                room_preference: "triple",
                family_room_request: true,
                registration_number: "UMR202400005"
            },
            {
                id: 6,
                name: "Rina Santoso",
                nik: "1234567890123461",
                phone: "081234567895",
                email: "rina.santoso@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "12111985",
                birth_place: "Bandung",
                gender: "female",
                address: "Jl. Sudirman No. 456, Bandung",
                passport_number: "F6789012",
                passport_name: "Rina Santoso",
                passport_city: "Bandung",
                passport_issue_date: "10062021",
                passport_expire_date: "10062031",
                provinsi: "Jawa Barat",
                marital_status: "married",
                education: "d3",
                occupation: "Perawat",
                emergency_contact_name: "Budi Santoso",
                emergency_contact_phone: "081234567894",
                emergency_contact_relation: "Suami",
                mahram_name: "Budi Santoso",
                main_family_id: 2,
                family_role: "istri",
                room_preference: "triple",
                family_room_request: true,
                registration_number: "UMR202400006"
            },
            {
                id: 7,
                name: "Aditya Santoso",
                nik: "1234567890123462",
                phone: "081234567896",
                email: "aditya.santoso@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 13000000,
                amount_paid: 13000000,
                birth_date: "08092008",
                birth_place: "Bandung",
                gender: "male",
                address: "Jl. Sudirman No. 456, Bandung",
                passport_number: "G7890123",
                passport_name: "Aditya Santoso",
                passport_city: "Bandung",
                passport_issue_date: "15072021",
                passport_expire_date: "15072031",
                provinsi: "Jawa Barat",
                marital_status: "single",
                education: "sma",
                occupation: "Pelajar",
                emergency_contact_name: "Budi Santoso",
                emergency_contact_phone: "081234567894",
                emergency_contact_relation: "Ayah",
                mahram_name: "Budi Santoso",
                main_family_id: 2,
                family_role: "anak",
                room_preference: "triple",
                family_room_request: true,
                registration_number: "UMR202400007"
            },
            // Individual jamaah (double rooms)
            {
                id: 8,
                name: "Hasan Ibrahim",
                nik: "1234567890123463",
                phone: "081234567897",
                email: "hasan.ibrahim@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "25071975",
                birth_place: "Surabaya",
                gender: "male",
                address: "Jl. Pahlawan No. 789, Surabaya",
                passport_number: "H8901234",
                passport_name: "Hasan Ibrahim",
                passport_city: "Surabaya",
                passport_issue_date: "01012020",
                passport_expire_date: "01012030",
                provinsi: "Jawa Timur",
                marital_status: "widowed",
                education: "s1",
                occupation: "Wiraswasta",
                emergency_contact_name: "Ali Ibrahim",
                emergency_contact_phone: "081234567898",
                emergency_contact_relation: "Anak",
                mahram_name: "Sendiri",
                main_family_id: 3,
                family_role: "kepala_keluarga",
                room_preference: "double",
                family_room_request: false,
                registration_number: "UMR202400008"
            },
            {
                id: 9,
                name: "Abdullah Rahman",
                nik: "1234567890123464",
                phone: "081234567899",
                email: "abdullah.rahman@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "partial",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 10000000,
                birth_date: "18041980",
                birth_place: "Medan",
                gender: "male",
                address: "Jl. Gatot Subroto No. 321, Medan",
                passport_number: "I9012345",
                passport_name: "Abdullah Rahman",
                passport_city: "Medan",
                passport_issue_date: "12122019",
                passport_expire_date: "12122029",
                provinsi: "Sumatera Utara",
                marital_status: "single",
                education: "s2",
                occupation: "Dosen",
                emergency_contact_name: "Fatimah Rahman",
                emergency_contact_phone: "081234567900",
                emergency_contact_relation: "Ibu",
                mahram_name: "Sendiri",
                main_family_id: 4,
                family_role: "kepala_keluarga",
                room_preference: "double",
                family_room_request: false,
                registration_number: "UMR202400009"
            },
            {
                id: 10,
                name: "Yusuf Hakim",
                nik: "1234567890123465",
                phone: "081234567901",
                email: "yusuf.hakim@email.com",
                package: "Umroh Ramadhan 2024",
                package_id: 1,
                group_id: 1,
                status: "verified",
                payment_status: "paid",
                document_status: "approved",
                visa_status: "approved",
                total_amount: 15000000,
                amount_paid: 15000000,
                birth_date: "03021990",
                birth_place: "Yogyakarta",
                gender: "male",
                address: "Jl. Malioboro No. 111, Yogyakarta",
                passport_number: "J0123456",
                passport_name: "Yusuf Hakim",
                passport_city: "Yogyakarta",
                passport_issue_date: "20032021",
                passport_expire_date: "20032031",
                provinsi: "DI Yogyakarta",
                marital_status: "married",
                education: "s1",
                occupation: "Pegawai Negeri",
                emergency_contact_name: "Zainab Hakim",
                emergency_contact_phone: "081234567902",
                emergency_contact_relation: "Istri",
                mahram_name: "Sendiri",
                main_family_id: 5,
                family_role: "kepala_keluarga",
                room_preference: "double",
                family_room_request: false,
                registration_number: "UMR202400010"
            }
            // Total so far: 10 jamaah for Group 1
            // Add more jamaah to reach 42 members for Group 1...
        ];

        let packageData = [
            {
                id: 1,
                name: "Umroh Ramadhan 2024",
                code: "PKG001",
                price: 25000000,
                departure_date: "2024-03-15",
                duration: 14,
                quota: 45,
                booked: 10,
                makkah_hotel: "Hilton Makkah Convention",
                madinah_hotel: "Pullman Zamzam Madinah",
                makkah_nights: 7,
                madinah_nights: 7,
                airline: "Emirates",
                airline_code: "EK",
                description: "Paket umroh spesial bulan Ramadhan dengan fasilitas premium",
                flight_details: {
                    flight_numbers: "EK 357 / EK 362",
                    transit_info: "Dubai (DXB) - 2 jam",
                    route: "CGK - DXB - JED",
                    notes: "Bagasi 30kg, meal halal tersedia"
                },
                facilities: {
                    haramain_train: true,
                    thaif_tour: true,
                    equipment_kit: true,
                    visa_handling: true
                },
                brochure_photos: [
                    {
                        id: 'bro1',
                        name: 'Masjid Haram View',
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNDMzNDU1Ii8+PHRleHQgeD0iNTAlIiB5PSI0MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2Y4ZmFmYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1hc2ppZCBIYXJhbSBWaWV3PC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNjAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiNjYmQ1ZTEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5QYWtldCBSYW1hZGhhbjwvdGV4dD48L3N2Zz4='
                    }
                ]
            },
            {
                id: 2,
                name: "Umroh Plus Turki",
                code: "PKG002",
                price: 35000000,
                departure_date: "2024-04-20",
                duration: 21,
                quota: 30,
                booked: 18,
                makkah_hotel: "Swissotel Makkah",
                madinah_hotel: "Anwar Al Madinah Movenpick",
                makkah_nights: 10,
                madinah_nights: 8,
                airline: "Turkish Airlines",
                airline_code: "TK",
                description: "Paket umroh dengan ekstensi wisata Istanbul, Turki",
                flight_details: {
                    flight_numbers: "TK 57 / TK 141",
                    transit_info: "Istanbul (IST) - 4 jam",
                    route: "CGK - IST - JED",
                    notes: "Termasuk city tour Istanbul 3 hari"
                },
                facilities: {
                    haramain_train: false,
                    thaif_tour: true,
                    equipment_kit: true,
                    visa_handling: true
                }
            },
            {
                id: 3,
                name: "Umroh Keluarga",
                code: "PKG003",
                price: 22000000,
                departure_date: "2024-05-10",
                duration: 12,
                quota: 50,
                booked: 25,
                makkah_hotel: "Fairmont Makkah",
                madinah_hotel: "Dar Al Iman InterContinental",
                makkah_nights: 6,
                madinah_nights: 6,
                airline: "Saudi Airlines",
                airline_code: "SV",
                description: "Paket umroh khusus keluarga dengan fasilitas ramah anak",
                facilities: {
                    haramain_train: false,
                    thaif_tour: false,
                    equipment_kit: true,
                    visa_handling: true
                }
            }
        ];

        let paymentData = [
            {
                id: 1,
                jamaah_id: 1,
                jamaah_name: "Ahmad Fauzi",
                jamaah_phone: "081234567890",
                package: "Umroh Ramadhan 2024",
                amount: 15000000,
                date: "2024-01-15",
                method: "Transfer Bank",
                bank: "BCA",
                reference: "TRF20240115001",
                status: "verified"
            },
            {
                id: 2,
                jamaah_id: 1,
                jamaah_name: "Ahmad Fauzi",
                jamaah_phone: "081234567890",
                package: "Umroh Ramadhan 2024",
                amount: 10000000,
                date: "2024-02-01",
                method: "Transfer Bank",
                bank: "BCA",
                reference: "TRF20240201001",
                status: "verified"
            },
            {
                id: 3,
                jamaah_id: 2,
                jamaah_name: "Siti Aisyah",
                jamaah_phone: "081234567891",
                package: "Umroh Plus Turki",
                amount: 20000000,
                date: "2024-01-20",
                method: "Transfer Bank",
                bank: "Mandiri",
                reference: "TRF20240120001",
                status: "verified"
            },
            {
                id: 4,
                jamaah_id: 2,
                jamaah_name: "Siti Aisyah",
                jamaah_phone: "081234567891",
                package: "Umroh Plus Turki",
                amount: 5000000,
                date: "2024-02-10",
                method: "Cash",
                bank: "-",
                reference: "CASH20240210001",
                status: "pending"
            }
        ];

        let documentData = [
            {
                id: 1,
                jamaah_name: "Ahmad Fauzi",
                type: "Paspor",
                filename: "paspor_ahmad.pdf",
                upload_date: "2024-01-10",
                status: "verified"
            },
            {
                id: 2,
                jamaah_name: "Siti Aisyah",
                type: "KTP",
                filename: "ktp_siti.jpg",
                upload_date: "2024-01-12",
                status: "pending"
            }
        ];

        let groupData = [
            {
                id: 1,
                name: "Grup Ramadhan A",
                package: "Umroh Ramadhan 2024",
                departure_date: "2024-03-15",
                max_members: 45,
                current_members: 10,
                bus_number: "BUS001",
                meeting_time: "04:00",
                meeting_point: "Masjid Al-Ikhlas, Jakarta Pusat",
                status: "open",
                flight_details: {
                    departure_flight: "EK 357",
                    departure_date: "2024-03-15",
                    departure_time: "08:30",
                    return_flight: "EK 362",
                    return_date: "2024-03-28",
                    return_time: "14:20",
                    transit_info: "Dubai (DXB) - 2 jam",
                    route: "CGK - DXB - JED"
                },
                tour_leader: {
                    name: "Ustadz Ahmad Rahman",
                    phone: "081234567890",
                    experience: "15 tahun",
                    languages: ["Indonesia", "Arab", "English"]
                },
                muthawif: {
                    name: "Sheikh Abdullah Al-Harami",
                    phone: "+966501234567",
                    experience: "20 tahun",
                    specialization: "Sejarah Islam & Manasik Haji/Umroh"
                },
                sub_groups: [
                    {
                        id: 1,
                        name: "Sub Grup Hotel Hilton",
                        hotel_makkah: "Hilton Makkah Convention",
                        hotel_madinah: "Hilton Madinah",
                        members: 7,
                        max_members: 23
                    },
                    {
                        id: 2,
                        name: "Sub Grup Hotel Marriott", 
                        hotel_makkah: "Marriott Makkah",
                        hotel_madinah: "Marriott Madinah",
                        members: 3,
                        max_members: 22
                    }
                ]
            },
            {
                id: 2,
                name: "Grup Turki Premium",
                package: "Umroh Plus Turki",
                departure_date: "2024-04-20",
                max_members: 40,
                current_members: 25,
                bus_number: "BUS002",
                meeting_time: "03:30",
                meeting_point: "Masjid Istiqlal, Jakarta",
                status: "full",
                flight_details: {
                    departure_flight: "TK 57",
                    departure_date: "2024-04-20",
                    departure_time: "10:15",
                    return_flight: "TK 141",
                    return_date: "2024-05-10",
                    return_time: "16:45",
                    transit_info: "Istanbul (IST) - 4 jam",
                    route: "CGK - IST - JED"
                },
                tour_leader: {
                    name: "Ustadz Muhammad Yusuf",
                    phone: "081234567891",
                    experience: "12 tahun",
                    languages: ["Indonesia", "Arab", "Turkish"]
                },
                muthawif: {
                    name: "Sheikh Omar Al-Madani",
                    phone: "+966501234568",
                    experience: "18 tahun",
                    specialization: "Fiqih Manasik & Sejarah Masjid Nabawi"
                },
                sub_groups: [
                    {
                        id: 3,
                        name: "Sub Grup Hotel Swissotel",
                        hotel_makkah: "Swissotel Makkah",
                        hotel_madinah: "Swissotel Al Madinah",
                        members: 15,
                        max_members: 20
                    },
                    {
                        id: 4,
                        name: "Sub Grup Hotel Hyatt",
                        hotel_makkah: "Hyatt Regency Makkah",
                        hotel_madinah: "Hyatt Regency Madinah",
                        members: 10,
                        max_members: 20
                    }
                ]
            },
            {
                id: 3,
                name: "Grup Keluarga Bahagia",
                package: "Umroh Keluarga",
                departure_date: "2024-02-10",
                max_members: 30,
                current_members: 30,
                bus_number: "BUS003",
                meeting_time: "05:00",
                meeting_point: "Terminal Kampung Rambutan",
                status: "traveling",
                sub_groups: [
                    {
                        id: 5,
                        name: "Sub Grup Hotel Sheraton",
                        hotel_makkah: "Sheraton Makkah",
                        hotel_madinah: "Sheraton Madinah",
                        members: 30,
                        max_members: 30
                    }
                ]
            },
            {
                id: 4,
                name: "Grup Ekonomi Smart",
                package: "Umroh Ekonomi",
                departure_date: "2024-06-15",
                max_members: 50,
                current_members: 12,
                bus_number: "BUS004",
                meeting_time: "02:30",
                meeting_point: "Masjid Agung Sunda Kelapa",
                status: "planning",
                sub_groups: [
                    {
                        id: 6,
                        name: "Sub Grup Hotel Ibis",
                        hotel_makkah: "Ibis Styles Makkah",
                        hotel_madinah: "Ibis Styles Madinah",
                        members: 8,
                        max_members: 25
                    },
                    {
                        id: 7,
                        name: "Sub Grup Hotel Novotel",
                        hotel_makkah: "Novotel Makkah",
                        hotel_madinah: "Novotel Madinah",
                        members: 4,
                        max_members: 25
                    }
                ]
            },
            {
                id: 5,
                name: "Grup VIP Executive",
                package: "Umroh VIP",
                departure_date: "2024-05-25",
                max_members: 25,
                current_members: 25,
                bus_number: "BUS005",
                meeting_time: "06:00",
                meeting_point: "Hotel Grand Sahid Jaya",
                status: "returned",
                sub_groups: [
                    {
                        id: 8,
                        name: "Sub Grup Hotel Conrad",
                        hotel_makkah: "Conrad Makkah",
                        hotel_madinah: "Conrad Madinah",
                        members: 25,
                        max_members: 25
                    }
                ]
            },
            {
                id: 6,
                name: "Grup Haji Furoda",
                package: "Umroh Plus Haji",
                departure_date: "2024-07-12",
                max_members: 35,
                current_members: 18,
                bus_number: "BUS006",
                meeting_time: "04:30",
                meeting_point: "Masjid Al-Azhar, Kebayoran",
                status: "active",
                sub_groups: [
                    {
                        id: 9,
                        name: "Sub Grup Hotel Fairmont",
                        hotel_makkah: "Fairmont Makkah",
                        hotel_madinah: "Fairmont Madinah",
                        members: 10,
                        max_members: 18
                    },
                    {
                        id: 10,
                        name: "Sub Grup Hotel Intercontinental",
                        hotel_makkah: "InterContinental Makkah",
                        hotel_madinah: "InterContinental Madinah",
                        members: 8,
                        max_members: 17
                    }
                ]
            }
        ];

        // Room Management Data
        let roomData = [];
        let currentGroupRooms = [];
        let selectedAllocationStrategy = 'auto';

        // Navigation
        function showPage(pageId) {
            try {
                console.log('Navigating to page:', pageId);
                
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Show selected page
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    console.error('Page not found:', pageId);
                    return;
                }
                
                // Add active class to clicked nav item - fix the event reference
                const clickedNavItem = document.querySelector(`[onclick="showPage('${pageId}')"]`);
                if (clickedNavItem) {
                    clickedNavItem.classList.add('active');
                } else {
                    console.warn('Nav item not found for page:', pageId);
                }
                
                // Load page specific data
                loadPageData(pageId);
                
            } catch (error) {
                console.error('Error in showPage:', error);
                showNotification('Navigation error: ' + error.message, 'error');
            }
        }

        // Make showPage available globally
        window.showPage = showPage;

        function loadPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'jamaah':
                    loadJamaahTable();
                    break;
                case 'packages':
                    loadPackageCards();
                    break;
                case 'payments':
                    loadPaymentTable();
                    break;
                case 'documents':
                    loadDocumentTable();
                    break;
                case 'groups':
                    loadGroupCards();
                    break;
                case 'reports':
                    loadReportCharts();
                    break;
                case 'finance':
                    loadFinancePage();
                    break;
                case 'marketing':
                    loadMarketingPage();
                    break;
                case 'automation':
                    loadAutomationPage();
                    break;
                case 'excel':
                    // Excel page is static, no specific loading needed
                    console.log('Excel page loaded');
                    break;
                default:
                    console.warn('Unknown page:', pageId);
            }
        }

        // Dashboard
        function loadDashboard() {
            // Update basic stats
            document.getElementById('totalJamaah').textContent = jamaahData.length.toLocaleString();
            document.getElementById('activePackages').textContent = packageData.length;
            
            const totalRevenue = paymentData.reduce((sum, payment) => sum + payment.amount, 0);
            document.getElementById('totalRevenue').textContent = (totalRevenue / 1000000000).toFixed(1) + 'B';
            
            // Update group departure statistics
            updateGroupDepartureStats();

            // Load charts
            loadDashboardCharts();
        }

        function updateGroupDepartureStats() {
            // Calculate group statistics based on new status
            const pendingGroups = groupData.filter(g => g.status === 'open' || g.status === 'full').length;
            const departedGroups = groupData.filter(g => g.status === 'depart').length;
            const returnedGroups = groupData.filter(g => g.status === 'arrival').length;
            const totalGroups = groupData.length;
            
            // Update the numbers
            document.getElementById('groupsPending').textContent = pendingGroups;
            document.getElementById('groupsDeparted').textContent = departedGroups;
            document.getElementById('groupsReturned').textContent = returnedGroups;
            document.getElementById('totalGroups').textContent = totalGroups;
            
            // Calculate progress percentage
            const progressPercentage = totalGroups > 0 ? Math.round((returnedGroups / totalGroups) * 100) : 0;
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar && progressText) {
                progressBar.style.width = progressPercentage + '%';
                progressText.textContent = progressPercentage + '%';
            }
        }

        function loadDashboardCharts() {
            // Jamaah registration chart
            const jamaahCtx = document.getElementById('jamaahChart').getContext('2d');
            new Chart(jamaahCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Registrasi Jamaah',
                        data: [120, 190, 300, 250, 180, 220],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: 'white',
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            }
                        },
                        y: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });

            // Revenue chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Umroh Ramadhan', 'Umroh Plus Turki', 'Umroh Keluarga'],
                    datasets: [{
                        data: [800, 540, 350],
                        backgroundColor: ['#4facfe', '#00f2fe', '#a8edea']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: 'white',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // Jamaah Management
        function loadJamaahTable() {
            const tbody = document.getElementById('jamaahTableBody');
            tbody.innerHTML = '';
            
            jamaahData.forEach((jamaah, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${jamaah.name}</td>
                    <td>${jamaah.nik}</td>
                    <td>${jamaah.phone}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${jamaah.passport_image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzY0NzQ4YiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iOCIgZmlsbD0iI2Y4ZmFmYyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='}" 
                                 style="width: 40px; height: 24px; border-radius: 4px; object-fit: cover; cursor: pointer;" 
                                 onclick="viewPassportImage('${jamaah.passport_image}', '${jamaah.name}')"
                                 title="Klik untuk melihat paspor">
                            <span style="font-size: 12px; color: #cbd5e1;">${jamaah.passport_number || 'Belum ada'}</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            ${jamaah.ktp ? '<span class="material-icons" style="font-size: 16px; color: #10b981;" title="KTP tersedia">credit_card</span>' : '<span class="material-icons" style="font-size: 16px; color: #64748b;" title="KTP belum upload">credit_card</span>'}
                            ${jamaah.kk ? '<span class="material-icons" style="font-size: 16px; color: #10b981;" title="KK tersedia">family_restroom</span>' : '<span class="material-icons" style="font-size: 16px; color: #64748b;" title="KK belum upload">family_restroom</span>'}
                            ${jamaah.photo ? '<span class="material-icons" style="font-size: 16px; color: #10b981;" title="Foto tersedia">person</span>' : '<span class="material-icons" style="font-size: 16px; color: #64748b;" title="Foto belum upload">person</span>'}
                        </div>
                    </td>
                    <td>${jamaah.package}</td>
                    <td><span class="status-badge status-${jamaah.status}">${getStatusText(jamaah.status)}</span></td>
                    <td>Rp ${(jamaah.total_paid || 0).toLocaleString()}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="editJamaah(${jamaah.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteJamaah(${jamaah.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'verified': 'Terverifikasi',
                'pending': 'Pending',
                'rejected': 'Ditolak'
            };
            return statusMap[status] || status;
        }

        function filterJamaah() {
            const search = document.getElementById('searchJamaah').value.toLowerCase();
            const packageFilter = document.getElementById('filterPackage').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            // In a real app, this would filter the data
            showNotification('Filter diterapkan!');
            loadJamaahTable();
        }

        function editJamaah(id) {
            const jamaah = jamaahData.find(j => j.id === id);
            if (jamaah) {
                // Populate form with jamaah data
                document.getElementById('jamaahName').value = jamaah.name;
                document.getElementById('jamaahNik').value = jamaah.nik;
                document.getElementById('jamaahBirthDate').value = jamaah.birth_date;
                // Sync with date picker
                const birthDatePicker = document.getElementById('jamaahBirthDatePicker');
                if (birthDatePicker && jamaah.birth_date) {
                    const isoDate = convertToISODate(jamaah.birth_date);
                    if (isoDate) birthDatePicker.value = isoDate;
                }
                document.getElementById('jamaahBirthPlace').value = jamaah.birth_place;
                document.getElementById('jamaahGender').value = jamaah.gender;
                document.getElementById('jamaahPhone').value = jamaah.phone;
                document.getElementById('jamaahEmail').value = jamaah.email;
                document.getElementById('jamaahPackage').value = jamaah.package_id;
                document.getElementById('jamaahAddress').value = jamaah.address;
                
                // Regional data
                document.getElementById('jamaahProvinsi').value = jamaah.provinsi || '';
                document.getElementById('jamaahKabupaten').value = jamaah.kabupaten || '';
                document.getElementById('jamaahKecamatan').value = jamaah.kecamatan || '';
                document.getElementById('jamaahKelurahan').value = jamaah.kelurahan || '';
                
                // Personal data
                document.getElementById('jamaahMaritalStatus').value = jamaah.marital_status || '';
                document.getElementById('jamaahEducation').value = jamaah.education || '';
                document.getElementById('jamaahOccupation').value = jamaah.occupation || '';
                
                // Passport data
                document.getElementById('jamaahPassportName').value = jamaah.passport_name || '';
                document.getElementById('jamaahPassportNumber').value = jamaah.passport_number || '';
                document.getElementById('jamaahPassportCity').value = jamaah.passport_city || '';
                document.getElementById('jamaahPassportIssueDate').value = jamaah.passport_issue_date || '';
                document.getElementById('jamaahPassportExpireDate').value = jamaah.passport_expire_date || '';
                
                // Sync passport dates with date pickers
                const issueDatePicker = document.getElementById('jamaahPassportIssueDatePicker');
                const expireDatePicker = document.getElementById('jamaahPassportExpireDatePicker');
                
                if (issueDatePicker && jamaah.passport_issue_date) {
                    const isoDate = convertToISODate(jamaah.passport_issue_date);
                    if (isoDate) issueDatePicker.value = isoDate;
                }
                
                if (expireDatePicker && jamaah.passport_expire_date) {
                    const isoDate = convertToISODate(jamaah.passport_expire_date);
                    if (isoDate) expireDatePicker.value = isoDate;
                }
                
                // Check if passport name is same as KTP name
                if (jamaah.passport_name === jamaah.name && jamaah.passport_name) {
                    document.getElementById('sameAsKtpName').checked = true;
                    togglePassportName(document.getElementById('sameAsKtpName'));
                }
                
                // Family data
                document.getElementById('jamaahFamilyRole').value = jamaah.family_role || '';
                document.getElementById('jamaahRoomPreference').value = jamaah.room_preference || '';
                document.getElementById('jamaahFamilyRoomRequest').checked = jamaah.family_room_request || false;
                
                // Trigger family field toggle
                if (jamaah.family_role) {
                    toggleFamilyFields(document.getElementById('jamaahFamilyRole'));
                    if (jamaah.main_family_id && (jamaah.family_role === 'istri' || jamaah.family_role === 'anak')) {
                        setTimeout(() => {
                            document.getElementById('jamaahMainFamily').value = jamaah.main_family_id;
                        }, 100);
                    }
                }
                
                // Show passport preview if exists
                if (jamaah.passport_image) {
                    document.getElementById('passportPreview').style.display = 'block';
                    document.getElementById('passportImg').src = jamaah.passport_image;
                }
                
                // Show additional documents if exist
                ['ktp', 'kk', 'photo'].forEach(docType => {
                    if (jamaah[docType]) {
                        const previewContainer = document.getElementById(`${docType}Preview`);
                        const previewImage = document.getElementById(`${docType}Img`);
                        
                        if (previewContainer && previewImage) {
                            previewImage.src = jamaah[docType];
                            previewImage.dataset.imageData = jamaah[docType];
                            previewContainer.style.display = 'block';
                        }
                    }
                });
                
                openModal('jamaahModal');
            }
        }

        function deleteJamaah(id) {
            if (confirm('Yakin ingin menghapus data jamaah ini?')) {
                jamaahData = jamaahData.filter(j => j.id !== id);
                loadJamaahTable();
                showNotification('Data jamaah berhasil dihapus!');
            }
        }

        function saveJamaah(event) {
            event.preventDefault();
            
            // Validate birth date first
            const birthDate = document.getElementById('jamaahBirthDate').value;
            if (!validateBirthDate(birthDate)) {
                showNotification('Format tanggal lahir tidak valid. Gunakan format ddmmyyyy (contoh: 15051985)', 'error');
                document.getElementById('jamaahBirthDate').focus();
                return;
            }
            
            // Validate passport dates if provided
            const passportIssueDate = document.getElementById('jamaahPassportIssueDate').value;
            const passportExpireDate = document.getElementById('jamaahPassportExpireDate').value;
            
            if (passportIssueDate && !validatePassportDate(passportIssueDate)) {
                showNotification('Format tanggal penerbitan paspor tidak valid. Gunakan format ddmmyyyy', 'error');
                document.getElementById('jamaahPassportIssueDate').focus();
                return;
            }
            
            if (passportExpireDate && !validatePassportDate(passportExpireDate)) {
                showNotification('Format tanggal kadaluarsa paspor tidak valid. Gunakan format ddmmyyyy', 'error');
                document.getElementById('jamaahPassportExpireDate').focus();
                return;
            }

            const formData = {
                name: document.getElementById('jamaahName').value,
                nik: document.getElementById('jamaahNik').value,
                birth_date: birthDate,
                birth_place: document.getElementById('jamaahBirthPlace').value,
                gender: document.getElementById('jamaahGender').value,
                phone: document.getElementById('jamaahPhone').value,
                email: document.getElementById('jamaahEmail').value,
                package_id: parseInt(document.getElementById('jamaahPackage').value),
                address: document.getElementById('jamaahAddress').value,
                
                // Regional data (optional)
                provinsi: document.getElementById('jamaahProvinsi').value,
                kabupaten: document.getElementById('jamaahKabupaten').value,
                kecamatan: document.getElementById('jamaahKecamatan').value,
                kelurahan: document.getElementById('jamaahKelurahan').value,
                
                // Personal data (optional)
                marital_status: document.getElementById('jamaahMaritalStatus').value,
                education: document.getElementById('jamaahEducation').value,
                occupation: document.getElementById('jamaahOccupation').value,
                
                // Passport data
                passport_name: document.getElementById('jamaahPassportName').value,
                passport_number: document.getElementById('jamaahPassportNumber').value,
                passport_city: document.getElementById('jamaahPassportCity').value,
                passport_issue_date: passportIssueDate,
                passport_expire_date: passportExpireDate,
                passport_image: document.getElementById('passportImg').src || null,
                
                // Additional documents
                ...getAdditionalDocuments(),
                
                // Family data
                family_role: document.getElementById('jamaahFamilyRole').value,
                room_preference: document.getElementById('jamaahRoomPreference').value || 'quad', // Default to quad
                family_room_request: document.getElementById('jamaahFamilyRoomRequest').checked
            };

            // Handle family ID assignment
            const familyRole = formData.family_role;
            let mainFamilyId;
            
            if (familyRole === 'kepala_keluarga') {
                mainFamilyId = generateNewFamilyId();
            } else if (familyRole === 'istri' || familyRole === 'anak') {
                const selectedFamily = document.getElementById('jamaahMainFamily').value;
                if (selectedFamily === 'new_family') {
                    mainFamilyId = generateNewFamilyId();
                } else if (selectedFamily) {
                    mainFamilyId = parseInt(selectedFamily);
                } else {
                    showNotification('Silakan pilih kepala keluarga atau buat family baru', 'error');
                    return;
                }
            } else if (familyRole === 'individu') {
                mainFamilyId = generateNewFamilyId(); // Each individual gets their own family ID
            }
            
            formData.main_family_id = mainFamilyId;

            // Get package name
            const packageSelect = document.getElementById('jamaahPackage');
            const packageName = packageSelect.options[packageSelect.selectedIndex].text.split(' - ')[0];
            
            // Add to jamaahData (in real app, this would be an API call)
            const newId = Math.max(...jamaahData.map(j => j.id)) + 1;
            jamaahData.push({
                id: newId,
                ...formData,
                package: packageName,
                status: 'pending',
                total_paid: 0
            });
            
            // Get package price for receivable entry
            const selectedPackage = packageData.find(p => p.name === packageName);
            const packagePrice = selectedPackage ? selectedPackage.price : 0;
            
            // Create automatic journal entry for receivable
            if (packagePrice > 0) {
                const journalEntry = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    description: `Pendaftaran jamaah ${formData.name} - ${packageName}`,
                    lines: [
                        { account: '1-20001', debit: packagePrice, credit: 0 }, // Debit Piutang Jamaah
                        { account: '4-10001', debit: 0, credit: packagePrice }  // Credit Pendapatan Umroh
                    ],
                    status: 'posted',
                    type: 'registration'
                };
                
                // Update account balances
                const receivableAcc = chartOfAccounts.find(a => a.code === '1-20001');
                const revenueAcc = chartOfAccounts.find(a => a.code === '4-10001');
                
                if (receivableAcc) receivableAcc.balance += packagePrice;
                if (revenueAcc) revenueAcc.balance += packagePrice;
                
                journalEntries.push(journalEntry);
            }
            
            closeModal('jamaahModal');
            loadJamaahTable();
            loadJournalTable();
            loadCOATable();
            updateFinancialStats();
            showNotification('Data jamaah berhasil disimpan dan dicatat ke jurnal!');
            
            // Reset form
            event.target.reset();
            document.getElementById('passportPreview').style.display = 'none';
        }

        // Package Management
        function loadPackageCards() {
            const container = document.getElementById('packageGrid');
            container.innerHTML = '';
            
            packageData.forEach(package => {
                const remainingSeats = package.quota - package.booked;
                const card = document.createElement('div');
                card.className = 'glass-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <h3 style="color: white; margin: 0;">${package.name}</h3>
                        <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">${package.code}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Harga</p>
                            <p style="color: #4facfe; font-weight: 600;">Rp ${(package.price || 0).toLocaleString()}</p>
                        </div>
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Keberangkatan</p>
                            <p style="color: white;">${formatDate(package.departure_date)}</p>
                        </div>
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Durasi</p>
                            <p style="color: white;">${package.duration} hari</p>
                        </div>
                        <div>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Sisa Seat</p>
                            <p style="color: ${remainingSeats > 10 ? '#22c55e' : remainingSeats > 0 ? '#f59e0b' : '#ef4444'}; font-weight: 600;">${remainingSeats}/${package.quota}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: white; font-size: 14px; margin-bottom: 8px;">Detail Hotel & Penerbangan</h4>
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.8);">
                            <p> Makkah: ${package.makkah_hotel} (${package.makkah_nights} malam)</p>
                            <p> Madinah: ${package.madinah_hotel} (${package.madinah_nights} malam)</p>
                            <p> Maskapai: ${package.airline}</p>
                            ${package.flight_details && package.flight_details.flight_numbers ? `<p> Flight: ${package.flight_details.flight_numbers}</p>` : ''}
                            ${package.flight_details && package.flight_details.transit_info ? `<p> Transit: ${package.flight_details.transit_info}</p>` : ''}
                            ${package.flight_details && package.flight_details.route ? `<p> Rute: ${package.flight_details.route}</p>` : ''}
                        </div>
                    </div>
                    
                    ${package.facilities ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: white; font-size: 14px; margin-bottom: 8px;">Fasilitas</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${package.facilities.haramain_train ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 12px; font-size: 11px;"> Kereta Haramain</span>' : ''}
                            ${package.facilities.thaif_tour ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 12px; font-size: 11px;"> Tour Thaif</span>' : ''}
                            ${package.facilities.equipment_kit ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 12px; font-size: 11px;"> Perlengkapan</span>' : ''}
                            ${package.facilities.visa_handling ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 12px; font-size: 11px;"> Pengurusan Visa</span>' : ''}
                        </div>
                    </div>` : ''}
                    
                    ${package.brochure_photos && package.brochure_photos.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: white; font-size: 14px; margin-bottom: 8px;">Foto Brosur (${package.brochure_photos.length})</h4>
                        <div style="display: flex; gap: 4px; overflow-x: auto; padding-bottom: 4px;">
                            ${package.brochure_photos.slice(0, 4).map(photo => `
                                <img src="${photo.url}" onclick="viewBrochureFromPackage('${package.id}', '${photo.id}')" 
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);" 
                                     alt="Brosur ${photo.name}">
                            `).join('')}
                            ${package.brochure_photos.length > 4 ? `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 4px; color: rgba(255,255,255,0.7); font-size: 10px;">+${package.brochure_photos.length - 4}</div>` : ''}
                        </div>
                    </div>` : ''}
                    
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 12px; margin-bottom: 15px;">${package.description}</p>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary btn-flex" onclick="editPackage(${package.id})">
                            <span class="material-icons">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-danger btn-flex" onclick="deletePackage(${package.id})">
                            <span class="material-icons">delete</span>
                            Hapus
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function editPackage(id) {
            const package = packageData.find(p => p.id === id);
            if (package) {
                document.getElementById('packageName').value = package.name;
                document.getElementById('packageCode').value = package.code || '';
                document.getElementById('packagePrice').value = package.price;
                document.getElementById('packageDeparture').value = package.departure_date;
                document.getElementById('packageDuration').value = package.duration;
                document.getElementById('packageQuota').value = package.quota;
                document.getElementById('packageMakkahHotel').value = package.makkah_hotel;
                document.getElementById('packageMadinahHotel').value = package.madinah_hotel;
                document.getElementById('packageMakkahNights').value = package.makkah_nights;
                document.getElementById('packageMadinahNights').value = package.madinah_nights;
                document.getElementById('packageAirline').value = package.airline;
                document.getElementById('packageDescription').value = package.description;
                
                // Populate flight details
                if (package.flight_details) {
                    document.getElementById('flightNumbers').value = package.flight_details.flight_numbers || '';
                    document.getElementById('transitInfo').value = package.flight_details.transit_info || '';
                    document.getElementById('flightRoute').value = package.flight_details.route || '';
                    document.getElementById('flightNotes').value = package.flight_details.notes || '';
                }
                
                // Populate facilities
                if (package.facilities) {
                    document.getElementById('facilityHaramin').checked = package.facilities.haramain_train || false;
                    document.getElementById('facilityThaif').checked = package.facilities.thaif_tour || false;
                    document.getElementById('facilityKit').checked = package.facilities.equipment_kit || false;
                    document.getElementById('facilityVisa').checked = package.facilities.visa_handling || false;
                }
                
                // Populate brochure photos
                if (package.brochure_photos && package.brochure_photos.length > 0) {
                    brochurePhotos = [...package.brochure_photos];
                    renderBrochurePreview();
                }
                
                openModal('packageModal');
            }
        }

        function deletePackage(id) {
            if (confirm('Yakin ingin menghapus paket ini?')) {
                packageData = packageData.filter(p => p.id !== id);
                loadPackageCards();
                showNotification('Paket berhasil dihapus!');
            }
        }

        function savePackage(event) {
            event.preventDefault();
            
            // Get facilities data
            const facilities = {
                haramain_train: document.getElementById('facilityHaramin').checked,
                thaif_tour: document.getElementById('facilityThaif').checked,
                equipment_kit: document.getElementById('facilityKit').checked,
                visa_handling: document.getElementById('facilityVisa').checked
            };
            
            // Get flight details data
            const flightDetails = {
                flight_numbers: document.getElementById('flightNumbers').value,
                transit_info: document.getElementById('transitInfo').value,
                route: document.getElementById('flightRoute').value,
                notes: document.getElementById('flightNotes').value
            };
            
            const formData = {
                name: document.getElementById('packageName').value,
                code: document.getElementById('packageCode').value,
                price: parseInt(document.getElementById('packagePrice').value),
                departure_date: document.getElementById('packageDeparture').value,
                duration: parseInt(document.getElementById('packageDuration').value),
                quota: parseInt(document.getElementById('packageQuota').value),
                makkah_hotel: document.getElementById('packageMakkahHotel').value,
                madinah_hotel: document.getElementById('packageMadinahHotel').value,
                makkah_nights: parseInt(document.getElementById('packageMakkahNights').value),
                madinah_nights: parseInt(document.getElementById('packageMadinahNights').value),
                airline: document.getElementById('packageAirline').value,
                description: document.getElementById('packageDescription').value,
                flight_details: flightDetails,
                facilities: facilities,
                brochure_photos: brochurePhotos || []
            };
            
            const newId = Math.max(...packageData.map(p => p.id)) + 1;
            packageData.push({
                id: newId,
                ...formData,
                booked: 0
            });
            
            // Reset brochure photos array
            brochurePhotos = [];
            renderBrochurePreview();
            
            closeModal('packageModal');
            loadPackageCards();
            showNotification('Paket berhasil disimpan!');
            event.target.reset();
        }

        // Payment Management
        function loadPaymentTable(searchTerm = '') {
            const tbody = document.getElementById('paymentTableBody');
            tbody.innerHTML = '';
            
            // Filter payments based on search term
            let filteredPayments = paymentData;
            if (searchTerm) {
                const search = searchTerm.toLowerCase();
                filteredPayments = paymentData.filter(payment => 
                    payment.jamaah_name.toLowerCase().includes(search) ||
                    payment.jamaah_phone.includes(search)
                );
            }
            
            filteredPayments.forEach(payment => {
                // Get jamaah data for package price
                const jamaah = jamaahData.find(j => j.id === payment.jamaah_id);
                const packageInfo = packageData.find(p => p.name === payment.package);
                const packagePrice = packageInfo ? packageInfo.price : 25000000; // Default price
                
                // Calculate total paid for this jamaah
                const totalPaidByJamaah = paymentData
                    .filter(p => p.jamaah_id === payment.jamaah_id && p.status === 'verified')
                    .reduce((sum, p) => sum + p.amount, 0);
                
                // Calculate remaining amount
                const remainingAmount = packagePrice - totalPaidByJamaah;
                const paymentStatusText = remainingAmount <= 0 ? 
                    '<span style="color: #10b981; font-weight: 600;">LUNAS</span>' : 
                    `<span style="color: #f59e0b;">Kurang: Rp ${remainingAmount.toLocaleString()}</span>`;
                
                // Calculate H-minus (days until departure)
                const departureDate = packageInfo ? new Date(packageInfo.departure_date) : null;
                const today = new Date();
                const daysUntilDeparture = departureDate ? 
                    Math.ceil((departureDate - today) / (1000 * 60 * 60 * 24)) : null;
                
                const hMinusText = daysUntilDeparture !== null ? 
                    (daysUntilDeparture > 0 ? 
                        `<span style="color: ${daysUntilDeparture <= 7 ? '#ef4444' : daysUntilDeparture <= 30 ? '#f59e0b' : '#10b981'};">H-${daysUntilDeparture}</span>` : 
                        '<span style="color: #8b5cf6;">Sudah Berangkat</span>') : 
                    '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>
                        <div>${payment.jamaah_name}</div>
                        <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6);">${payment.jamaah_phone}</div>
                    </td>
                    <td>${payment.package}</td>
                    <td>Rp ${(payment.amount || 0).toLocaleString()}</td>
                    <td>
                        <div>${paymentStatusText}</div>
                        <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6);">Total: Rp ${totalPaidByJamaah.toLocaleString()} / Rp ${packagePrice.toLocaleString()}</div>
                    </td>
                    <td>${hMinusText}</td>
                    <td>${payment.method}</td>
                    <td><span class="status-badge status-${payment.status}">${getStatusText(payment.status)}</span></td>
                    <td>
                        <div class="table-actions">
                        ${payment.status === 'pending' ? 
                            `<button class="btn btn-success btn-sm" onclick="verifyPayment(${payment.id})">
                                <span class="material-icons">check</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectPayment(${payment.id})">
                                <span class="material-icons">close</span>
                            </button>` :
                            `<button class="btn btn-primary btn-sm" onclick="viewPayment(${payment.id})">
                                <span class="material-icons">visibility</span>
                            </button>`
                        }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Show message if no results
            if (filteredPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                            <span class="material-icons" style="font-size: 48px; margin-bottom: 10px; display: block;">search_off</span>
                            Tidak ada pembayaran yang ditemukan
                        </td>
                    </tr>
                `;
            }
        }

        function searchPayments() {
            const searchTerm = document.getElementById('searchPayment').value;
            loadPaymentTable(searchTerm);
        }

        function verifyPayment(id) {
            const payment = paymentData.find(p => p.id === id);
            if (payment && confirm('Verifikasi pembayaran ini?')) {
                payment.status = 'verified';
                
                // Automatically post to journal
                postPaymentToJournal(payment);
                
                loadPaymentTable();
                loadJournalTable();
                loadCOATable();
                updateFinancialStats();
                
                showNotification('Pembayaran berhasil diverifikasi dan dicatat ke jurnal!');
            }
        }

        function rejectPayment(id) {
            const payment = paymentData.find(p => p.id === id);
            if (payment && confirm('Tolak pembayaran ini?')) {
                payment.status = 'rejected';
                loadPaymentTable();
                showNotification('Pembayaran ditolak!', 'error');
            }
        }

        function savePayment(event) {
            event.preventDefault();
            
            const jamaahSelect = document.getElementById('paymentJamaah');
            const jamaahId = parseInt(jamaahSelect.value);
            const jamaahName = jamaahSelect.options[jamaahSelect.selectedIndex].text.split(' - ')[0];
            
            // Get jamaah phone from jamaahData
            const jamaah = jamaahData.find(j => j.id === jamaahId);
            const jamaahPhone = jamaah ? jamaah.phone : '';
            
            const newPayment = {
                id: Math.max(...paymentData.map(p => p.id)) + 1,
                jamaah_id: jamaahId,
                jamaah_name: jamaahName,
                jamaah_phone: jamaahPhone,
                package: jamaah ? jamaah.package : "Umroh Ramadhan 2024",
                amount: parseInt(document.getElementById('paymentAmount').value),
                date: document.getElementById('paymentDate').value,
                method: document.getElementById('paymentMethod').value,
                bank: document.getElementById('paymentBank').value,
                reference: document.getElementById('paymentReference').value,
                status: 'pending'
            };
            
            paymentData.push(newPayment);
            closeModal('paymentModal');
            loadPaymentTable();
            showNotification('Pembayaran berhasil dicatat!');
            event.target.reset();
        }

        // Document Management
        function loadDocumentTable() {
            const tbody = document.getElementById('documentTableBody');
            tbody.innerHTML = '';
            
            documentData.forEach(doc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${doc.jamaah_name}</td>
                    <td>${doc.type}</td>
                    <td><a href="#" style="color: #4facfe;">${doc.filename}</a></td>
                    <td>${formatDate(doc.upload_date)}</td>
                    <td><span class="status-badge status-${doc.status}">${getStatusText(doc.status)}</span></td>
                    <td>
                        <div class="table-actions">
                        ${doc.status === 'pending' ? 
                            `<button class="btn btn-success btn-sm" onclick="verifyDocument(${doc.id})">
                                <span class="material-icons">check</span>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectDocument(${doc.id})">
                                <span class="material-icons">close</span>
                            </button>` :
                            `<button class="btn btn-primary btn-sm" onclick="viewDocument(${doc.id})">
                                <span class="material-icons">visibility</span>
                            </button>`
                        }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                showNotification(`${files.length} file berhasil diupload!`);
                // In real app, files would be uploaded to server
                for (let file of files) {
                    documentData.push({
                        id: Math.max(...documentData.map(d => d.id)) + 1,
                        jamaah_name: "Jamaah Baru",
                        type: "Dokumen",
                        filename: file.name,
                        upload_date: new Date().toISOString().split('T')[0],
                        status: 'pending'
                    });
                }
                loadDocumentTable();
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            handleFileUpload(event);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.target.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.target.classList.remove('dragover');
        }

        function verifyDocument(id) {
            const doc = documentData.find(d => d.id === id);
            if (doc && confirm('Verifikasi dokumen ini?')) {
                doc.status = 'verified';
                loadDocumentTable();
                showNotification('Dokumen berhasil diverifikasi!');
            }
        }

        function rejectDocument(id) {
            const doc = documentData.find(d => d.id === id);
            if (doc && confirm('Tolak dokumen ini?')) {
                doc.status = 'rejected';
                loadDocumentTable();
                showNotification('Dokumen ditolak!', 'error');
            }
        }

        // Group Management
        function loadGroupCards() {
            const container = document.getElementById('groupGrid');
            container.innerHTML = '';
            
            groupData.forEach(group => {
                const card = document.createElement('div');
                card.className = 'group-card';
                
                // Calculate progress percentage
                const progressPercentage = (group.current_members / group.max_members) * 100;
                
                card.innerHTML = `
                    <!-- Group Header -->
                    <div class="group-header">
                        <div class="group-title">
                            <h3>${group.name}</h3>
                            <div class="group-package">${group.package}</div>
                        </div>
                        <div class="group-status-badge">
                            <span class="status-badge status-${group.status}">${getGroupStatusText(group.status)}</span>
                        </div>
                    </div>

                    <!-- Group Progress -->
                    <div class="group-progress">
                        <div class="group-progress-bar">
                            <div class="group-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="group-progress-text">
                            ${group.current_members} dari ${group.max_members} anggota (${Math.round(progressPercentage)}%)
                        </div>
                    </div>

                    <!-- Group Information Grid -->
                    <div class="group-info-grid">
                        <div class="group-info-item">
                            <div class="group-info-label">Keberangkatan</div>
                            <div class="group-info-value">${formatDate(group.departure_date)}</div>
                        </div>
                        <div class="group-info-item">
                            <div class="group-info-label">Anggota</div>
                            <div class="group-info-value highlight">${group.current_members}/${group.max_members}</div>
                        </div>
                        <div class="group-info-item">
                            <div class="group-info-label">Bus</div>
                            <div class="group-info-value">${group.bus_number}</div>
                        </div>
                        <div class="group-info-item">
                            <div class="group-info-label">Kumpul</div>
                            <div class="group-info-value">${group.meeting_time}</div>
                        </div>
                    </div>

                    <!-- Flight Details Section -->
                    ${group.flight_details ? `
                    <div class="group-logistics">
                        <div class="group-logistics-title">
                            <span class="material-icons" style="font-size: 16px;">flight</span>
                            Detail Penerbangan
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon"></div>
                            <div>Berangkat: ${group.flight_details.departure_flight} - ${group.flight_details.departure_time}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon"></div>
                            <div>Pulang: ${group.flight_details.return_flight} - ${group.flight_details.return_time}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon"></div>
                            <div>Transit: ${group.flight_details.transit_info}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon"></div>
                            <div>Rute: ${group.flight_details.route}</div>
                        </div>
                    </div>` : ''}

                    <!-- Staff Information Section -->
                    <div class="group-logistics">
                        <div class="group-logistics-title">
                            <span class="material-icons" style="font-size: 16px;">person</span>
                            Tim Pembimbing
                        </div>
                        ${group.tour_leader ? `
                        <div class="staff-info-item" style="margin-bottom: 10px; padding: 8px; background: rgba(30, 41, 59, 0.5); border-radius: 6px;">
                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; margin-right: 6px;"></span>
                                <span style="color: #4facfe; font-weight: 600; font-size: 12px;">Tour Leader</span>
                            </div>
                            <div style="color: #f8fafc; font-weight: 500; font-size: 13px; margin-bottom: 2px;">${group.tour_leader.name}</div>
                            <div style="color: #cbd5e1; font-size: 10px;"> ${group.tour_leader.phone}</div>
                            <div style="color: #cbd5e1; font-size: 10px;"> ${group.tour_leader.experience} | ${group.tour_leader.languages.join(', ')}</div>
                        </div>` : ''}
                        ${group.muthawif ? `
                        <div class="staff-info-item" style="padding: 8px; background: rgba(30, 41, 59, 0.5); border-radius: 6px;">
                            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; margin-right: 6px;"></span>
                                <span style="color: #10b981; font-weight: 600; font-size: 12px;">Muthawif</span>
                            </div>
                            <div style="color: #f8fafc; font-weight: 500; font-size: 13px; margin-bottom: 2px;">${group.muthawif.name}</div>
                            <div style="color: #cbd5e1; font-size: 10px;"> ${group.muthawif.phone}</div>
                            <div style="color: #cbd5e1; font-size: 10px;"> ${group.muthawif.experience}</div>
                            <div style="color: #cbd5e1; font-size: 10px;"> ${group.muthawif.specialization}</div>
                        </div>` : ''}
                    </div>

                    <!-- Group Logistics -->
                    <div class="group-logistics">
                        <div class="group-logistics-title">
                            <span class="material-icons" style="font-size: 16px;">location_on</span>
                            Detail Logistik
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon"></div>
                            <div>Bus: ${group.bus_number}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon"></div>
                            <div>Waktu Kumpul: ${group.meeting_time}</div>
                        </div>
                        <div class="group-logistics-item">
                            <div class="group-logistics-icon"></div>
                            <div>Lokasi: ${group.meeting_point}</div>
                        </div>
                    </div>

                    <!-- Sub Groups Section -->
                    ${group.sub_groups && group.sub_groups.length > 0 ? `
                    <div class="group-sub-groups" style="margin: 12px 0; padding: 12px; background: rgba(30, 41, 59, 0.5); border-radius: 8px; border: 1px solid rgba(71, 85, 105, 0.3);">
                        <div class="group-logistics-title" style="margin-bottom: 8px; font-size: 12px;">
                            <span class="material-icons" style="font-size: 14px;">hotel</span>
                            Sub Groups (${group.sub_groups.length} Hotel)
                        </div>
                        <div class="sub-groups-list">
                            ${group.sub_groups.map(subGroup => `
                                <div class="sub-group-item" style="margin-bottom: 8px; padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 6px; border-left: 2px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="color: #f8fafc; font-weight: 500; font-size: 11px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${subGroup.name}</div>
                                            <div style="color: #cbd5e1; font-size: 9px; margin-top: 1px; line-height: 1.1;">
                                                 ${subGroup.hotel_makkah.length > 15 ? subGroup.hotel_makkah.substring(0, 15) + '...' : subGroup.hotel_makkah}
                                            </div>
                                            <div style="color: #cbd5e1; font-size: 9px; line-height: 1.1;">
                                                 ${subGroup.hotel_madinah.length > 15 ? subGroup.hotel_madinah.substring(0, 15) + '...' : subGroup.hotel_madinah}
                                            </div>
                                        </div>
                                        <div style="text-align: right; flex-shrink: 0; margin-left: 8px;">
                                            <div style="color: #10b981; font-weight: 600; font-size: 11px;">${subGroup.members}/${subGroup.max_members}</div>
                                            <div style="color: #64748b; font-size: 8px;">jamaah</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 6px;">
                                        <button class="btn btn-sm" style="background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); font-size: 9px; padding: 3px 6px; width: 100%;" onclick="manageSubGroup(${group.id}, ${subGroup.id})">
                                            <span class="material-icons" style="font-size: 12px; margin-right: 2px;">manage_accounts</span>
                                            Kelola
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 8px; text-align: center;">
                            <button class="btn btn-sm btn-primary" onclick="addSubGroup(${group.id})" style="font-size: 9px; padding: 4px 8px;">
                                <span class="material-icons" style="font-size: 12px; margin-right: 2px;">add_circle</span>
                                Tambah Sub Grup
                            </button>
                        </div>
                    </div>
                    ` : `
                    <div style="margin: 15px 0; text-align: center;">
                        <button class="btn btn-sm btn-primary" onclick="addSubGroup(${group.id})" style="font-size: 11px; padding: 6px 12px;">
                            <span class="material-icons" style="font-size: 14px;">add_circle</span>
                            Buat Sub Grup Hotel
                        </button>
                    </div>
                    `}

                    <!-- Group Actions -->
                    <div class="group-actions">
                        <button class="btn btn-primary btn-sm" onclick="manageGroupMembers(${group.id})" title="Kelola Anggota">
                            <span class="material-icons">people</span>
                            Anggota
                        </button>
                        <button class="btn btn-success btn-sm" onclick="generateRoomList(${group.id})" title="Generate Room List">
                            <span class="material-icons">auto_awesome</span>
                            Auto
                        </button>
                        <button class="btn btn-info btn-sm" onclick="openRoomManagement(${group.id})" title="Lihat Room List">
                            <span class="material-icons">hotel</span>
                            Kamar
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportManifest(${group.id})" title="Export Manifest Grup">
                            <span class="material-icons">description</span>
                            Manifest
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editGroup(${group.id})" title="Edit Grup">
                            <span class="material-icons">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="viewGroupDetails(${group.id})" title="Lihat Detail">
                            <span class="material-icons">visibility</span>
                            Detail
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Update dashboard statistics if on dashboard page
            if (document.getElementById('dashboard') && document.getElementById('dashboard').classList.contains('active')) {
                updateGroupDepartureStats();
            }
        }

        function getGroupStatusText(status) {
            const statusMap = {
                'open': 'Open',
                'full': 'Full',
                'canceled': 'Canceled',
                'depart': 'Depart',
                'arrival': 'Arrival'
            };
            return statusMap[status] || status;
        }

        function saveGroup(event) {
            event.preventDefault();
            
            const packageSelect = document.getElementById('groupPackage');
            const packageName = packageSelect.options[packageSelect.selectedIndex].text;
            
            // Process languages for tour leader
            const tourLeaderLanguages = document.getElementById('groupTourLeaderLanguages').value
                .split(',').map(lang => lang.trim()).filter(lang => lang);
            
            const newGroup = {
                id: Math.max(...groupData.map(g => g.id)) + 1,
                name: document.getElementById('groupName').value,
                package: packageName,
                departure_date: document.getElementById('groupDeparture').value,
                max_members: parseInt(document.getElementById('groupMaxMembers').value),
                current_members: 0,
                bus_number: document.getElementById('groupBusNumber').value,
                meeting_time: document.getElementById('groupMeetingTime').value,
                meeting_point: document.getElementById('groupMeetingPoint').value,
                status: document.getElementById('groupStatus').value,
                flight_details: {
                    departure_flight: document.getElementById('groupDepartureFlight').value,
                    departure_date: document.getElementById('groupDeparture').value,
                    departure_time: document.getElementById('groupDepartureTime').value,
                    return_flight: document.getElementById('groupReturnFlight').value,
                    return_date: '', // Could add return date field if needed
                    return_time: document.getElementById('groupReturnTime').value,
                    transit_info: document.getElementById('groupTransitInfo').value,
                    route: document.getElementById('groupFlightRoute').value
                },
                tour_leader: {
                    name: document.getElementById('groupTourLeaderName').value,
                    phone: document.getElementById('groupTourLeaderPhone').value,
                    experience: document.getElementById('groupTourLeaderExperience').value,
                    languages: tourLeaderLanguages
                },
                muthawif: {
                    name: document.getElementById('groupMuthawifName').value,
                    phone: document.getElementById('groupMuthawifPhone').value,
                    experience: document.getElementById('groupMuthawifExperience').value,
                    specialization: document.getElementById('groupMuthawifSpecialization').value
                }
            };
            
            groupData.push(newGroup);
            closeModal('groupModal');
            loadGroupCards();
            showNotification('Grup berhasil dibuat!');
            event.target.reset();
        }

        function manageGroupMembers(id) {
            showNotification('Fitur kelola anggota grup akan segera tersedia!');
        }

        function editGroup(id) {
            showNotification('Fitur edit grup akan segera tersedia!');
        }

        function viewGroupDetails(id) {
            const group = groupData.find(g => g.id === id);
            if (!group) return;
            
            // Create modal for group details
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Detail Grup - ${group.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <!-- Status Badge Section -->
                        <div style="text-align: center; margin-bottom: 25px;">
                            <span class="status-badge status-${group.status}" style="font-size: 14px; padding: 8px 20px;">${getGroupStatusText(group.status)}</span>
                        </div>
                        
                        <!-- Main Information Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
                            <!-- Left Column - Group Info -->
                            <div style="background: rgba(30, 41, 59, 0.4); padding: 20px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3);">
                                <h4 style="color: #4facfe; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons" style="font-size: 18px;">group</span>
                                    Informasi Grup
                                </h4>
                                <div style="space-y: 10px;">
                                    <div style="margin-bottom: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Nama Grup</span>
                                        <p style="color: white; font-weight: 600; margin: 4px 0 0 0;">${group.name}</p>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Paket</span>
                                        <p style="color: white; font-weight: 600; margin: 4px 0 0 0;">${group.package}</p>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Kapasitas</span>
                                        <p style="color: #10b981; font-weight: 600; margin: 4px 0 0 0; font-size: 18px;">${group.current_members}/${group.max_members} orang</p>
                                        <div style="background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; margin-top: 6px;">
                                            <div style="background: linear-gradient(90deg, #10b981, #34d399); height: 100%; border-radius: 3px; width: ${Math.round((group.current_members / group.max_members) * 100)}%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column - Departure Info -->
                            <div style="background: rgba(30, 41, 59, 0.4); padding: 20px; border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.3);">
                                <h4 style="color: #4facfe; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons" style="font-size: 18px;">flight_takeoff</span>
                                    Keberangkatan
                                </h4>
                                <div style="space-y: 10px;">
                                    <div style="margin-bottom: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Tanggal</span>
                                        <p style="color: white; font-weight: 600; margin: 4px 0 0 0;">${formatDate(group.departure_date)}</p>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Bus</span>
                                        <p style="color: white; font-weight: 600; margin: 4px 0 0 0;">${group.bus_number}</p>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Waktu Kumpul</span>
                                        <p style="color: #f59e0b; font-weight: 600; margin: 4px 0 0 0; font-size: 18px;">${group.meeting_time}</p>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Lokasi Kumpul</span>
                                        <p style="color: white; font-weight: 500; margin: 4px 0 0 0; line-height: 1.4;">${group.meeting_point}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Members Section -->
                        <div style="background: rgba(30, 41, 59, 0.3); border-radius: 12px; padding: 20px; border: 1px solid rgba(71, 85, 105, 0.2);">
                            <h4 style="color: #4facfe; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                <span class="material-icons" style="font-size: 18px;">people</span>
                                Daftar Anggota Grup
                            </h4>
                            <div style="text-align: center; padding: 30px 20px;">
                                <div style="margin-bottom: 15px;">
                                    <span style="font-size: 48px; color: rgba(79, 172, 254, 0.3);"></span>
                                </div>
                                <p style="color: rgba(255, 255, 255, 0.8); font-size: 16px; margin-bottom: 8px;">
                                    ${group.current_members > 0 ? 
                                        `Grup ini memiliki ${group.current_members} anggota terdaftar` : 
                                        'Belum ada anggota terdaftar dalam grup ini'
                                    }
                                </p>
                                <p style="color: rgba(255, 255, 255, 0.5); font-size: 13px;">
                                    Fitur detail anggota akan segera tersedia
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Sub-Group Management Functions
        function addSubGroup(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;

            // Create modal for adding sub-group
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Tambah Sub Grup - ${group.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <form onsubmit="saveSubGroup(event, ${groupId})" style="padding: 20px;">
                        <div class="form-group">
                            <label for="subGroupName">Nama Sub Grup</label>
                            <input type="text" id="subGroupName" placeholder="Contoh: Sub Grup Hotel Hilton" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subGroupHotelMakkah">Hotel Makkah</label>
                            <input type="text" id="subGroupHotelMakkah" placeholder="Nama hotel di Makkah" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subGroupHotelMadinah">Hotel Madinah</label>
                            <input type="text" id="subGroupHotelMadinah" placeholder="Nama hotel di Madinah" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="subGroupMaxMembers">Maksimal Anggota</label>
                            <input type="number" id="subGroupMaxMembers" min="1" max="${group.max_members}" placeholder="Jumlah maksimal jamaah" required>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary close-btn">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan Sub Grup</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function saveSubGroup(event, groupId) {
            event.preventDefault();
            
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;
            
            // Initialize sub_groups array if it doesn't exist
            if (!group.sub_groups) {
                group.sub_groups = [];
            }
            
            const newSubGroup = {
                id: Date.now(), // Simple ID generation
                name: document.getElementById('subGroupName').value,
                hotel_makkah: document.getElementById('subGroupHotelMakkah').value,
                hotel_madinah: document.getElementById('subGroupHotelMadinah').value,
                members: 0,
                max_members: parseInt(document.getElementById('subGroupMaxMembers').value)
            };
            
            group.sub_groups.push(newSubGroup);
            
            // Close modal
            event.target.closest('.modal').remove();
            
            // Refresh group cards
            loadGroupCards();
            showNotification('Sub grup berhasil ditambahkan!');
        }

        function manageSubGroup(groupId, subGroupId) {
            const group = groupData.find(g => g.id === groupId);
            const subGroup = group?.sub_groups?.find(sg => sg.id === subGroupId);
            
            if (!group || !subGroup) return;

            // Get jamaah assigned to this sub-group
            const assignedJamaah = jamaahData.filter(j => j.sub_group_id === subGroupId);
            // Get jamaah in this group but not assigned to any sub-group
            const unassignedJamaah = jamaahData.filter(j => j.group_id === groupId && !j.sub_group_id);
            // Get jamaah from other sub-groups in the same group for transfer options
            const otherSubGroupJamaah = jamaahData.filter(j => j.group_id === groupId && j.sub_group_id && j.sub_group_id !== subGroupId);

            // Create modal for managing sub-group
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Kelola ${subGroup.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: rgba(30, 41, 59, 0.4); padding: 15px; border-radius: 12px;">
                                <h4 style="color: #3b82f6; margin-bottom: 10px;">Informasi Sub Grup</h4>
                                <p><strong>Nama:</strong> ${subGroup.name}</p>
                                <p><strong>Hotel Makkah:</strong> ${subGroup.hotel_makkah}</p>
                                <p><strong>Hotel Madinah:</strong> ${subGroup.hotel_madinah}</p>
                                <p><strong>Anggota:</strong> ${assignedJamaah.length}/${subGroup.max_members}</p>
                            </div>
                            <div style="background: rgba(30, 41, 59, 0.4); padding: 15px; border-radius: 12px;">
                                <h4 style="color: #10b981; margin-bottom: 10px;">Statistik</h4>
                                <p><strong>Kapasitas:</strong> ${Math.round((assignedJamaah.length / subGroup.max_members) * 100)}%</p>
                                <p><strong>Sisa Slot:</strong> ${subGroup.max_members - assignedJamaah.length} orang</p>
                                <p><strong>Status:</strong> ${assignedJamaah.length === subGroup.max_members ? 'Penuh' : 'Tersedia'}</p>
                            </div>
                        </div>
                        
                        <!-- Current Members -->
                        <div style="background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #4facfe; margin-bottom: 15px;">Anggota Sub Grup (${assignedJamaah.length})</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${assignedJamaah.length > 0 ? 
                                    assignedJamaah.map(jamaah => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                            <div>
                                                <strong>${jamaah.name}</strong> 
                                                <span style="color: rgba(255,255,255,0.7); font-size: 12px;">(${jamaah.gender === 'male' ? 'L' : 'P'}) - ${jamaah.phone}</span>
                                            </div>
                                            <button class="btn btn-sm btn-danger" onclick="removeJamaahFromSubGroup(${jamaah.id}, ${subGroupId})" style="padding: 4px 8px; font-size: 11px;">
                                                Keluarkan
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<div style="color: rgba(255, 255, 255, 0.7); text-align: center; padding: 20px;">Belum ada anggota terdaftar</div>'
                                }
                            </div>
                        </div>

                        <!-- Available Jamaah to Assign -->
                        <div style="background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #10b981; margin-bottom: 15px;">Jamaah Tersedia untuk Ditambahkan (${unassignedJamaah.length})</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${unassignedJamaah.length > 0 ? 
                                    unassignedJamaah.map(jamaah => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                            <div>
                                                <strong>${jamaah.name}</strong> 
                                                <span style="color: rgba(255,255,255,0.7); font-size: 12px;">(${jamaah.gender === 'male' ? 'L' : 'P'}) - ${jamaah.phone}</span>
                                            </div>
                                            <button class="btn btn-sm btn-primary" onclick="assignJamaahToSubGroup(${jamaah.id}, ${subGroupId})" style="padding: 4px 8px; font-size: 11px;">
                                                Tambahkan
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<div style="color: rgba(255, 255, 255, 0.7); text-align: center; padding: 20px;">Semua jamaah sudah ditugaskan ke sub grup</div>'
                                }
                            </div>
                        </div>

                        <!-- Transfer from Other Sub Groups -->
                        ${otherSubGroupJamaah.length > 0 ? `
                            <div style="background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="color: #f59e0b; margin-bottom: 15px;">Transfer dari Sub Grup Lain (${otherSubGroupJamaah.length})</h4>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${otherSubGroupJamaah.map(jamaah => {
                                        const currentSubGroup = group.sub_groups.find(sg => sg.id === jamaah.sub_group_id);
                                        return `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                                <div>
                                                    <strong>${jamaah.name}</strong> 
                                                    <span style="color: rgba(255,255,255,0.7); font-size: 12px;">(${jamaah.gender === 'male' ? 'L' : 'P'}) - dari ${currentSubGroup?.name || 'Unknown'}</span>
                                                </div>
                                                <button class="btn btn-sm btn-warning" onclick="transferJamaahToSubGroup(${jamaah.id}, ${jamaah.sub_group_id}, ${subGroupId})" style="padding: 4px 8px; font-size: 11px;">
                                                    Transfer
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-warning" onclick="editSubGroup(${groupId}, ${subGroupId})">
                                <span class="material-icons">edit</span>
                                Edit Sub Grup
                            </button>
                            <button class="btn btn-danger" onclick="deleteSubGroup(${groupId}, ${subGroupId})">
                                <span class="material-icons">delete</span>
                                Hapus Sub Grup
                            </button>
                            <button class="btn btn-secondary close-btn">Tutup</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function editSubGroup(groupId, subGroupId) {
            const group = groupData.find(g => g.id === groupId);
            const subGroup = group?.sub_groups?.find(sg => sg.id === subGroupId);
            
            if (!group || !subGroup) return;

            // Close current modal
            document.querySelector('.modal').remove();

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Edit Sub Grup</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <form onsubmit="updateSubGroup(event, ${groupId}, ${subGroupId})" style="padding: 20px;">
                        <div class="form-group">
                            <label for="editSubGroupName">Nama Sub Grup</label>
                            <input type="text" id="editSubGroupName" value="${subGroup.name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubGroupHotelMakkah">Hotel Makkah</label>
                            <input type="text" id="editSubGroupHotelMakkah" value="${subGroup.hotel_makkah}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubGroupHotelMadinah">Hotel Madinah</label>
                            <input type="text" id="editSubGroupHotelMadinah" value="${subGroup.hotel_madinah}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSubGroupMaxMembers">Maksimal Anggota</label>
                            <input type="number" id="editSubGroupMaxMembers" min="${subGroup.members}" max="${group.max_members}" value="${subGroup.max_members}" required>
                            <small style="color: rgba(255, 255, 255, 0.6);">Minimal ${subGroup.members} (anggota saat ini)</small>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary close-btn">Batal</button>
                            <button type="submit" class="btn btn-primary">Update Sub Grup</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function updateSubGroup(event, groupId, subGroupId) {
            event.preventDefault();
            
            const group = groupData.find(g => g.id === groupId);
            const subGroup = group?.sub_groups?.find(sg => sg.id === subGroupId);
            
            if (!group || !subGroup) return;
            
            // Update sub-group data
            subGroup.name = document.getElementById('editSubGroupName').value;
            subGroup.hotel_makkah = document.getElementById('editSubGroupHotelMakkah').value;
            subGroup.hotel_madinah = document.getElementById('editSubGroupHotelMadinah').value;
            subGroup.max_members = parseInt(document.getElementById('editSubGroupMaxMembers').value);
            
            // Close modal
            event.target.closest('.modal').remove();
            
            // Refresh group cards
            loadGroupCards();
            showNotification('Sub grup berhasil diupdate!');
        }

        function deleteSubGroup(groupId, subGroupId) {
            if (!confirm('Yakin ingin menghapus sub grup ini? Tindakan ini tidak dapat dibatalkan.')) return;
            
            const group = groupData.find(g => g.id === groupId);
            if (!group || !group.sub_groups) return;
            
            // Check if sub-group has members
            const assignedJamaah = jamaahData.filter(j => j.sub_group_id === subGroupId);
            if (assignedJamaah.length > 0) {
                if (!confirm(`Sub grup ini memiliki ${assignedJamaah.length} anggota. Mereka akan dikeluarkan dari sub grup. Yakin ingin menghapus?`)) {
                    return;
                }
                // Remove sub_group_id from all assigned jamaah
                assignedJamaah.forEach(jamaah => {
                    delete jamaah.sub_group_id;
                });
            }
            
            // Remove sub-group
            group.sub_groups = group.sub_groups.filter(sg => sg.id !== subGroupId);
            
            // Close modal
            document.querySelector('.modal').remove();
            
            // Refresh group cards
            loadGroupCards();
            showNotification('Sub grup berhasil dihapus!');
        }

        // Jamaah Assignment Functions
        function assignJamaahToSubGroup(jamaahId, subGroupId) {
            const jamaah = jamaahData.find(j => j.id === jamaahId);
            if (!jamaah) {
                showNotification('Jamaah tidak ditemukan!', 'error');
                return;
            }

            // Check if sub-group is at capacity
            const group = groupData.find(g => g.sub_groups?.some(sg => sg.id === subGroupId));
            const subGroup = group?.sub_groups?.find(sg => sg.id === subGroupId);
            const currentMembers = jamaahData.filter(j => j.sub_group_id === subGroupId).length;
            
            if (currentMembers >= subGroup.max_members) {
                showNotification('Sub grup sudah penuh!', 'error');
                return;
            }

            // Assign jamaah to sub-group
            jamaah.sub_group_id = subGroupId;
            
            // Close current modal and reopen to refresh
            document.querySelector('.modal').remove();
            setTimeout(() => {
                manageSubGroup(group.id, subGroupId);
                showNotification(`${jamaah.name} berhasil ditambahkan ke sub grup!`);
            }, 100);
        }

        function removeJamaahFromSubGroup(jamaahId, subGroupId) {
            const jamaah = jamaahData.find(j => j.id === jamaahId);
            if (!jamaah) {
                showNotification('Jamaah tidak ditemukan!', 'error');
                return;
            }

            // Remove from sub-group
            delete jamaah.sub_group_id;
            
            // Find the group to refresh modal
            const group = groupData.find(g => g.sub_groups?.some(sg => sg.id === subGroupId));
            
            // Close current modal and reopen to refresh
            document.querySelector('.modal').remove();
            setTimeout(() => {
                manageSubGroup(group.id, subGroupId);
                showNotification(`${jamaah.name} berhasil dikeluarkan dari sub grup!`);
            }, 100);
        }

        function transferJamaahToSubGroup(jamaahId, fromSubGroupId, toSubGroupId) {
            const jamaah = jamaahData.find(j => j.id === jamaahId);
            if (!jamaah) {
                showNotification('Jamaah tidak ditemukan!', 'error');
                return;
            }

            // Check if target sub-group is at capacity
            const group = groupData.find(g => g.sub_groups?.some(sg => sg.id === toSubGroupId));
            const targetSubGroup = group?.sub_groups?.find(sg => sg.id === toSubGroupId);
            const currentMembers = jamaahData.filter(j => j.sub_group_id === toSubGroupId).length;
            
            if (currentMembers >= targetSubGroup.max_members) {
                showNotification('Sub grup tujuan sudah penuh!', 'error');
                return;
            }

            // Transfer jamaah
            jamaah.sub_group_id = toSubGroupId;
            
            // Close current modal and reopen to refresh
            document.querySelector('.modal').remove();
            setTimeout(() => {
                manageSubGroup(group.id, toSubGroupId);
                showNotification(`${jamaah.name} berhasil dipindahkan ke sub grup!`);
            }, 100);
        }

        // Generate Room List Function - The Main Feature
        function generateRoomList(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;

            // Get all jamaah in this group
            const groupJamaah = jamaahData.filter(j => j.group_id === groupId);
            
            if (groupJamaah.length === 0) {
                showNotification('Tidak ada jamaah dalam grup ini', 'error');
                return;
            }

            // Process room allocation
            const roomAllocation = processRoomAllocation(groupJamaah, group);
            
            // Show result in modal
            showRoomListResult(group, roomAllocation);
        }

        function processRoomAllocation(jamaahList, group) {
            const allocation = {
                hotels: {},
                summary: {
                    total_jamaah: jamaahList.length,
                    total_families: 0,
                    total_rooms: 0,
                    room_types: { quad: 0, triple: 0, double: 0 }
                }
            };

            // Group jamaah by sub-group (hotel)
            const jamaahBySubGroup = {};
            
            jamaahList.forEach(jamaah => {
                // Determine which sub-group/hotel this jamaah belongs to
                let subGroupKey = 'default';
                
                if (group.sub_groups && group.sub_groups.length > 0) {
                    // For now, distribute evenly. In real implementation, 
                    // this would be based on user selection
                    const subGroupIndex = jamaah.id % group.sub_groups.length;
                    subGroupKey = group.sub_groups[subGroupIndex].name;
                }
                
                if (!jamaahBySubGroup[subGroupKey]) {
                    jamaahBySubGroup[subGroupKey] = [];
                }
                jamaahBySubGroup[subGroupKey].push(jamaah);
            });

            // Process each sub-group/hotel
            Object.keys(jamaahBySubGroup).forEach(hotelName => {
                const hotelJamaah = jamaahBySubGroup[hotelName];
                allocation.hotels[hotelName] = processHotelRoomAllocation(hotelJamaah);
            });

            // Calculate summary
            Object.values(allocation.hotels).forEach(hotel => {
                allocation.summary.total_families += hotel.families.length;
                allocation.summary.total_rooms += hotel.rooms.length;
                
                hotel.rooms.forEach(room => {
                    allocation.summary.room_types[room.type]++;
                });
            });

            return allocation;
        }

        function processHotelRoomAllocation(jamaahList) {
            const hotelAllocation = {
                families: [],
                rooms: [],
                unassigned: []
            };

            // Group by family
            const familyGroups = {};
            
            jamaahList.forEach(jamaah => {
                const familyId = jamaah.main_family_id;
                if (!familyGroups[familyId]) {
                    familyGroups[familyId] = [];
                }
                familyGroups[familyId].push(jamaah);
            });

            // Process each family
            Object.keys(familyGroups).forEach(familyId => {
                const family = familyGroups[familyId];
                const familyInfo = processFamilyRoomAssignment(family);
                hotelAllocation.families.push(familyInfo);
            });

            // Allocate rooms
            hotelAllocation.families.forEach(family => {
                const rooms = allocateRoomsForFamily(family);
                hotelAllocation.rooms.push(...rooms);
            });

            return hotelAllocation;
        }

        function processFamilyRoomAssignment(familyMembers) {
            const mainFamily = familyMembers.find(j => j.family_role === 'kepala_keluarga') || familyMembers[0];
            
            return {
                main_family_id: mainFamily.main_family_id,
                main_family_name: mainFamily.name,
                family_role: mainFamily.family_role,
                members: familyMembers,
                family_room_request: familyMembers.some(j => j.family_room_request),
                preferred_room_type: mainFamily.room_preference || 'double',
                member_count: familyMembers.length,
                male_count: familyMembers.filter(j => j.gender === 'L').length,
                female_count: familyMembers.filter(j => j.gender === 'P').length
            };
        }

        function allocateRoomsForFamily(family) {
            const rooms = [];
            
            if (family.family_room_request && family.member_count <= 4) {
                // Family wants to stay together in one room
                const roomType = getRoomTypeByCapacity(family.member_count);
                rooms.push({
                    type: roomType,
                    capacity: getRoomCapacity(roomType),
                    occupants: family.members,
                    main_family: family.main_family_name,
                    special_request: 'Family Room',
                    gender_mixed: family.male_count > 0 && family.female_count > 0
                });
            } else {
                // Separate by gender
                const maleMembers = family.members.filter(j => j.gender === 'L');
                const femaleMembers = family.members.filter(j => j.gender === 'P');
                
                if (maleMembers.length > 0) {
                    const maleRooms = allocateRoomsByGender(maleMembers, family, 'L');
                    rooms.push(...maleRooms);
                }
                
                if (femaleMembers.length > 0) {
                    const femaleRooms = allocateRoomsByGender(femaleMembers, family, 'P');
                    rooms.push(...femaleRooms);
                }
            }
            
            return rooms;
        }

        function allocateRoomsByGender(members, family, gender) {
            const rooms = [];
            const preferredRoomType = family.preferred_room_type;
            const capacity = getRoomCapacity(preferredRoomType);
            
            for (let i = 0; i < members.length; i += capacity) {
                const roomMembers = members.slice(i, i + capacity);
                const actualCapacity = roomMembers.length;
                const roomType = getRoomTypeByCapacity(actualCapacity);
                
                rooms.push({
                    type: roomType,
                    capacity: actualCapacity,
                    occupants: roomMembers,
                    main_family: family.main_family_name,
                    gender: gender === 'L' ? 'Laki-laki' : 'Perempuan',
                    special_request: null,
                    gender_mixed: false
                });
            }
            
            return rooms;
        }

        function getRoomCapacity(roomType) {
            const capacities = {
                'quad': 4,
                'triple': 3,
                'double': 2
            };
            return capacities[roomType] || 2;
        }

        function getRoomTypeByCapacity(memberCount) {
            if (memberCount >= 4) return 'quad';
            if (memberCount === 3) return 'triple';
            return 'double';
        }

        function showRoomListResult(group, allocation) {
            // Create modal for room list result
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1200px; width: 95%;">
                    <div class="modal-header">
                        <h3> Room List Generated - ${group.name}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        ${generateRoomListHTML(allocation, group)}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin: 20px; padding-top: 20px; border-top: 1px solid rgba(71, 85, 105, 0.3);">
                        <button class="btn btn-success" onclick="exportRoomListToExcel(${JSON.stringify(allocation).replace(/"/g, '&quot;')}, '${group.name}')">
                            <span class="material-icons">download</span>
                            Export to Excel
                        </button>
                        <button class="btn btn-primary" onclick="applyRoomList(${group.id}, ${JSON.stringify(allocation).replace(/"/g, '&quot;')})">
                            <span class="material-icons">check_circle</span>
                            Apply Room List
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            <span class="material-icons">close</span>
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function generateRoomListHTML(allocation, group) {
            let html = `
                <!-- Summary Section -->
                <div style="background: rgba(30, 41, 59, 0.4); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;"> Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Total Jamaah</div>
                            <div style="color: #f8fafc; font-size: 18px; font-weight: 600;">${allocation.summary.total_jamaah} orang</div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Total Keluarga</div>
                            <div style="color: #f8fafc; font-size: 18px; font-weight: 600;">${allocation.summary.total_families} family</div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Total Kamar</div>
                            <div style="color: #f8fafc; font-size: 18px; font-weight: 600;">${allocation.summary.total_rooms} kamar</div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">Room Types</div>
                            <div style="color: #f8fafc; font-size: 14px;">
                                Quad: ${allocation.summary.room_types.quad} | 
                                Triple: ${allocation.summary.room_types.triple} | 
                                Double: ${allocation.summary.room_types.double}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Hotel sections
            Object.keys(allocation.hotels).forEach(hotelName => {
                const hotel = allocation.hotels[hotelName];
                html += generateHotelRoomListHTML(hotelName, hotel);
            });

            return html;
        }

        function generateHotelRoomListHTML(hotelName, hotel) {
            let html = `
                <div style="background: rgba(15, 23, 42, 0.6); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                    <h4 style="color: #10b981; margin-bottom: 15px; display: flex; align-items: center;">
                        <span class="material-icons" style="margin-right: 8px;">hotel</span>
                        ${hotelName}
                    </h4>
                    
                    <div style="display: grid; gap: 15px;">
            `;

            // Room cards
            hotel.rooms.forEach((room, index) => {
                const roomNumber = index + 1;
                html += `
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 15px; border-radius: 8px; border: 1px solid rgba(71, 85, 105, 0.3);">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="color: #f8fafc; font-weight: 600; font-size: 16px;">Room ${roomNumber} (${room.type.toUpperCase()})</div>
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px; margin-top: 2px;">
                                    Main Family: ${room.main_family} | ${room.gender || 'Mixed Gender'}
                                    ${room.special_request ? ` | ${room.special_request}` : ''}
                                    ${room.gender_mixed ? ' |  Mixed Gender (Family Request)' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #10b981; font-weight: 600;">${room.occupants.length}/${room.capacity}</div>
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 10px;">orang</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${room.occupants.map(occupant => `
                                <div style="background: rgba(71, 85, 105, 0.3); padding: 8px; border-radius: 6px;">
                                    <div style="color: #f8fafc; font-weight: 500; font-size: 13px;">${occupant.name}</div>
                                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 11px;">
                                        ${occupant.gender === 'male' ? '' : ''} 
                                        <strong>${occupant.gender === 'male' ? 'L' : 'P'}</strong> | 
                                        <span style="background: rgba(59, 130, 246, 0.15); color: #60a5fa; padding: 1px 4px; border-radius: 3px; font-size: 9px; font-weight: 600;">
                                            ${(occupant.room_preference || 'quad').toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 10px; margin-top: 2px;">
                                        ${occupant.family_role || 'Individual'} | Born: ${formatBirthDate(occupant.birth_date)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Room Management Functions
        function openRoomManagement(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;
            
            // Set modal title with sub-group information
            let titleText = `Room List - ${group.name}`;
            if (group.sub_groups && group.sub_groups.length > 0) {
                titleText += ` (${group.sub_groups.length} Sub Grup Hotel)`;
            }
            document.getElementById('roomModalTitle').textContent = titleText;
            
            // Generate room data for this group
            generateRoomsForGroup(groupId);
            
            // Load room interface
            loadRoomManagement(groupId);
            
            // Open modal
            openModal('roomModal');
        }

        function generateRoomsForGroup(groupId) {
            const group = groupData.find(g => g.id === groupId);
            if (!group) return;
            
            // Get jamaah in this group (simulate from jamaahData)
            const groupJamaah = jamaahData.filter(j => j.id <= group.current_members).map((j, index) => ({
                ...j,
                id: index + 1,
                group_id: groupId,
                room_preference: ['double', 'triple', 'quad'][Math.floor(Math.random() * 3)],
                gender: index % 2 === 0 ? 'male' : 'female',
                family_group: index < 4 ? 'FAM001' : index < 8 ? 'FAM002' : null,
                room_number: null,
                bed_assignment: null
            }));
            
            // Store current group jamaah
            window.currentGroupJamaah = groupJamaah;
            
            // Generate initial room structure
            currentGroupRooms = [];
            
            // Calculate needed rooms based on preferences
            const maleJamaah = groupJamaah.filter(j => j.gender === 'male');
            const femaleJamaah = groupJamaah.filter(j => j.gender === 'female');
            
            let roomNumber = 1;
            
            // Generate rooms for males
            roomNumber = generateRoomsForGender(maleJamaah, 'male', roomNumber);
            
            // Generate rooms for females  
            generateRoomsForGender(femaleJamaah, 'female', roomNumber);
        }

        function generateRoomsForGender(jamaahList, gender, startRoomNumber) {
            let roomNumber = startRoomNumber;
            const preferences = {};
            
            // Count preferences
            jamaahList.forEach(j => {
                preferences[j.room_preference] = (preferences[j.room_preference] || 0) + 1;
            });
            
            // Generate quad rooms first
            const quadNeeded = Math.ceil(preferences.quad / 4) || 0;
            for (let i = 0; i < quadNeeded; i++) {
                currentGroupRooms.push(createRoom(roomNumber++, 'quad', gender));
            }
            
            // Generate triple rooms
            const tripleNeeded = Math.ceil(preferences.triple / 3) || 0;
            for (let i = 0; i < tripleNeeded; i++) {
                currentGroupRooms.push(createRoom(roomNumber++, 'triple', gender));
            }
            
            // Generate double rooms
            const doubleNeeded = Math.ceil(preferences.double / 2) || 0;
            for (let i = 0; i < doubleNeeded; i++) {
                currentGroupRooms.push(createRoom(roomNumber++, 'double', gender));
            }
            
            // Add extra rooms if needed
            const totalCapacity = (quadNeeded * 4) + (tripleNeeded * 3) + (doubleNeeded * 2);
            if (totalCapacity < jamaahList.length) {
                const extraNeeded = Math.ceil((jamaahList.length - totalCapacity) / 2);
                for (let i = 0; i < extraNeeded; i++) {
                    currentGroupRooms.push(createRoom(roomNumber++, 'double', gender));
                }
            }
            
            return roomNumber;
        }

        function createRoom(number, type, gender) {
            const capacity = {
                'single': 1,
                'double': 2, 
                'triple': 3,
                'quad': 4
            };
            
            return {
                id: `room_${number}`,
                number: `${number.toString().padStart(3, '0')}`,
                type: type,
                gender: gender,
                capacity: capacity[type],
                occupants: [],
                isEmpty: true
            };
        }

        function loadRoomManagement(groupId) {
            // Update statistics
            updateRoomStatistics();
            
            // Load unassigned jamaah
            loadUnassignedJamaah();
            
            // Load room grid
            loadRoomGrid();
        }

        function updateRoomStatistics() {
            const totalRooms = currentGroupRooms.length;
            const occupiedRooms = currentGroupRooms.filter(r => r.occupants.length > 0).length;
            const assignedJamaah = currentGroupRooms.reduce((sum, r) => sum + r.occupants.length, 0);
            const unassignedJamaah = window.currentGroupJamaah ? window.currentGroupJamaah.filter(j => !j.room_number).length : 0;
            
            document.getElementById('totalRooms').textContent = totalRooms;
            document.getElementById('occupiedRooms').textContent = occupiedRooms;
            document.getElementById('assignedJamaah').textContent = assignedJamaah;
            document.getElementById('unassignedJamaah').textContent = unassignedJamaah;
            document.getElementById('unassignedCount').textContent = unassignedJamaah;
        }

        function loadUnassignedJamaah() {
            const container = document.getElementById('unassignedList');
            container.innerHTML = '';
            
            if (!window.currentGroupJamaah) return;
            
            const unassigned = window.currentGroupJamaah.filter(j => !j.room_number);
            
            unassigned.forEach(jamaah => {
                const item = document.createElement('div');
                item.className = 'unassigned-item';
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 500; color: #f8fafc; font-size: 13px;">${jamaah.name}</div>
                        <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6);">
                            ${jamaah.gender === 'male' ? '' : ''} 
                            <strong>${jamaah.gender === 'male' ? 'L' : 'P'}</strong> | 
                            Beli: <span style="color: #60a5fa; font-weight: 600;">${(jamaah.room_preference || 'quad').toUpperCase()}</span>
                            ${jamaah.family_group ? ` | Family: ${jamaah.family_group}` : ''}
                        </div>
                    </div>
                    <div class="room-type ${jamaah.room_preference || 'quad'}">${(jamaah.room_preference || 'quad').toUpperCase()}</div>
                `;
                
                item.addEventListener('click', () => {
                    item.classList.toggle('selected');
                });
                
                container.appendChild(item);
            });
        }

        function loadRoomGrid() {
            const container = document.getElementById('roomGrid');
            container.innerHTML = '';
            
            currentGroupRooms.forEach(room => {
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-header">
                        <div class="room-number">Room ${room.number}</div>
                        <div class="room-type ${room.type}">${room.type}</div>
                    </div>
                    
                    <div class="room-occupants">
                        ${generateOccupantsHTML(room)}
                        ${generateEmptyBedsHTML(room)}
                    </div>
                    
                    <div class="room-actions">
                        <button class="btn btn-primary" onclick="assignToRoom('${room.id}')">
                            <span class="material-icons">person_add</span>
                            Assign
                        </button>
                        <button class="btn btn-warning" onclick="editRoom('${room.id}')">
                            <span class="material-icons">edit</span>
                            Edit
                        </button>
                        <button class="btn btn-danger" onclick="clearRoom('${room.id}')">
                            <span class="material-icons">clear</span>
                            Clear
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function generateOccupantsHTML(room) {
            return room.occupants.map((occupant, index) => `
                <div class="occupant-item">
                    <div class="occupant-info">
                        <div class="occupant-name">${occupant.name}</div>
                        <div class="occupant-details">
                            ${occupant.gender === 'male' ? '' : ''} 
                            <strong>${occupant.gender === 'male' ? 'L' : 'P'}</strong> | 
                            <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;">
                                ${(occupant.room_preference || 'quad').toUpperCase()}
                            </span> | 
                            ${occupant.phone}
                        </div>
                    </div>
                    <div class="bed-assignment">Bed ${index + 1}</div>
                </div>
            `).join('');
        }

        function generateEmptyBedsHTML(room) {
            const emptyBeds = room.capacity - room.occupants.length;
            let html = '';
            
            for (let i = 0; i < emptyBeds; i++) {
                html += `<div class="empty-bed">Empty Bed ${room.occupants.length + i + 1}</div>`;
            }
            
            return html;
        }

        function selectAllocationStrategy(strategy) {
            selectedAllocationStrategy = strategy;
            
            // Update UI
            document.querySelectorAll('.allocation-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-strategy="${strategy}"]`).classList.add('active');
        }

        function autoAllocateRooms() {
            if (!window.currentGroupJamaah) return;
            
            // Clear existing assignments
            clearAllRooms();
            
            const unassigned = [...window.currentGroupJamaah];
            
            // Sort by strategy
            switch (selectedAllocationStrategy) {
                case 'family':
                    allocateByFamily(unassigned);
                    break;
                case 'preference':
                    allocateByPreference(unassigned);
                    break;
                case 'auto':
                default:
                    allocateSmartly(unassigned);
                    break;
            }
            
            // Refresh display
            loadRoomManagement();
            showNotification('Rooms allocated successfully!');
        }

        function allocateSmartly(jamaahList) {
            // First try to allocate by preference, then fallback to simple allocation
            allocateByPreference(jamaahList);
            
            // Check for any unassigned jamaah and allocate them to available rooms
            const unassigned = jamaahList.filter(j => !j.room_number);
            if (unassigned.length > 0) {
                console.log(`Found ${unassigned.length} unassigned jamaah, allocating to available rooms`);
                
                // Separate by gender
                const males = unassigned.filter(j => j.gender === 'male');
                const females = unassigned.filter(j => j.gender === 'female');
                
                // Allocate males
                allocateGenderGroupFallback(males, 'male');
                
                // Allocate females
                allocateGenderGroupFallback(females, 'female');
            }
        }

        function allocateGenderGroupFallback(jamaahList, gender) {
            // Find rooms with available capacity for this gender
            const availableRooms = currentGroupRooms.filter(r => 
                r.gender === gender && r.occupants.length < r.capacity
            ).sort((a, b) => {
                // Prioritize rooms that match jamaah preferences
                const aHasMatchingPreference = jamaahList.some(j => j.room_preference === a.type);
                const bHasMatchingPreference = jamaahList.some(j => j.room_preference === b.type);
                if (aHasMatchingPreference && !bHasMatchingPreference) return -1;
                if (!aHasMatchingPreference && bHasMatchingPreference) return 1;
                // Then by available space (fill partially occupied rooms first)
                return b.occupants.length - a.occupants.length;
            });
            
            let jamaahIndex = 0;
            
            // Fill rooms based on capacity
            availableRooms.forEach(room => {
                while (room.occupants.length < room.capacity && jamaahIndex < jamaahList.length) {
                    const jamaah = jamaahList[jamaahIndex];
                    room.occupants.push(jamaah);
                    jamaah.room_number = room.number;
                    jamaah.bed_assignment = `Bed ${room.occupants.length}`;
                    jamaahIndex++;
                }
            });
        }

        function allocateByFamily(jamaahList) {
            // Group by family first, then by gender
            const families = {};
            const singles = [];
            
            jamaahList.forEach(jamaah => {
                if (jamaah.family_group) {
                    if (!families[jamaah.family_group]) {
                        families[jamaah.family_group] = [];
                    }
                    families[jamaah.family_group].push(jamaah);
                } else {
                    singles.push(jamaah);
                }
            });
            
            // Allocate families first
            Object.values(families).forEach(family => {
                allocateGenderGroup(family.filter(j => j.gender === 'male'), 'male');
                allocateGenderGroup(family.filter(j => j.gender === 'female'), 'female');
            });
            
            // Then allocate singles
            allocateSmartly(singles);
        }

        function allocateByPreference(jamaahList) {
            // Group by gender and preference
            const groups = {
                'male': { 'quad': [], 'triple': [], 'double': [] },
                'female': { 'quad': [], 'triple': [], 'double': [] }
            };
            
            jamaahList.forEach(jamaah => {
                // Default to quad if no preference is set
                const preference = jamaah.room_preference || 'quad';
                if (groups[jamaah.gender] && groups[jamaah.gender][preference]) {
                    groups[jamaah.gender][preference].push(jamaah);
                }
            });
            
            // Allocate by preference
            ['male', 'female'].forEach(gender => {
                ['quad', 'triple', 'double'].forEach(preference => {
                    const preferenceGroup = groups[gender][preference];
                    const preferredRooms = currentGroupRooms.filter(r => r.gender === gender && r.type === preference);
                    
                    let jamaahIndex = 0;
                    preferredRooms.forEach(room => {
                        while (room.occupants.length < room.capacity && jamaahIndex < preferenceGroup.length) {
                            const jamaah = preferenceGroup[jamaahIndex];
                            room.occupants.push(jamaah);
                            jamaah.room_number = room.number;
                            jamaah.bed_assignment = `Bed ${room.occupants.length}`;
                            jamaahIndex++;
                        }
                    });
                });
            });
        }

        function clearAllRooms() {
            currentGroupRooms.forEach(room => {
                room.occupants.forEach(occupant => {
                    occupant.room_number = null;
                    occupant.bed_assignment = null;
                });
                room.occupants = [];
            });
            
            loadRoomManagement();
        }

        function clearRoom(roomId) {
            const room = currentGroupRooms.find(r => r.id === roomId);
            if (room) {
                room.occupants.forEach(occupant => {
                    occupant.room_number = null;
                    occupant.bed_assignment = null;
                });
                room.occupants = [];
                loadRoomManagement();
            }
        }

        function assignToRoom(roomId) {
            const selectedJamaah = document.querySelectorAll('.unassigned-item.selected');
            if (selectedJamaah.length === 0) {
                showNotification('Pilih jamaah yang akan ditempatkan', 'error');
                return;
            }
            
            const room = currentGroupRooms.find(r => r.id === roomId);
            if (!room) return;
            
            if (room.occupants.length >= room.capacity) {
                showNotification('Kamar sudah penuh', 'error');
                return;
            }
            
            // Process selected jamaah
            selectedJamaah.forEach(item => {
                if (room.occupants.length < room.capacity) {
                    const jamaahName = item.querySelector('.occupant-name, div[style*="font-weight: 500"]')?.textContent;
                    const jamaah = window.currentGroupJamaah.find(j => j.name === jamaahName);
                    
                    if (jamaah && !jamaah.room_number) {
                        room.occupants.push(jamaah);
                        jamaah.room_number = room.number;
                        jamaah.bed_assignment = `Bed ${room.occupants.length}`;
                    }
                }
            });
            
            loadRoomManagement();
            showNotification('Jamaah berhasil ditempatkan ke kamar');
        }

        function editRoom(roomId) {
            showNotification('Fitur edit room akan segera tersedia');
        }

        function saveRoomAssignments() {
            showNotification('Room assignments saved successfully!');
            closeModal('roomModal');
        }

        function exportRoomList() {
            // Create Excel-like data structure
            const data = [
                ['Room Number', 'Room Type', 'Gender', 'Occupant 1', 'Occupant 2', 'Occupant 3', 'Occupant 4']
            ];
            
            currentGroupRooms.forEach(room => {
                const row = [
                    room.number,
                    room.type.toUpperCase(),
                    room.gender.toUpperCase()
                ];
                
                // Add occupants
                for (let i = 0; i < 4; i++) {
                    row.push(room.occupants[i] ? room.occupants[i].name : '');
                }
                
                data.push(row);
            });
            
            // Create and download Excel file
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Room List');
            XLSX.writeFile(wb, 'room_list.xlsx');
            
            showNotification('Room list exported successfully!');
        }

        // Reports
        function loadReportCharts() {
            // Trend chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Registrasi',
                        data: [120, 190, 300, 250, 180, 220],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { 
                                color: 'white',
                                font: { size: 12 }
                            } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            } 
                        },
                        y: { 
                            ticks: { 
                                color: 'white',
                                font: { size: 11 }
                            } 
                        }
                    }
                }
            });

            // Status chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Terverifikasi', 'Pending', 'Ditolak'],
                    datasets: [{
                        data: [1089, 158, 23],
                        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { 
                                color: 'white',
                                font: { size: 11 }
                            } 
                        }
                    }
                }
            });
        }

        function generateReport(type) {
            showNotification(`Generating laporan ${type}...`);
            
            // Simulate report generation
            setTimeout(() => {
                showNotification(`Laporan ${type} berhasil dibuat!`);
            }, 2000);
        }

        // Excel Functions
        function downloadTemplate(type) {
            let templateData = [];
            let filename = '';

            switch(type) {
                case 'jamaah':
                    templateData = [
                        ['Nama Lengkap', 'NIK', 'Tanggal Lahir', 'Tempat Lahir', 'Jenis Kelamin', 'No. Telepon', 'Email', 'Alamat', 'No. Paspor', 'Paket ID'],
                        ['Ahmad Fauzi', '1234567890123456', '1985-05-15', 'Jakarta', 'L', '081234567890', 'ahmad@email.com', 'Jl. Merdeka No. 123', 'A1234567', '1']
                    ];
                    filename = 'template_jamaah.xlsx';
                    break;
                case 'package':
                    templateData = [
                        ['Nama Paket', 'Harga', 'Tanggal Keberangkatan', 'Durasi', 'Kuota', 'Hotel Makkah', 'Hotel Madinah', 'Malam Makkah', 'Malam Madinah', 'Maskapai'],
                        ['Umroh Ramadhan 2024', '25000000', '2024-03-15', '14', '45', 'Hilton Makkah', 'Pullman Madinah', '7', '7', 'Emirates']
                    ];
                    filename = 'template_paket.xlsx';
                    break;
                case 'payment':
                    templateData = [
                        ['Jamaah ID', 'Jumlah', 'Tanggal', 'Metode', 'Bank', 'No. Referensi'],
                        ['1', '15000000', '2024-01-15', 'Transfer Bank', 'BCA', 'TRF20240115001']
                    ];
                    filename = 'template_pembayaran.xlsx';
                    break;
            }

            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, filename);
            
            showNotification(`Template ${type} berhasil didownload!`);
        }

        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, {type: 'binary'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // Process imported data
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let errors = [];

                    rows.forEach((row, index) => {
                        try {
                            // Validate and process each row
                            if (row.length >= headers.length - 1) {
                                successCount++;
                            } else {
                                errorCount++;
                                errors.push(`Baris ${index + 2}: Data tidak lengkap`);
                            }
                        } catch (error) {
                            errorCount++;
                            errors.push(`Baris ${index + 2}: ${error.message}`);
                        }
                    });

                    // Show import results
                    const resultsDiv = document.getElementById('importResults');
                    const contentDiv = document.getElementById('importResultsContent');
                    
                    contentDiv.innerHTML = `
                        <div class="glass-card">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div class="stat-card">
                                    <div class="stat-number" style="color: #22c55e;">${successCount}</div>
                                    <div class="stat-label">Berhasil</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" style="color: #ef4444;">${errorCount}</div>
                                    <div class="stat-label">Error</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${rows.length}</div>
                                    <div class="stat-label">Total</div>
                                </div>
                            </div>
                            ${errors.length > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 15px;">
                                    <h4 style="color: #ef4444; margin-bottom: 10px;">Error Details:</h4>
                                    <ul style="color: rgba(255, 255, 255, 0.8); margin-left: 20px;">
                                        ${errors.map(error => `<li>${error}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    resultsDiv.style.display = 'block';
                    showNotification('Import Excel selesai!');
                    
                } catch (error) {
                    showNotification('Error membaca file Excel!', 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        function exportToExcel(type) {
            let data = [];
            let filename = '';

            switch(type) {
                case 'jamaah':
                    data = jamaahData.map(j => [
                        j.name, j.nik, j.phone, j.email, j.passport_number || 'Belum ada', j.package, 
                        getStatusText(j.status), j.total_paid
                    ]);
                    data.unshift(['Nama', 'NIK', 'Telepon', 'Email', 'No. Paspor', 'Paket', 'Status', 'Total Bayar']);
                    filename = 'data_jamaah.xlsx';
                    break;
                case 'package':
                    data = packageData.map(p => [
                        p.name, p.price, p.departure_date, p.duration, p.quota, p.booked,
                        p.makkah_hotel, p.madinah_hotel, p.airline
                    ]);
                    data.unshift(['Nama', 'Harga', 'Keberangkatan', 'Durasi', 'Kuota', 'Terdaftar', 'Hotel Makkah', 'Hotel Madinah', 'Maskapai']);
                    filename = 'data_paket.xlsx';
                    break;
                case 'payment':
                    data = paymentData.map(p => [
                        p.id, p.reference, p.jamaah_name, p.package, p.amount, p.date, p.method, p.bank, getStatusText(p.status)
                    ]);
                    data.unshift(['ID', 'No. Referensi', 'Jamaah', 'Paket', 'Jumlah', 'Tanggal', 'Metode', 'Bank', 'Status']);
                    filename = 'data_pembayaran.xlsx';
                    break;
                case 'manifest':
                    exportManifest();
                    return;
                case 'all':
                    // Create workbook with multiple sheets
                    const wb = XLSX.utils.book_new();
                    
                    // Jamaah sheet
                    const jamaahData2D = jamaahData.map(j => [j.name, j.nik, j.phone, j.email, j.passport_number || 'Belum ada', j.package, getStatusText(j.status), j.total_paid]);
                    jamaahData2D.unshift(['Nama', 'NIK', 'Telepon', 'Email', 'No. Paspor', 'Paket', 'Status', 'Total Bayar']);
                    const wsJamaah = XLSX.utils.aoa_to_sheet(jamaahData2D);
                    XLSX.utils.book_append_sheet(wb, wsJamaah, 'Jamaah');
                    
                    // Package sheet
                    const packageData2D = packageData.map(p => [p.code, p.name, p.price, p.departure_date, p.duration, p.quota, p.booked]);
                    packageData2D.unshift(['Kode', 'Nama', 'Harga', 'Keberangkatan', 'Durasi', 'Kuota', 'Terdaftar']);
                    const wsPackage = XLSX.utils.aoa_to_sheet(packageData2D);
                    XLSX.utils.book_append_sheet(wb, wsPackage, 'Paket');
                    
                    // Payment sheet
                    const paymentData2D = paymentData.map(p => [p.id, p.reference, p.jamaah_name, p.package, p.amount, p.date, p.method, p.bank, getStatusText(p.status)]);
                    paymentData2D.unshift(['ID', 'No. Referensi', 'Jamaah', 'Paket', 'Jumlah', 'Tanggal', 'Metode', 'Bank', 'Status']);
                    const wsPayment = XLSX.utils.aoa_to_sheet(paymentData2D);
                    XLSX.utils.book_append_sheet(wb, wsPayment, 'Pembayaran');
                    
                    XLSX.writeFile(wb, 'data_umroh_lengkap.xlsx');
                    showNotification('Semua data berhasil diekspor!');
                    return;
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, filename);
            
            showNotification(`Data ${type} berhasil diekspor!`);
        }

        // Manifest Export Function
        function exportManifest(groupId = null) {
            // Get all jamaah for the specified group or all if no group specified
            let jamaahList = jamaahData;
            let groupInfo = null;
            
            if (groupId) {
                groupInfo = groupData.find(g => g.id === groupId);
                jamaahList = jamaahData.filter(j => j.group_id === groupId);
            }
            
            if (jamaahList.length === 0) {
                showNotification('Tidak ada data jamaah untuk diekspor!', 'error');
                return;
            }
            
            // Create manifest data structure
            const manifestData = [];
            
            // Get package and airline information
            let packageInfo = null;
            let airlineCode = '';
            let packageCode = '';
            
            if (groupInfo) {
                // Find package info from group
                packageInfo = packageData.find(p => p.name === groupInfo.package);
            } else if (jamaahList.length > 0) {
                // Get package info from first jamaah if no specific group
                packageInfo = packageData.find(p => p.name === jamaahList[0].package);
            }
            
            if (packageInfo) {
                // Extract airline code (first 2-3 characters of airline name or use airline field)
                airlineCode = packageInfo.airline_code || packageInfo.airline?.substring(0, 3).toUpperCase() || 'XXX';
                packageCode = packageInfo.code || `PKG${packageInfo.id.toString().padStart(3, '0')}`;
            }
            
            // Header Information with Airline and Package Codes
            manifestData.push(['MANIFEST JAMAAH UMROH']);
            manifestData.push(['']);
            manifestData.push(['KODE MASKAPAI:', airlineCode]);
            manifestData.push(['KODE PAKET:', packageCode]);
            manifestData.push(['']);
            
            if (groupInfo) {
                manifestData.push(['INFORMASI GRUP']);
                manifestData.push(['Nama Grup:', groupInfo.name]);
                manifestData.push(['Paket:', groupInfo.package]);
                manifestData.push(['Tanggal Keberangkatan:', formatDate(groupInfo.departure_date)]);
                manifestData.push(['Bus:', groupInfo.bus_number]);
                manifestData.push(['Waktu Kumpul:', groupInfo.meeting_time]);
                manifestData.push(['Tempat Kumpul:', groupInfo.meeting_point]);
                manifestData.push(['Total Jamaah:', jamaahList.length]);
                manifestData.push(['']);
            }
            
            manifestData.push(['DAFTAR JAMAAH']);
            manifestData.push(['']);
            
            // Table headers - Format sesuai manifest standar
            manifestData.push([
                'NO',
                'NAME PASSPORT',
                'SEX',
                'PLACE OF BIRTH',
                'DATE OF BIRTH',
                'AGE',
                'NO PASSPORT',
                'DATE OF ISSUED',
                'DATE OF EXPIRED',
                'PLACE OF ISSUED',
                'FIRST NAME'
            ]);
            
            // Jamaah data rows - Format sesuai manifest standar
            jamaahList.forEach((jamaah, index) => {
                const age = jamaah.birth_date ? calculateAge(jamaah.birth_date) : 0;
                
                // Format tanggal untuk passport issued dan expired
                const passportIssued = jamaah.passport_issue_date ? formatDateForManifest(jamaah.passport_issue_date) : '';
                const passportExpired = jamaah.passport_expire_date ? formatDateForManifest(jamaah.passport_expire_date) : '';
                const birthDate = jamaah.birth_date ? formatDateForManifest(jamaah.birth_date) : '';
                
                manifestData.push([
                    index + 1,                                          // NO
                    jamaah.passport_name || jamaah.name || '',         // NAME PASSPORT
                    jamaah.gender === 'male' ? 'M' : 'F',              // SEX
                    jamaah.birth_place || '',                          // PLACE OF BIRTH
                    birthDate,                                         // DATE OF BIRTH
                    age,                                               // AGE
                    jamaah.passport_number || '',                      // NO PASSPORT
                    passportIssued,                                    // DATE OF ISSUED
                    passportExpired,                                   // DATE OF EXPIRED
                    jamaah.passport_city || '',                        // PLACE OF ISSUED
                    jamaah.name ? jamaah.name.split(' ')[0] : ''       // FIRST NAME
                ]);
            });
            
            // Summary section
            manifestData.push(['']);
            manifestData.push(['RINGKASAN']);
            manifestData.push(['Total Jamaah:', jamaahList.length]);
            manifestData.push(['Laki-laki:', jamaahList.filter(j => j.gender === 'male').length]);
            manifestData.push(['Perempuan:', jamaahList.filter(j => j.gender === 'female').length]);
            manifestData.push(['Sudah Lunas:', jamaahList.filter(j => j.payment_status === 'paid').length]);
            manifestData.push(['Belum Lunas:', jamaahList.filter(j => j.payment_status !== 'paid').length]);
            manifestData.push(['Dokumen Lengkap:', jamaahList.filter(j => j.document_status === 'approved').length]);
            manifestData.push(['Visa Approved:', jamaahList.filter(j => j.visa_status === 'approved').length]);
            
            // Room allocation summary
            manifestData.push(['']);
            manifestData.push(['ALOKASI KAMAR']);
            const roomPreferences = jamaahList.reduce((acc, j) => {
                const pref = j.room_preference || 'quad';
                acc[pref] = (acc[pref] || 0) + 1;
                return acc;
            }, {});
            
            Object.entries(roomPreferences).forEach(([type, count]) => {
                manifestData.push([`Kamar ${type.charAt(0).toUpperCase() + type.slice(1)}:`, count]);
            });
            
            // Export to Excel
            const filename = groupInfo ? 
                `manifest-${groupInfo.name.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.xlsx` :
                `manifest-all-jamaah-${new Date().toISOString().slice(0,10)}.xlsx`;
                
            const ws = XLSX.utils.aoa_to_sheet(manifestData);
            
            // Set column widths for better formatting - Format manifest standar
            const wscols = [
                {wch: 5},   // NO
                {wch: 30},  // NAME PASSPORT
                {wch: 5},   // SEX
                {wch: 20},  // PLACE OF BIRTH
                {wch: 15},  // DATE OF BIRTH
                {wch: 5},   // AGE
                {wch: 15},  // NO PASSPORT
                {wch: 15},  // DATE OF ISSUED
                {wch: 15},  // DATE OF EXPIRED
                {wch: 20},  // PLACE OF ISSUED
                {wch: 20}   // FIRST NAME
            ];
            ws['!cols'] = wscols;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Manifest');
            XLSX.writeFile(wb, filename);
            
            showNotification(`Manifest berhasil diekspor! (${jamaahList.length} jamaah)`, 'success');
        }
        
        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            
            // Handle ddmmyyyy format
            let dateObj;
            if (birthDate.length === 8 && !birthDate.includes('-')) {
                const day = birthDate.substring(0, 2);
                const month = birthDate.substring(2, 4);
                const year = birthDate.substring(4, 8);
                dateObj = new Date(`${year}-${month}-${day}`);
            } else {
                dateObj = new Date(birthDate);
            }
            
            const today = new Date();
            let age = today.getFullYear() - dateObj.getFullYear();
            const monthDiff = today.getMonth() - dateObj.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dateObj.getDate())) {
                age--;
            }
            return age;
        }
        
        function formatDateForManifest(dateString) {
            if (!dateString) return '';
            
            let dateObj;
            // Handle ddmmyyyy format
            if (dateString.length === 8 && !dateString.includes('-')) {
                const day = dateString.substring(0, 2);
                const month = dateString.substring(2, 4);
                const year = dateString.substring(4, 8);
                dateObj = new Date(`${year}-${month}-${day}`);
            } else {
                dateObj = new Date(dateString);
            }
            
            if (isNaN(dateObj.getTime())) return dateString;
            
            // Format as DD-MM-YYYY for manifest
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            return `${day}-${month}-${year}`;
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Focus trap - focus on the modal
                modal.focus();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto'; // Restore background scrolling
                
                // Clear any form data if it's a form modal
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        }

        // Function to close any active modal
        function closeActiveModal() {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Date utility functions for ddmmyyyy format
        function formatBirthDate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return ddmmyyyy;
            
            const day = ddmmyyyy.substring(0, 2);
            const month = ddmmyyyy.substring(2, 4);
            const year = ddmmyyyy.substring(4, 8);
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 
                              'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthIndex = parseInt(month) - 1;
            const monthName = monthNames[monthIndex] || month;
            
            return `${day} ${monthName} ${year}`;
        }

        function validateBirthDate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return false;
            
            const day = parseInt(ddmmyyyy.substring(0, 2));
            const month = parseInt(ddmmyyyy.substring(2, 4));
            const year = parseInt(ddmmyyyy.substring(4, 8));
            
            // Basic validation
            if (day < 1 || day > 31) return false;
            if (month < 1 || month > 12) return false;
            if (year < 1900 || year > new Date().getFullYear()) return false;
            
            // Check if date is valid
            const testDate = new Date(year, month - 1, day);
            return testDate.getFullYear() === year && 
                   testDate.getMonth() === month - 1 && 
                   testDate.getDate() === day;
        }

        function convertToISODate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return '';
            
            const day = ddmmyyyy.substring(0, 2);
            const month = ddmmyyyy.substring(2, 4);
            const year = ddmmyyyy.substring(4, 8);
            
            return `${year}-${month}-${day}`;
        }

        // Passport form functions
        function togglePassportName(checkbox) {
            const passportNameInput = document.getElementById('jamaahPassportName');
            const ktpNameInput = document.getElementById('jamaahName');
            
            if (checkbox.checked) {
                passportNameInput.value = ktpNameInput.value;
                passportNameInput.readOnly = true;
                passportNameInput.style.backgroundColor = 'rgba(71, 85, 105, 0.3)';
            } else {
                passportNameInput.readOnly = false;
                passportNameInput.style.backgroundColor = '';
            }
        }

        function validatePassportDate(ddmmyyyy) {
            if (!ddmmyyyy || ddmmyyyy.length !== 8) return false;
            
            const day = parseInt(ddmmyyyy.substring(0, 2));
            const month = parseInt(ddmmyyyy.substring(2, 4));
            const year = parseInt(ddmmyyyy.substring(4, 8));
            
            // Basic validation
            if (day < 1 || day > 31) return false;
            if (month < 1 || month > 12) return false;
            if (year < 1900 || year > 2100) return false; // Allow future dates for passport expiry
            
            // Check if date is valid
            const testDate = new Date(year, month - 1, day);
            return testDate.getFullYear() === year && 
                   testDate.getMonth() === month - 1 && 
                   testDate.getDate() === day;
        }

        function formatDateInput(inputElement) {
            inputElement.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                
                if (value.length > 8) {
                    value = value.slice(0, 8);
                }
                
                e.target.value = value;
                
                // Real-time validation feedback
                if (value.length === 8) {
                    if (validatePassportDate(value)) {
                        e.target.style.borderColor = '#10b981';
                        e.target.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                    } else {
                        e.target.style.borderColor = '#ef4444';
                        e.target.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
                    }
                } else {
                    e.target.style.borderColor = '';
                    e.target.style.backgroundColor = '';
                }
            });
            
            inputElement.addEventListener('blur', function(e) {
                const value = e.target.value;
                if (value.length === 8 && validatePassportDate(value)) {
                    const formatted = formatBirthDate(value);
                    e.target.title = `Tanggal: ${formatted}`;
                }
            });
        }

        // Date Input Toggle Functions
        function toggleDateInput(fieldId) {
            const manualInput = document.getElementById(fieldId);
            const pickerInput = document.getElementById(fieldId + 'Picker');
            const toggleBtn = manualInput.parentElement.querySelector('.date-toggle-btn');
            
            if (manualInput.style.display === 'none') {
                // Switch to manual input
                manualInput.style.display = 'block';
                pickerInput.style.display = 'none';
                toggleBtn.classList.remove('active');
                manualInput.focus();
            } else {
                // Switch to date picker
                manualInput.style.display = 'none';
                pickerInput.style.display = 'block';
                toggleBtn.classList.add('active');
                pickerInput.focus();
                
                // Convert manual input to date picker if valid
                if (manualInput.value.length === 8) {
                    const ddmmyyyy = manualInput.value;
                    const isoDate = convertToISODate(ddmmyyyy);
                    if (isoDate) {
                        pickerInput.value = isoDate;
                    }
                }
            }
        }

        function convertToISODate(ddmmyyyy) {
            if (ddmmyyyy.length !== 8) return null;
            
            const day = ddmmyyyy.substring(0, 2);
            const month = ddmmyyyy.substring(2, 4);
            const year = ddmmyyyy.substring(4, 8);
            
            // Validate date components
            if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
                return null;
            }
            
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        function convertFromISODate(isoDate) {
            if (!isoDate) return '';
            
            const dateParts = isoDate.split('-');
            if (dateParts.length !== 3) return '';
            
            const year = dateParts[0];
            const month = dateParts[1];
            const day = dateParts[2];
            
            return `${day}${month}${year}`;
        }

        function setupDateInputSync() {
            const dateFields = ['jamaahBirthDate', 'jamaahPassportIssueDate', 'jamaahPassportExpireDate'];
            
            dateFields.forEach(fieldId => {
                const manualInput = document.getElementById(fieldId);
                const pickerInput = document.getElementById(fieldId + 'Picker');
                
                if (manualInput && pickerInput) {
                    // Manual input changes update picker
                    manualInput.addEventListener('input', function() {
                        if (this.value.length === 8) {
                            const isoDate = convertToISODate(this.value);
                            if (isoDate) {
                                pickerInput.value = isoDate;
                            }
                        }
                    });
                    
                    // Picker changes update manual input
                    pickerInput.addEventListener('change', function() {
                        if (this.value) {
                            const ddmmyyyy = convertFromISODate(this.value);
                            if (ddmmyyyy) {
                                manualInput.value = ddmmyyyy;
                                // Trigger validation
                                manualInput.dispatchEvent(new Event('input'));
                            }
                        }
                    });
                    
                    // Setup formatting for manual input
                    formatDateInput(manualInput);
                }
            });
        }

        // Family management functions
        function toggleFamilyFields(selectElement) {
            const mainFamilySection = document.getElementById('mainFamilySection');
            const value = selectElement.value;
            
            if (value === 'istri' || value === 'anak') {
                mainFamilySection.style.display = 'block';
                populateMainFamilyOptions();
            } else {
                mainFamilySection.style.display = 'none';
            }
        }

        function populateMainFamilyOptions() {
            const mainFamilySelect = document.getElementById('jamaahMainFamily');
            
            // Clear existing options except the first one
            mainFamilySelect.innerHTML = '<option value="">Pilih Kepala Keluarga</option>';
            
            // Find all kepala keluarga from jamaahData
            const kepalaKeluarga = jamaahData.filter(j => j.family_role === 'kepala_keluarga');
            
            kepalaKeluarga.forEach(kk => {
                const option = document.createElement('option');
                option.value = kk.main_family_id;
                option.textContent = `${kk.name} (Family ID: ${kk.main_family_id})`;
                mainFamilySelect.appendChild(option);
            });
            
            // Add option to create new family
            const newFamilyOption = document.createElement('option');
            newFamilyOption.value = 'new_family';
            newFamilyOption.textContent = '+ Buat Family Baru';
            mainFamilySelect.appendChild(newFamilyOption);
        }

        function generateNewFamilyId() {
            const existingFamilyIds = jamaahData
                .map(j => j.main_family_id)
                .filter(id => id !== undefined && id !== null);
            
            if (existingFamilyIds.length === 0) return 1;
            
            return Math.max(...existingFamilyIds) + 1;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Passport Functions
        function previewPassportImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('passportPreview').style.display = 'block';
                    document.getElementById('passportImg').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function viewPassportImage(imageSrc, jamaahName) {
            if (!imageSrc) {
                showNotification('Belum ada foto paspor untuk jamaah ini', 'error');
                return;
            }
            
            // Create modal for passport view
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Foto Paspor - ${jamaahName}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="text-align: center;">
                        <img src="${imageSrc}" style="max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Additional Document Functions
        function previewAdditionalDocument(event, docType) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Ukuran file terlalu besar. Maksimal 5MB.', 'error');
                event.target.value = '';
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('File harus berupa gambar (JPG, PNG).', 'error');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.getElementById(`${docType}Preview`);
                const previewImage = document.getElementById(`${docType}Img`);
                
                if (previewContainer && previewImage) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                    
                    // Store the image data for later use
                    previewImage.dataset.imageData = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }

        function viewDocumentImage(docType) {
            const previewImage = document.getElementById(`${docType}Img`);
            if (!previewImage || !previewImage.src) {
                showNotification('Belum ada gambar untuk ditampilkan', 'error');
                return;
            }

            const docNames = {
                'ktp': 'KTP',
                'kk': 'Kartu Keluarga', 
                'photo': 'Foto Jamaah'
            };

            // Create modal for document view
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>${docNames[docType]}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <img src="${previewImage.src}" style="max-width: 100%; max-height: 500px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners for close buttons
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            // Close on click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function removeDocument(docType) {
            if (confirm('Yakin ingin menghapus dokumen ini?')) {
                // Clear the file input
                const fileInput = document.getElementById(`jamaah${docType.charAt(0).toUpperCase() + docType.slice(1)}${docType === 'photo' ? '' : 'Image'}`);
                const previewContainer = document.getElementById(`${docType}Preview`);
                const previewImage = document.getElementById(`${docType}Img`);
                
                if (fileInput) fileInput.value = '';
                if (previewContainer) previewContainer.style.display = 'none';
                if (previewImage) {
                    previewImage.src = '';
                    delete previewImage.dataset.imageData;
                }
                
                showNotification('Dokumen berhasil dihapus');
            }
        }

        function getAdditionalDocuments() {
            const documents = {};
            
            ['ktp', 'kk', 'photo'].forEach(docType => {
                const previewImage = document.getElementById(`${docType}Img`);
                if (previewImage && previewImage.dataset.imageData) {
                    documents[docType] = previewImage.dataset.imageData;
                }
            });
            
            return documents;
        }

        // Package Brochure Functions
        let brochurePhotos = [];

        // Financial Data Structures
        let chartOfAccounts = [];
        let journalEntries = [];
        let financialTransactions = [];

        // Marketing Data
        let leadData = [
            {
                id: 1,
                name: "Ibu Fatimah",
                phone: "081234567890",
                source: "fb_ads",
                status: "interested",
                temperature: "hot",
                marketer_id: "1",
                marketer_name: "Ani - Marketing 1",
                score: 85,
                budget: "medium",
                package_interest: "1",
                created_date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                last_contact: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
                tags: ["urgent", "family"],
                notes: [
                    {
                        date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        note: "First contact via FB. Tertarik paket ramadhan untuk keluarga 4 orang.",
                        by: "Ani"
                    },
                    {
                        date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        note: "Follow up WA. Sudah kirim brosur dan price list. Minta waktu diskusi dengan suami.",
                        by: "Ani"
                    },
                    {
                        date: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
                        note: "Suami setuju. Minta info cicilan dan proses pendaftaran. Schedule meeting besok.",
                        by: "Ani"
                    }
                ]
            },
            {
                id: 2,
                name: "Bapak Rahman",
                phone: "081234567891",
                source: "google_ads",
                status: "contacted",
                temperature: "warm",
                marketer_id: "2",
                marketer_name: "Budi - Marketing 2",
                score: 65,
                budget: "high",
                package_interest: "2",
                created_date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                last_contact: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                tags: ["first_time"],
                notes: [
                    {
                        date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        note: "Inquiry from Google Ads. Looking for premium package.",
                        by: "Budi"
                    },
                    {
                        date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        note: "Sent package details. Interested but comparing with other travel.",
                        by: "Budi"
                    }
                ]
            },
            {
                id: 3,
                name: "Ibu Siti Nurhaliza",
                phone: "081234567892",
                source: "referral",
                status: "new",
                temperature: "cold",
                marketer_id: "1",
                marketer_name: "Ani - Marketing 1",
                score: 40,
                budget: "low",
                package_interest: "",
                created_date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                last_contact: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                tags: ["referral"],
                notes: [
                    {
                        date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                        note: "Referral from Ibu Aminah. Just asking for information.",
                        by: "Ani"
                    }
                ]
            }
        ];

        let campaigns = [
            {
                id: 1,
                name: "Ramadhan Early Bird",
                type: "fb_ads",
                status: "active",
                budget: 5000000,
                spent: 3500000,
                leads: 45,
                conversions: 8,
                start_date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                end_date: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 2,
                name: "Google Search - Umroh",
                type: "google_ads",
                status: "active",
                budget: 3000000,
                spent: 2100000,
                leads: 28,
                conversions: 5,
                start_date: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(),
                end_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }
        ];

        let marketers = [
            {
                id: "1",
                name: "Ani",
                full_name: "Ani - Marketing 1",
                total_leads: 68,
                hot_leads: 12,
                conversions: 15,
                conversion_rate: 22,
                avg_response_time: 2.5,
                active: true
            },
            {
                id: "2", 
                name: "Budi",
                full_name: "Budi - Marketing 2",
                total_leads: 45,
                hot_leads: 8,
                conversions: 10,
                conversion_rate: 22.2,
                avg_response_time: 3.2,
                active: true
            },
            {
                id: "3",
                name: "Citra",
                full_name: "Citra - Marketing 3",
                total_leads: 52,
                hot_leads: 10,
                conversions: 12,
                conversion_rate: 23.1,
                avg_response_time: 2.8,
                active: true
            },
            {
                id: "4",
                name: "Dodi",
                full_name: "Dodi - Marketing 4",
                total_leads: 38,
                hot_leads: 5,
                conversions: 7,
                conversion_rate: 18.4,
                avg_response_time: 4.1,
                active: true
            }
        ];

        // Initialize default COA if empty
        function initializeFinancialData() {
            if (chartOfAccounts.length === 0) {
                loadDefaultCOA();
            }
            updateFinancialStats();
        }

        function handleBrochureUpload(event) {
            const files = Array.from(event.target.files);
            
            if (files.length + brochurePhotos.length > 10) {
                showNotification('Maksimal 10 foto brosur yang bisa diupload', 'error');
                return;
            }
            
            files.forEach((file, index) => {
                // Validate file size
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`File ${file.name} terlalu besar. Maksimal 5MB per foto.`, 'error');
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showNotification(`File ${file.name} harus berupa gambar (JPG, PNG).`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    brochurePhotos.push({
                        id: Date.now() + index,
                        src: e.target.result,
                        name: file.name
                    });
                    
                    renderBrochurePreview();
                };
                reader.readAsDataURL(file);
            });
            
            // Reset file input
            event.target.value = '';
        }

        function renderBrochurePreview() {
            const container = document.getElementById('brochurePreviewContainer');
            
            if (brochurePhotos.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'grid';
            container.innerHTML = brochurePhotos.map((photo, index) => `
                <div class="brochure-preview-item">
                    <img src="${photo.src}" onclick="viewBrochureImage(${photo.id})" alt="Brochure ${index + 1}">
                    <button class="remove-btn" onclick="removeBrochurePhoto(${photo.id})" title="Hapus foto">
                        <span class="material-icons" style="font-size: 12px;">close</span>
                    </button>
                    <div class="photo-index">${index + 1}</div>
                </div>
            `).join('');
        }

        function viewBrochureImage(photoId) {
            const photo = brochurePhotos.find(p => p.id === photoId);
            if (!photo) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Foto Brosur</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <img src="${photo.src}" style="max-width: 100%; max-height: 600px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const closeButtons = modal.querySelectorAll('.close-btn');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function removeBrochurePhoto(photoId) {
            brochurePhotos = brochurePhotos.filter(p => p.id !== photoId);
            renderBrochurePreview();
            showNotification('Foto brosur berhasil dihapus');
        }

        function getBrochurePhotos() {
            return brochurePhotos.map(photo => photo.src);
        }

        function clearBrochurePhotos() {
            brochurePhotos = [];
            renderBrochurePreview();
        }

        function viewBrochureFromPackage(packageId, photoId) {
            const package = packageData.find(p => p.id == packageId);
            if (!package || !package.brochure_photos) return;
            
            const photo = package.brochure_photos.find(p => p.id === photoId);
            if (!photo) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Foto Brosur - ${package.name}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="text-align: center;">
                        <img src="${photo.url}" alt="${photo.name}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
                        <p style="margin-top: 10px; color: #666;">${photo.name}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                }
            });
        }

        // Financial Management Functions
        function loadFinancePage() {
            updateFinancialStats();
            loadCOATable();
            loadJournalTable();
        }

        function loadDefaultCOA() {
            chartOfAccounts = [
                // Assets (1-xxxxx)
                { code: '1-10001', name: 'Kas', category: 'asset', normalBalance: 'debit', balance: 0 },
                { code: '1-10002', name: 'Bank BCA', category: 'asset', normalBalance: 'debit', balance: 0 },
                { code: '1-10003', name: 'Bank Mandiri', category: 'asset', normalBalance: 'debit', balance: 0 },
                { code: '1-20001', name: 'Piutang Jamaah', category: 'asset', normalBalance: 'debit', balance: 0 },
                { code: '1-30001', name: 'Perlengkapan Kantor', category: 'asset', normalBalance: 'debit', balance: 0 },
                { code: '1-40001', name: 'Kendaraan', category: 'asset', normalBalance: 'debit', balance: 0 },
                
                // Liabilities (2-xxxxx)
                { code: '2-10001', name: 'Hutang Vendor', category: 'liability', normalBalance: 'credit', balance: 0 },
                { code: '2-10002', name: 'Hutang Hotel', category: 'liability', normalBalance: 'credit', balance: 0 },
                { code: '2-10003', name: 'Hutang Tiket', category: 'liability', normalBalance: 'credit', balance: 0 },
                { code: '2-20001', name: 'Pendapatan Diterima Dimuka', category: 'liability', normalBalance: 'credit', balance: 0 },
                
                // Equity (3-xxxxx)
                { code: '3-10001', name: 'Modal Pemilik', category: 'equity', normalBalance: 'credit', balance: 0 },
                { code: '3-20001', name: 'Laba Ditahan', category: 'equity', normalBalance: 'credit', balance: 0 },
                
                // Revenue (4-xxxxx)
                { code: '4-10001', name: 'Pendapatan Umroh', category: 'revenue', normalBalance: 'credit', balance: 0 },
                { code: '4-10002', name: 'Pendapatan Administrasi', category: 'revenue', normalBalance: 'credit', balance: 0 },
                { code: '4-20001', name: 'Pendapatan Lain-lain', category: 'revenue', normalBalance: 'credit', balance: 0 },
                
                // Expenses (5-xxxxx)
                { code: '5-10001', name: 'Beban Hotel', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-10002', name: 'Beban Tiket Pesawat', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-10003', name: 'Beban Visa', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-10004', name: 'Beban Transportasi', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-10005', name: 'Beban Makan', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-10006', name: 'Beban Guide/Muthawif', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-20001', name: 'Beban Gaji', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-20002', name: 'Beban Administrasi', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-20003', name: 'Beban Sewa Kantor', category: 'expense', normalBalance: 'debit', balance: 0 },
                { code: '5-30001', name: 'Beban Lain-lain', category: 'expense', normalBalance: 'debit', balance: 0 }
            ];
            
            loadCOATable();
            showNotification('Default Chart of Accounts berhasil dimuat!');
        }

        function loadCOATable() {
            const tbody = document.getElementById('coaTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            chartOfAccounts.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${account.code}</td>
                    <td>${account.name}</td>
                    <td>${getCategoryText(account.category)}</td>
                    <td>${account.normalBalance === 'debit' ? 'Debit' : 'Kredit'}</td>
                    <td>Rp ${(account.balance || 0).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editCOA('${account.code}')">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCOA('${account.code}')">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getCategoryText(category) {
            const categories = {
                'asset': 'Aset',
                'liability': 'Kewajiban',
                'equity': 'Modal',
                'revenue': 'Pendapatan',
                'expense': 'Beban'
            };
            return categories[category] || category;
        }

        function updateNormalBalance() {
            const category = document.getElementById('coaCategory').value;
            const normalBalanceInput = document.getElementById('coaNormalBalance');
            
            if (category === 'asset' || category === 'expense') {
                normalBalanceInput.value = 'Debit';
            } else if (category === 'liability' || category === 'equity' || category === 'revenue') {
                normalBalanceInput.value = 'Kredit';
            } else {
                normalBalanceInput.value = '';
            }
        }

        function saveCOA(event) {
            event.preventDefault();
            
            const code = document.getElementById('coaCode').value;
            const name = document.getElementById('coaName').value;
            const category = document.getElementById('coaCategory').value;
            const normalBalance = document.getElementById('coaNormalBalance').value.toLowerCase() === 'debit' ? 'debit' : 'credit';
            
            // Check if code already exists
            if (chartOfAccounts.some(acc => acc.code === code)) {
                showNotification('Kode akun sudah ada!', 'error');
                return;
            }
            
            chartOfAccounts.push({
                code: code,
                name: name,
                category: category,
                normalBalance: normalBalance,
                balance: 0
            });
            
            chartOfAccounts.sort((a, b) => a.code.localeCompare(b.code));
            
            closeModal('coaModal');
            loadCOATable();
            showNotification('Akun berhasil ditambahkan!');
            event.target.reset();
        }

        function deleteCOA(code) {
            if (confirm('Yakin ingin menghapus akun ini?')) {
                chartOfAccounts = chartOfAccounts.filter(acc => acc.code !== code);
                loadCOATable();
                showNotification('Akun berhasil dihapus!');
            }
        }

        // Journal Entry Functions
        function addJournalLine() {
            const journalLines = document.getElementById('journalLines');
            const newLine = document.createElement('div');
            newLine.className = 'journal-line';
            newLine.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            
            const accountOptions = chartOfAccounts.map(acc => 
                `<option value="${acc.code}">${acc.code} - ${acc.name}</option>`
            ).join('');
            
            newLine.innerHTML = `
                <select class="form-control" style="flex: 2;" required onchange="validateJournal()">
                    <option value="">Pilih Akun</option>
                    ${accountOptions}
                </select>
                <input type="number" class="form-control" placeholder="Debit" style="flex: 1;" onkeyup="validateJournal()">
                <input type="number" class="form-control" placeholder="Kredit" style="flex: 1;" onkeyup="validateJournal()">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeJournalLine(this)">
                    <span class="material-icons">delete</span>
                </button>
            `;
            
            journalLines.appendChild(newLine);
        }

        function removeJournalLine(button) {
            const journalLines = document.getElementById('journalLines');
            if (journalLines.children.length > 2) {
                button.parentElement.remove();
                validateJournal();
            } else {
                showNotification('Minimal harus ada 2 baris jurnal!', 'error');
            }
        }

        function validateJournal() {
            const journalLines = document.getElementById('journalLines').getElementsByClassName('journal-line');
            let totalDebit = 0;
            let totalCredit = 0;
            
            Array.from(journalLines).forEach(line => {
                const debitInput = line.querySelector('input[placeholder="Debit"]');
                const creditInput = line.querySelector('input[placeholder="Kredit"]');
                
                totalDebit += parseFloat(debitInput.value) || 0;
                totalCredit += parseFloat(creditInput.value) || 0;
            });
            
            document.getElementById('totalDebit').textContent = `Rp ${totalDebit.toLocaleString()}`;
            document.getElementById('totalCredit').textContent = `Rp ${totalCredit.toLocaleString()}`;
            
            const isBalanced = totalDebit > 0 && totalCredit > 0 && totalDebit === totalCredit;
            const balanceStatus = document.getElementById('balanceStatus');
            const saveButton = document.getElementById('saveJournalBtn');
            
            if (isBalanced) {
                balanceStatus.textContent = 'Balance ';
                balanceStatus.style.color = '#10b981';
                saveButton.disabled = false;
            } else {
                balanceStatus.textContent = 'Tidak Balance';
                balanceStatus.style.color = '#ef4444';
                saveButton.disabled = true;
            }
        }

        function saveJournal(event) {
            event.preventDefault();
            
            const date = document.getElementById('journalDate').value;
            const description = document.getElementById('journalDescription').value;
            const journalLines = document.getElementById('journalLines').getElementsByClassName('journal-line');
            
            const journalEntry = {
                id: Date.now(),
                date: date,
                description: description,
                lines: [],
                status: 'posted'
            };
            
            Array.from(journalLines).forEach(line => {
                const account = line.querySelector('select').value;
                const debit = parseFloat(line.querySelector('input[placeholder="Debit"]').value) || 0;
                const credit = parseFloat(line.querySelector('input[placeholder="Kredit"]').value) || 0;
                
                if (account && (debit > 0 || credit > 0)) {
                    journalEntry.lines.push({
                        account: account,
                        debit: debit,
                        credit: credit
                    });
                    
                    // Update account balance
                    const accObj = chartOfAccounts.find(a => a.code === account);
                    if (accObj) {
                        if (accObj.normalBalance === 'debit') {
                            accObj.balance += debit - credit;
                        } else {
                            accObj.balance += credit - debit;
                        }
                    }
                }
            });
            
            journalEntries.push(journalEntry);
            
            closeModal('journalModal');
            loadJournalTable();
            loadCOATable();
            updateFinancialStats();
            showNotification('Jurnal berhasil disimpan!');
            event.target.reset();
        }

        function loadJournalTable() {
            const tbody = document.getElementById('journalTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            journalEntries.slice(-10).reverse().forEach(entry => {
                entry.lines.forEach((line, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index === 0 ? formatDate(entry.date) : ''}</td>
                        <td>${index === 0 ? `JV-${entry.id}` : ''}</td>
                        <td>${index === 0 ? entry.description : ''}</td>
                        <td>Rp ${line.debit > 0 ? line.debit.toLocaleString() : '-'}</td>
                        <td>Rp ${line.credit > 0 ? line.credit.toLocaleString() : '-'}</td>
                        <td>${index === 0 ? '<span class="status-badge status-verified">Posted</span>' : ''}</td>
                        <td>${index === 0 ? `<button class="btn btn-primary btn-sm" onclick="viewJournal(${entry.id})"><span class="material-icons">visibility</span></button>` : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // Expense Functions
        function saveExpense(event) {
            event.preventDefault();
            
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const method = document.getElementById('expenseMethod').value;
            const vendor = document.getElementById('expenseVendor').value;
            const description = document.getElementById('expenseDescription').value;
            const reference = document.getElementById('expenseReference').value;
            
            // Map expense category to COA
            const expenseAccountMap = {
                'hotel': '5-10001',
                'flight': '5-10002',
                'visa': '5-10003',
                'transport': '5-10004',
                'meal': '5-10005',
                'guide': '5-10006',
                'admin': '5-20002',
                'other': '5-30001'
            };
            
            const cashAccount = method === 'cash' ? '1-10001' : '1-10002'; // Kas or Bank
            const expenseAccount = expenseAccountMap[category];
            
            // Create journal entry
            const journalEntry = {
                id: Date.now(),
                date: date,
                description: `${description} - ${vendor} (${reference})`,
                lines: [
                    { account: expenseAccount, debit: amount, credit: 0 },
                    { account: cashAccount, debit: 0, credit: amount }
                ],
                status: 'posted',
                type: 'expense'
            };
            
            // Update account balances
            const expAcc = chartOfAccounts.find(a => a.code === expenseAccount);
            const cashAcc = chartOfAccounts.find(a => a.code === cashAccount);
            
            if (expAcc) expAcc.balance += amount;
            if (cashAcc) cashAcc.balance -= amount;
            
            journalEntries.push(journalEntry);
            
            closeModal('expenseModal');
            loadJournalTable();
            loadCOATable();
            updateFinancialStats();
            showNotification('Pengeluaran berhasil dicatat!');
            event.target.reset();
        }

        // Automatic posting from payment
        function postPaymentToJournal(payment) {
            if (payment.status !== 'verified') return;
            
            const cashAccount = payment.method === 'cash' ? '1-10001' : '1-10002';
            const revenueAccount = '4-10001'; // Pendapatan Umroh
            const receivableAccount = '1-20001'; // Piutang Jamaah
            
            // Create journal entry for payment
            const journalEntry = {
                id: Date.now(),
                date: payment.date,
                description: `Pembayaran dari ${payment.jamaah_name} - ${payment.package}`,
                lines: [
                    { account: cashAccount, debit: payment.amount, credit: 0 },
                    { account: receivableAccount, debit: 0, credit: payment.amount }
                ],
                status: 'posted',
                type: 'receipt',
                reference: payment.reference
            };
            
            // Update balances
            const cash = chartOfAccounts.find(a => a.code === cashAccount);
            const receivable = chartOfAccounts.find(a => a.code === receivableAccount);
            
            if (cash) cash.balance += payment.amount;
            if (receivable) receivable.balance -= payment.amount;
            
            journalEntries.push(journalEntry);
        }

        // Update financial statistics
        function updateFinancialStats() {
            if (!document.getElementById('totalCash')) return;
            
            // Calculate totals
            const totalCash = chartOfAccounts
                .filter(acc => acc.code.startsWith('1-1'))
                .reduce((sum, acc) => sum + acc.balance, 0);
            
            const totalRevenue = chartOfAccounts
                .filter(acc => acc.category === 'revenue')
                .reduce((sum, acc) => sum + acc.balance, 0);
            
            const totalExpense = chartOfAccounts
                .filter(acc => acc.category === 'expense')
                .reduce((sum, acc) => sum + acc.balance, 0);
            
            const netProfit = totalRevenue - totalExpense;
            
            // Update displays
            document.getElementById('totalCash').textContent = `Rp ${totalCash.toLocaleString()}`;
            document.getElementById('totalRevenue').textContent = `Rp ${totalRevenue.toLocaleString()}`;
            document.getElementById('totalExpense').textContent = `Rp ${totalExpense.toLocaleString()}`;
            document.getElementById('netProfit').textContent = `Rp ${netProfit.toLocaleString()}`;
            
            // Update profit color
            document.getElementById('netProfit').parentElement.style.background = 
                netProfit >= 0 ? 
                'linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1))' : 
                'linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1))';
        }

        // Generate Financial Reports
        function generateFinancialReport(reportType) {
            switch(reportType) {
                case 'balance_sheet':
                    generateBalanceSheet();
                    break;
                case 'income_statement':
                    generateIncomeStatement();
                    break;
                case 'cash_flow':
                    generateCashFlow();
                    break;
                case 'general_journal':
                    generateGeneralJournal();
                    break;
                case 'special_journal':
                    generateSpecialJournal();
                    break;
                case 'general_ledger':
                    generateGeneralLedger();
                    break;
            }
        }

        function generateBalanceSheet() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            const assets = chartOfAccounts.filter(acc => acc.category === 'asset');
            const liabilities = chartOfAccounts.filter(acc => acc.category === 'liability');
            const equity = chartOfAccounts.filter(acc => acc.category === 'equity');
            
            const totalAssets = assets.reduce((sum, acc) => sum + acc.balance, 0);
            const totalLiabilities = liabilities.reduce((sum, acc) => sum + acc.balance, 0);
            const totalEquity = equity.reduce((sum, acc) => sum + acc.balance, 0);
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Neraca (Balance Sheet)</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <h4 style="text-align: center; color: #4facfe;">VAUZA TAMMA MANAGEMENT</h4>
                        <h5 style="text-align: center; color: #cbd5e1;">NERACA</h5>
                        <p style="text-align: center; color: #94a3b8;">Per ${new Date().toLocaleDateString('id-ID')}</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                            <!-- Assets -->
                            <div>
                                <h4 style="color: #4facfe; border-bottom: 2px solid #4facfe; padding-bottom: 10px;">ASET</h4>
                                ${assets.map(acc => `
                                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span>${acc.name}</span>
                                        <span>Rp ${acc.balance.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 1px solid #475569; margin-top: 10px; font-weight: bold;">
                                    <span>Total Aset</span>
                                    <span>Rp ${totalAssets.toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <!-- Liabilities & Equity -->
                            <div>
                                <h4 style="color: #4facfe; border-bottom: 2px solid #4facfe; padding-bottom: 10px;">KEWAJIBAN & MODAL</h4>
                                <h5 style="color: #cbd5e1; margin-top: 15px;">Kewajiban</h5>
                                ${liabilities.map(acc => `
                                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span>${acc.name}</span>
                                        <span>Rp ${acc.balance.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                                <div style="display: flex; justify-content: space-between; padding: 10px 0; margin-bottom: 15px;">
                                    <span style="font-weight: 600;">Total Kewajiban</span>
                                    <span style="font-weight: 600;">Rp ${totalLiabilities.toLocaleString()}</span>
                                </div>
                                
                                <h5 style="color: #cbd5e1;">Modal</h5>
                                ${equity.map(acc => `
                                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span>${acc.name}</span>
                                        <span>Rp ${acc.balance.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                                <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                                    <span style="font-weight: 600;">Total Modal</span>
                                    <span style="font-weight: 600;">Rp ${totalEquity.toLocaleString()}</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 1px solid #475569; margin-top: 10px; font-weight: bold;">
                                    <span>Total Kewajiban & Modal</span>
                                    <span>Rp ${(totalLiabilities + totalEquity).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">
                                <span class="material-icons">print</span>
                                Cetak
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('balance_sheet')">
                                <span class="material-icons">download</span>
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateIncomeStatement() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            const revenues = chartOfAccounts.filter(acc => acc.category === 'revenue');
            const expenses = chartOfAccounts.filter(acc => acc.category === 'expense');
            
            const totalRevenue = revenues.reduce((sum, acc) => sum + acc.balance, 0);
            const totalExpense = expenses.reduce((sum, acc) => sum + acc.balance, 0);
            const netIncome = totalRevenue - totalExpense;
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Laporan Laba Rugi (Income Statement)</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <h4 style="text-align: center; color: #4facfe;">VAUZA TAMMA MANAGEMENT</h4>
                        <h5 style="text-align: center; color: #cbd5e1;">LAPORAN LABA RUGI</h5>
                        <p style="text-align: center; color: #94a3b8;">Periode ${new Date().toLocaleDateString('id-ID')}</p>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="color: #4facfe; border-bottom: 2px solid #4facfe; padding-bottom: 10px;">PENDAPATAN</h4>
                            ${revenues.map(acc => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span>${acc.name}</span>
                                    <span>Rp ${acc.balance.toLocaleString()}</span>
                                </div>
                            `).join('')}
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 1px solid #475569; margin-top: 10px; font-weight: bold;">
                                <span>Total Pendapatan</span>
                                <span>Rp ${totalRevenue.toLocaleString()}</span>
                            </div>
                            
                            <h4 style="color: #4facfe; border-bottom: 2px solid #4facfe; padding-bottom: 10px; margin-top: 30px;">BEBAN</h4>
                            ${expenses.map(acc => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span>${acc.name}</span>
                                    <span>Rp ${acc.balance.toLocaleString()}</span>
                                </div>
                            `).join('')}
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 1px solid #475569; margin-top: 10px; font-weight: bold;">
                                <span>Total Beban</span>
                                <span>Rp ${totalExpense.toLocaleString()}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: ${netIncome >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 8px; margin-top: 20px; font-size: 18px; font-weight: bold;">
                                <span>${netIncome >= 0 ? 'LABA BERSIH' : 'RUGI BERSIH'}</span>
                                <span style="color: ${netIncome >= 0 ? '#10b981' : '#ef4444'};">Rp ${Math.abs(netIncome).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">
                                <span class="material-icons">print</span>
                                Cetak
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('income_statement')">
                                <span class="material-icons">download</span>
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateCashFlow() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            // Filter cash-related entries
            const cashAccounts = ['1-10001', '1-10002', '1-10003']; // Kas and Banks
            const cashEntries = journalEntries.filter(entry => 
                entry.lines.some(line => cashAccounts.includes(line.account))
            );
            
            let operatingCashFlow = 0;
            let investingCashFlow = 0;
            let financingCashFlow = 0;
            
            cashEntries.forEach(entry => {
                entry.lines.forEach(line => {
                    if (cashAccounts.includes(line.account)) {
                        const amount = line.debit - line.credit;
                        
                        // Categorize by type
                        if (entry.type === 'receipt' || entry.type === 'expense') {
                            operatingCashFlow += amount;
                        } else if (entry.type === 'investment') {
                            investingCashFlow += amount;
                        } else if (entry.type === 'financing') {
                            financingCashFlow += amount;
                        } else {
                            operatingCashFlow += amount; // Default to operating
                        }
                    }
                });
            });
            
            const netCashFlow = operatingCashFlow + investingCashFlow + financingCashFlow;
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Laporan Arus Kas (Cash Flow Statement)</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <h4 style="text-align: center; color: #4facfe;">VAUZA TAMMA MANAGEMENT</h4>
                        <h5 style="text-align: center; color: #cbd5e1;">LAPORAN ARUS KAS</h5>
                        <p style="text-align: center; color: #94a3b8;">Periode ${new Date().toLocaleDateString('id-ID')}</p>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="color: #4facfe; border-bottom: 2px solid #4facfe; padding-bottom: 10px;">AKTIVITAS OPERASI</h4>
                            <div style="padding: 15px 0;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Penerimaan dari Jamaah</span>
                                    <span>Rp ${Math.max(0, operatingCashFlow).toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Pembayaran Operasional</span>
                                    <span>(Rp ${Math.abs(Math.min(0, operatingCashFlow)).toLocaleString()})</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid #475569; font-weight: bold;">
                                    <span>Arus Kas dari Aktivitas Operasi</span>
                                    <span style="color: ${operatingCashFlow >= 0 ? '#10b981' : '#ef4444'};">Rp ${operatingCashFlow.toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <h4 style="color: #4facfe; border-bottom: 2px solid #4facfe; padding-bottom: 10px; margin-top: 30px;">AKTIVITAS INVESTASI</h4>
                            <div style="padding: 15px 0;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Pembelian Aset</span>
                                    <span>Rp ${investingCashFlow.toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid #475569; font-weight: bold;">
                                    <span>Arus Kas dari Aktivitas Investasi</span>
                                    <span style="color: ${investingCashFlow >= 0 ? '#10b981' : '#ef4444'};">Rp ${investingCashFlow.toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <h4 style="color: #4facfe; border-bottom: 2px solid #4facfe; padding-bottom: 10px; margin-top: 30px;">AKTIVITAS PENDANAAN</h4>
                            <div style="padding: 15px 0;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Modal/Pinjaman</span>
                                    <span>Rp ${financingCashFlow.toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid #475569; font-weight: bold;">
                                    <span>Arus Kas dari Aktivitas Pendanaan</span>
                                    <span style="color: ${financingCashFlow >= 0 ? '#10b981' : '#ef4444'};">Rp ${financingCashFlow.toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: ${netCashFlow >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 8px; margin-top: 20px; font-size: 18px; font-weight: bold;">
                                <span>PERUBAHAN KAS BERSIH</span>
                                <span style="color: ${netCashFlow >= 0 ? '#10b981' : '#ef4444'};">Rp ${netCashFlow.toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">
                                <span class="material-icons">print</span>
                                Cetak
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('cash_flow')">
                                <span class="material-icons">download</span>
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateGeneralJournal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Jurnal Umum (General Journal)</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <h4 style="text-align: center; color: #4facfe;">VAUZA TAMMA MANAGEMENT</h4>
                        <h5 style="text-align: center; color: #cbd5e1;">JURNAL UMUM</h5>
                        <p style="text-align: center; color: #94a3b8;">Periode ${new Date().toLocaleDateString('id-ID')}</p>
                        
                        <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(79, 172, 254, 0.1);">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4facfe;">Tanggal</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4facfe;">No. Jurnal</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4facfe;">Keterangan</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4facfe;">Akun</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4facfe;">Debit</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4facfe;">Kredit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${journalEntries.map(entry => {
                                    const rows = [];
                                    entry.lines.forEach((line, index) => {
                                        const account = chartOfAccounts.find(acc => acc.code === line.account);
                                        rows.push(`
                                            <tr>
                                                <td style="padding: 8px; border-bottom: 1px solid #475569;">${index === 0 ? formatDate(entry.date) : ''}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #475569;">${index === 0 ? `JV-${entry.id}` : ''}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #475569;">${index === 0 ? entry.description : ''}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #475569;">${account ? account.name : line.account}</td>
                                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">${line.debit > 0 ? `Rp ${line.debit.toLocaleString()}` : '-'}</td>
                                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">${line.credit > 0 ? `Rp ${line.credit.toLocaleString()}` : '-'}</td>
                                            </tr>
                                        `);
                                    });
                                    return rows.join('');
                                }).join('')}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">
                                <span class="material-icons">print</span>
                                Cetak
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('general_journal')">
                                <span class="material-icons">download</span>
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateSpecialJournal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            // Categorize journals by type
            const receiptJournals = journalEntries.filter(entry => entry.type === 'receipt');
            const expenseJournals = journalEntries.filter(entry => entry.type === 'expense');
            const generalJournals = journalEntries.filter(entry => !entry.type || (entry.type !== 'receipt' && entry.type !== 'expense'));
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Jurnal Khusus (Special Journal)</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <h4 style="text-align: center; color: #4facfe;">VAUZA TAMMA MANAGEMENT</h4>
                        <h5 style="text-align: center; color: #cbd5e1;">JURNAL KHUSUS</h5>
                        <p style="text-align: center; color: #94a3b8;">Periode ${new Date().toLocaleDateString('id-ID')}</p>
                        
                        <!-- Receipt Journal -->
                        <h4 style="color: #10b981; margin-top: 30px; border-bottom: 2px solid #10b981; padding-bottom: 10px;">JURNAL PENERIMAAN KAS</h4>
                        <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(16, 185, 129, 0.1);">
                                    <th style="padding: 8px; text-align: left;">Tanggal</th>
                                    <th style="padding: 8px; text-align: left;">No. Ref</th>
                                    <th style="padding: 8px; text-align: left;">Keterangan</th>
                                    <th style="padding: 8px; text-align: right;">Kas (D)</th>
                                    <th style="padding: 8px; text-align: right;">Piutang (K)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${receiptJournals.map(entry => {
                                    const cashLine = entry.lines.find(l => l.account.startsWith('1-1') && l.debit > 0);
                                    const receivableLine = entry.lines.find(l => l.account === '1-20001' && l.credit > 0);
                                    return `
                                        <tr>
                                            <td style="padding: 8px; border-bottom: 1px solid #475569;">${formatDate(entry.date)}</td>
                                            <td style="padding: 8px; border-bottom: 1px solid #475569;">JV-${entry.id}</td>
                                            <td style="padding: 8px; border-bottom: 1px solid #475569;">${entry.description}</td>
                                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">Rp ${(cashLine?.debit || 0).toLocaleString()}</td>
                                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">Rp ${(receivableLine?.credit || 0).toLocaleString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        
                        <!-- Expense Journal -->
                        <h4 style="color: #ef4444; margin-top: 30px; border-bottom: 2px solid #ef4444; padding-bottom: 10px;">JURNAL PENGELUARAN KAS</h4>
                        <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(239, 68, 68, 0.1);">
                                    <th style="padding: 8px; text-align: left;">Tanggal</th>
                                    <th style="padding: 8px; text-align: left;">No. Ref</th>
                                    <th style="padding: 8px; text-align: left;">Keterangan</th>
                                    <th style="padding: 8px; text-align: right;">Beban (D)</th>
                                    <th style="padding: 8px; text-align: right;">Kas (K)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expenseJournals.map(entry => {
                                    const expenseLine = entry.lines.find(l => l.account.startsWith('5-') && l.debit > 0);
                                    const cashLine = entry.lines.find(l => l.account.startsWith('1-1') && l.credit > 0);
                                    return `
                                        <tr>
                                            <td style="padding: 8px; border-bottom: 1px solid #475569;">${formatDate(entry.date)}</td>
                                            <td style="padding: 8px; border-bottom: 1px solid #475569;">JV-${entry.id}</td>
                                            <td style="padding: 8px; border-bottom: 1px solid #475569;">${entry.description}</td>
                                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">Rp ${(expenseLine?.debit || 0).toLocaleString()}</td>
                                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">Rp ${(cashLine?.credit || 0).toLocaleString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        
                        <!-- General Journal Entries -->
                        <h4 style="color: #4facfe; margin-top: 30px; border-bottom: 2px solid #4facfe; padding-bottom: 10px;">JURNAL UMUM LAINNYA</h4>
                        <p style="color: rgba(255, 255, 255, 0.7);">Total ${generalJournals.length} entri jurnal umum</p>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">
                                <span class="material-icons">print</span>
                                Cetak
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('special_journal')">
                                <span class="material-icons">download</span>
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateGeneralLedger() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            // Select main accounts to show
            const mainAccounts = ['1-10001', '1-10002', '1-20001', '4-10001', '5-10001', '5-10002'];
            const selectedAccounts = chartOfAccounts.filter(acc => mainAccounts.includes(acc.code));
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Buku Besar (General Ledger)</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <h4 style="text-align: center; color: #4facfe;">VAUZA TAMMA MANAGEMENT</h4>
                        <h5 style="text-align: center; color: #cbd5e1;">BUKU BESAR</h5>
                        <p style="text-align: center; color: #94a3b8;">Periode ${new Date().toLocaleDateString('id-ID')}</p>
                        
                        ${selectedAccounts.map(account => {
                            // Get all journal entries for this account
                            const accountEntries = [];
                            journalEntries.forEach(entry => {
                                entry.lines.forEach(line => {
                                    if (line.account === account.code) {
                                        accountEntries.push({
                                            date: entry.date,
                                            ref: `JV-${entry.id}`,
                                            description: entry.description,
                                            debit: line.debit,
                                            credit: line.credit
                                        });
                                    }
                                });
                            });
                            
                            // Calculate running balance
                            let runningBalance = 0;
                            const entriesWithBalance = accountEntries.map(entry => {
                                if (account.normalBalance === 'debit') {
                                    runningBalance += entry.debit - entry.credit;
                                } else {
                                    runningBalance += entry.credit - entry.debit;
                                }
                                return { ...entry, balance: runningBalance };
                            });
                            
                            return `
                                <div style="margin-top: 30px; border: 1px solid #475569; border-radius: 8px; padding: 15px;">
                                    <h4 style="color: #4facfe; margin-bottom: 15px;">${account.name} (${account.code})</h4>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: rgba(79, 172, 254, 0.1);">
                                                <th style="padding: 8px; text-align: left;">Tanggal</th>
                                                <th style="padding: 8px; text-align: left;">Ref</th>
                                                <th style="padding: 8px; text-align: left;">Keterangan</th>
                                                <th style="padding: 8px; text-align: right;">Debit</th>
                                                <th style="padding: 8px; text-align: right;">Kredit</th>
                                                <th style="padding: 8px; text-align: right;">Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${entriesWithBalance.map(entry => `
                                                <tr>
                                                    <td style="padding: 8px; border-bottom: 1px solid #475569;">${formatDate(entry.date)}</td>
                                                    <td style="padding: 8px; border-bottom: 1px solid #475569;">${entry.ref}</td>
                                                    <td style="padding: 8px; border-bottom: 1px solid #475569;">${entry.description}</td>
                                                    <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">${entry.debit > 0 ? `Rp ${entry.debit.toLocaleString()}` : '-'}</td>
                                                    <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569;">${entry.credit > 0 ? `Rp ${entry.credit.toLocaleString()}` : '-'}</td>
                                                    <td style="padding: 8px; text-align: right; border-bottom: 1px solid #475569; font-weight: bold;">Rp ${entry.balance.toLocaleString()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }).join('')}
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-primary" onclick="window.print()">
                                <span class="material-icons">print</span>
                                Cetak
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('general_ledger')">
                                <span class="material-icons">download</span>
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Show Financial Tutorial
        function showFinanceTutorial() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Tutorial Sistem Keuangan</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <h4 style="color: #4facfe; margin-bottom: 20px;"> Panduan Penggunaan Modul Keuangan</h4>
                        
                        <div class="glass-card" style="margin-bottom: 20px;">
                            <h5 style="color: #10b981;">1. Chart of Accounts (COA)</h5>
                            <p>COA adalah daftar semua akun yang digunakan dalam pembukuan. Setiap akun memiliki:</p>
                            <ul style="color: rgba(255, 255, 255, 0.8);">
                                <li><strong>Kode Akun:</strong> Format X-XXXXX (1=Aset, 2=Kewajiban, 3=Modal, 4=Pendapatan, 5=Beban)</li>
                                <li><strong>Nama Akun:</strong> Deskripsi akun</li>
                                <li><strong>Kategori:</strong> Jenis akun (Asset, Liability, Equity, Revenue, Expense)</li>
                                <li><strong>Saldo Normal:</strong> Debit atau Kredit</li>
                            </ul>
                            <p style="background: rgba(79, 172, 254, 0.1); padding: 10px; border-radius: 8px;">
                                 <strong>Tips:</strong> Klik "Load Default COA" untuk memuat akun-akun standar umroh
                            </p>
                        </div>

                        <div class="glass-card" style="margin-bottom: 20px;">
                            <h5 style="color: #10b981;">2. Alur Otomatis Pembayaran Jamaah</h5>
                            <p>Ketika pembayaran jamaah diverifikasi, sistem otomatis akan:</p>
                            <ol style="color: rgba(255, 255, 255, 0.8);">
                                <li>Debit: Kas/Bank (sesuai metode pembayaran)</li>
                                <li>Kredit: Piutang Jamaah</li>
                                <li>Saat jamaah mendaftar: Debit Piutang, Kredit Pendapatan Umroh</li>
                            </ol>
                        </div>

                        <div class="glass-card" style="margin-bottom: 20px;">
                            <h5 style="color: #10b981;">3. Input Pengeluaran</h5>
                            <p>Untuk mencatat pengeluaran perusahaan:</p>
                            <ol style="color: rgba(255, 255, 255, 0.8);">
                                <li>Klik tombol "Pengeluaran"</li>
                                <li>Pilih kategori (Hotel, Tiket, Visa, dll)</li>
                                <li>Isi jumlah dan detail vendor</li>
                                <li>Sistem akan otomatis membuat jurnal:
                                    <ul>
                                        <li>Debit: Beban (sesuai kategori)</li>
                                        <li>Kredit: Kas/Bank</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>

                        <div class="glass-card" style="margin-bottom: 20px;">
                            <h5 style="color: #10b981;">4. Jurnal Umum</h5>
                            <p>Untuk transaksi yang tidak standar:</p>
                            <ul style="color: rgba(255, 255, 255, 0.8);">
                                <li>Minimal 2 baris jurnal (1 debit, 1 kredit)</li>
                                <li>Total debit HARUS sama dengan total kredit</li>
                                <li>Pilih akun dari COA yang sudah ada</li>
                            </ul>
                        </div>

                        <div class="glass-card" style="margin-bottom: 20px;">
                            <h5 style="color: #10b981;">5. Laporan Keuangan</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <h6 style="color: #4facfe;">Neraca</h6>
                                    <p style="font-size: 13px;">Posisi keuangan: Aset = Kewajiban + Modal</p>
                                </div>
                                <div>
                                    <h6 style="color: #4facfe;">Laba Rugi</h6>
                                    <p style="font-size: 13px;">Pendapatan - Beban = Laba/Rugi</p>
                                </div>
                                <div>
                                    <h6 style="color: #4facfe;">Arus Kas</h6>
                                    <p style="font-size: 13px;">Aliran kas masuk dan keluar</p>
                                </div>
                                <div>
                                    <h6 style="color: #4facfe;">Jurnal Umum</h6>
                                    <p style="font-size: 13px;">Semua transaksi kronologis</p>
                                </div>
                                <div>
                                    <h6 style="color: #4facfe;">Jurnal Khusus</h6>
                                    <p style="font-size: 13px;">Jurnal per jenis transaksi</p>
                                </div>
                                <div>
                                    <h6 style="color: #4facfe;">Buku Besar</h6>
                                    <p style="font-size: 13px;">Mutasi per akun</p>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
                            <h5 style="color: #ef4444;"> Penting!</h5>
                            <ul style="color: rgba(255, 255, 255, 0.8);">
                                <li>Selalu backup data keuangan secara berkala</li>
                                <li>Periksa balance jurnal sebelum posting</li>
                                <li>Rekonsiliasi bank minimal sebulan sekali</li>
                                <li>Jangan hapus jurnal yang sudah diposting</li>
                            </ul>
                        </div>

                        <div style="margin-top: 30px; text-align: center;">
                            <button class="btn btn-success" onclick="this.closest('.modal').remove()">
                                <span class="material-icons">check</span>
                                Saya Mengerti
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Marketing Functions
        function loadMarketingPage() {
            updateMarketingStats();
            updateConversionFunnel();
            loadLeadTable();
            showMarketingTab('leads');
        }

        function updateMarketingStats() {
            const totalLeads = leadData.length;
            const hotLeads = leadData.filter(lead => lead.temperature === 'hot').length;
            const convertedLeads = leadData.filter(lead => lead.status === 'converted').length;
            const conversionRate = totalLeads > 0 ? Math.round((convertedLeads / totalLeads) * 100) : 0;
            
            // Calculate average response time
            const totalResponseTime = marketers.reduce((sum, m) => sum + m.avg_response_time, 0);
            const avgResponseTime = Math.round(totalResponseTime / marketers.length * 10) / 10;
            
            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('hotLeads').textContent = hotLeads;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
            document.getElementById('avgResponseTime').textContent = `${avgResponseTime}h`;
        }

        function updateConversionFunnel() {
            const leadCount = leadData.length;
            const contactedCount = leadData.filter(l => ['contacted', 'interested', 'closing', 'converted'].includes(l.status)).length;
            const interestedCount = leadData.filter(l => ['interested', 'closing', 'converted'].includes(l.status)).length;
            const closingCount = leadData.filter(l => ['closing', 'converted'].includes(l.status)).length;
            const convertedCount = leadData.filter(l => l.status === 'converted').length;
            
            document.getElementById('funnelLead').textContent = leadCount;
            document.getElementById('funnelContacted').textContent = contactedCount;
            document.getElementById('funnelInterested').textContent = interestedCount;
            document.getElementById('funnelClosing').textContent = closingCount;
            document.getElementById('funnelConverted').textContent = convertedCount;
        }

        function showMarketingTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.marketing-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active to clicked button
            event.target.classList.add('active');
            
            // Load tab-specific data
            switch(tabName) {
                case 'leads':
                    loadLeadTable();
                    break;
                case 'followup':
                    loadFollowUpCards();
                    break;
                case 'campaigns':
                    loadCampaignCards();
                    break;
                case 'team':
                    loadTeamPerformance();
                    break;
            }
        }

        function loadLeadTable() {
            const tbody = document.getElementById('leadTableBody');
            if (!tbody) return;
            
            // Get filter values
            const searchTerm = document.getElementById('searchLead').value.toLowerCase();
            const statusFilter = document.getElementById('filterLeadStatus').value;
            const tempFilter = document.getElementById('filterLeadTemp').value;
            const sourceFilter = document.getElementById('filterLeadSource').value;
            
            // Filter leads
            let filteredLeads = leadData.filter(lead => {
                const matchesSearch = !searchTerm || 
                    lead.name.toLowerCase().includes(searchTerm) ||
                    lead.phone.includes(searchTerm);
                const matchesStatus = !statusFilter || lead.status === statusFilter;
                const matchesTemp = !tempFilter || lead.temperature === tempFilter;
                const matchesSource = !sourceFilter || lead.source === sourceFilter;
                
                return matchesSearch && matchesStatus && matchesTemp && matchesSource;
            });
            
            tbody.innerHTML = filteredLeads.map(lead => {
                const tempEmoji = {
                    'hot': '',
                    'warm': '',
                    'cold': ''
                }[lead.temperature] || '';
                
                const scoreClass = lead.score >= 80 ? 'high' : lead.score >= 60 ? 'medium' : 'low';
                const statusText = getStatusText(lead.status);
                const lastContact = new Date(lead.last_contact);
                const daysSinceContact = Math.floor((Date.now() - lastContact.getTime()) / (1000 * 60 * 60 * 24));
                
                return `
                    <tr>
                        <td class="lead-temperature">${tempEmoji}</td>
                        <td>
                            <strong>${lead.name}</strong>
                            <div class="lead-tags">
                                ${lead.tags.map(tag => `<span class="lead-tag">${tag}</span>`).join('')}
                            </div>
                        </td>
                        <td>
                            <a href="https://wa.me/${lead.phone.replace(/^0/, '62')}" target="_blank" style="color: #4facfe; text-decoration: none;">
                                ${lead.phone}
                                <span class="material-icons" style="font-size: 14px; vertical-align: middle;">open_in_new</span>
                            </a>
                        </td>
                        <td>${getSourceText(lead.source)}</td>
                        <td><span class="status-badge status-${lead.status}">${statusText}</span></td>
                        <td>${lead.marketer_name}</td>
                        <td>${daysSinceContact}d ago</td>
                        <td><span class="lead-score ${scoreClass}">${lead.score}</span></td>
                        <td>
                            <div class="lead-actions">
                                <button class="btn btn-primary" onclick="openLeadDetail(${lead.id})" title="Detail">
                                    <span class="material-icons">visibility</span>
                                </button>
                                <button class="btn btn-success" onclick="editLead(${lead.id})" title="Edit">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-warning" onclick="updateLeadStatus(${lead.id})" title="Update Status">
                                    <span class="material-icons">update</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadFollowUpCards() {
            const container = document.querySelector('#followupTab .follow-up-container');
            if (!container) return;
            
            // Get leads that need follow-up
            const needsFollowUp = leadData.filter(lead => {
                const lastContact = new Date(lead.last_contact);
                const hoursSinceContact = (Date.now() - lastContact.getTime()) / (1000 * 60 * 60);
                
                // Needs follow-up if no contact in 24h and not converted/rejected
                return hoursSinceContact > 24 && !['converted', 'not_interested'].includes(lead.status);
            });
            
            container.innerHTML = needsFollowUp.map(lead => {
                const lastContact = new Date(lead.last_contact);
                const hoursSinceContact = Math.floor((Date.now() - lastContact.getTime()) / (1000 * 60 * 60));
                const isOverdue = hoursSinceContact > 48;
                
                return `
                    <div class="follow-up-card ${isOverdue ? 'follow-up-overdue' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0;">${lead.name}</h4>
                                <p style="margin: 5px 0; color: #cbd5e1;">${lead.phone}</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; margin-bottom: 5px;">
                                    ${lead.temperature === 'hot' ? '' : lead.temperature === 'warm' ? '' : ''}
                                </div>
                                <small style="color: #94a3b8;">${hoursSinceContact}h ago</small>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <small style="color: #94a3b8;">Last Note:</small>
                            <p style="margin: 5px 0; font-size: 14px;">${lead.notes[lead.notes.length - 1]?.note || 'No notes yet'}</p>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary btn-sm" onclick="quickFollowUp(${lead.id})" style="flex: 1;">
                                <span class="material-icons">message</span>
                                Quick Follow-up
                            </button>
                            <button class="btn btn-success btn-sm" onclick="openLeadDetail(${lead.id})">
                                <span class="material-icons">visibility</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (needsFollowUp.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px;">Semua leads sudah di-follow up!</div>';
            }
        }

        function loadCampaignCards() {
            const container = document.getElementById('campaignGrid');
            if (!container) return;
            
            container.innerHTML = campaigns.map(campaign => {
                const roi = campaign.conversions > 0 ? Math.round(((campaign.conversions * 15000000) - campaign.spent) / campaign.spent * 100) : 0;
                const conversionRate = campaign.leads > 0 ? Math.round((campaign.conversions / campaign.leads) * 100) : 0;
                const costPerLead = campaign.leads > 0 ? Math.round(campaign.spent / campaign.leads) : 0;
                
                return `
                    <div class="campaign-card">
                        <h4 style="margin-bottom: 10px;">${campaign.name}</h4>
                        <div style="margin-bottom: 15px;">
                            <span class="status-badge status-${campaign.status}">${campaign.status}</span>
                        </div>
                        
                        <div class="campaign-stats">
                            <div class="campaign-stat">
                                <div style="font-size: 18px; font-weight: bold; color: #4facfe;">${campaign.leads}</div>
                                <div style="font-size: 12px; color: #94a3b8;">Leads</div>
                            </div>
                            <div class="campaign-stat">
                                <div style="font-size: 18px; font-weight: bold; color: #22c55e;">${campaign.conversions}</div>
                                <div style="font-size: 12px; color: #94a3b8;">Conversions</div>
                            </div>
                            <div class="campaign-stat">
                                <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">${conversionRate}%</div>
                                <div style="font-size: 12px; color: #94a3b8;">Conv. Rate</div>
                            </div>
                            <div class="campaign-stat">
                                <div style="font-size: 16px; font-weight: bold; color: ${roi > 0 ? '#22c55e' : '#ef4444'};">${roi}%</div>
                                <div style="font-size: 12px; color: #94a3b8;">ROI</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; font-size: 13px; color: #cbd5e1;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Budget:</span>
                                <span>Rp ${campaign.budget.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Spent:</span>
                                <span>Rp ${campaign.spent.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Cost/Lead:</span>
                                <span>Rp ${costPerLead.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadTeamPerformance() {
            const container = document.getElementById('teamGrid');
            if (!container) return;
            
            container.innerHTML = marketers.map(marketer => {
                const performanceColor = marketer.conversion_rate >= 20 ? '#22c55e' : marketer.conversion_rate >= 15 ? '#f59e0b' : '#ef4444';
                
                return `
                    <div class="team-card">
                        <div class="team-avatar">
                            ${marketer.name.charAt(0)}
                        </div>
                        <h4 style="margin-bottom: 15px;">${marketer.full_name}</h4>
                        
                        <div class="performance-metric">
                            <span>Total Leads</span>
                            <span style="font-weight: bold;">${marketer.total_leads}</span>
                        </div>
                        <div class="performance-metric">
                            <span>Hot Leads</span>
                            <span style="font-weight: bold; color: #f59e0b;"> ${marketer.hot_leads}</span>
                        </div>
                        <div class="performance-metric">
                            <span>Conversions</span>
                            <span style="font-weight: bold; color: #22c55e;">${marketer.conversions}</span>
                        </div>
                        <div class="performance-metric">
                            <span>Conversion Rate</span>
                            <span style="font-weight: bold; color: ${performanceColor};">${marketer.conversion_rate}%</span>
                        </div>
                        <div class="performance-metric">
                            <span>Avg Response Time</span>
                            <span style="font-weight: bold;">${marketer.avg_response_time}h</span>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="background: rgba(79, 172, 254, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: ${performanceColor}; width: ${Math.min(marketer.conversion_rate * 4, 100)}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #94a3b8; margin-top: 5px; display: block;">Performance Score</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLeads() {
            loadLeadTable();
        }

        function saveLead(event) {
            event.preventDefault();
            
            const formData = {
                id: Date.now(),
                name: document.getElementById('leadName').value,
                phone: document.getElementById('leadPhone').value,
                source: document.getElementById('leadSource').value,
                status: 'new',
                temperature: 'cold',
                marketer_id: document.getElementById('leadMarketer').value,
                marketer_name: document.getElementById('leadMarketer').selectedOptions[0].text,
                score: 40,
                budget: document.getElementById('leadBudget').value,
                package_interest: document.getElementById('leadPackageInterest').value,
                created_date: new Date().toISOString(),
                last_contact: new Date().toISOString(),
                tags: Array.from(document.querySelectorAll('input[name="leadTags"]:checked')).map(cb => cb.value),
                notes: [
                    {
                        date: new Date().toISOString(),
                        note: document.getElementById('leadNotes').value || 'Lead baru ditambahkan ke sistem.',
                        by: 'System'
                    }
                ]
            };
            
            leadData.push(formData);
            closeModal('leadModal');
            updateMarketingStats();
            updateConversionFunnel();
            loadLeadTable();
            showNotification('Lead baru berhasil ditambahkan!');
            event.target.reset();
        }

        function openLeadDetail(leadId) {
            const lead = leadData.find(l => l.id === leadId);
            if (!lead) return;
            
            // Populate lead info
            document.getElementById('leadDetailName').textContent = lead.name;
            document.getElementById('leadDetailPhone').textContent = lead.phone;
            document.getElementById('leadDetailTemp').textContent = {
                'hot': '',
                'warm': '',
                'cold': ''
            }[lead.temperature];
            document.getElementById('leadDetailScore').textContent = lead.score;
            document.getElementById('leadDetailScore').className = `lead-score ${lead.score >= 80 ? 'high' : lead.score >= 60 ? 'medium' : 'low'}`;
            document.getElementById('leadDetailSource').textContent = getSourceText(lead.source);
            document.getElementById('leadDetailStatus').textContent = getStatusText(lead.status);
            document.getElementById('leadDetailMarketer').textContent = lead.marketer_name;
            document.getElementById('leadDetailCreated').textContent = formatDate(lead.created_date);
            document.getElementById('leadDetailId').value = leadId;
            
            // Load timeline
            const timeline = document.getElementById('leadTimeline');
            timeline.innerHTML = lead.notes.map(note => `
                <div class="timeline-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong>${note.by}</strong>
                        <small style="color: #94a3b8;">${formatDateTime(note.date)}</small>
                    </div>
                    <p style="margin: 0; font-size: 14px;">${note.note}</p>
                </div>
            `).join('');
            
            openModal('leadDetailModal');
        }

        function addLeadNote(event) {
            event.preventDefault();
            
            const leadId = parseInt(document.getElementById('leadDetailId').value);
            const note = document.getElementById('leadNewNote').value;
            const newStatus = document.getElementById('leadUpdateStatus').value;
            
            const lead = leadData.find(l => l.id === leadId);
            if (!lead) return;
            
            // Add note
            lead.notes.push({
                date: new Date().toISOString(),
                note: note,
                by: 'Current User'
            });
            
            // Update status if provided
            if (newStatus) {
                lead.status = newStatus;
                lead.last_contact = new Date().toISOString();
                
                // Update temperature based on status
                if (newStatus === 'interested') {
                    lead.temperature = 'warm';
                    lead.score = Math.min(lead.score + 15, 100);
                } else if (newStatus === 'closing') {
                    lead.temperature = 'hot';
                    lead.score = Math.min(lead.score + 25, 100);
                }
            }
            
            // Refresh displays
            updateMarketingStats();
            updateConversionFunnel();
            loadLeadTable();
            openLeadDetail(leadId); // Refresh modal
            
            showNotification('Note berhasil ditambahkan!');
            document.getElementById('leadNewNote').value = '';
            document.getElementById('leadUpdateStatus').value = '';
        }

        function getSourceText(source) {
            const sources = {
                'fb_ads': 'FB Ads',
                'google_ads': 'Google Ads',
                'instagram': 'Instagram',
                'referral': 'Referral',
                'website': 'Website',
                'other': 'Lainnya'
            };
            return sources[source] || source;
        }

        function getStatusText(status) {
            const statuses = {
                'new': 'New',
                'contacted': 'Contacted',
                'interested': 'Interested',
                'not_interested': 'Not Interested',
                'closing': 'Closing',
                'converted': 'Converted'
            };
            return statuses[status] || status;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - App Initializing');
            
            // Test if showPage function is available
            if (typeof showPage === 'function') {
                console.log('showPage function is available');
            } else {
                console.error('showPage function is NOT available');
            }
            
            // Test nav items
            const navItems = document.querySelectorAll('.nav-item');
            console.log('Found nav items:', navItems.length);
            
            // Add click event listeners as backup
            navItems.forEach((item, index) => {
                console.log(`Nav item ${index}:`, item.textContent.trim());
                const onclick = item.getAttribute('onclick');
                if (onclick) {
                    console.log(`  - has onclick: ${onclick}`);
                } else {
                    console.warn(`  - missing onclick attribute`);
                }
            });
            
            loadDashboard();
            loadJamaahTable();
            
            // Setup dual date input functionality
            setupDateInputSync();

            // Sync passport name with KTP name
            const ktpNameInput = document.getElementById('jamaahName');
            const sameAsKtpCheckbox = document.getElementById('sameAsKtpName');
            
            if (ktpNameInput && sameAsKtpCheckbox) {
                ktpNameInput.addEventListener('input', function() {
                    if (sameAsKtpCheckbox.checked) {
                        document.getElementById('jamaahPassportName').value = this.value;
                    }
                });
            }

            // Modal event listeners
            // 1. ESC key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    closeActiveModal();
                }
            });

            // 2. Click outside modal to close
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    // Only close if clicked on the modal backdrop (not the modal content)
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // 3. Close button functionality for all modals
            document.querySelectorAll('.modal .close-btn').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
        });

        // WhatsApp Automation System
        let automationRules = [
            {
                id: 1,
                name: "Welcome New Lead",
                trigger: "new_lead",
                conditions: {
                    source: "facebook",
                    timeDelay: 0
                },
                template: "welcome_message",
                status: "active",
                created_date: "2024-01-15",
                last_executed: "2024-01-22 14:30",
                executions: 157
            },
            {
                id: 2,
                name: "Follow-up Day 3",
                trigger: "time_based",
                conditions: {
                    days_since_last_contact: 3,
                    lead_status: "new",
                    timeDelay: 72
                },
                template: "followup_day3",
                status: "active",
                created_date: "2024-01-10",
                last_executed: "2024-01-22 09:15",
                executions: 89
            },
            {
                id: 3,
                name: "Payment Reminder",
                trigger: "payment_overdue",
                conditions: {
                    days_overdue: 7,
                    payment_status: "partial"
                },
                template: "payment_reminder",
                status: "paused",
                created_date: "2024-01-05",
                last_executed: "2024-01-20 16:45",
                executions: 23
            }
        ];

        let messageTemplates = [
            {
                id: 1,
                name: "welcome_message",
                title: "Welcome New Lead",
                content: "Assalamu'alaikum {name} \n\nTerima kasih telah menghubungi Vauza Tamma! Saya {agent_name} siap membantu perjalanan umroh impian Anda.\n\nAda yang bisa saya bantu?",
                variables: ["name", "agent_name"],
                category: "welcome",
                created_date: "2024-01-15",
                usage_count: 157
            },
            {
                id: 2,
                name: "followup_day3",
                title: "Follow-up Day 3",
                content: "Halo {name} \n\nKami ingin mengetahui apakah Anda masih berminat dengan paket umroh kami?\n\nJika ada pertanyaan, jangan ragu untuk bertanya ya!",
                variables: ["name"],
                category: "followup",
                created_date: "2024-01-10",
                usage_count: 89
            },
            {
                id: 3,
                name: "payment_reminder",
                title: "Payment Reminder",
                content: "Dear {name},\n\nKami ingatkan bahwa pembayaran untuk paket {package_name} sebesar Rp {remaining_amount} sudah jatuh tempo {days_overdue} hari yang lalu.\n\nMohon segera melakukan pembayaran. Terima kasih.",
                variables: ["name", "package_name", "remaining_amount", "days_overdue"],
                category: "payment",
                created_date: "2024-01-05",
                usage_count: 23
            },
            {
                id: 4,
                name: "birthday_greeting",
                title: "Birthday Greeting",
                content: " Selamat ulang tahun {name}! \n\nSemoga Allah SWT memberikan berkah dan kesehatan selalu. Sebagai hadiah ulang tahun, dapatkan diskon khusus 5% untuk paket umroh!\n\nValid hingga {valid_until}",
                variables: ["name", "valid_until"],
                category: "special",
                created_date: "2024-01-20",
                usage_count: 12
            }
        ];

        let messageQueue = [
            {
                id: 1,
                phone: "6281234567890",
                name: "Ahmad Fauzi",
                template: "welcome_message",
                scheduled_time: "2024-01-22 15:00",
                status: "pending",
                created_date: "2024-01-22 14:45",
                rule_id: 1,
                attempts: 0,
                priority: "normal"
            },
            {
                id: 2,
                phone: "6281234567891",
                name: "Siti Aminah",
                template: "followup_day3",
                scheduled_time: "2024-01-22 16:30",
                status: "processing",
                created_date: "2024-01-22 16:25",
                rule_id: 2,
                attempts: 1,
                priority: "high"
            },
            {
                id: 3,
                phone: "6281234567892",
                name: "Budi Santoso",
                template: "payment_reminder",
                scheduled_time: "2024-01-22 10:00",
                status: "sent",
                created_date: "2024-01-22 09:55",
                rule_id: 3,
                attempts: 1,
                priority: "urgent"
            },
            {
                id: 4,
                phone: "6281234567893",
                name: "Dewi Maharani",
                template: "welcome_message",
                scheduled_time: "2024-01-22 17:00",
                status: "failed",
                created_date: "2024-01-22 16:45",
                rule_id: 1,
                attempts: 3,
                priority: "normal",
                error: "Invalid phone number format"
            }
        ];

        // WhatsApp Automation Functions
        function loadAutomationPage() {
            loadAutomationRules();
            loadMessageTemplates();
            loadMessageQueue();
            loadAutomationAnalytics();
        }

        function loadAutomationRules() {
            const container = document.getElementById('rulesTableBody');
            if (!container) return;

            container.innerHTML = automationRules.map(rule => {
                const statusClass = rule.status === 'active' ? 'status-verified' : 'status-pending';
                const statusText = rule.status === 'active' ? 'Aktif' : 'Nonaktif';
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 500;">${rule.name}</div>
                            <small style="color: #94a3b8;">${rule.trigger.replace('_', ' ').toUpperCase()}</small>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td>${rule.executions}</td>
                        <td>${rule.last_executed || 'Belum pernah'}</td>
                        <td>
                            <div class="btn-group" style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-primary" onclick="editAutomationRule(${rule.id})">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-sm btn-${rule.status === 'active' ? 'warning' : 'success'}" onclick="toggleRuleStatus(${rule.id})">
                                    <span class="material-icons">${rule.status === 'active' ? 'pause' : 'play_arrow'}</span>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAutomationRule(${rule.id})">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadMessageTemplates() {
            const container = document.getElementById('templatesGrid');
            if (!container) return;

            container.innerHTML = messageTemplates.map(template => {
                const categoryColors = {
                    welcome: '#4facfe',
                    followup: '#f59e0b',
                    payment: '#ef4444',
                    special: '#22c55e'
                };

                return `
                    <div class="template-card" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin-bottom: 5px;">${template.title}</h4>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="status-badge" style="background: ${categoryColors[template.category]}20; color: ${categoryColors[template.category]}; border: 1px solid ${categoryColors[template.category]}50;">
                                        ${template.category.toUpperCase()}
                                    </span>
                                    <small style="color: #94a3b8;">Used ${template.usage_count} times</small>
                                </div>
                            </div>
                            <div class="btn-group" style="display: flex; gap: 5px;">
                                <button class="btn btn-sm btn-primary" onclick="editMessageTemplate(${template.id})" title="Edit">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="previewTemplate(${template.id})" title="Preview">
                                    <span class="material-icons">visibility</span>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMessageTemplate(${template.id})" title="Delete">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 14px; line-height: 1.5; color: rgba(255, 255, 255, 0.9);">
                                ${template.content.substring(0, 120)}${template.content.length > 120 ? '...' : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #94a3b8;">
                            <span>Variables: ${template.variables.join(', ')}</span>
                            <span>${template.created_date}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadMessageQueue() {
            const container = document.getElementById('queueTableBody');
            if (!container) return;

            container.innerHTML = messageQueue.map(item => {
                const statusColors = {
                    pending: '#f59e0b',
                    processing: '#4facfe',
                    sent: '#22c55e',
                    failed: '#ef4444',
                    scheduled: '#8b5cf6'
                };

                const priorityColors = {
                    normal: '#94a3b8',
                    high: '#f59e0b',
                    urgent: '#ef4444'
                };

                return `
                    <tr>
                        <td>
                            <div style="font-weight: 500;">${item.name}</div>
                            <small style="color: #94a3b8;">${item.phone}</small>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${messageTemplates.find(t => t.name === item.template)?.title || item.template}</div>
                        </td>
                        <td>
                            <span style="color: ${priorityColors[item.priority]}; font-weight: 500; text-transform: uppercase; font-size: 12px;">
                                ${item.priority}
                            </span>
                        </td>
                        <td>${item.scheduled_time}</td>
                        <td>
                            <span class="status-badge" style="background: ${statusColors[item.status]}20; color: ${statusColors[item.status]}; border: 1px solid ${statusColors[item.status]}50;">
                                ${item.status.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" style="display: flex; gap: 5px;">
                                ${item.status === 'pending' || item.status === 'failed' ? `
                                    <button class="btn btn-sm btn-success" onclick="retryMessage(${item.id})" title="Retry">
                                        <span class="material-icons">refresh</span>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-primary" onclick="viewMessageDetail(${item.id})" title="Detail">
                                    <span class="material-icons">visibility</span>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteQueueItem(${item.id})" title="Delete">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadAutomationAnalytics() {
            // Update analytics stats
            const totalRules = automationRules.length;
            const activeRules = automationRules.filter(r => r.status === 'active').length;
            const totalQueue = messageQueue.length;
            const pendingMessages = messageQueue.filter(m => m.status === 'pending').length;
            const totalSent = messageQueue.filter(m => m.status === 'sent').length;
            const failedMessages = messageQueue.filter(m => m.status === 'failed').length;
            const successRate = totalSent > 0 ? Math.round((totalSent / (totalSent + failedMessages)) * 100) : 0;

            // Update stat cards
            document.getElementById('totalRulesCount').textContent = totalRules;
            document.getElementById('activeRulesCount').textContent = activeRules;
            document.getElementById('queueCountStat').textContent = totalQueue;
            document.getElementById('pendingMessagesCount').textContent = pendingMessages;
            document.getElementById('sentMessagesCount').textContent = totalSent;
            document.getElementById('successRatePercent').textContent = successRate + '%';
        }

        // Automation Rule Management
        function openAutomationRuleModal(ruleId = null) {
            const modal = document.getElementById('automationRuleModal');
            const form = document.getElementById('automationRuleForm');
            
            if (ruleId) {
                const rule = automationRules.find(r => r.id === ruleId);
                if (rule) {
                    document.getElementById('ruleId').value = rule.id;
                    document.getElementById('ruleName').value = rule.name;
                    document.getElementById('ruleTrigger').value = rule.trigger;
                    document.getElementById('ruleTemplate').value = rule.template;
                    document.getElementById('ruleStatus').value = rule.status;
                    
                    // Set conditions based on trigger type
                    if (rule.trigger === 'time_based' && rule.conditions.days_since_last_contact) {
                        document.getElementById('timeDelay').value = rule.conditions.days_since_last_contact;
                    }
                }
            } else {
                form.reset();
                document.getElementById('ruleId').value = '';
            }
            
            // Populate template options
            const templateSelect = document.getElementById('ruleTemplate');
            templateSelect.innerHTML = '<option value="">Pilih Template</option>' + 
                messageTemplates.map(t => `<option value="${t.name}">${t.title}</option>`).join('');
            
            openModal('automationRuleModal');
        }

        function saveAutomationRule(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const ruleData = {
                name: formData.get('ruleName'),
                trigger: formData.get('ruleTrigger'),
                template: formData.get('ruleTemplate'),
                status: formData.get('ruleStatus') || 'active',
                conditions: {}
            };
            
            // Add conditions based on trigger type
            if (ruleData.trigger === 'time_based') {
                ruleData.conditions.days_since_last_contact = parseInt(formData.get('timeDelay')) || 1;
                ruleData.conditions.timeDelay = (parseInt(formData.get('timeDelay')) || 1) * 24;
            }
            
            const ruleId = formData.get('ruleId');
            
            if (ruleId) {
                // Update existing rule
                const index = automationRules.findIndex(r => r.id === parseInt(ruleId));
                if (index !== -1) {
                    automationRules[index] = { ...automationRules[index], ...ruleData };
                    showNotification('Automation rule updated successfully!');
                }
            } else {
                // Create new rule
                ruleData.id = Math.max(...automationRules.map(r => r.id), 0) + 1;
                ruleData.created_date = new Date().toLocaleDateString('id-ID');
                ruleData.executions = 0;
                automationRules.push(ruleData);
                showNotification('Automation rule created successfully!');
            }
            
            loadAutomationRules();
            loadAutomationAnalytics();
            closeModal('automationRuleModal');
        }

        function editAutomationRule(ruleId) {
            openAutomationRuleModal(ruleId);
        }

        function toggleRuleStatus(ruleId) {
            const rule = automationRules.find(r => r.id === ruleId);
            if (rule) {
                rule.status = rule.status === 'active' ? 'paused' : 'active';
                loadAutomationRules();
                loadAutomationAnalytics();
                showNotification(`Rule ${rule.status === 'active' ? 'activated' : 'paused'}!`);
            }
        }

        function deleteAutomationRule(ruleId) {
            if (confirm('Are you sure you want to delete this automation rule?')) {
                const index = automationRules.findIndex(r => r.id === ruleId);
                if (index !== -1) {
                    automationRules.splice(index, 1);
                    loadAutomationRules();
                    loadAutomationAnalytics();
                    showNotification('Automation rule deleted!');
                }
            }
        }

        // Message Template Management
        function openMessageTemplateModal(templateId = null) {
            const modal = document.getElementById('messageTemplateModal');
            const form = document.getElementById('messageTemplateForm');
            
            if (templateId) {
                const template = messageTemplates.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('templateId').value = template.id;
                    document.getElementById('templateName').value = template.name;
                    document.getElementById('templateTitle').value = template.title;
                    document.getElementById('templateContent').value = template.content;
                    document.getElementById('templateCategory').value = template.category;
                    document.getElementById('templateVariables').value = template.variables.join(', ');
                }
            } else {
                form.reset();
                document.getElementById('templateId').value = '';
            }
            
            openModal('messageTemplateModal');
        }

        function saveMessageTemplate(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const templateData = {
                name: formData.get('templateName'),
                title: formData.get('templateTitle'),
                content: formData.get('templateContent'),
                category: formData.get('templateCategory'),
                variables: formData.get('templateVariables').split(',').map(v => v.trim()).filter(v => v)
            };
            
            const templateId = formData.get('templateId');
            
            if (templateId) {
                // Update existing template
                const index = messageTemplates.findIndex(t => t.id === parseInt(templateId));
                if (index !== -1) {
                    messageTemplates[index] = { ...messageTemplates[index], ...templateData };
                    showNotification('Message template updated successfully!');
                }
            } else {
                // Create new template
                templateData.id = Math.max(...messageTemplates.map(t => t.id), 0) + 1;
                templateData.created_date = new Date().toLocaleDateString('id-ID');
                templateData.usage_count = 0;
                messageTemplates.push(templateData);
                showNotification('Message template created successfully!');
            }
            
            loadMessageTemplates();
            closeModal('messageTemplateModal');
        }

        function editMessageTemplate(templateId) {
            openMessageTemplateModal(templateId);
        }

        function previewTemplate(templateId) {
            const template = messageTemplates.find(t => t.id === templateId);
            if (template) {
                // Show preview with sample data
                let previewContent = template.content;
                template.variables.forEach(variable => {
                    const sampleData = {
                        name: 'Ahmad Fauzi',
                        agent_name: 'Siti Customer Service',
                        package_name: 'Umroh Ramadhan 2024',
                        remaining_amount: '5.000.000',
                        days_overdue: '3',
                        valid_until: '31 Januari 2024'
                    };
                    previewContent = previewContent.replace(new RegExp(`{${variable}}`, 'g'), sampleData[variable] || `{${variable}}`);
                });
                
                alert(`Preview Template: ${template.title}\n\n${previewContent}`);
            }
        }

        function deleteMessageTemplate(templateId) {
            if (confirm('Are you sure you want to delete this message template?')) {
                const index = messageTemplates.findIndex(t => t.id === templateId);
                if (index !== -1) {
                    messageTemplates.splice(index, 1);
                    loadMessageTemplates();
                    showNotification('Message template deleted!');
                }
            }
        }

        // Message Queue Management
        function retryMessage(itemId) {
            const item = messageQueue.find(m => m.id === itemId);
            if (item) {
                item.status = 'pending';
                item.attempts += 1;
                item.scheduled_time = new Date(Date.now() + 60000).toLocaleString('sv-SE').replace('T', ' ').substring(0, 16); // Retry in 1 minute
                loadMessageQueue();
                loadAutomationAnalytics();
                showNotification('Message queued for retry!');
            }
        }

        function viewMessageDetail(itemId) {
            const item = messageQueue.find(m => m.id === itemId);
            const template = messageTemplates.find(t => t.name === item.template);
            
            if (item && template) {
                const detail = `
Message Details:

Recipient: ${item.name} (${item.phone})
Template: ${template.title}
Status: ${item.status.toUpperCase()}
Scheduled: ${item.scheduled_time}
Attempts: ${item.attempts}
Priority: ${item.priority.toUpperCase()}
${item.error ? `Error: ${item.error}` : ''}

Message Content:
${template.content}
                `;
                alert(detail);
            }
        }

        function deleteQueueItem(itemId) {
            if (confirm('Are you sure you want to delete this queue item?')) {
                const index = messageQueue.findIndex(m => m.id === itemId);
                if (index !== -1) {
                    messageQueue.splice(index, 1);
                    loadMessageQueue();
                    loadAutomationAnalytics();
                    showNotification('Queue item deleted!');
                }
            }
        }

        // WAHA API Integration Functions (Ready for Server Configuration)
        const WAHA_CONFIG = {
            baseUrl: 'http://localhost:3000', // Will be configured when server is ready
            sessionName: 'umroh-automation',
            webhook: '/webhook/whatsapp'
        };

        async function sendWhatsAppMessage(phone, message, mediaUrl = null) {
            try {
                // This function will be activated when WAHA server is configured
                const payload = {
                    chatId: phone + '@c.us',
                    text: message,
                    session: WAHA_CONFIG.sessionName
                };

                if (mediaUrl) {
                    payload.file = {
                        mimetype: 'image/jpeg',
                        filename: 'image.jpg',
                        data: mediaUrl
                    };
                }

                // Placeholder for actual WAHA API call
                console.log('WAHA API Call (Ready for server):', payload);
                
                // Simulate API response for now
                return {
                    success: true,
                    messageId: 'msg_' + Date.now(),
                    timestamp: new Date().toISOString()
                };
                
                // Actual implementation (uncomment when server is ready):
                /*
                const response = await fetch(`${WAHA_CONFIG.baseUrl}/api/sendText`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                return await response.json();
                */
            } catch (error) {
                console.error('WAHA API Error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function processMessageQueue() {
            const now = new Date();
            const pendingMessages = messageQueue.filter(item => 
                item.status === 'pending' && 
                new Date(item.scheduled_time) <= now
            );

            for (const item of pendingMessages) {
                try {
                    item.status = 'processing';
                    loadMessageQueue();

                    const template = messageTemplates.find(t => t.name === item.template);
                    if (!template) {
                        throw new Error('Template not found');
                    }

                    // Process template variables (placeholder implementation)
                    let message = template.content;
                    template.variables.forEach(variable => {
                        // In real implementation, get actual data from lead/jamaah records
                        const sampleData = {
                            name: item.name,
                            agent_name: 'Customer Service',
                            package_name: 'Umroh Ramadhan 2024'
                        };
                        message = message.replace(new RegExp(`{${variable}}`, 'g'), sampleData[variable] || `{${variable}}`);
                    });

                    const result = await sendWhatsAppMessage(item.phone, message);
                    
                    if (result.success) {
                        item.status = 'sent';
                        item.sent_time = new Date().toISOString();
                        
                        // Update template usage count
                        template.usage_count += 1;
                        
                        // Update rule execution count
                        const rule = automationRules.find(r => r.id === item.rule_id);
                        if (rule) {
                            rule.executions += 1;
                            rule.last_executed = new Date().toLocaleString('sv-SE').replace('T', ' ').substring(0, 16);
                        }
                    } else {
                        item.status = 'failed';
                        item.error = result.error || 'Unknown error';
                    }
                } catch (error) {
                    item.status = 'failed';
                    item.error = error.message;
                }
            }

            loadMessageQueue();
            loadAutomationAnalytics();
            loadAutomationRules();
        }

        // Automation Scheduling Engine
        function startAutomationEngine() {
            // Process queue every minute
            setInterval(processMessageQueue, 60000);
            
            // Check for new automation triggers every 5 minutes
            setInterval(checkAutomationTriggers, 300000);
            
            console.log('WhatsApp Automation Engine Started');
            showNotification('Automation engine started!');
        }

        function checkAutomationTriggers() {
            // This function will check for triggers like:
            // - New leads (trigger: new_lead)
            // - Time-based triggers (trigger: time_based)
            // - Payment overdue (trigger: payment_overdue)
            // - Special events (birthdays, etc.)
            
            console.log('Checking automation triggers...');
            
            // Placeholder implementation - in real system, this would:
            // 1. Check lead data for new entries
            // 2. Check for time-based conditions
            // 3. Check payment status
            // 4. Create new queue items for matching conditions
        }

        // Test Functions for Development
        function testAutomationSystem() {
            console.log('Testing automation system...');
            
            // Test message queue processing
            processMessageQueue();
            
            // Test trigger checking
            checkAutomationTriggers();
            
            showNotification('Automation system test completed!');
        }

        function addTestQueueItem() {
            const testItem = {
                id: Math.max(...messageQueue.map(m => m.id), 0) + 1,
                phone: "6281234567899",
                name: "Test User",
                template: "welcome_message",
                scheduled_time: new Date(Date.now() + 30000).toLocaleString('sv-SE').replace('T', ' ').substring(0, 16), // 30 seconds from now
                status: "pending",
                created_date: new Date().toLocaleString('sv-SE').replace('T', ' ').substring(0, 16),
                rule_id: 1,
                attempts: 0,
                priority: "normal"
            };
            
            messageQueue.push(testItem);
            loadMessageQueue();
            loadAutomationAnalytics();
            showNotification('Test message added to queue!');
        }

        // Debug and test functions (outside DOMContentLoaded)
        function testNavigation() {
            console.log('Testing navigation...');
            const pages = ['dashboard', 'jamaah', 'packages', 'payments', 'documents', 'groups', 'finance', 'marketing', 'automation', 'reports', 'excel'];
            
            pages.forEach((pageId, index) => {
                setTimeout(() => {
                    console.log(`Testing page: ${pageId}`);
                    showPage(pageId);
                }, index * 1000);
            });
        }

        function testButtonClicks() {
            console.log('Testing button functionality...');
            const buttons = document.querySelectorAll('button[onclick]');
            console.log(`Found ${buttons.length} buttons with onclick handlers`);
            
            buttons.forEach((btn, index) => {
                if (index < 5) { // Test first 5 buttons only
                    console.log(`Button ${index + 1}: "${btn.textContent.trim()}" - onclick: ${btn.getAttribute('onclick')}`);
                }
            });
        }

        // Make test functions available globally
        window.testNavigation = testNavigation;
        window.testButtonClicks = testButtonClicks;
    </script>
</body>
</html>